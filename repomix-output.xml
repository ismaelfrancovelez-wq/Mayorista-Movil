This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.firebaserc
.gitignore
app/admin/productos-intermediarios/page.tsx
app/admin/verificaciones/[id]/page.tsx
app/admin/verificaciones/page.tsx
app/api/admin/products/mark-intermediary/route.ts
app/api/admin/verification/approve/route.ts
app/api/admin/verification/reject/route.ts
app/api/auth/login/route.ts
app/api/auth/me/route.ts
app/api/auth/register/route.ts
app/api/auth/switch-role/route.ts
app/api/featured/active/route.ts
app/api/featured/create/route.ts
app/api/lots/[productId]/route.ts
app/api/lots/active/route.ts
app/api/lots/fraccionado/progress/route.ts
app/api/manufacturers/address/route.ts
app/api/manufacturers/mp-auth-url/route.ts
app/api/manufacturers/mp-callback/route.ts
app/api/manufacturers/mp-connect/route.ts
app/api/manufacturers/mp-disconnect/route.ts
app/api/manufacturers/mp-status-public/route.ts
app/api/manufacturers/mp-status/route.ts
app/api/manufacturers/profile/route.ts
app/api/manufacturers/verification/status/route.ts
app/api/manufacturers/verification/submit/route.ts
app/api/payments/create-preference/route.ts
app/api/payments/fraccionado/create/route.ts
app/api/payments/mercadopago/route.ts
app/api/payments/refund/route.ts
app/api/payments/route.ts
app/api/products/create/route.ts
app/api/products/delete/route.ts
app/api/products/explore/route.ts
app/api/products/my-products/route.ts
app/api/retailers/address/route.ts
app/api/shipping/calculate/route.ts
app/api/shipping/factory/route.ts
app/api/shipping/fraccionado/route.ts
app/api/test-firebase/route.ts
app/api/test/route.ts
app/api/webhooks/mercadopago/route.ts
app/dashboard/fabricante/destacados/page.tsx
app/dashboard/fabricante/layout.tsx
app/dashboard/fabricante/page.tsx
app/dashboard/fabricante/pedidos/page.tsx
app/dashboard/fabricante/perfil/page.tsx
app/dashboard/fabricante/productos/nuevo/page.tsx
app/dashboard/fabricante/productos/page.tsx
app/dashboard/fabricante/verificacion/page.tsx
app/dashboard/fabricante/vinculacion-mp/page.tsx
app/dashboard/pedidos-fraccionados/layout.tsx
app/dashboard/pedidos-fraccionados/page.tsx
app/dashboard/pedidos-fraccionados/pedidos/page.tsx
app/dashboard/pedidos-fraccionados/perfil/page.tsx
app/explorar/[productId]/page.tsx
app/explorar/page.tsx
app/failure/page.tsx
app/favicon.ico
app/globals.css
app/layout.tsx
app/login/page.tsx
app/page.tsx
app/pending/page.tsx
app/products/[id]/page.tsx
app/products/page.tsx
app/products/test/page.tsx
app/registro/page.tsx
app/success/page.tsx
app/test-payment/page.tsx
components/ActiveRoleBadge.tsx
components/admin/AdminProductIntermediaryManager.tsx
components/admin/VerificationActions.tsx
components/AuthCheck.tsx
components/BackButton.tsx
components/DashboardSkeleton.tsx
components/FabricanteSidebar.tsx
components/FeaturedExpirationAlert.tsx
components/HomeButtons.tsx
components/HomePrincipal.tsx
components/HomeRegistro.tsx
components/ManufacturerInfoCard.tsx.tsx
components/PedidoFraccionadoCard.tsx
components/PickupDeadlineCounter.tsx
components/ProductBadges.tsx
components/products/ProductPurchaseClient.tsx
components/ProductsSkeleton.tsx
components/RevendedorSidebar.tsx
components/SwitchRoleButton.tsx
components/ui/radio-group.tsx
components/VerificationBadge.tsx
eslint.config.mjs
firebase.json
firestore.indexes.json
functions/.gitignore
functions/package.json
functions/src/index.ts
functions/src/scheduled/checkFeaturedExpiration.ts
functions/tsconfig.json
lib/auth/requireAdmin.ts
lib/auth/requireRole.ts
lib/business-hours.ts
lib/date-utils.ts
lib/email/client.ts
lib/email/templates.ts
lib/env.ts
lib/featured/checkExpiration.ts
lib/firebase-admin.ts
lib/firebase-client.ts
lib/lot.types.ts
lib/lots.ts
lib/lots/addFraccionadoToLot.ts
lib/lots/getOrCreateOpenLot.ts
lib/mercadopago-split.ts
lib/mercadopago.ts
lib/notifications/send.ts
lib/orders.ts
lib/rate-limit.ts
lib/shipping.ts
lib/shipping/calculateShippingInternal.ts
lib/shipping/distance.ts
lib/shipping/fraccionadoShipping.ts
lib/shipping/index.ts
lib/shipping/ownShipping.ts
lib/shipping/thirdPartyShipping.ts
lib/shipping/types.ts
lib/shipping/validateConfig.ts
lib/shipping/validateShippingConfig.ts
lib/shipping/zones.ts
lib/types/featured.ts
lib/types/product.ts
lib/types/shipping.ts
lib/types/verification.ts
lib/utils.ts
lib/validate-image.ts
middleware.ts
next.config.js
package.json
pages/api/cron/featured.ts
postcss.config.mjs
public/file.svg
public/globe.svg
public/google.svg
public/hero.jpeg
public/next.svg
public/vercel.svg
public/window.svg
README.md
scripts/migrate-products-category.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".firebaserc">
{
  "projects": {
    "default": "studio-3528216260-c7c7e"
  }
}
</file>

<file path="app/admin/productos-intermediarios/page.tsx">
// app/admin/productos-intermediarios/page.tsx - VERSI√ìN CORREGIDA

import { requireAdmin } from "../../../lib/auth/requireAdmin";
import { db } from "../../../lib/firebase-admin";
import AdminProductIntermediaryManager from "../../../components/admin/AdminProductIntermediaryManager";

// Tipo del producto simplificado para esta vista
type AdminProduct = {
  id: string;
  name: string;
  price: number;
  minimumOrder: number;
  factoryId: string;
  isIntermediary: boolean;
  active: boolean;
  createdAt: Date;
};

// üîß FUNCI√ìN CORREGIDA
async function getAdminProducts(adminUserId: string): Promise<AdminProduct[]> {
  console.log("üîç Buscando productos para admin:", adminUserId);

  // OPCI√ìN 1: Buscar el manufacturer asociado al userId del admin
  const manufacturersSnap = await db
    .collection("manufacturers")
    .where("userId", "==", adminUserId)
    .limit(1)
    .get();

  if (manufacturersSnap.empty) {
    console.log("‚ö†Ô∏è No se encontr√≥ manufacturer para userId:", adminUserId);
    console.log("üîç Intentando buscar productos directamente con factoryId = userId");
    
    // OPCI√ìN 2: Si no hay manufacturer, buscar productos donde factoryId = userId
    const productsSnap = await db
      .collection("products")
      .where("factoryId", "==", adminUserId)
      .orderBy("createdAt", "desc")
      .get();

    if (productsSnap.empty) {
      console.log("‚ùå Tampoco se encontraron productos con factoryId:", adminUserId);
      return [];
    }

    console.log("‚úÖ Encontrados", productsSnap.size, "productos con factoryId = userId");

    return productsSnap.docs.map((doc) => {
      const data = doc.data();
      return {
        id: doc.id,
        name: data.name || "Sin nombre",
        price: data.price || 0,
        minimumOrder: data.minimumOrder || 0,
        factoryId: data.factoryId,
        isIntermediary: data.isIntermediary || false,
        active: data.active !== false,
        createdAt: data.createdAt?.toDate() || new Date(),
      };
    });
  }

  const factoryId = manufacturersSnap.docs[0].id;
  console.log("‚úÖ Encontrado manufacturer con ID:", factoryId);

  // Obtener todos los productos de este fabricante
  const productsSnap = await db
    .collection("products")
    .where("factoryId", "==", factoryId)
    .orderBy("createdAt", "desc")
    .get();

  console.log("‚úÖ Encontrados", productsSnap.size, "productos para factoryId:", factoryId);

  return productsSnap.docs.map((doc) => {
    const data = doc.data();
    return {
      id: doc.id,
      name: data.name || "Sin nombre",
      price: data.price || 0,
      minimumOrder: data.minimumOrder || 0,
      factoryId: data.factoryId,
      isIntermediary: data.isIntermediary || false,
      active: data.active !== false,
      createdAt: data.createdAt?.toDate() || new Date(),
    };
  });
}

export default async function AdminProductIntermediaryPage() {
  const adminUserId = await requireAdmin();

  const products = await getAdminProducts(adminUserId);

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-6xl mx-auto p-8">
        
        {/* HEADER */}
        <div className="mb-8">
          <a 
            href="/admin/verificaciones"
            className="text-blue-600 hover:underline mb-4 inline-block"
          >
            ‚Üê Volver al panel admin
          </a>
          
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            Gesti√≥n de Productos Intermediarios
          </h1>
          <p className="text-gray-600">
            Marca los productos que funcionan como intermediarios (ustedes gestionan stock, compra y log√≠stica)
          </p>

          {/* üÜï DEBUG INFO */}
          <div className="mt-4 bg-gray-100 border border-gray-300 rounded-lg p-3 text-sm">
            <p className="text-gray-700">
              <strong>Usuario admin:</strong> {adminUserId}
            </p>
            <p className="text-gray-700">
              <strong>Productos encontrados:</strong> {products.length}
            </p>
          </div>
        </div>

        {/* INFORMACI√ìN */}
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-8">
          <h3 className="font-semibold text-blue-900 mb-2">
            ‚ÑπÔ∏è ¬øQu√© es un producto intermediario?
          </h3>
          <p className="text-sm text-blue-800">
            Los productos marcados como "intermediarios" mostrar√°n un badge especial indicando que ustedes (la plataforma) 
            funcionan como intermediarios: consultan precios, gestionan stock, realizan la compra y coordinan la log√≠stica. 
            Esto es √∫til cuando el fabricante original no publica directamente en la plataforma.
          </p>
        </div>

        {/* TABLA DE PRODUCTOS */}
        {products.length === 0 ? (
          <div className="bg-white rounded-xl shadow-lg p-12 text-center">
            <p className="text-gray-500 text-lg mb-4">
              No se encontraron productos para tu cuenta
            </p>
            <p className="text-sm text-gray-400">
              Aseg√∫rate de haber creado productos con tu cuenta de admin
            </p>
          </div>
        ) : (
          <AdminProductIntermediaryManager products={products} />
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/admin/verificaciones/[id]/page.tsx">
// app/admin/verificaciones/[id]/page.tsx

import { requireAdmin } from "../../../../lib/auth/requireAdmin";
import { db } from "../../../../lib/firebase-admin";
import { notFound } from "next/navigation";
import VerificationActions from "../../../../components/admin/VerificationActions";

type VerificationDetail = {
  id: string;
  manufacturerId: string;
  legalName: string;
  cuit: string;
  taxType: string;
  fantasyName: string | null;
  address: {
    street: string;
    city: string;
    province: string;
    postalCode: string;
    formatted: string;
  };
  contact: {
    name: string;
    phone: string;
    email: string;
  };
  documents: {
    afip: {
      url: string;
      fileName: string;
      size: number;
    };
  };
  status: 'pending' | 'verified' | 'rejected';
  submittedAt: Date;
  rejectionReason?: string;
};

async function getVerificationDetail(id: string): Promise<VerificationDetail | null> {
  const doc = await db.collection("verification_requests").doc(id).get();

  if (!doc.exists) return null;

  const data = doc.data()!;

  return {
    id: doc.id,
    manufacturerId: data.manufacturerId,
    legalName: data.legalName,
    cuit: data.cuit,
    taxType: data.taxType,
    fantasyName: data.fantasyName || null,
    address: data.address,
    contact: data.contact,
    documents: data.documents,
    status: data.status,
    submittedAt: data.submittedAt?.toDate() || new Date(),
    rejectionReason: data.rejectionReason,
  };
}

export default async function VerificationDetailPage({
  params,
}: {
  params: { id: string };
}) {
  await requireAdmin();

  const verification = await getVerificationDetail(params.id);

  if (!verification) {
    notFound();
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-5xl mx-auto p-8">
        
        {/* HEADER */}
        <div className="mb-8">
          <a 
            href="/admin/verificaciones"
            className="text-blue-600 hover:underline mb-4 inline-block"
          >
            ‚Üê Volver a solicitudes
          </a>
          
          <div className="flex items-start justify-between">
            <div>
              <h1 className="text-3xl font-bold text-gray-900 mb-2">
                {verification.legalName}
              </h1>
              <p className="text-gray-600">
                Solicitud de verificaci√≥n
              </p>
            </div>

            {verification.status === 'pending' && (
              <span className="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-full font-semibold">
                ‚è≥ Pendiente
              </span>
            )}
            {verification.status === 'verified' && (
              <span className="bg-blue-100 text-blue-800 px-4 py-2 rounded-full font-semibold">
                ‚úì Verificada
              </span>
            )}
            {verification.status === 'rejected' && (
              <span className="bg-red-100 text-red-800 px-4 py-2 rounded-full font-semibold">
                ‚úï Rechazada
              </span>
            )}
          </div>
        </div>

        {/* GRID DE INFORMACI√ìN */}
        <div className="grid lg:grid-cols-2 gap-6 mb-8">
          
          {/* DATOS DE LA EMPRESA */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
              üßæ Datos de la Empresa
            </h2>
            
            <div className="space-y-3">
              <div>
                <div className="text-xs text-gray-500 uppercase tracking-wide mb-1">Raz√≥n Social</div>
                <div className="font-semibold text-gray-900">{verification.legalName}</div>
              </div>

              <div>
                <div className="text-xs text-gray-500 uppercase tracking-wide mb-1">CUIT</div>
                <div className="font-mono text-gray-900">
                  {verification.cuit.replace(/(\d{2})(\d{8})(\d{1})/, '$1-$2-$3')}
                </div>
              </div>

              <div>
                <div className="text-xs text-gray-500 uppercase tracking-wide mb-1">Tipo de Contribuyente</div>
                <div className="text-gray-900">
                  {verification.taxType === 'monotributo' && 'Monotributo'}
                  {verification.taxType === 'responsable_inscripto' && 'Responsable Inscripto'}
                  {verification.taxType === 'sociedad' && 'Sociedad (SRL/SA/SAS)'}
                </div>
              </div>

              {verification.fantasyName && (
                <div>
                  <div className="text-xs text-gray-500 uppercase tracking-wide mb-1">Nombre de Fantas√≠a</div>
                  <div className="text-gray-900">{verification.fantasyName}</div>
                </div>
              )}

              <div>
                <div className="text-xs text-gray-500 uppercase tracking-wide mb-1">Fecha de Solicitud</div>
                <div className="text-gray-900">
                  {verification.submittedAt.toLocaleDateString('es-AR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}
                </div>
              </div>
            </div>
          </div>

          {/* DIRECCI√ìN */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
              üìç Direcci√≥n
            </h2>
            
            <div className="space-y-3">
              <div>
                <div className="text-xs text-gray-500 uppercase tracking-wide mb-1">Calle</div>
                <div className="text-gray-900">{verification.address.street}</div>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <div className="text-xs text-gray-500 uppercase tracking-wide mb-1">Ciudad</div>
                  <div className="text-gray-900">{verification.address.city}</div>
                </div>
                <div>
                  <div className="text-xs text-gray-500 uppercase tracking-wide mb-1">CP</div>
                  <div className="text-gray-900">{verification.address.postalCode}</div>
                </div>
              </div>

              <div>
                <div className="text-xs text-gray-500 uppercase tracking-wide mb-1">Provincia</div>
                <div className="text-gray-900">{verification.address.province}</div>
              </div>

              <div className="mt-4 p-3 bg-gray-50 rounded-lg">
                <div className="text-xs text-gray-500 uppercase tracking-wide mb-1">Direcci√≥n Completa</div>
                <div className="text-sm text-gray-700">{verification.address.formatted}</div>
              </div>
            </div>
          </div>

          {/* RESPONSABLE */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
              üë§ Responsable de Contacto
            </h2>
            
            <div className="space-y-3">
              <div>
                <div className="text-xs text-gray-500 uppercase tracking-wide mb-1">Nombre</div>
                <div className="text-gray-900">{verification.contact.name}</div>
              </div>

              <div>
                <div className="text-xs text-gray-500 uppercase tracking-wide mb-1">Tel√©fono</div>
                <div className="text-gray-900">
                  <a href={`tel:${verification.contact.phone}`} className="text-blue-600 hover:underline">
                    {verification.contact.phone}
                  </a>
                </div>
              </div>

              <div>
                <div className="text-xs text-gray-500 uppercase tracking-wide mb-1">Email</div>
                <div className="text-gray-900">
                  <a href={`mailto:${verification.contact.email}`} className="text-blue-600 hover:underline">
                    {verification.contact.email}
                  </a>
                </div>
              </div>
            </div>
          </div>

          {/* DOCUMENTACI√ìN */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
              üìÇ Documentaci√≥n
            </h2>
            
            <div className="space-y-3">
              <div className="border-2 border-gray-200 rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <div className="font-semibold text-gray-900">Constancia AFIP</div>
                  <div className="text-xs text-gray-500">
                    {(verification.documents.afip.size / 1024 / 1024).toFixed(2)} MB
                  </div>
                </div>
                
                <div className="text-sm text-gray-600 mb-3">
                  {verification.documents.afip.fileName}
                </div>

                <a
                  href={verification.documents.afip.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition w-full justify-center"
                >
                  <span>üìÑ</span>
                  <span>Ver Documento</span>
                </a>

                <p className="text-xs text-gray-500 mt-2">
                  ‚ö†Ô∏è Verific√° que el CUIT, raz√≥n social y estado activo coincidan
                </p>
              </div>
            </div>
          </div>
        </div>

        {/* ACCIONES (solo si est√° pendiente) */}
        {verification.status === 'pending' && (
          <VerificationActions 
            verificationId={verification.id}
            manufacturerId={verification.manufacturerId}
            legalName={verification.legalName}
          />
        )}

        {/* MOTIVO DE RECHAZO (si fue rechazada) */}
        {verification.status === 'rejected' && verification.rejectionReason && (
          <div className="bg-red-50 border-2 border-red-200 rounded-xl p-6">
            <h3 className="font-bold text-red-900 mb-2">Motivo de Rechazo</h3>
            <p className="text-red-700">{verification.rejectionReason}</p>
          </div>
        )}

      </div>
    </div>
  );
}
</file>

<file path="app/admin/verificaciones/page.tsx">
// app/admin/verificaciones/page.tsx - VERSI√ìN ACTUALIZADA

import { requireAdmin } from "../../../lib/auth/requireAdmin";
import { db } from "../../../lib/firebase-admin";
import Link from "next/link";

type VerificationRequest = {
  id: string;
  manufacturerId: string;
  legalName: string;
  cuit: string;
  taxType: string;
  status: 'pending' | 'verified' | 'rejected';
  submittedAt: Date;
};

async function getAllVerifications(): Promise<{
  pending: VerificationRequest[];
  verified: VerificationRequest[];
  rejected: VerificationRequest[];
}> {
  const [pendingSnap, verifiedSnap, rejectedSnap] = await Promise.all([
    db.collection("verification_requests").where("status", "==", "pending").orderBy("submittedAt", "desc").get(),
    db.collection("verification_requests").where("status", "==", "verified").orderBy("submittedAt", "desc").limit(10).get(),
    db.collection("verification_requests").where("status", "==", "rejected").orderBy("submittedAt", "desc").limit(10).get(),
  ]);

  const mapDocs = (snap: any) => snap.docs.map((doc: any) => ({
    id: doc.id,
    manufacturerId: doc.data().manufacturerId,
    legalName: doc.data().legalName,
    cuit: doc.data().cuit,
    taxType: doc.data().taxType,
    status: doc.data().status,
    submittedAt: doc.data().submittedAt?.toDate() || new Date(),
  }));

  return {
    pending: mapDocs(pendingSnap),
    verified: mapDocs(verifiedSnap),
    rejected: mapDocs(rejectedSnap),
  };
}

export default async function AdminVerificacionesPage() {
  await requireAdmin();

  const { pending, verified, rejected } = await getAllVerifications();

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-7xl mx-auto p-8">
        
        {/* HEADER */}
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            üîê Panel de Administraci√≥n
          </h1>
          <p className="text-gray-600 mb-4">
            Gesti√≥n de verificaciones de empresas y productos intermediarios
          </p>
          
          {/* üÜï NUEVO: BOT√ìN PARA GESTIONAR PRODUCTOS INTERMEDIARIOS */}
          <div className="flex gap-3 mt-4">
            <Link
              href="/admin/productos-intermediarios"
              className="inline-flex items-center gap-2 bg-orange-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-orange-700 transition shadow-md"
            >
              <svg 
                className="w-5 h-5"
                viewBox="0 0 24 24" 
                fill="currentColor"
              >
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
              </svg>
              <span>Gestionar Productos Intermediarios</span>
            </Link>
          </div>
        </div>

        {/* ESTAD√çSTICAS */}
        <div className="grid md:grid-cols-3 gap-6 mb-8">
          <div className="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-yellow-700 font-medium">Pendientes</p>
                <p className="text-3xl font-bold text-yellow-900">{pending.length}</p>
              </div>
              <div className="text-4xl">‚è≥</div>
            </div>
          </div>

          <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-blue-700 font-medium">Verificadas</p>
                <p className="text-3xl font-bold text-blue-900">{verified.length}</p>
              </div>
              <div className="text-4xl">‚úì</div>
            </div>
          </div>

          <div className="bg-red-50 border-2 border-red-200 rounded-xl p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-red-700 font-medium">Rechazadas</p>
                <p className="text-3xl font-bold text-red-900">{rejected.length}</p>
              </div>
              <div className="text-4xl">‚úï</div>
            </div>
          </div>
        </div>

        {/* SOLICITUDES PENDIENTES */}
        <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
          <h2 className="text-xl font-bold mb-6 flex items-center gap-2">
            ‚è≥ Solicitudes Pendientes
            {pending.length > 0 && (
              <span className="bg-yellow-500 text-white text-sm px-2 py-1 rounded-full">
                {pending.length}
              </span>
            )}
          </h2>

          {pending.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <div className="text-6xl mb-4">‚úì</div>
              <p className="text-lg">No hay solicitudes pendientes</p>
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b-2 border-gray-200">
                    <th className="text-left py-3 px-4 font-semibold text-gray-700">Empresa</th>
                    <th className="text-left py-3 px-4 font-semibold text-gray-700">CUIT</th>
                    <th className="text-left py-3 px-4 font-semibold text-gray-700">Tipo</th>
                    <th className="text-left py-3 px-4 font-semibold text-gray-700">Fecha</th>
                    <th className="text-center py-3 px-4 font-semibold text-gray-700">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {pending.map((req) => (
                    <tr key={req.id} className="border-b border-gray-100 hover:bg-gray-50">
                      <td className="py-4 px-4">
                        <div className="font-semibold text-gray-900">{req.legalName}</div>
                        <div className="text-xs text-gray-500">ID: {req.manufacturerId.slice(0, 8)}...</div>
                      </td>
                      <td className="py-4 px-4">
                        <code className="text-sm bg-gray-100 px-2 py-1 rounded">
                          {req.cuit.replace(/(\d{2})(\d{8})(\d{1})/, '$1-$2-$3')}
                        </code>
                      </td>
                      <td className="py-4 px-4">
                        <span className="text-sm text-gray-600">
                          {req.taxType === 'monotributo' && 'Monotributo'}
                          {req.taxType === 'responsable_inscripto' && 'RI'}
                          {req.taxType === 'sociedad' && 'Sociedad'}
                        </span>
                      </td>
                      <td className="py-4 px-4 text-sm text-gray-600">
                        {req.submittedAt.toLocaleDateString('es-AR', {
                          day: '2-digit',
                          month: '2-digit',
                          year: 'numeric',
                        })}
                      </td>
                      <td className="py-4 px-4">
                        <Link
                          href={`/admin/verificaciones/${req.id}`}
                          className="inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition"
                        >
                          <span>Revisar</span>
                          <span>‚Üí</span>
                        </Link>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>

        {/* HISTORIAL RECIENTE */}
        <div className="grid md:grid-cols-2 gap-8">
          
          {/* VERIFICADAS */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h2 className="text-lg font-bold mb-4 text-blue-900">
              ‚úì √öltimas Verificadas
            </h2>
            {verified.length === 0 ? (
              <p className="text-gray-500 text-sm">No hay registros</p>
            ) : (
              <div className="space-y-3">
                {verified.slice(0, 5).map((req) => (
                  <div key={req.id} className="border-l-4 border-blue-500 pl-3 py-2">
                    <div className="font-medium text-sm">{req.legalName}</div>
                    <div className="text-xs text-gray-500">
                      {req.submittedAt.toLocaleDateString('es-AR')}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* RECHAZADAS */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h2 className="text-lg font-bold mb-4 text-red-900">
              ‚úï √öltimas Rechazadas
            </h2>
            {rejected.length === 0 ? (
              <p className="text-gray-500 text-sm">No hay registros</p>
            ) : (
              <div className="space-y-3">
                {rejected.slice(0, 5).map((req) => (
                  <div key={req.id} className="border-l-4 border-red-500 pl-3 py-2">
                    <div className="font-medium text-sm">{req.legalName}</div>
                    <div className="text-xs text-gray-500">
                      {req.submittedAt.toLocaleDateString('es-AR')}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/api/admin/products/mark-intermediary/route.ts">
// app/api/admin/products/mark-intermediary/route.ts

import { NextResponse } from "next/server";
import { requireAdmin } from "../../../../../lib/auth/requireAdmin";
import { db } from "../../../../../lib/firebase-admin";
import { FieldValue } from "firebase-admin/firestore";

export async function POST(req: Request) {
  try {
    // üîí SOLO ADMIN puede marcar productos como intermediarios
    await requireAdmin();

    const body = await req.json();
    
    const { productId, isIntermediary } = body;

    // Validar que se envi√≥ el productId
    if (!productId || typeof productId !== "string") {
      return NextResponse.json(
        { error: "ID de producto inv√°lido" },
        { status: 400 }
      );
    }

    // Validar que isIntermediary es booleano
    if (typeof isIntermediary !== "boolean") {
      return NextResponse.json(
        { error: "El valor de isIntermediary debe ser true o false" },
        { status: 400 }
      );
    }

    // Verificar que el producto existe
    const productRef = db.collection("products").doc(productId);
    const productSnap = await productRef.get();

    if (!productSnap.exists) {
      return NextResponse.json(
        { error: "Producto no encontrado" },
        { status: 404 }
      );
    }

    // Actualizar el producto con el flag de intermediario
    await productRef.update({
      isIntermediary: isIntermediary,
      updatedAt: FieldValue.serverTimestamp(),
    });

    return NextResponse.json({
      success: true,
      message: isIntermediary 
        ? "Producto marcado como intermediario" 
        : "Marca de intermediario removida",
    });

  } catch (error: any) {
    console.error("‚ùå ERROR AL MARCAR PRODUCTO COMO INTERMEDIARIO:", error);
    
    return NextResponse.json(
      { error: error?.message || "Error al actualizar producto" },
      { status: 400 }
    );
  }
}
</file>

<file path="app/api/admin/verification/approve/route.ts">
// app/api/admin/verification/approve/route.ts

import { NextResponse } from "next/server";
import { requireAdmin } from "../../../../../lib/auth/requireAdmin";
import { db } from "../../../../../lib/firebase-admin";
import { FieldValue } from "firebase-admin/firestore";

export async function POST(req: Request) {
  try {
    // ‚úÖ VERIFICAR QUE SEA ADMIN
    const adminId = await requireAdmin();

    const body = await req.json();
    const { verificationId, manufacturerId } = body;

    if (!verificationId || !manufacturerId) {
      return NextResponse.json(
        { error: "Datos incompletos" },
        { status: 400 }
      );
    }

    // üìã OBTENER SOLICITUD
    const verificationRef = db.collection("verification_requests").doc(verificationId);
    const verificationSnap = await verificationRef.get();

    if (!verificationSnap.exists) {
      return NextResponse.json(
        { error: "Solicitud no encontrada" },
        { status: 404 }
      );
    }

    const verificationData = verificationSnap.data()!;

    // ‚úÖ ACTUALIZAR SOLICITUD
    await verificationRef.update({
      status: "verified",
      reviewedAt: FieldValue.serverTimestamp(),
      reviewedBy: adminId,
      updatedAt: FieldValue.serverTimestamp(),
    });

    // ‚úÖ ACTUALIZAR PERFIL DEL FABRICANTE
    await db.collection("manufacturers").doc(manufacturerId).set({
      verification: {
        status: "verified",
        verifiedAt: FieldValue.serverTimestamp(),
        legalName: verificationData.legalName,
        cuit: verificationData.cuit,
        taxType: verificationData.taxType,
        fantasyName: verificationData.fantasyName || null,
      },
      updatedAt: FieldValue.serverTimestamp(),
    }, { merge: true });

    // üìß TODO: Enviar email de notificaci√≥n al fabricante
    console.log(`‚úÖ Verificaci√≥n aprobada: ${manufacturerId}`);

    return NextResponse.json({
      success: true,
      message: "Verificaci√≥n aprobada correctamente",
    });

  } catch (error: any) {
    console.error("‚ùå Error aprobando verificaci√≥n:", error);
    
    if (error.message.includes("No autorizado")) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    return NextResponse.json(
      { error: "Error al aprobar verificaci√≥n" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/admin/verification/reject/route.ts">
// app/api/admin/verification/reject/route.ts

import { NextResponse } from "next/server";
import { requireAdmin } from "../../../../../lib/auth/requireAdmin";
import { db } from "../../../../../lib/firebase-admin";
import { FieldValue } from "firebase-admin/firestore";

export async function POST(req: Request) {
  try {
    // ‚úÖ VERIFICAR QUE SEA ADMIN
    const adminId = await requireAdmin();

    const body = await req.json();
    const { verificationId, manufacturerId, rejectionReason } = body;

    if (!verificationId || !manufacturerId || !rejectionReason) {
      return NextResponse.json(
        { error: "Datos incompletos" },
        { status: 400 }
      );
    }

    // üìã OBTENER SOLICITUD
    const verificationRef = db.collection("verification_requests").doc(verificationId);
    const verificationSnap = await verificationRef.get();

    if (!verificationSnap.exists) {
      return NextResponse.json(
        { error: "Solicitud no encontrada" },
        { status: 404 }
      );
    }

    // ‚ùå ACTUALIZAR SOLICITUD
    await verificationRef.update({
      status: "rejected",
      rejectionReason: rejectionReason.trim(),
      reviewedAt: FieldValue.serverTimestamp(),
      reviewedBy: adminId,
      updatedAt: FieldValue.serverTimestamp(),
    });

    // ‚ùå ACTUALIZAR PERFIL DEL FABRICANTE
    await db.collection("manufacturers").doc(manufacturerId).update({
      "verification.status": "rejected",
      "verification.rejectionReason": rejectionReason.trim(),
      updatedAt: FieldValue.serverTimestamp(),
    });

    // üìß TODO: Enviar email de notificaci√≥n al fabricante con el motivo
    console.log(`‚ùå Verificaci√≥n rechazada: ${manufacturerId}`);
    console.log(`Motivo: ${rejectionReason}`);

    return NextResponse.json({
      success: true,
      message: "Verificaci√≥n rechazada correctamente",
    });

  } catch (error: any) {
    console.error("‚ùå Error rechazando verificaci√≥n:", error);
    
    if (error.message.includes("No autorizado")) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    return NextResponse.json(
      { error: "Error al rechazar verificaci√≥n" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/auth/me/route.ts">
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function GET() {
  const role = cookies().get("activeRole")?.value;
  const userId = cookies().get("userId")?.value;

  if (!userId || !role) {
    return NextResponse.json(
      { error: "No autenticado" },
      { status: 401 }
    );
  }

  return NextResponse.json({
    userId,
    role,
  });
}
</file>

<file path="app/api/auth/register/route.ts">
import { NextResponse } from "next/server";
import { db, auth } from "../../../../lib/firebase-admin";
import { FieldValue } from "firebase-admin/firestore";

export async function POST(req: Request) {
  try {
    const { idToken, usertype } = await req.json();

    if (!idToken) {
      return NextResponse.json(
        { error: "Token requerido" },
        { status: 400 }
      );
    }

    // Validar usertype
    if (!usertype || !["manufacturer", "retailer"].includes(usertype)) {
      return NextResponse.json(
        { error: "Tipo de usuario inv√°lido" },
        { status: 400 }
      );
    }

    // Verificar token
    const decoded = await auth.verifyIdToken(idToken);
    const userId = decoded.uid;
    const email = decoded.email;

    // ‚úÖ FIX: Usar userId como ID del documento
    const userRef = db.collection("users").doc(userId);
    const userSnap = await userRef.get();

    if (userSnap.exists) {
      // Usuario ya existe, solo actualizar activeRole
      await userRef.update({
        activeRole: usertype,
        updatedAt: FieldValue.serverTimestamp(),
      });

      return NextResponse.json({
        success: true,
        userId,
        usertype,
        message: "Usuario actualizado",
      });
    }

    // ‚úÖ FIX: Crear usuario con userId como ID del documento
    await userRef.set({
      userId,
      email,
      usertype,
      activeRole: usertype,
      createdAt: FieldValue.serverTimestamp(),
    });

    // Crear documento de fabricante si corresponde
    if (usertype === "manufacturer") {
      await db.collection("manufacturers").doc(userId).set({
        createdAt: FieldValue.serverTimestamp(),
      });
    }

    // Crear documento de revendedor si corresponde
    if (usertype === "retailer") {
      await db.collection("retailers").doc(userId).set({
        createdAt: FieldValue.serverTimestamp(),
      });
    }

    return NextResponse.json({
      success: true,
      userId,
      usertype,
      message: "Usuario registrado exitosamente",
    });

  } catch (err) {
    console.error("‚ùå REGISTER ERROR:", err);
    return NextResponse.json(
      { error: "Error al registrar usuario" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/auth/switch-role/route.ts">
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function POST(req: Request) {
  const { role } = await req.json();

  if (!role || !["manufacturer", "retailer"].includes(role)) {
    return NextResponse.json(
      { error: "Rol inv√°lido" },
      { status: 400 }
    );
  }

  cookies().set("activeRole", role, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    sameSite: "lax",
    path: "/",
  });

  return NextResponse.json({ success: true });
}
</file>

<file path="app/api/featured/active/route.ts">
import { NextResponse } from "next/server";
import { db } from "../../../../lib/firebase-admin";
import { FeaturedType } from "../../../../lib/types/featured";

export async function GET(req: Request) {
  try {
    const { searchParams } = new URL(req.url);
    const type = searchParams.get("type") as FeaturedType | null;

    if (!type || !["product", "factory"].includes(type)) {
      return NextResponse.json(
        { error: "Tipo requerido (product o factory)" },
        { status: 400 }
      );
    }

    const now = new Date();

    const snap = await db
      .collection("featured")
      .where("type", "==", type)
      .where("active", "==", true)
      .where("expired", "==", false)
      .orderBy("createdAt", "desc")
      .limit(10)
      .get();

    const items = [];

    for (const doc of snap.docs) {
      const data = doc.data();
      const endDate = data.endDate?.toDate();

      if (endDate && endDate < now) {
        await doc.ref.update({
          expired: true,
          active: false,
          updatedAt: new Date(),
        });
        continue;
      }

      let itemData = null;

      if (type === "product") {
        const productSnap = await db.collection("products").doc(data.itemId).get();
        if (productSnap.exists) {
          const p = productSnap.data()!;
          itemData = {
            id: productSnap.id,
            name: p.name,
            price: p.price,
            minimumOrder: p.minimumOrder,
            category: p.category,
          };
        }
      } else {
        const factorySnap = await db.collection("manufacturers").doc(data.itemId).get();
        if (factorySnap.exists) {
          const f = factorySnap.data()!;
          itemData = {
            id: factorySnap.id,
            name: f.businessName || f.name || "F√°brica",
            description: f.description || "",
            address: f.address?.formattedAddress || "",
          };
        }
      }

      if (itemData) {
        items.push({
          id: doc.id,
          type: data.type,
          itemId: data.itemId,
          endDate: endDate?.toISOString(),
          metadata: data.metadata,
          itemData,
        });
      }
    }

    return NextResponse.json({
      type,
      count: items.length,
      items,
    });

  } catch (error) {
    console.error("‚ùå GET FEATURED ERROR:", error);
    return NextResponse.json(
      { error: "Error al obtener destacados" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/featured/create/route.ts">
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { db } from "../../../../lib/firebase-admin";
import { FeaturedType, FeaturedDuration, FEATURED_PRICES, FEATURED_SLOTS } from "../../../../lib/types/featured";
import { createPreference } from "../../../../lib/mercadopago";

export async function POST(req: Request) {
  try {
    const userId = cookies().get("userId")?.value;
    const role = cookies().get("activeRole")?.value;

    if (!userId || role !== "manufacturer") {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    const body = await req.json();
    const { type, itemId, duration } = body as {
      type: FeaturedType;
      itemId: string;
      duration: FeaturedDuration;
    };

    if (!type || !["product", "factory"].includes(type)) {
      return NextResponse.json(
        { error: "Tipo inv√°lido" },
        { status: 400 }
      );
    }

    if (!itemId) {
      return NextResponse.json(
        { error: "itemId requerido" },
        { status: 400 }
      );
    }

    if (!duration || ![7, 15, 30].includes(duration)) {
      return NextResponse.json(
        { error: "Duraci√≥n inv√°lida (7, 15 o 30 d√≠as)" },
        { status: 400 }
      );
    }

    const activeCount = await db
      .collection("featured")
      .where("type", "==", type)
      .where("active", "==", true)
      .where("expired", "==", false)
      .count()
      .get();

    const maxSlots = FEATURED_SLOTS[type];
    
    if (activeCount.data().count >= maxSlots) {
      return NextResponse.json(
        { error: `No hay slots disponibles. M√°ximo: ${maxSlots}` },
        { status: 400 }
      );
    }

    let metadata: any = {};

    if (type === "product") {
      const productSnap = await db.collection("products").doc(itemId).get();
      
      if (!productSnap.exists) {
        return NextResponse.json(
          { error: "Producto no encontrado" },
          { status: 404 }
        );
      }

      const product = productSnap.data()!;
      
      if (product.factoryId !== userId) {
        return NextResponse.json(
          { error: "Este producto no te pertenece" },
          { status: 403 }
        );
      }

      metadata = {
        name: product.name,
        description: product.description || "",
        imageUrl: product.imageUrl || "",
      };
    } else {
      const factorySnap = await db.collection("manufacturers").doc(itemId).get();
      
      if (!factorySnap.exists) {
        return NextResponse.json(
          { error: "F√°brica no encontrada" },
          { status: 404 }
        );
      }

      if (itemId !== userId) {
        return NextResponse.json(
          { error: "Esta f√°brica no te pertenece" },
          { status: 403 }
        );
      }

      const factory = factorySnap.data()!;

      metadata = {
        name: factory.businessName || factory.name || "Mi f√°brica",
        description: factory.description || "",
        imageUrl: factory.imageUrl || "",
      };
    }

    const amount = FEATURED_PRICES[duration];

    const preference = await createPreference({
      title: `Destacar ${type === "product" ? "producto" : "f√°brica"} por ${duration} d√≠as`,
      unit_price: amount,
      quantity: 1,
      metadata: {
        productId: "featured_payment",
        qty: 1,
        tipo: "destacado",
        withShipping: false,
        featuredType: type,
        featuredItemId: itemId,
        featuredDuration: duration,
      },
      back_urls: {
        success: process.env.NEXT_PUBLIC_APP_URL + "/dashboard/fabricante/destacados",
        pending: process.env.NEXT_PUBLIC_APP_URL + "/pending",
        failure: process.env.NEXT_PUBLIC_APP_URL + "/failure",
      },
    });

    if (!preference.init_point) {
      throw new Error("No se pudo crear preferencia de pago");
    }

    return NextResponse.json({
      init_point: preference.init_point,
      amount,
      duration,
    });

  } catch (error) {
    console.error("‚ùå CREATE FEATURED ERROR:", error);
    return NextResponse.json(
      { error: "Error al crear destacado" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/lots/fraccionado/progress/route.ts">
import { NextResponse } from "next/server";
import { db } from "../../../../../lib/firebase-admin";

export async function GET(req: Request) {
  try {
    const { searchParams } = new URL(req.url);
    const productId = searchParams.get("productId");

    if (!productId) {
      return NextResponse.json(
        { error: "productId requerido" },
        { status: 400 }
      );
    }

    const snap = await db
      .collection("lots")
      .where("productId", "==", productId)
      .where("status", "==", "open")
      .get();

    let withShipping = {
      accumulatedQty: 0,
      MF: 0,
      percentage: 0,
    };

    let withoutShipping = {
      accumulatedQty: 0,
      MF: 0,
      percentage: 0,
    };

    snap.docs.forEach((doc) => {
      const data = doc.data();
      const MF = data.MF ?? 0;
      const accumulated = data.accumulatedQty ?? 0;
      const percentage =
        MF > 0 ? Math.min(accumulated / MF, 1) * 100 : 0;

      if (data.type === "fraccionado_envio") {
        withShipping = { accumulatedQty: accumulated, MF, percentage };
      }

      if (data.type === "fraccionado_retiro") {
        withoutShipping = { accumulatedQty: accumulated, MF, percentage };
      }
    });

    const missingQty =
      Math.max(
        withShipping.MF || withoutShipping.MF,
        0
      ) -
      Math.max(
        withShipping.accumulatedQty,
        withoutShipping.accumulatedQty
      );

    return NextResponse.json({
      minimumOrder:
        withShipping.MF || withoutShipping.MF || 0,
      withShipping,
      withoutShipping,
      missingQty: Math.max(missingQty, 0),
    });
  } catch (err) {
    console.error("‚ùå FRACCIONADO PROGRESS ERROR:", err);
    return NextResponse.json(
      { error: "Error cargando progreso fraccionado" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/manufacturers/address/route.ts">
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { db } from "../../../../lib/firebase-admin";

export async function GET() {
  try {
    const userId = cookies().get("userId")?.value;

    if (!userId) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    const snap = await db
      .collection("manufacturers")
      .doc(userId)
      .get();

    if (!snap.exists) {
      return NextResponse.json({ address: null });
    }

    return NextResponse.json({
      address: snap.data()?.address ?? null,
    });
  } catch (error) {
    console.error("‚ùå Get address:", error);
    return NextResponse.json(
      { error: "Error obteniendo direcci√≥n" },
      { status: 500 }
    );
  }
}

export async function POST(req: Request) {
  try {
    const userId = cookies().get("userId")?.value;

    if (!userId) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    const { formattedAddress, lat, lng } = await req.json();

    if (
      !formattedAddress ||
      typeof lat !== "number" ||
      typeof lng !== "number"
    ) {
      return NextResponse.json(
        { error: "Datos inv√°lidos" },
        { status: 400 }
      );
    }

    await db
      .collection("manufacturers")
      .doc(userId)
      .set(
        {
          address: {
            formattedAddress,
            lat,
            lng,
          },
          updatedAt: new Date(),
        },
        { merge: true }
      );

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error("‚ùå Save address:", error);
    return NextResponse.json(
      { error: "Error guardando direcci√≥n" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/manufacturers/mp-auth-url/route.ts">
import { NextResponse } from "next/server";
import { cookies } from "next/headers";

export async function GET() {
  try {
    const userId = cookies().get("userId")?.value;

    if (!userId) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    const APP_ID = process.env.MERCADOPAGO_APP_ID;
    const BASE_URL = process.env.NEXT_PUBLIC_APP_URL;

    if (!APP_ID || !BASE_URL) {
      console.error('‚ùå Variables faltantes:', { APP_ID: !!APP_ID, BASE_URL: !!BASE_URL });
      return NextResponse.json(
        { error: "Configuraci√≥n incompleta del servidor" },
        { status: 500 }
      );
    }

    // ‚úÖ URL correcta de callback
    const REDIRECT_URI = `${BASE_URL}/api/manufacturers/mp-callback`;

    // ‚úÖ Construir URL de autorizaci√≥n
    const authUrl = new URL('https://auth.mercadopago.com.ar/authorization');
    authUrl.searchParams.set('client_id', APP_ID);
    authUrl.searchParams.set('response_type', 'code');
    authUrl.searchParams.set('platform_id', 'mp');
    authUrl.searchParams.set('state', userId);
    authUrl.searchParams.set('redirect_uri', REDIRECT_URI);

    console.log('üîó URL de autorizaci√≥n generada:', authUrl.toString());

    return NextResponse.json({ authUrl: authUrl.toString() });
  } catch (error) {
    console.error("Error generando URL de auth:", error);
    return NextResponse.json(
      { error: "Error al generar URL" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/manufacturers/mp-callback/route.ts">
import { NextResponse } from "next/server";

export async function GET(req: Request) {
  try {
    const { searchParams } = new URL(req.url);
    const code = searchParams.get('code');
    const state = searchParams.get('state');
    const error = searchParams.get('error');

    const BASE_URL = process.env.NEXT_PUBLIC_APP_URL;

    if (error) {
      console.error('‚ùå Error de Mercado Pago:', error);
      return NextResponse.redirect(
        `${BASE_URL}/dashboard/fabricante/vinculacion-mp?error=${error}`
      );
    }

    if (!code || !state) {
      console.error('‚ùå Faltan par√°metros:', { code: !!code, state: !!state });
      return NextResponse.redirect(
        `${BASE_URL}/dashboard/fabricante/vinculacion-mp?error=missing_params`
      );
    }

    // Redirigir a la p√°gina de vinculaci√≥n con el c√≥digo
    return NextResponse.redirect(
      `${BASE_URL}/dashboard/fabricante/vinculacion-mp?code=${code}&state=${state}`
    );
  } catch (error) {
    console.error('Error en callback:', error);
    return NextResponse.redirect(
      `${process.env.NEXT_PUBLIC_APP_URL}/dashboard/fabricante/vinculacion-mp?error=callback_error`
    );
  }
}
</file>

<file path="app/api/manufacturers/mp-connect/route.ts">
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { db } from "../../../../lib/firebase-admin";

export async function POST(req: Request) {
  try {
    const userId = cookies().get("userId")?.value;

    if (!userId) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    const { code } = await req.json();

    if (!code) {
      return NextResponse.json(
        { error: "C√≥digo de autorizaci√≥n requerido" },
        { status: 400 }
      );
    }

    // Intercambiar c√≥digo por access_token
    const tokenResponse = await fetch("https://api.mercadopago.com/oauth/token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        client_id: process.env.MERCADOPAGO_APP_ID,
        client_secret: process.env.MERCADOPAGO_CLIENT_SECRET,
        code,
        grant_type: "authorization_code",
        redirect_uri: process.env.NEXT_PUBLIC_APP_URL + "/dashboard/fabricante/vinculacion-mp",
      }),
    });

    if (!tokenResponse.ok) {
      throw new Error("Error al obtener access token");
    }

    const tokenData = await tokenResponse.json();

    // Guardar en Firestore
    await db.collection("manufacturers").doc(userId).set({
      mercadopago: {
        access_token: tokenData.access_token,
        refresh_token: tokenData.refresh_token,
        user_id: tokenData.user_id,
        public_key: tokenData.public_key,
        connected_at: new Date(),
      },
      updatedAt: new Date(),
    }, { merge: true });

    return NextResponse.json({
      success: true,
      email: tokenData.email || null,
    });
  } catch (error) {
    console.error("Error conectando MP:", error);
    return NextResponse.json(
      { error: "Error al conectar cuenta" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/manufacturers/mp-disconnect/route.ts">
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { db } from "../../../../lib/firebase-admin";
import { FieldValue } from "firebase-admin/firestore";

export async function POST() {
  try {
    const userId = cookies().get("userId")?.value;

    if (!userId) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    await db.collection("manufacturers").doc(userId).update({
      mercadopago: FieldValue.delete(),
      updatedAt: new Date(),
    });

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error("Error desconectando MP:", error);
    return NextResponse.json(
      { error: "Error al desvincular" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/manufacturers/mp-status-public/route.ts">
import { NextResponse } from "next/server";
import { db } from "../../../../lib/firebase-admin";

export async function GET(req: Request) {
  try {
    const { searchParams } = new URL(req.url);
    const factoryId = searchParams.get("factoryId");

    if (!factoryId) {
      return NextResponse.json({ error: "factoryId requerido" }, { status: 400 });
    }

    const snap = await db.collection("manufacturers").doc(factoryId).get();

    if (!snap.exists) {
      return NextResponse.json({ connected: false });
    }

    const data = snap.data()!;
    const mpData = data.mercadopago;

    return NextResponse.json({
      connected: !!mpData?.access_token,
    });
  } catch (error) {
    console.error("Error verificando estado MP:", error);
    return NextResponse.json({ connected: false }, { status: 500 });
  }
}
</file>

<file path="app/api/manufacturers/mp-status/route.ts">
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { db } from "../../../../lib/firebase-admin";

export async function GET() {
  try {
    const userId = cookies().get("userId")?.value;

    if (!userId) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    const snap = await db.collection("manufacturers").doc(userId).get();

    if (!snap.exists) {
      return NextResponse.json({ connected: false });
    }

    const data = snap.data()!;
    const mpData = data.mercadopago;

    return NextResponse.json({
      connected: !!mpData?.access_token,
      email: mpData?.email || null,
    });
  } catch (error) {
    console.error("Error verificando estado MP:", error);
    return NextResponse.json(
      { error: "Error al verificar estado" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/manufacturers/profile/route.ts">
// app/api/manufacturers/profile/route.ts

import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { db } from "../../../../lib/firebase-admin";
import { FieldValue } from "firebase-admin/firestore";

/* ===============================
   GET ‚Üí OBTENER PERFIL COMPLETO
================================ */
export async function GET() {
  try {
    const userId = cookies().get("userId")?.value;

    if (!userId) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    const snap = await db
      .collection("manufacturers")
      .doc(userId)
      .get();

    if (!snap.exists) {
      return NextResponse.json({
        address: null,
        businessName: "",
        phone: "",
        email: "",
        schedule: null,
        profileImageUrl: "",
      });
    }

    const data = snap.data();

    return NextResponse.json({
      address: data?.address ?? null,
      businessName: data?.businessName ?? "",
      phone: data?.phone ?? "",
      email: data?.email ?? "",
      schedule: data?.schedule ?? null,
      profileImageUrl: data?.profileImageUrl ?? "",
    });
  } catch (error) {
    console.error("‚ùå Get profile:", error);
    return NextResponse.json(
      { error: "Error obteniendo perfil" },
      { status: 500 }
    );
  }
}

/* ===============================
   POST ‚Üí GUARDAR PERFIL COMPLETO
================================ */
export async function POST(req: Request) {
  try {
    const userId = cookies().get("userId")?.value;

    if (!userId) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    const body = await req.json();
    const {
      address,
      businessName,
      phone,
      email,
      schedule,
      profileImageUrl,
    } = body;

    // ‚úÖ Validaciones
    if (
      !address ||
      !address.formattedAddress ||
      typeof address.lat !== "number" ||
      typeof address.lng !== "number"
    ) {
      return NextResponse.json(
        { error: "Direcci√≥n inv√°lida" },
        { status: 400 }
      );
    }

    if (!businessName || typeof businessName !== "string") {
      return NextResponse.json(
        { error: "Nombre de empresa obligatorio" },
        { status: 400 }
      );
    }

    // ‚úÖ Guardar todo junto
    await db
      .collection("manufacturers")
      .doc(userId)
      .set(
        {
          address,
          businessName,
          phone: phone || null,
          email: email || null,
          schedule: schedule || null,
          profileImageUrl: profileImageUrl || null,
          updatedAt: FieldValue.serverTimestamp(),
        },
        { merge: true }
      );

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error("‚ùå Save profile:", error);
    return NextResponse.json(
      { error: "Error guardando perfil" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/manufacturers/verification/status/route.ts">
// app/api/manufacturers/verification/status/route.ts

import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { db } from "../../../../../lib/firebase-admin";

export async function GET() {
  try {
    const userId = cookies().get("userId")?.value;

    if (!userId) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    // Obtener info del fabricante
    const manufacturerSnap = await db
      .collection("manufacturers")
      .doc(userId)
      .get();

    if (!manufacturerSnap.exists) {
      return NextResponse.json({
        status: 'unverified',
        cuit: "",
        legalName: "",
        businessAddress: "",
      });
    }

    const data = manufacturerSnap.data();

    return NextResponse.json({
      status: data?.verification?.status || 'unverified',
      cuit: data?.verification?.cuit || "",
      legalName: data?.verification?.legalName || "",
      businessAddress: data?.verification?.businessAddress || "",
      verifiedAt: data?.verification?.verifiedAt?.toDate()?.toISOString() || null,
      rejectionReason: data?.verification?.rejectionReason || "",
    });

  } catch (error) {
    console.error("‚ùå Get verification status:", error);
    return NextResponse.json(
      { error: "Error obteniendo estado" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/manufacturers/verification/submit/route.ts">
// app/api/manufacturers/verification/submit/route.ts

import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { db } from "../../../../../lib/firebase-admin";
import { FieldValue } from "firebase-admin/firestore";

export async function POST(req: Request) {
  try {
    const userId = cookies().get("userId")?.value;

    if (!userId) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    const formData = await req.formData();
    
    // üßæ 1Ô∏è‚É£ Datos de la empresa
    const legalName = formData.get('legalName') as string;
    const cuit = formData.get('cuit') as string;
    const taxType = formData.get('taxType') as string;
    const fantasyName = formData.get('fantasyName') as string;

    // üìç 2Ô∏è‚É£ Direcci√≥n
    const street = formData.get('street') as string;
    const city = formData.get('city') as string;
    const province = formData.get('province') as string;
    const postalCode = formData.get('postalCode') as string;
    const lat = parseFloat(formData.get('lat') as string);
    const lng = parseFloat(formData.get('lng') as string);

    // üë§ 3Ô∏è‚É£ Responsable
    const contactName = formData.get('contactName') as string;
    const contactPhone = formData.get('contactPhone') as string;
    const contactEmail = formData.get('contactEmail') as string;

    // üìÇ 5Ô∏è‚É£ Documentaci√≥n
    const afipDoc = formData.get('afipDoc') as File;

    // ‚úÖ Validaciones b√°sicas
    if (!legalName || !cuit || !street || !city || !province || !postalCode) {
      return NextResponse.json(
        { error: "Datos de empresa incompletos" },
        { status: 400 }
      );
    }

    const cleanCuit = cuit.replace(/\D/g, '');
    if (cleanCuit.length !== 11) {
      return NextResponse.json(
        { error: "CUIT inv√°lido" },
        { status: 400 }
      );
    }

    if (!contactName || !contactPhone || !contactEmail) {
      return NextResponse.json(
        { error: "Datos de contacto incompletos" },
        { status: 400 }
      );
    }

    if (!afipDoc) {
      return NextResponse.json(
        { error: "Falta la constancia de AFIP" },
        { status: 400 }
      );
    }

    if (afipDoc.size > 5 * 1024 * 1024) {
      return NextResponse.json(
        { error: "Archivo demasiado grande (m√°x 5MB)" },
        { status: 400 }
      );
    }

    // TODO: Subir archivo a Firebase Storage
    // const afipUrl = await uploadToStorage(afipDoc, userId);
    const afipUrl = `pending-upload/${userId}/afip-${Date.now()}.pdf`; // Placeholder

    // üíæ Crear solicitud completa
    const verificationRequest = {
      manufacturerId: userId,
      
      // Empresa
      legalName,
      cuit: cleanCuit,
      taxType,
      fantasyName: fantasyName || null,
      
      // Direcci√≥n
      address: {
        street,
        city,
        province,
        postalCode,
        lat,
        lng,
        formatted: `${street}, ${city}, ${province}, ${postalCode}`,
      },
      
      // Contacto
      contact: {
        name: contactName,
        phone: contactPhone,
        email: contactEmail,
      },
      
      // Documentos
      documents: {
        afip: {
          url: afipUrl,
          fileName: afipDoc.name,
          size: afipDoc.size,
          uploadedAt: new Date(),
        },
      },
      
      // Estado
      status: 'pending',
      submittedAt: FieldValue.serverTimestamp(),
      createdAt: FieldValue.serverTimestamp(),
      updatedAt: FieldValue.serverTimestamp(),
    };

    // Guardar solicitud
    await db.collection('verification_requests').add(verificationRequest);

    // Actualizar estado en perfil del fabricante
    await db
      .collection('manufacturers')
      .doc(userId)
      .set(
        {
          verification: {
            status: 'pending',
            legalName,
            cuit: cleanCuit,
            taxType,
            fantasyName: fantasyName || null,
            street,
            city,
            province,
            postalCode,
            contactName,
            contactPhone,
            contactEmail,
            submittedAt: FieldValue.serverTimestamp(),
          },
          updatedAt: FieldValue.serverTimestamp(),
        },
        { merge: true }
      );

    // TODO: Notificar a admins
    console.log(`‚úÖ Nueva solicitud de verificaci√≥n: ${legalName} (${userId})`);

    return NextResponse.json({
      success: true,
      message: "Solicitud enviada correctamente",
    });

  } catch (error) {
    console.error("‚ùå Submit verification:", error);
    return NextResponse.json(
      { error: "Error al enviar solicitud" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/payments/fraccionado/create/route.ts">
import { NextResponse } from "next/server";
import { createPreference } from "../../../../../lib/mercadopago";
import { cookies } from "next/headers";
import rateLimit from "../../../../../lib/rate-limit"; // ‚úÖ NUEVO

// ‚úÖ NUEVO: Crear el limitador
const limiter = rateLimit({
  interval: 60 * 1000, // 1 minuto
  uniqueTokenPerInterval: 500,
});

export async function POST(req: Request) {
  // ‚úÖ NUEVO: Verificar rate limit
  const ip = req.headers.get('x-forwarded-for') || 
             req.headers.get('x-real-ip') || 
             'unknown';
  
  try {
    await limiter.check(10, ip); // M√°ximo 10 compras fraccionadas por minuto
  } catch {
    return NextResponse.json(
      { error: "Demasiados intentos. Por favor, espera un minuto." },
      { status: 429 }
    );
  }

  try {
    const body = await req.json();

    const { productId, qty, mode } = body;

    if (!productId || !qty || qty <= 0) {
      return NextResponse.json(
        { error: "Datos inv√°lidos" },
        { status: 400 }
      );
    }

    // üîç Retailer desde cookie
    const retailerId = cookies().get("userId")?.value;

    if (!retailerId) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    const withShipping = mode === "envio";

    /* ===============================
       MERCADO PAGO PREFERENCE
    =============================== */
    const preference = await createPreference({
      title: "Compra fraccionada",
      unit_price: 1, // üí° el monto real se calcula luego
      quantity: 1,
      metadata: {
        productId,
        qty,
        tipo: "fraccionada", // ‚úÖ CLAVE (YA EXISTE EN EL TIPO)
        withShipping,
      },
      back_urls: {
        success:
          process.env.NEXT_PUBLIC_BASE_URL + "/success",
        pending:
          process.env.NEXT_PUBLIC_BASE_URL + "/pending",
        failure:
          process.env.NEXT_PUBLIC_BASE_URL + "/failure",
      },
    });

    if (!preference.init_point) {
      throw new Error("No se pudo crear preferencia");
    }

    return NextResponse.json({
      init_point: preference.init_point,
    });
  } catch (error) {
    console.error("‚ùå FRACCIONADO CREATE ERROR:", error);

    return NextResponse.json(
      { error: "Error creando compra fraccionada" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/products/create/route.ts">
import { NextResponse } from "next/server";
import { requireRole } from "../../../../lib/auth/requireRole";
import { validateShippingConfig } from "../../../../lib/shipping/validateShippingConfig";
import { db } from "../../../../lib/firebase-admin";
import { FieldValue } from "firebase-admin/firestore";
import rateLimit from "../../../../lib/rate-limit";

// ‚úÖ Crear el limitador
const limiter = rateLimit({
  interval: 60 * 1000, // 1 minuto
  uniqueTokenPerInterval: 500,
});

export async function POST(req: Request) {
  // ‚úÖ Verificar rate limit
  const ip = req.headers.get('x-forwarded-for') || 
             req.headers.get('x-real-ip') || 
             'unknown';
  
  try {
    await limiter.check(5, ip); // M√°ximo 5 productos por minuto
  } catch {
    return NextResponse.json(
      { error: "Demasiados intentos. Por favor, espera un minuto." },
      { status: 429 }
    );
  }

  try {
    /* ===============================
       üîí SOLO FABRICANTES
    =============================== */
    const factoryId = await requireRole("manufacturer");

    const body = await req.json();

    /* ===============================
       üì¶ VALIDACIONES B√ÅSICAS
    =============================== */

    if (!body.name || typeof body.name !== "string") {
      return NextResponse.json(
        { error: "Nombre de producto inv√°lido" },
        { status: 400 }
      );
    }

    if (typeof body.price !== "number" || body.price <= 0) {
      return NextResponse.json(
        { error: "Precio inv√°lido" },
        { status: 400 }
      );
    }

    if (
      typeof body.minimumOrder !== "number" ||
      body.minimumOrder <= 0
    ) {
      return NextResponse.json(
        { error: "Pedido m√≠nimo inv√°lido" },
        { status: 400 }
      );
    }

    /* ===============================
       üí∞ GANANCIA NETA (INFORMATIVA)
    =============================== */

    if (
      typeof body.netProfitPerUnit !== "number" ||
      body.netProfitPerUnit < 0
    ) {
      return NextResponse.json(
        { error: "Ganancia neta inv√°lida" },
        { status: 400 }
      );
    }

    /* ===============================
       üöö VALIDACI√ìN DE SHIPPING
    =============================== */

    if (!body.shipping) {
      return NextResponse.json(
        { error: "Falta configuraci√≥n de env√≠o" },
        { status: 400 }
      );
    }

    validateShippingConfig(body.shipping);

    /* ===============================
       üíæ GUARDAR PRODUCTO
       üÜï AHORA INCLUYE isIntermediary
    =============================== */

    const productRef = await db.collection("products").add({
      factoryId, // üîí siempre desde cookie / rol

      name: body.name,
      price: body.price,
      minimumOrder: body.minimumOrder,

      // üí∞ solo informativo
      netProfitPerUnit: body.netProfitPerUnit,

      // üöö reglas de env√≠o
      shipping: body.shipping,

      // ‚≠ê destacados
      featured: false,
      featuredUntil: null,

      // üìä estado
      active: true,

      // üÜï NUEVO: Por defecto NO es intermediario
      // Solo el admin podr√° cambiarlo despu√©s
      isIntermediary: false,

      createdAt: FieldValue.serverTimestamp(),
      updatedAt: FieldValue.serverTimestamp(),
    });

    return NextResponse.json({
      success: true,
      productId: productRef.id,
    });
  } catch (error: any) {
    console.error("‚ùå CREATE PRODUCT ERROR:", error);

    /* ===============================
       ‚ö†Ô∏è ERROR CONTROLADO
    =============================== */
    return NextResponse.json(
      { error: error?.message ?? "Error al crear producto" },
      { status: 400 }
    );
  }
}
</file>

<file path="app/api/products/delete/route.ts">
// app/api/products/delete/route.ts
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { db } from "../../../../lib/firebase-admin";

export async function POST(req: Request) {
  try {
    const userId = cookies().get("userId")?.value;
    const role = cookies().get("activeRole")?.value;

    if (!userId || role !== "manufacturer") {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    const { productId } = await req.json();

    if (!productId) {
      return NextResponse.json(
        { error: "productId requerido" },
        { status: 400 }
      );
    }

    // Verificar que el producto pertenece al fabricante
    const productRef = db.collection("products").doc(productId);
    const productSnap = await productRef.get();

    if (!productSnap.exists) {
      return NextResponse.json(
        { error: "Producto no encontrado" },
        { status: 404 }
      );
    }

    const productData = productSnap.data()!;

    if (productData.factoryId !== userId) {
      return NextResponse.json(
        { error: "Este producto no te pertenece" },
        { status: 403 }
      );
    }

    // Verificar si hay pedidos activos asociados
    const activeLots = await db
      .collection("lots")
      .where("productId", "==", productId)
      .where("status", "==", "accumulating")
      .get();

    if (!activeLots.empty) {
      return NextResponse.json(
        { error: "No se puede borrar. Hay pedidos fraccionados activos para este producto" },
        { status: 400 }
      );
    }

    // Borrar el producto
    await productRef.delete();

    return NextResponse.json({
      success: true,
      message: "Producto eliminado correctamente",
    });

  } catch (error) {
    console.error("‚ùå Error borrando producto:", error);
    return NextResponse.json(
      { error: "Error al borrar producto" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/products/explore/route.ts">
import { NextResponse } from "next/server";
import { getAdminServices } from "../../../../lib/firebase-admin";

export async function GET() {
  try {
    const { adminDb } = await getAdminServices();

    const snap = await adminDb
      .collection("products")
      .where("active", "==", true)
      .get();

    const products = snap.docs.map((doc) => {
      const data = doc.data();

      return {
        id: doc.id,
        name: data.name,
        price: data.price,
        minimumOrder: data.minimumOrder,
        category: data.category || "otros",
        factoryId: data.factoryId,
        shippingMethods: data.shipping?.methods ?? [],
      };
    });

    return NextResponse.json({ products });
  } catch (err) {
    console.error("‚ùå EXPLORE PRODUCTS ERROR:", err);
    return NextResponse.json(
      { error: "Error al cargar productos" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/products/my-products/route.ts">
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { db } from "../../../../lib/firebase-admin";

export async function GET() {
  try {
    const userId = cookies().get("userId")?.value;
    const role = cookies().get("activeRole")?.value;

    if (!userId) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    if (role !== "manufacturer") {
      return NextResponse.json(
        { error: "Solo fabricantes pueden acceder a esta ruta" },
        { status: 403 }
      );
    }

    const snapshot = await db
      .collection("products")
      .where("factoryId", "==", userId)
      .orderBy("createdAt", "desc")
      .get();

    const products = snapshot.docs.map((doc) => {
      const data = doc.data();

      return {
        id: doc.id,
        name: data.name,
        price: data.price,
        minimumOrder: data.minimumOrder,
        category: data.category || "otros",
        active: data.active !== false,
        featured: data.featured || false,
        featuredUntil: data.featuredUntil?.toDate()?.toISOString() || null,
        createdAt: data.createdAt?.toDate()?.toISOString() || null,
      };
    });

    return NextResponse.json({
      success: true,
      count: products.length,
      products,
    });

  } catch (error) {
    console.error("‚ùå MY PRODUCTS ERROR:", error);
    return NextResponse.json(
      { error: "Error al obtener productos" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/retailers/address/route.ts">
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { db } from "../../../../lib/firebase-admin";

/* ===============================
   GET ‚Üí OBTENER DIRECCI√ìN
================================ */
export async function GET() {
  const userId = cookies().get("userId")?.value;

  if (!userId) {
    return NextResponse.json(
      { error: "No autorizado" },
      { status: 401 }
    );
  }

  const snap = await db
    .collection("retailers")
    .doc(userId)
    .get();

  if (!snap.exists) {
    return NextResponse.json({ address: null });
  }

  return NextResponse.json({
    address: snap.data()?.address || null,
  });
}

/* ===============================
   POST ‚Üí GUARDAR DIRECCI√ìN
================================ */
export async function POST(req: Request) {
  const userId = cookies().get("userId")?.value;

  if (!userId) {
    return NextResponse.json(
      { error: "No autorizado" },
      { status: 401 }
    );
  }

  const body = await req.json();
  const { formattedAddress, lat, lng } = body;

  if (
    !formattedAddress ||
    typeof lat !== "number" ||
    typeof lng !== "number"
  ) {
    return NextResponse.json(
      { error: "Datos inv√°lidos" },
      { status: 400 }
    );
  }

  await db
    .collection("retailers")
    .doc(userId)
    .set(
      {
        address: {
          formattedAddress,
          lat,
          lng,
        },
        updatedAt: new Date(),
      },
      { merge: true }
    );

  return NextResponse.json({ success: true });
}
</file>

<file path="app/api/test/route.ts">
export async function GET() {
  return new Response("OK");
}
</file>

<file path="app/dashboard/fabricante/destacados/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { FeaturedDuration, FEATURED_PRICES } from "../../../../lib/types/featured";
// 1. Importaci√≥n del componente
import BackButton from "../../../../components/BackButton"; 

type Product = {
  id: string;
  name: string;
  featured: boolean;
  featuredUntil?: string;
};

type Factory = {
  id: string;
  name: string;
};

export default function DestacadosPage() {
  const [products, setProducts] = useState<Product[]>([]);
  const [factory, setFactory] = useState<Factory | null>(null);
  const [loading, setLoading] = useState(true);
  
  const [selectedType, setSelectedType] = useState<"product" | "factory">("product");
  const [selectedItemId, setSelectedItemId] = useState("");
  const [selectedDuration, setSelectedDuration] = useState<FeaturedDuration>(7);
  
  const [loadingPayment, setLoadingPayment] = useState(false);
  const [error, setError] = useState("");

  // ‚úÖ Cargar productos del fabricante
  useEffect(() => {
    async function loadProducts() {
      try {
        setLoading(true);
        
        // Obtener info del usuario
        const meRes = await fetch("/api/auth/me");
        if (!meRes.ok) {
          throw new Error("No autorizado");
        }
        
        const { userId } = await meRes.json();
        setFactory({ id: userId, name: "Mi F√°brica" });

        // ‚úÖ Obtener productos del fabricante
        const productsRes = await fetch("/api/products/my-products");
        
        if (!productsRes.ok) {
          throw new Error("Error al cargar productos");
        }
        
        const data = await productsRes.json();
        
        console.log("üì¶ Productos recibidos:", data); // Debug
        
        if (data.products && Array.isArray(data.products)) {
          setProducts(data.products);
        } else {
          console.warn("‚ö†Ô∏è No se recibieron productos en el formato esperado");
          setProducts([]);
        }
        
      } catch (err) {
        console.error("‚ùå Error cargando datos:", err);
        setError("Error al cargar tus productos");
      } finally {
        setLoading(false);
      }
    }

    loadProducts();
  }, []);

  async function handleCreateFeatured() {
    if (!selectedItemId) {
      setError("Seleccion√° un item para destacar");
      return;
    }

    setLoadingPayment(true);
    setError("");

    try {
      const res = await fetch("/api/featured/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: selectedType,
          itemId: selectedItemId,
          duration: selectedDuration,
        }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || "Error al crear destacado");
      }

      const data = await res.json();

      // Redirigir a Mercado Pago
      if (data.init_point) {
        window.location.href = data.init_point;
      }

    } catch (err: any) {
      setError(err.message);
    } finally {
      setLoadingPayment(false);
    }
  }

  const price = FEATURED_PRICES[selectedDuration];

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-4xl mx-auto p-8">
        
        {/* 2. Componente BackButton agregado */}
        <BackButton className="mb-6" />

        <h1 className="text-3xl font-semibold mb-2">
          Destacar en el Home
        </h1>
        <p className="text-gray-600 mb-8">
          Aument√° la visibilidad de tus productos o f√°brica en la p√°gina principal
        </p>

        {/* INFORMACI√ìN DE SLOTS */}
        <div className="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8">
          <h2 className="font-semibold text-lg mb-3">
            üìä Informaci√≥n de espacios disponibles
          </h2>
          <ul className="space-y-2 text-sm text-gray-700">
            <li>‚Ä¢ <strong>10 espacios</strong> para productos destacados</li>
            <li>‚Ä¢ <strong>10 espacios</strong> para f√°bricas destacadas</li>
            <li>‚Ä¢ Los espacios se asignan por orden de llegada</li>
            <li>‚Ä¢ Cuando vence tu destacado, se libera el espacio</li>
          </ul>
        </div>

        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-xl mb-6">
            {error}
          </div>
        )}

        {/* FORMULARIO */}
        <div className="bg-white rounded-xl shadow p-8">
          
          {/* Tipo */}
          <div className="mb-6">
            <label className="block font-medium mb-3">
              ¬øQu√© quer√©s destacar?
            </label>
            <div className="grid grid-cols-2 gap-4">
              <button
                onClick={() => {
                  setSelectedType("product");
                  setSelectedItemId("");
                }}
                className={`p-4 rounded-xl border-2 transition ${
                  selectedType === "product"
                    ? "border-blue-600 bg-blue-50"
                    : "border-gray-200 hover:border-gray-300"
                }`}
              >
                <div className="text-3xl mb-2">üì¶</div>
                <div className="font-semibold">Un Producto</div>
                <div className="text-xs text-gray-500 mt-1">
                  Aparecer√° en la secci√≥n de productos destacados
                </div>
              </button>

              <button
                onClick={() => {
                  setSelectedType("factory");
                  setSelectedItemId(factory?.id || "");
                }}
                className={`p-4 rounded-xl border-2 transition ${
                  selectedType === "factory"
                    ? "border-blue-600 bg-blue-50"
                    : "border-gray-200 hover:border-gray-300"
                }`}
              >
                <div className="text-3xl mb-2">üè≠</div>
                <div className="font-semibold">Mi F√°brica</div>
                <div className="text-xs text-gray-500 mt-1">
                  Aparecer√° en la secci√≥n de f√°bricas destacadas
                </div>
              </button>
            </div>
          </div>

          {/* Selecci√≥n de producto (solo si type = product) */}
          {selectedType === "product" && (
            <div className="mb-6">
              <label className="block font-medium mb-2">
                Seleccion√° el producto
              </label>
              
              {loading ? (
                <div className="text-sm text-gray-500">Cargando productos...</div>
              ) : products.length === 0 ? (
                <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg text-sm">
                  <p className="font-medium mb-1">No ten√©s productos creados</p>
                  <p>Primero deb√©s crear al menos un producto en la secci√≥n "Productos"</p>
                </div>
              ) : (
                <>
                  <select
                    className="w-full border rounded-lg px-4 py-3"
                    value={selectedItemId}
                    onChange={(e) => setSelectedItemId(e.target.value)}
                  >
                    <option value="">-- Eleg√≠ un producto --</option>
                    {products.map((p) => (
                      <option key={p.id} value={p.id}>
                        {p.name} {p.featured && "(ya destacado)"}
                      </option>
                    ))}
                  </select>
                  <p className="text-xs text-gray-500 mt-2">
                    Total de productos: {products.length}
                  </p>
                </>
              )}
            </div>
          )}

          {/* Duraci√≥n */}
          <div className="mb-6">
            <label className="block font-medium mb-3">
              Duraci√≥n
            </label>
            <div className="grid grid-cols-3 gap-4">
              {([7, 15, 30] as FeaturedDuration[]).map((days) => (
                <button
                  key={days}
                  onClick={() => setSelectedDuration(days)}
                  className={`p-4 rounded-xl border-2 transition ${
                    selectedDuration === days
                      ? "border-blue-600 bg-blue-50"
                      : "border-gray-200 hover:border-gray-300"
                  }`}
                >
                  <div className="font-semibold text-lg">{days} d√≠as</div>
                  <div className="text-sm text-gray-600 mt-1">
                    ${FEATURED_PRICES[days].toLocaleString("es-AR")}
                  </div>
                </button>
              ))}
            </div>
          </div>

          {/* Resumen */}
          <div className="bg-gray-50 rounded-xl p-6 mb-6">
            <h3 className="font-semibold mb-3">Resumen</h3>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-600">Tipo:</span>
                <span className="font-medium">
                  {selectedType === "product" ? "Producto" : "F√°brica"}
                </span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">Duraci√≥n:</span>
                <span className="font-medium">{selectedDuration} d√≠as</span>
              </div>
              <div className="flex justify-between text-lg font-semibold border-t pt-2 mt-2">
                <span>Total a pagar:</span>
                <span className="text-blue-600">
                  ${price.toLocaleString("es-AR")}
                </span>
              </div>
            </div>
          </div>

          {/* Bot√≥n */}
          <button
            onClick={handleCreateFeatured}
            disabled={loadingPayment || !selectedItemId || (selectedType === "product" && products.length === 0)}
            className="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loadingPayment ? "Procesando..." : "Continuar al pago"}
          </button>

        </div>

        {/* DESTACADOS ACTIVOS */}
        <div className="mt-12">
          <h2 className="text-2xl font-semibold mb-6">
            Mis destacados activos
          </h2>
          
          <div className="bg-white rounded-xl shadow p-6">
            <p className="text-gray-500 text-sm">
              Aqu√≠ aparecer√°n tus productos o f√°brica cuando est√©n destacados
            </p>
          </div>
        </div>

      </div>
    </div>
  );
}
</file>

<file path="app/dashboard/fabricante/layout.tsx">
import FabricanteSidebar from "../../../components/FabricanteSidebar";

export default function FabricanteLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="flex min-h-screen bg-gray-100">
      <FabricanteSidebar />
      <main className="flex-1 p-8">{children}</main>
    </div>
  );
}
</file>

<file path="app/dashboard/fabricante/page.tsx">
import { db } from "../../../lib/firebase-admin";
import { cookies } from "next/headers";
import Link from "next/link";
import ActiveRoleBadge from "../../../components/ActiveRoleBadge";
import SwitchRoleButton from "../../../components/SwitchRoleButton";
import { formatCurrency } from "../../../lib/utils";
import { Suspense } from "react"; // ‚úÖ NUEVO
import { DashboardSkeleton } from "../../../components/DashboardSkeleton"; // ‚úÖ NUEVO

// ‚úÖ NUEVO: Separar contenido en funci√≥n async
async function DashboardFabricanteContent() {
  const userId = cookies().get("userId")?.value;
  const role = cookies().get("activeRole")?.value;

  if (!userId || role !== "manufacturer") {
    return <div className="p-6">No autorizado</div>;
  }

  /* ===============================
     üí≥ PEDIDOS CERRADOS
  =============================== */
  const ordersSnap = await db
    .collection("payments")
    .where("factoryId", "==", userId)
    .where("lotStatus", "==", "closed")
    .orderBy("createdAt", "desc")
    .get();

  const orders = ordersSnap.docs.map((doc) => {
    const o = doc.data();

    const qty = o.qty || 0;
    const netProfitPerUnit = o.netProfitPerUnit || 0;

    return {
      id: doc.id,
      productId: o.productId || "-",
      productName: o.productName || "Producto",
      qty,
      netProfitPerUnit,
      netProfit: qty * netProfitPerUnit, // üëà GANANCIA REAL
      total:
        (o.totalProductPrice || 0) +
        (o.shippingIncome || 0),
      createdAt: o.createdAt
        ? o.createdAt.toDate().toLocaleDateString("es-AR")
        : "-",
    };
  });

  /* ===============================
     üìä M√âTRICAS
  =============================== */
  // ‚úÖ Ingresos totales (producto + env√≠o que recibe el fabricante)
  const ingresosTotales = orders.reduce(
    (acc, o) => acc + (o.total || 0),
    0
  );

  // ‚úÖ Ganancia neta REAL del fabricante (SOLO informativo)
  const gananciaNeta = orders.reduce(
    (acc, o) => acc + (o.netProfit || 0),
    0
  );

  const pedidosTotales = orders.length;

  /* ===============================
     üßæ UI - ‚úÖ FIX ERROR 21: formatCurrency
  =============================== */
  return (
    <div className="min-h-screen bg-gray-50">
      <div className="p-8 max-w-7xl mx-auto">

        {/* HEADER */}
        <div className="flex justify-between items-start mb-12">
          <div>
            <h1 className="text-3xl font-semibold text-gray-900">
              Panel del fabricante
            </h1>
            <p className="text-gray-500 mt-1">
              Resumen general de tu actividad y tus ingresos
            </p>
          </div>

          <div className="flex items-center gap-4">
            <ActiveRoleBadge />
            <SwitchRoleButton targetRole="retailer" />
          </div>
        </div>

        {/* KPIs */}
        <div className="grid md:grid-cols-4 gap-6 mb-14">

          {/* GANANCIA */}
          <div className="md:col-span-2 bg-white rounded-2xl shadow p-8 border-l-4 border-green-500">
            <p className="text-sm text-gray-500 mb-1">
              Ganancia real
            </p>
            <p className="text-4xl font-bold text-green-600">
              {formatCurrency(gananciaNeta)}
            </p>
            <p className="text-xs text-green-700 mt-1">
              Beneficio neto del fabricante
            </p>
          </div>

          {/* INGRESOS */}
          <div className="bg-white rounded-2xl shadow p-6">
            <p className="text-sm text-gray-500">
              Ingresos totales
            </p>
            <p className="text-2xl font-semibold mt-2">
              {formatCurrency(ingresosTotales)}
            </p>
          </div>

          {/* PEDIDOS */}
          <div className="bg-white rounded-2xl shadow p-6">
            <p className="text-sm text-gray-500">
              Pedidos cerrados
            </p>
            <p className="text-2xl font-semibold mt-2">
              {pedidosTotales}
            </p>
          </div>
        </div>

        {/* PEDIDOS RECIENTES */}
        <div className="bg-white rounded-2xl shadow p-8 mb-14">
          <h2 className="text-xl font-semibold mb-6">
            Pedidos recientes
          </h2>

          {orders.length === 0 ? (
            <p className="text-gray-500">
              Todav√≠a no recibiste pedidos.
            </p>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-gray-500 border-b">
                    <th className="pb-3 text-left">Producto</th>
                    <th className="pb-3 text-left">ID producto</th>
                    <th className="pb-3 text-left">Cantidad</th>
                    <th className="pb-3 text-left">Fecha</th>
                    <th className="pb-3 text-right">Total</th>
                  </tr>
                </thead>
                <tbody>
                  {orders.map((o) => (
                    <tr
                      key={o.id}
                      className="border-b last:border-0 hover:bg-gray-50"
                    >
                      <td className="py-4 font-medium">
                        {o.productName}
                      </td>
                      <td className="text-xs text-gray-500">
                        {o.productId}
                      </td>
                      <td>{o.qty}</td>
                      <td>{o.createdAt}</td>
                      <td className="text-right font-semibold">
                        {formatCurrency(o.total)}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>

        {/* ACCIONES */}
        <div className="grid md:grid-cols-2 gap-6">
          <Link
            href="/dashboard/fabricante/productos/nuevo"
            className="bg-white p-8 rounded-2xl shadow hover:shadow-lg transition border border-dashed border-gray-300 hover:border-blue-500"
          >
            <h2 className="text-xl font-semibold mb-2">
              Publicar nuevo producto
            </h2>
            <p className="text-gray-600 mb-4">
              Agreg√° un nuevo producto para vender a revendedores
            </p>
            <span className="text-blue-600 font-medium">
              Crear producto ‚Üí
            </span>
          </Link>

          <Link
            href="/dashboard/fabricante/destacados"
            className="bg-white p-8 rounded-2xl shadow hover:shadow-lg transition"
          >
            <h2 className="text-xl font-semibold mb-2">
              Productos destacados
            </h2>
            <p className="text-gray-600 mb-4">
              Aument√° la visibilidad de tus productos
            </p>
            <span className="text-blue-600 font-medium">
              Gestionar destacados ‚Üí
            </span>
          </Link>
        </div>

      </div>
    </div>
  );
}

// ‚úÖ NUEVO: P√°gina principal con Suspense
export default function DashboardFabricante() {
  return (
    <Suspense fallback={<DashboardSkeleton />}>
      <DashboardFabricanteContent />
    </Suspense>
  );
}
</file>

<file path="app/dashboard/fabricante/pedidos/page.tsx">
import BackButton from "../../../../components/BackButton";

export default function PedidosFabricantePage() {
  return (
    <div>
      <BackButton className="mb-4" />
      
      <h1 className="text-2xl font-semibold mb-6">
        Pedidos de tus productos
      </h1>

      <p className="text-gray-600">
        No ten√©s pedidos todav√≠a.
      </p>
    </div>
  );
}
</file>

<file path="app/dashboard/fabricante/perfil/page.tsx">
// app/dashboard/fabricante/perfil/page.tsx
"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";

type DaySchedule = {
  open: string;
  close: string;
  closed: boolean;
};

type WeekSchedule = {
  monday: DaySchedule;
  tuesday: DaySchedule;
  wednesday: DaySchedule;
  thursday: DaySchedule;
  friday: DaySchedule;
  saturday: DaySchedule;
  sunday: DaySchedule;
};

const DEFAULT_SCHEDULE: WeekSchedule = {
  monday: { open: '09:00', close: '18:00', closed: false },
  tuesday: { open: '09:00', close: '18:00', closed: false },
  wednesday: { open: '09:00', close: '18:00', closed: false },
  thursday: { open: '09:00', close: '18:00', closed: false },
  friday: { open: '09:00', close: '18:00', closed: false },
  saturday: { open: '00:00', close: '00:00', closed: true },
  sunday: { open: '00:00', close: '00:00', closed: true },
};

export default function PerfilFabricantePage() {
  const router = useRouter();
  
  const [formattedAddress, setFormattedAddress] = useState("");
  const [lat, setLat] = useState("");
  const [lng, setLng] = useState("");
  
  const [businessName, setBusinessName] = useState("");
  const [phone, setPhone] = useState("");
  const [email, setEmail] = useState("");
  const [schedule, setSchedule] = useState<WeekSchedule>(DEFAULT_SCHEDULE);
  const [profileImage, setProfileImage] = useState<File | null>(null);
  const [profileImageUrl, setProfileImageUrl] = useState("");

  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Estados para verificaci√≥n
  const [verificationStatus, setVerificationStatus] = useState<string | null>(null);
  
  // Estados para Mercado Pago
  const [mpConnected, setMpConnected] = useState<boolean | null>(null);
  const [mpEmail, setMpEmail] = useState("");

  /* ===============================
     üî• CARGAR DATOS EXISTENTES
  =============================== */
  useEffect(() => {
    async function loadProfile() {
      try {
        const res = await fetch("/api/manufacturers/profile");
        if (!res.ok) return;

        const data = await res.json();

        if (data.address) {
          setFormattedAddress(data.address.formattedAddress || "");
          setLat(data.address.lat !== undefined ? String(data.address.lat) : "");
          setLng(data.address.lng !== undefined ? String(data.address.lng) : "");
        }

        setBusinessName(data.businessName || "");
        setPhone(data.phone || "");
        setEmail(data.email || "");
        setProfileImageUrl(data.profileImageUrl || "");
        
        if (data.schedule) {
          setSchedule(data.schedule);
        }
      } catch (err) {
        console.error("Error cargando perfil", err);
      }
    }

    async function loadVerificationStatus() {
      try {
        const res = await fetch("/api/manufacturers/verification/status");
        if (res.ok) {
          const data = await res.json();
          setVerificationStatus(data.status || 'unverified');
        }
      } catch (error) {
        console.error("Error verificando estado:", error);
      }
    }

    async function loadMPStatus() {
      try {
        const res = await fetch("/api/manufacturers/mp-status");
        if (res.ok) {
          const data = await res.json();
          setMpConnected(data.connected);
          setMpEmail(data.email || '');
        }
      } catch (error) {
        console.error("Error verificando MP:", error);
      }
    }

    loadProfile();
    loadVerificationStatus();
    loadMPStatus();
  }, []);

  /* ===============================
     üíæ GUARDAR PERFIL
  =============================== */
  async function handleSave() {
    setLoading(true);
    setError(null);
    setSuccess(false);

    if (!formattedAddress || !lat || !lng) {
      setError("Complet√° todos los campos de direcci√≥n");
      setLoading(false);
      return;
    }

    if (!businessName) {
      setError("El nombre de la empresa es obligatorio");
      setLoading(false);
      return;
    }

    try {
      let imageUrl = profileImageUrl;
      
      if (profileImage) {
        console.log("üî∏ Imagen seleccionada (upload pendiente):", profileImage.name);
      }

      const res = await fetch("/api/manufacturers/profile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          address: {
            formattedAddress,
            lat: Number(lat),
            lng: Number(lng),
          },
          businessName,
          phone,
          email,
          schedule,
          profileImageUrl: imageUrl,
        }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || "Error al guardar");
      }

      setSuccess(true);
      setTimeout(() => setSuccess(false), 3000);
    } catch (err: any) {
      setError(err.message || "Error al guardar perfil");
    } finally {
      setLoading(false);
    }
  }

  /* ===============================
     üïê ACTUALIZAR HORARIO DE UN D√çA
  =============================== */
  function updateDaySchedule(day: keyof WeekSchedule, updates: Partial<DaySchedule>) {
    setSchedule(prev => ({
      ...prev,
      [day]: { ...prev[day], ...updates }
    }));
  }

  /* ===============================
     üé® RENDERIZAR EDITOR DE HORARIOS
  =============================== */
  const days: { key: keyof WeekSchedule; label: string }[] = [
    { key: 'monday', label: 'Lunes' },
    { key: 'tuesday', label: 'Martes' },
    { key: 'wednesday', label: 'Mi√©rcoles' },
    { key: 'thursday', label: 'Jueves' },
    { key: 'friday', label: 'Viernes' },
    { key: 'saturday', label: 'S√°bado' },
    { key: 'sunday', label: 'Domingo' },
  ];

  return (
    <div className="max-w-3xl mx-auto">
      {/* BOT√ìN VOLVER */}
      <button
        onClick={() => router.back()}
        className="mb-4 text-blue-600 hover:text-blue-700 flex items-center gap-2 font-medium"
      >
        ‚Üê Volver
      </button>

      <h1 className="text-2xl font-semibold mb-6">
        Configuraci√≥n del perfil
      </h1>

      <p className="text-gray-600 mb-8">
        Esta informaci√≥n aparecer√° en tus productos y ser√° visible para los revendedores.
      </p>

      {/* MENSAJES */}
      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded mb-6">
          {error}
        </div>
      )}

      {success && (
        <div className="bg-green-50 border border-green-200 text-green-700 p-4 rounded mb-6">
          ‚úÖ Perfil guardado correctamente
        </div>
      )}

      {/* INFORMACI√ìN B√ÅSICA */}
      <div className="bg-white rounded-xl shadow p-6 mb-6">
        <h2 className="font-semibold text-lg mb-4">üè¢ Informaci√≥n b√°sica</h2>

        <div className="mb-4">
          <label className="block text-sm mb-1 font-medium">
            Nombre de la empresa *
          </label>
          <input
            type="text"
            value={businessName}
            onChange={(e) => setBusinessName(e.target.value)}
            className="w-full border rounded px-3 py-2"
            placeholder="Ej: F√°brica de Zapatillas XYZ"
          />
        </div>

        <div className="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label className="block text-sm mb-1 font-medium">Tel√©fono</label>
            <input
              type="tel"
              value={phone}
              onChange={(e) => setPhone(e.target.value)}
              className="w-full border rounded px-3 py-2"
              placeholder="1123456789"
            />
          </div>

          <div>
            <label className="block text-sm mb-1 font-medium">Email</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full border rounded px-3 py-2"
              placeholder="contacto@empresa.com"
            />
          </div>
        </div>

        <div>
          <label className="block text-sm mb-1 font-medium">
            Foto de perfil
          </label>
          {profileImageUrl && (
            <img 
              src={profileImageUrl} 
              alt="Perfil actual" 
              className="w-24 h-24 rounded-full object-cover mb-2"
            />
          )}
          <input
            type="file"
            accept="image/*"
            onChange={(e) => setProfileImage(e.target.files?.[0] || null)}
            className="text-sm"
          />
          <p className="text-xs text-gray-500 mt-1">
            Recomendado: imagen cuadrada, m√≠nimo 200x200px
          </p>
        </div>

        {/* ‚úÖ VERIFICACI√ìN EN PERFIL */}
        <div className="mt-6 pt-6 border-t">
          <h3 className="font-semibold text-sm mb-3 flex items-center gap-2">
            {verificationStatus === 'verified' ? '‚úì' : 
             verificationStatus === 'pending' ? '‚è≥' : 
             verificationStatus === 'rejected' ? '‚úï' : 'üè¢'}
            Verificaci√≥n de empresa
          </h3>
          
          {verificationStatus === 'verified' && (
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
              <p className="text-sm text-blue-800 font-medium">
                ‚úì Tu empresa est√° verificada
              </p>
            </div>
          )}

          {verificationStatus === 'pending' && (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
              <p className="text-sm text-yellow-800 font-medium">
                ‚è≥ Verificaci√≥n en proceso
              </p>
              <p className="text-xs text-yellow-700 mt-1">
                Tu solicitud est√° siendo revisada
              </p>
            </div>
          )}

          {verificationStatus === 'rejected' && (
            <div className="bg-red-50 border border-red-200 rounded-lg p-3 mb-2">
              <p className="text-sm text-red-800 font-medium mb-2">
                ‚úï Verificaci√≥n rechazada
              </p>
              <Link
                href="/dashboard/fabricante/verificacion"
                className="text-sm text-red-600 hover:underline"
              >
                Ver motivo y corregir ‚Üí
              </Link>
            </div>
          )}

          {verificationStatus === 'unverified' && (
            <div className="bg-gray-50 border border-gray-200 rounded-lg p-3">
              <p className="text-sm text-gray-700 mb-2">
                Verific√° tu empresa para generar m√°s confianza
              </p>
              <Link
                href="/dashboard/fabricante/verificacion"
                className="inline-block text-sm bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
              >
                Iniciar verificaci√≥n ‚Üí
              </Link>
            </div>
          )}
        </div>
      </div>

      {/* DIRECCI√ìN */}
      <div className="bg-white rounded-xl shadow p-6 mb-6">
        <h2 className="font-semibold text-lg mb-4">üìç Direcci√≥n de la f√°brica</h2>

        <div className="mb-4">
          <label className="block text-sm mb-1 font-medium">Direcci√≥n *</label>
          <input
            type="text"
            value={formattedAddress}
            onChange={(e) => setFormattedAddress(e.target.value)}
            className="w-full border rounded px-3 py-2"
            placeholder="Ej: Av. Siempre Viva 123, Buenos Aires"
          />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm mb-1 font-medium">Latitud *</label>
            <input
              type="number"
              value={lat}
              onChange={(e) => setLat(e.target.value)}
              className="w-full border rounded px-3 py-2"
              placeholder="-34.6037"
              step="any"
            />
          </div>

          <div>
            <label className="block text-sm mb-1 font-medium">Longitud *</label>
            <input
              type="number"
              value={lng}
              onChange={(e) => setLng(e.target.value)}
              className="w-full border rounded px-3 py-2"
              placeholder="-58.3816"
              step="any"
            />
          </div>
        </div>
      </div>

      {/* HORARIOS DE ATENCI√ìN */}
      <div className="bg-white rounded-xl shadow p-6 mb-6">
        <h2 className="font-semibold text-lg mb-4">üìÖ Horarios de atenci√≥n</h2>
        <p className="text-sm text-gray-600 mb-4">
          Configur√° los d√≠as y horarios en los que los revendedores pueden retirar mercader√≠a.
        </p>

        <div className="space-y-3">
          {days.map(day => {
            const daySchedule = schedule[day.key];
            
            return (
              <div key={day.key} className="flex items-center gap-4">
                <div className="w-28">
                  <span className="text-sm font-medium">{day.label}</span>
                </div>

                <label className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    checked={!daySchedule.closed}
                    onChange={(e) => updateDaySchedule(day.key, { closed: !e.target.checked })}
                  />
                  <span className="text-sm">Abierto</span>
                </label>

                {!daySchedule.closed && (
                  <>
                    <input
                      type="time"
                      value={daySchedule.open}
                      onChange={(e) => updateDaySchedule(day.key, { open: e.target.value })}
                      className="border rounded px-3 py-1 text-sm"
                    />
                    <span className="text-sm">a</span>
                    <input
                      type="time"
                      value={daySchedule.close}
                      onChange={(e) => updateDaySchedule(day.key, { close: e.target.value })}
                      className="border rounded px-3 py-1 text-sm"
                    />
                  </>
                )}
              </div>
            );
          })}
        </div>
      </div>

      {/* ‚úÖ MERCADO PAGO EN PERFIL */}
      <div className="bg-white rounded-xl shadow p-6 mb-6">
        <h2 className="font-semibold text-lg mb-4">üí≥ Mercado Pago</h2>
        
        {mpConnected === true && (
          <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
            <div className="flex items-center justify-between mb-2">
              <p className="text-sm text-green-800 font-medium">
                ‚úì Cuenta vinculada
              </p>
              <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                Activa
              </span>
            </div>
            {mpEmail && (
              <p className="text-sm text-green-700">{mpEmail}</p>
            )}
          </div>
        )}

        {mpConnected === false && (
          <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
            <p className="text-sm text-orange-800 font-medium mb-2">
              ‚ö†Ô∏è Cuenta no vinculada
            </p>
            <p className="text-sm text-orange-700 mb-3">
              Vincul√° tu Mercado Pago para recibir pagos directamente
            </p>
          </div>
        )}

        <Link
          href="/dashboard/fabricante/vinculacion-mp"
          className="inline-block text-sm bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition mt-3"
        >
          {mpConnected ? 'Gestionar vinculaci√≥n' : 'Vincular Mercado Pago'} ‚Üí
        </Link>
      </div>

      {/* BOT√ìN GUARDAR */}
      <button
        onClick={handleSave}
        disabled={loading}
        className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition disabled:opacity-50"
      >
        {loading ? "Guardando..." : "Guardar perfil"}
      </button>
    </div>
  );
}
</file>

<file path="app/dashboard/fabricante/productos/nuevo/page.tsx">
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { ProductCategory, CATEGORY_LABELS } from "../../../../../lib/types/product";

/* ===============================
   üõ°Ô∏è FUNCIONES DE SANITIZACI√ìN
=============================== */
function sanitizeText(text: string, maxLength: number = 100): string {
  return text.trim().substring(0, maxLength);
}

function sanitizeNumber(value: number | "", min: number = 0, max: number = 1000000): number | "" {
  if (value === "") return "";
  const num = Number(value);
  if (!Number.isFinite(num)) return "";
  return Math.max(min, Math.min(max, num));
}

export default function NuevoProductoPage() {
  const router = useRouter();

  /* ===============================
     üì¶ DATOS B√ÅSICOS
  =============================== */
  const [name, setName] = useState("");
  const [price, setPrice] = useState<number | "">("");
  const [minimumOrder, setMinimumOrder] = useState<number | "">("");
  const [netProfitPerUnit, setNetProfitPerUnit] = useState<number | "">("");
  
  // ‚úÖ NUEVO: Categor√≠a
  const [category, setCategory] = useState<ProductCategory>("otros");

  /* ===============================
     üöö M√âTODOS DE ENV√çO
  =============================== */
  const [factoryPickup, setFactoryPickup] = useState(false);
  const [ownLogistics, setOwnLogistics] = useState(false);
  const [thirdParty, setThirdParty] = useState(false);

  /* ===============================
     üöö ENV√çO PROPIO
  =============================== */
  const [ownType, setOwnType] =
    useState<"per_km" | "zones" | "geographic" | "">("");

  // Precio por km
  const [pricePerKm, setPricePerKm] = useState<number | "">("");

  // Zonas por distancia
  const [zones, setZones] = useState({
    z1: "",
    z2: "",
    z3: "",
  });

  // Zonas geogr√°ficas
  const [geoPrices, setGeoPrices] = useState({
    caba: "",
    amba: "",
    interior: "",
  });

  // Env√≠o por terceros
  const [thirdPartyPrice, setThirdPartyPrice] =
    useState<number | "">("");

  /* ===============================
     ‚ö†Ô∏è UI
  =============================== */
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  /* ===============================
     üíæ SUBMIT CON VALIDACI√ìN REFORZADA
  =============================== */
  async function handleSubmit() {
    setError(null);

    // ‚úÖ SANITIZACI√ìN DE NOMBRE
    const sanitizedName = sanitizeText(name, 100);
    
    if (sanitizedName.length < 3) {
      setError("El nombre debe tener al menos 3 caracteres");
      return;
    }

    // ‚úÖ VALIDACI√ìN DE PRECIO
    if (price === "" || price <= 0) {
      setError("Ingres√° un precio v√°lido");
      return;
    }

    // ‚úÖ VALIDACI√ìN DE PEDIDO M√çNIMO
    if (minimumOrder === "" || minimumOrder <= 0) {
      setError("Ingres√° un pedido m√≠nimo v√°lido");
      return;
    }

    // ‚úÖ VALIDACI√ìN DE GANANCIA NETA
    if (netProfitPerUnit === "" || netProfitPerUnit < 0) {
      setError("Ingres√° una ganancia neta v√°lida (0 o mayor)");
      return;
    }

    // ‚úÖ VALIDACI√ìN DE M√âTODOS DE ENV√çO
    if (!factoryPickup && !ownLogistics && !thirdParty) {
      setError("Eleg√≠ al menos un m√©todo de env√≠o");
      return;
    }

    if (ownLogistics && !ownType) {
      setError("Seleccion√° c√≥mo calcular el env√≠o propio");
      return;
    }

    // ‚úÖ VALIDACIONES ESPEC√çFICAS DE ENV√çO PROPIO
    if (ownLogistics && ownType === "per_km") {
      if (pricePerKm === "" || pricePerKm <= 0) {
        setError("Ingres√° un precio por kil√≥metro v√°lido");
        return;
      }
    }

    if (ownLogistics && ownType === "zones") {
      if (!zones.z1 || !zones.z2 || !zones.z3) {
        setError("Complet√° los precios de las 3 zonas");
        return;
      }
      const z1 = Number(zones.z1);
      const z2 = Number(zones.z2);
      const z3 = Number(zones.z3);
      if (z1 <= 0 || z2 <= 0 || z3 <= 0) {
        setError("Los precios de zonas deben ser mayores a 0");
        return;
      }
    }

    if (ownLogistics && ownType === "geographic") {
      if (!geoPrices.caba || !geoPrices.amba || !geoPrices.interior) {
        setError("Complet√° los precios de las 3 regiones geogr√°ficas");
        return;
      }
      const caba = Number(geoPrices.caba);
      const amba = Number(geoPrices.amba);
      const interior = Number(geoPrices.interior);
      if (caba <= 0 || amba <= 0 || interior <= 0) {
        setError("Los precios geogr√°ficos deben ser mayores a 0");
        return;
      }
    }

    // ‚úÖ VALIDACI√ìN DE TERCEROS
    if (thirdParty) {
      if (thirdPartyPrice === "" || thirdPartyPrice <= 0) {
        setError("Ingres√° un precio de env√≠o por terceros v√°lido");
        return;
      }
    }

    /* ===============================
       üì¶ ARMADO SHIPPING
    =============================== */
    const shipping: any = { methods: [] };

    if (factoryPickup) {
      shipping.methods.push("factory_pickup");
    }

    if (ownLogistics) {
      shipping.methods.push("own_logistics");

      if (ownType === "per_km") {
        shipping.ownLogistics = {
          type: "per_km",
          pricePerKm: Number(pricePerKm),
        };
      }

      if (ownType === "zones") {
        shipping.ownLogistics = {
          type: "zones",
          zones: {
            z1: Number(zones.z1),
            z2: Number(zones.z2),
            z3: Number(zones.z3),
          },
        };
      }

      if (ownType === "geographic") {
        shipping.ownLogistics = {
          type: "geographic",
          areas: {
            caba: Number(geoPrices.caba),
            amba: Number(geoPrices.amba),
            interior: Number(geoPrices.interior),
          },
        };
      }
    }

    if (thirdParty) {
      shipping.methods.push("third_party");
      shipping.thirdParty = {
        fixedPrice: Number(thirdPartyPrice),
      };
    }

    /* ===============================
       üöÄ API CON DATOS SANITIZADOS
    =============================== */
    setLoading(true);

    const res = await fetch("/api/products/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name: sanitizedName,
        price: Number(price),
        minimumOrder: Number(minimumOrder),
        netProfitPerUnit: Number(netProfitPerUnit),
        category, // ‚úÖ NUEVO
        shipping,
      }),
    });

    setLoading(false);

    if (res.ok) {
      router.push("/dashboard/fabricante/productos");
    } else {
      const data = await res.json();
      setError(data.error || "Error al crear producto");
    }
  }

  /* ===============================
     üßæ UI
  =============================== */
  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-2xl mx-auto p-8">
        <h1 className="text-3xl font-semibold mb-6">
          Nuevo producto
        </h1>

        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded mb-6">
            {error}
          </div>
        )}

        {/* DATOS B√ÅSICOS */}
        <div className="bg-white rounded-xl shadow p-6 mb-6 space-y-4">
          <h2 className="font-semibold text-lg mb-4">Informaci√≥n b√°sica</h2>

          <div>
            <label className="block text-sm mb-1">Nombre del producto</label>
            <input
              placeholder="Ej: Zapatillas deportivas"
              className="w-full border rounded px-3 py-2"
              value={name}
              onChange={(e) => setName(e.target.value)}
              maxLength={100}
            />
          </div>

          {/* ‚úÖ NUEVO: Categor√≠a */}
          <div>
            <label className="block text-sm mb-1">Categor√≠a</label>
            <select
              className="w-full border rounded px-3 py-2"
              value={category}
              onChange={(e) => setCategory(e.target.value as ProductCategory)}
            >
              {Object.entries(CATEGORY_LABELS).map(([value, label]) => (
                <option key={value} value={value}>
                  {label}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm mb-1">Precio unitario</label>
            <input
              type="number"
              placeholder="1000"
              className="w-full border rounded px-3 py-2"
              value={price}
              onChange={(e) => setPrice(Number(e.target.value))}
              min={0}
            />
          </div>

          <div>
            <label className="block text-sm mb-1">Pedido m√≠nimo</label>
            <input
              type="number"
              placeholder="50"
              className="w-full border rounded px-3 py-2"
              value={minimumOrder}
              onChange={(e) =>
                setMinimumOrder(Number(e.target.value))
              }
              min={1}
            />
          </div>

          <div>
            <label className="block text-sm mb-1">Ganancia neta por unidad (informativa)</label>
            <input
              type="number"
              placeholder="200"
              className="w-full border rounded px-3 py-2"
              value={netProfitPerUnit}
              onChange={(e) =>
                setNetProfitPerUnit(Number(e.target.value))
              }
              min={0}
            />
          </div>
        </div>

        {/* ENV√çOS */}
        <div className="bg-white rounded-xl shadow p-6 mb-8 space-y-3">
          <h2 className="font-semibold mb-2">
            M√©todos de env√≠o
          </h2>

          <label className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={factoryPickup}
              onChange={(e) =>
                setFactoryPickup(e.target.checked)
              }
            />
            <span>Retiro en f√°brica (gratis)</span>
          </label>

          <label className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={ownLogistics}
              onChange={(e) =>
                setOwnLogistics(e.target.checked)
              }
            />
            <span>Env√≠o propio</span>
          </label>

          {ownLogistics && (
            <div className="ml-6 space-y-2 border-l-2 pl-4">
              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  checked={ownType === "per_km"}
                  onChange={() => setOwnType("per_km")}
                />
                <span>Por kil√≥metro</span>
              </label>

              {ownType === "per_km" && (
                <input
                  type="number"
                  placeholder="Precio por km"
                  className="border rounded px-3 py-2 w-48"
                  value={pricePerKm}
                  onChange={(e) =>
                    setPricePerKm(Number(e.target.value))
                  }
                  min={0}
                />
              )}

              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  checked={ownType === "zones"}
                  onChange={() => setOwnType("zones")}
                />
                <span>Por zonas de distancia</span>
              </label>

              {ownType === "zones" && (
                <div className="grid grid-cols-3 gap-2">
                  <input
                    placeholder="Z1 (0‚Äì10 km)"
                    className="border px-2 py-1"
                    onChange={(e) =>
                      setZones({
                        ...zones,
                        z1: e.target.value,
                      })
                    }
                  />
                  <input
                    placeholder="Z2 (10‚Äì30 km)"
                    className="border px-2 py-1"
                    onChange={(e) =>
                      setZones({
                        ...zones,
                        z2: e.target.value,
                      })
                    }
                  />
                  <input
                    placeholder="Z3 (+30 km)"
                    className="border px-2 py-1"
                    onChange={(e) =>
                      setZones({
                        ...zones,
                        z3: e.target.value,
                      })
                    }
                  />
                </div>
              )}

              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  checked={ownType === "geographic"}
                  onChange={() =>
                    setOwnType("geographic")
                  }
                />
                <span>Por zonas geogr√°ficas</span>
              </label>

              {ownType === "geographic" && (
                <div className="grid grid-cols-3 gap-2">
                  <input
                    placeholder="CABA"
                    className="border px-2 py-1"
                    onChange={(e) =>
                      setGeoPrices({
                        ...geoPrices,
                        caba: e.target.value,
                      })
                    }
                  />
                  <input
                    placeholder="AMBA"
                    className="border px-2 py-1"
                    onChange={(e) =>
                      setGeoPrices({
                        ...geoPrices,
                        amba: e.target.value,
                      })
                    }
                  />
                  <input
                    placeholder="Interior"
                    className="border px-2 py-1"
                    onChange={(e) =>
                      setGeoPrices({
                        ...geoPrices,
                        interior: e.target.value,
                      })
                    }
                  />
                </div>
              )}
            </div>
          )}

          <label className="flex items-center gap-2">
            <input
              type="checkbox"
              checked={thirdParty}
              onChange={(e) =>
                setThirdParty(e.target.checked)
              }
            />
            <span>Env√≠o por terceros</span>
          </label>

          {thirdParty && (
            <input
              type="number"
              placeholder="Precio fijo terceros"
              className="border rounded px-3 py-2 w-64 ml-6"
              value={thirdPartyPrice}
              onChange={(e) =>
                setThirdPartyPrice(Number(e.target.value))
              }
              min={0}
            />
          )}
        </div>

        <button
          onClick={handleSubmit}
          disabled={loading}
          className="w-full bg-blue-600 text-white py-3 rounded-xl disabled:opacity-50 hover:bg-blue-700 transition"
        >
          {loading ? "Creando producto..." : "Crear producto"}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="app/dashboard/fabricante/productos/page.tsx">
"use client";

import Link from "next/link";
import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
// 1. Importaci√≥n del componente agregada al inicio
import BackButton from "../../../../components/BackButton"; 

type Product = {
  id: string;
  name: string;
  price: number;
  minimumOrder: number;
  category: string;
  featured: boolean;
  active: boolean;
};

export default function ProductosFabricantePage() {
  const router = useRouter();
  const [products, setProducts] = useState<Product[]>([]);
  const [loading, setLoading] = useState(true);
  const [deletingId, setDeletingId] = useState<string | null>(null);

  useEffect(() => {
    loadProducts();
  }, []);

  async function loadProducts() {
    try {
      const res = await fetch("/api/products/my-products");
      if (res.ok) {
        const data = await res.json();
        setProducts(data.products || []);
      }
    } catch (error) {
      console.error("Error cargando productos:", error);
    } finally {
      setLoading(false);
    }
  }

  async function handleDelete(productId: string, productName: string) {
    if (!confirm(`¬øEst√°s seguro que quer√©s eliminar "${productName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
      return;
    }

    setDeletingId(productId);

    try {
      const res = await fetch("/api/products/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productId }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || "Error al eliminar producto");
      }

      await loadProducts();
      alert("Producto eliminado correctamente");
    } catch (error: any) {
      alert(error.message || "Error al eliminar producto");
    } finally {
      setDeletingId(null);
    }
  }

  if (loading) {
    return (
      <div className="p-8 max-w-6xl mx-auto">
        <p className="text-gray-600">Cargando productos...</p>
      </div>
    );
  }

  return (
    <div className="p-8 max-w-6xl mx-auto">
      
      {/* 2. Reemplazo del bot√≥n anterior por el componente BackButton */}
      <BackButton className="mb-4" />

      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-semibold">Mis productos</h1>
        
        <Link
          href="/dashboard/fabricante/productos/nuevo"
          className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-medium"
        >
          ‚ûï A√±adir producto
        </Link>
      </div>

      {products.length === 0 && (
        <div className="bg-white rounded-xl shadow p-12 text-center">
          <p className="text-gray-500 mb-4">Todav√≠a no publicaste productos.</p>
          <Link
            href="/dashboard/fabricante/productos/nuevo"
            className="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition"
          >
            Crear primer producto
          </Link>
        </div>
      )}

      <div className="grid md:grid-cols-3 gap-6">
        {products.map((p) => (
          <div
            key={p.id}
            className="bg-white p-6 rounded-xl shadow hover:shadow-lg transition relative"
          >
            {p.featured && (
              <span className="absolute top-4 right-4 inline-block text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-medium">
                ‚≠ê Destacado
              </span>
            )}

            <h3 className="font-semibold text-lg mb-3 pr-16">{p.name}</h3>

            <div className="space-y-2 mb-4">
              <p className="text-sm text-gray-600">
                <span className="font-medium">Precio:</span> ${p.price.toLocaleString('es-AR')}
              </p>
              <p className="text-sm text-gray-600">
                <span className="font-medium">M√≠nimo:</span> {p.minimumOrder} unidades
              </p>
              <p className="text-sm text-gray-600">
                <span className="font-medium">Categor√≠a:</span> {p.category}
              </p>
            </div>

            <button
              onClick={() => handleDelete(p.id, p.name)}
              disabled={deletingId === p.id}
              className="w-full border-2 border-red-500 text-red-600 py-2 rounded-lg hover:bg-red-50 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {deletingId === p.id ? "Eliminando..." : "üóëÔ∏è Eliminar producto"}
            </button>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="app/dashboard/fabricante/verificacion/page.tsx">
"use client";

import { useState, useEffect } from "react";
// 1Ô∏è‚É£ Importaci√≥n agregada
import BackButton from "../../../../components/BackButton"; 

type VerificationStatus = 'unverified' | 'pending' | 'verified' | 'rejected';

export default function VerificacionPage() {
  const [status, setStatus] = useState<VerificationStatus>('unverified');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [success, setSuccess] = useState(false);

  // üßæ 1Ô∏è‚É£ Datos de la empresa
  const [legalName, setLegalName] = useState("");
  const [cuit, setCuit] = useState("");
  const [taxType, setTaxType] = useState<"monotributo" | "responsable_inscripto" | "sociedad">("monotributo");
  const [fantasyName, setFantasyName] = useState("");

  // üìç 2Ô∏è‚É£ Direcci√≥n
  const [street, setStreet] = useState("");
  const [city, setCity] = useState("");
  const [province, setProvince] = useState("");
  const [postalCode, setPostalCode] = useState("");
  const [lat, setLat] = useState<number | null>(null);
  const [lng, setLng] = useState<number | null>(null);

  // üë§ 3Ô∏è‚É£ Responsable
  const [contactName, setContactName] = useState("");
  const [contactPhone, setContactPhone] = useState("");
  const [contactEmail, setContactEmail] = useState("");

  // üìÇ 5Ô∏è‚É£ Documentaci√≥n
  const [afipDoc, setAfipDoc] = useState<File | null>(null);

  // üîê 7Ô∏è‚É£ Confirmaciones
  const [confirmTruth, setConfirmTruth] = useState(false);
  const [confirmAuthorization, setConfirmAuthorization] = useState(false);

  const [rejectionReason, setRejectionReason] = useState("");

  // Cargar estado actual
  useEffect(() => {
    async function loadStatus() {
      try {
        const res = await fetch("/api/manufacturers/verification/status");
        if (res.ok) {
          const data = await res.json();
          setStatus(data.status || 'unverified');
          
          if (data.legalName) setLegalName(data.legalName);
          if (data.cuit) setCuit(data.cuit);
          if (data.taxType) setTaxType(data.taxType);
          if (data.fantasyName) setFantasyName(data.fantasyName);
          if (data.street) setStreet(data.street);
          if (data.city) setCity(data.city);
          if (data.province) setProvince(data.province);
          if (data.postalCode) setPostalCode(data.postalCode);
          if (data.contactName) setContactName(data.contactName);
          if (data.contactPhone) setContactPhone(data.contactPhone);
          if (data.contactEmail) setContactEmail(data.contactEmail);
          if (data.rejectionReason) setRejectionReason(data.rejectionReason);
        }
      } catch (err) {
        console.error("Error cargando estado:", err);
      }
    }
    loadStatus();
  }, []);

  // Geocodificar direcci√≥n (simulado - usar Google Maps API en prod)
  async function geocodeAddress() {
    const fullAddress = `${street}, ${city}, ${province}, ${postalCode}`;
    setLat(-34.6037);
    setLng(-58.3816);
  }

  useEffect(() => {
    if (street && city && province && postalCode) {
      geocodeAddress();
    }
  }, [street, city, province, postalCode]);

  async function handleSubmit() {
    setLoading(true);
    setError("");
    setSuccess(false);

    if (!legalName || !cuit || !street || !city || !province || !postalCode) {
      setError("Complet√° todos los campos obligatorios");
      setLoading(false);
      return;
    }

    if (cuit.replace(/\D/g, '').length !== 11) {
      setError("CUIT inv√°lido (debe tener 11 d√≠gitos)");
      setLoading(false);
      return;
    }

    if (!contactName || !contactPhone || !contactEmail) {
      setError("Complet√° los datos del responsable de contacto");
      setLoading(false);
      return;
    }

    if (!afipDoc) {
      setError("Deb√©s subir la constancia de AFIP");
      setLoading(false);
      return;
    }

    if (afipDoc.size > 5 * 1024 * 1024) {
      setError("El archivo es demasiado grande (m√°x 5MB)");
      setLoading(false);
      return;
    }

    if (!confirmTruth || !confirmAuthorization) {
      setError("Deb√©s aceptar las confirmaciones finales");
      setLoading(false);
      return;
    }

    try {
      const formData = new FormData();
      formData.append('legalName', legalName);
      formData.append('cuit', cuit);
      formData.append('taxType', taxType);
      formData.append('fantasyName', fantasyName);
      formData.append('street', street);
      formData.append('city', city);
      formData.append('province', province);
      formData.append('postalCode', postalCode);
      formData.append('lat', String(lat || 0));
      formData.append('lng', String(lng || 0));
      formData.append('contactName', contactName);
      formData.append('contactPhone', contactPhone);
      formData.append('contactEmail', contactEmail);
      formData.append('afipDoc', afipDoc);

      const res = await fetch("/api/manufacturers/verification/submit", {
        method: "POST",
        body: formData,
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || "Error al enviar solicitud");
      }

      setSuccess(true);
      setStatus('pending');
    } catch (err: any) {
      setError(err.message || "Error al enviar solicitud");
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="max-w-4xl mx-auto pb-12">
      
      {/* 2Ô∏è‚É£ Bot√≥n agregado con margen inferior */}
      <BackButton className="mb-6" />

      <div className="mb-8">
        <h1 className="text-3xl font-semibold mb-2">
          üè¢ Empresa Verificada
        </h1>
        <p className="text-gray-600">
          Verific√° tu empresa para que los revendedores conf√≠en m√°s en tus productos
        </p>
      </div>

      {/* ESTADO INTERNO (solo para el fabricante) */}
      {status === 'verified' && (
        <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-6 mb-8">
          <div className="flex items-center gap-3">
            <div className="bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center text-2xl font-bold">
              ‚úì
            </div>
            <div>
              <h2 className="text-xl font-bold text-blue-900">¬°Tu empresa est√° verificada!</h2>
              <p className="text-blue-700">Los revendedores ver√°n el badge azul de verificaci√≥n en tus productos.</p>
            </div>
          </div>
        </div>
      )}

      {status === 'pending' && (
        <div className="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6 mb-8">
          <div className="flex items-center gap-3">
            <div className="text-4xl">‚è≥</div>
            <div>
              <h2 className="text-xl font-bold text-yellow-900">Solicitud en revisi√≥n</h2>
              <p className="text-yellow-700">Estamos verificando tu documentaci√≥n. Te notificaremos cuando est√© aprobada (24-48hs h√°biles).</p>
            </div>
          </div>
        </div>
      )}

      {status === 'rejected' && rejectionReason && (
        <div className="bg-red-50 border-2 border-red-200 rounded-xl p-6 mb-8">
          <div className="flex items-start gap-3">
            <div className="text-4xl">‚úï</div>
            <div>
              <h2 className="text-xl font-bold text-red-900">Solicitud rechazada</h2>
              <p className="text-red-700 mb-2"><strong>Motivo:</strong> {rejectionReason}</p>
              <p className="text-red-600 text-sm">Pod√©s corregir la informaci√≥n y volver a enviar la solicitud.</p>
            </div>
          </div>
        </div>
      )}

      {/* FORMULARIO (ocultar si est√° verificado) */}
      {status !== 'verified' && (
        <>
          {error && (
            <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-xl mb-6">
              ‚ùå {error}
            </div>
          )}

          {success && (
            <div className="bg-green-50 border border-green-200 text-green-700 p-4 rounded-xl mb-6">
              ‚úÖ Solicitud enviada correctamente. La revisaremos en las pr√≥ximas 24-48hs h√°biles.
            </div>
          )}

          {/* üßæ 1Ô∏è‚É£ DATOS DE LA EMPRESA */}
          <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 className="font-bold text-xl mb-1 flex items-center gap-2">
              üßæ 1Ô∏è‚É£ Datos de la empresa
            </h2>
            <p className="text-sm text-gray-600 mb-6">Informaci√≥n legal y tributaria</p>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-semibold mb-2">
                  Raz√≥n social <span className="text-red-600">*</span>
                </label>
                <input
                  type="text"
                  value={legalName}
                  onChange={(e) => setLegalName(e.target.value)}
                  className="w-full border-2 rounded-lg px-4 py-2.5 focus:border-blue-500 focus:outline-none"
                  placeholder="Ej: F√°brica Textil San Mart√≠n S.R.L."
                />
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2">
                  CUIT <span className="text-red-600">*</span>
                </label>
                <input
                  type="text"
                  value={cuit}
                  onChange={(e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 11) {
                      if (value.length > 2) value = value.slice(0, 2) + '-' + value.slice(2);
                      if (value.length > 11) value = value.slice(0, 11) + '-' + value.slice(11);
                      setCuit(value);
                    }
                  }}
                  className="w-full border-2 rounded-lg px-4 py-2.5 focus:border-blue-500 focus:outline-none"
                  placeholder="30-12345678-9"
                  maxLength={13}
                />
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2">
                  Tipo de contribuyente <span className="text-red-600">*</span>
                </label>
                <div className="space-y-2">
                  <label className="flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50">
                    <input
                      type="radio"
                      name="taxType"
                      checked={taxType === 'monotributo'}
                      onChange={() => setTaxType('monotributo')}
                      className="w-4 h-4"
                    />
                    <span>Monotributo</span>
                  </label>

                  <label className="flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50">
                    <input
                      type="radio"
                      name="taxType"
                      checked={taxType === 'responsable_inscripto'}
                      onChange={() => setTaxType('responsable_inscripto')}
                      className="w-4 h-4"
                    />
                    <span>Responsable Inscripto</span>
                  </label>

                  <label className="flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50">
                    <input
                      type="radio"
                      name="taxType"
                      checked={taxType === 'sociedad'}
                      onChange={() => setTaxType('sociedad')}
                      className="w-4 h-4"
                    />
                    <span>Sociedad (SRL / SA / SAS)</span>
                  </label>
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2">
                  Nombre de fantas√≠a <span className="text-gray-500">(opcional)</span>
                </label>
                <input
                  type="text"
                  value={fantasyName}
                  onChange={(e) => setFantasyName(e.target.value)}
                  className="w-full border-2 rounded-lg px-4 py-2.5 focus:border-blue-500 focus:outline-none"
                  placeholder="Ej: Textil San Mart√≠n"
                />
              </div>
            </div>
          </div>

          {/* üìç 2Ô∏è‚É£ DIRECCI√ìN */}
          <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 className="font-bold text-xl mb-1 flex items-center gap-2">
              üìç 2Ô∏è‚É£ Direcci√≥n de la empresa
            </h2>
            <p className="text-sm text-gray-600 mb-6">Domicilio fiscal y comercial</p>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-semibold mb-2">
                  Calle y n√∫mero <span className="text-red-600">*</span>
                </label>
                <input
                  type="text"
                  value={street}
                  onChange={(e) => setStreet(e.target.value)}
                  className="w-full border-2 rounded-lg px-4 py-2.5 focus:border-blue-500 focus:outline-none"
                  placeholder="Ej: Av. San Mart√≠n 1234"
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold mb-2">
                    Ciudad / Localidad <span className="text-red-600">*</span>
                  </label>
                  <input
                    type="text"
                    value={city}
                    onChange={(e) => setCity(e.target.value)}
                    className="w-full border-2 rounded-lg px-4 py-2.5 focus:border-blue-500 focus:outline-none"
                    placeholder="Ej: Hurlingham"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-2">
                    Provincia <span className="text-red-600">*</span>
                  </label>
                  <input
                    type="text"
                    value={province}
                    onChange={(e) => setProvince(e.target.value)}
                    className="w-full border-2 rounded-lg px-4 py-2.5 focus:border-blue-500 focus:outline-none"
                    placeholder="Ej: Buenos Aires"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2">
                  C√≥digo postal <span className="text-red-600">*</span>
                </label>
                <input
                  type="text"
                  value={postalCode}
                  onChange={(e) => setPostalCode(e.target.value)}
                  className="w-full border-2 rounded-lg px-4 py-2.5 focus:border-blue-500 focus:outline-none"
                  placeholder="Ej: 1686"
                />
              </div>

              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-700">
                üìå Las coordenadas se calculan autom√°ticamente seg√∫n la direcci√≥n ingresada
              </div>
            </div>
          </div>

          {/* üë§ 3Ô∏è‚É£ RESPONSABLE */}
          <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 className="font-bold text-xl mb-1 flex items-center gap-2">
              üë§ 3Ô∏è‚É£ Responsable de contacto
            </h2>
            <p className="text-sm text-gray-600 mb-6">Persona autorizada para validar la informaci√≥n</p>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-semibold mb-2">
                  Nombre y apellido <span className="text-red-600">*</span>
                </label>
                <input
                  type="text"
                  value={contactName}
                  onChange={(e) => setContactName(e.target.value)}
                  className="w-full border-2 rounded-lg px-4 py-2.5 focus:border-blue-500 focus:outline-none"
                  placeholder="Ej: Juan P√©rez"
                />
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2">
                  Tel√©fono de contacto <span className="text-red-600">*</span>
                </label>
                <input
                  type="tel"
                  value={contactPhone}
                  onChange={(e) => setContactPhone(e.target.value)}
                  className="w-full border-2 rounded-lg px-4 py-2.5 focus:border-blue-500 focus:outline-none"
                  placeholder="Ej: +54 9 11 1234-5678"
                />
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2">
                  Email de contacto <span className="text-red-600">*</span>
                </label>
                <input
                  type="email"
                  value={contactEmail}
                  onChange={(e) => setContactEmail(e.target.value)}
                  className="w-full border-2 rounded-lg px-4 py-2.5 focus:border-blue-500 focus:outline-none"
                  placeholder="Ej: ventas@empresa.com"
                />
                <p className="text-xs text-gray-500 mt-1">
                  Se acepta Gmail, pero se recomienda email corporativo
                </p>
              </div>
            </div>
          </div>

          {/* üìÇ 5Ô∏è‚É£ DOCUMENTACI√ìN */}
          <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 className="font-bold text-xl mb-1 flex items-center gap-2">
              üìÇ 5Ô∏è‚É£ Documentaci√≥n fiscal
            </h2>
            <p className="text-sm text-gray-600 mb-6">Archivos necesarios para la verificaci√≥n</p>

            <div>
              <label className="block text-sm font-semibold mb-2">
                Constancia de inscripci√≥n AFIP <span className="text-red-600">*</span>
              </label>

              <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                <input
                  type="file"
                  accept=".pdf,.jpg,.jpeg,.png"
                  onChange={(e) => setAfipDoc(e.target.files?.[0] || null)}
                  className="hidden"
                  id="afip-upload"
                />
                <label
                  htmlFor="afip-upload"
                  className="cursor-pointer"
                >
                  {afipDoc ? (
                    <div className="text-green-600">
                      <div className="text-4xl mb-2">‚úì</div>
                      <p className="font-semibold">{afipDoc.name}</p>
                      <p className="text-xs text-gray-500 mt-1">
                        {(afipDoc.size / 1024 / 1024).toFixed(2)} MB
                      </p>
                    </div>
                  ) : (
                    <div>
                      <div className="text-4xl mb-2">üìé</div>
                      <p className="font-semibold text-blue-600">Subir constancia AFIP</p>
                      <p className="text-xs text-gray-500 mt-1">
                        PDF / JPG / PNG - M√°x 5 MB
                      </p>
                    </div>
                  )}
                </label>
              </div>

              <div className="mt-4 bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm text-gray-700">
                <p className="font-semibold mb-2">‚ÑπÔ∏è El documento debe mostrar:</p>
                <ul className="list-disc list-inside space-y-1">
                  <li>CUIT de la empresa</li>
                  <li>Raz√≥n social</li>
                  <li>Estado activo en AFIP</li>
                </ul>
                <p className="mt-3 text-xs text-gray-600">
                  Esta informaci√≥n es confidencial y no se comparte con terceros.
                </p>
              </div>
            </div>
          </div>

          {/* üîê 7Ô∏è‚É£ CONFIRMACIONES */}
          <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 className="font-bold text-xl mb-1 flex items-center gap-2">
              üîê 7Ô∏è‚É£ Confirmaciones finales
            </h2>
            <p className="text-sm text-gray-600 mb-6">Aceptaci√≥n de t√©rminos y condiciones</p>

            <div className="space-y-4">
              <label className="flex items-start gap-3 p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50">
                <input
                  type="checkbox"
                  checked={confirmTruth}
                  onChange={(e) => setConfirmTruth(e.target.checked)}
                  className="w-5 h-5 mt-0.5"
                />
                <span className="text-sm">
                  Declaro que la informaci√≥n ingresada es real y corresponde a mi empresa
                </span>
              </label>

              <label className="flex items-start gap-3 p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50">
                <input
                  type="checkbox"
                  checked={confirmAuthorization}
                  onChange={(e) => setConfirmAuthorization(e.target.checked)}
                  className="w-5 h-5 mt-0.5"
                />
                <span className="text-sm">
                  Autorizo a la plataforma a verificar estos datos con fines comerciales
                </span>
              </label>
            </div>
          </div>

          {/* BOT√ìN ENVIAR */}
          <button
            onClick={handleSubmit}
            disabled={loading || status === 'pending'}
            className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg"
          >
            {loading ? "Enviando..." : status === 'pending' ? "Solicitud en Revisi√≥n" : "‚úì Enviar Solicitud de Verificaci√≥n"}
          </button>
        </>
      )}
    </div>
  );
}
</file>

<file path="app/dashboard/fabricante/vinculacion-mp/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';

export default function VinculacionMPPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  
  const [loading, setLoading] = useState(false);
  const [mpConnected, setMpConnected] = useState(false);
  const [mpEmail, setMpEmail] = useState('');
  const [error, setError] = useState('');

  // Verificar si ya est√° vinculado
  useEffect(() => {
    checkConnection();
  }, []);

  // Procesar c√≥digo de autorizaci√≥n (cuando vuelve de MP)
  useEffect(() => {
    if (!searchParams) return;
    
    const code = searchParams.get('code');
    const state = searchParams.get('state');
    
    if (code && state) {
      processAuthorization(code);
    }
  }, [searchParams]);

  async function checkConnection() {
    try {
      const res = await fetch('/api/manufacturers/mp-status');
      if (res.ok) {
        const data = await res.json();
        setMpConnected(data.connected);
        setMpEmail(data.email || '');
      }
    } catch (error) {
      console.error('Error verificando conexi√≥n MP:', error);
    }
  }

  async function processAuthorization(code: string) {
    setLoading(true);
    setError('');

    try {
      const res = await fetch('/api/manufacturers/mp-connect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || 'Error al vincular cuenta');
      }

      const data = await res.json();
      setMpConnected(true);
      setMpEmail(data.email || '');

      // Limpiar URL
      router.replace('/dashboard/fabricante/vinculacion-mp');
    } catch (error: any) {
      console.error('Error:', error);
      setError(error.message || 'Error al vincular tu cuenta de Mercado Pago');
    } finally {
      setLoading(false);
    }
  }

  async function handleConnect() {
    setLoading(true);
    setError('');

    try {
      const res = await fetch('/api/manufacturers/mp-auth-url');
      
      if (!res.ok) {
        throw new Error('Error al generar URL de autorizaci√≥n');
      }
      
      const data = await res.json();

      if (data.authUrl) {
        // Redirigir a Mercado Pago
        window.location.href = data.authUrl;
      } else {
        throw new Error('No se pudo generar la URL de autorizaci√≥n');
      }
    } catch (error: any) {
      console.error('Error:', error);
      setError(error.message || 'Error al iniciar vinculaci√≥n');
      setLoading(false);
    }
  }

  async function handleDisconnect() {
    if (!confirm('¬øSeguro que deseas desvincular tu cuenta de Mercado Pago?')) {
      return;
    }

    setLoading(true);

    try {
      const res = await fetch('/api/manufacturers/mp-disconnect', {
        method: 'POST',
      });

      if (res.ok) {
        setMpConnected(false);
        setMpEmail('');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al desvincular cuenta');
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="max-w-3xl mx-auto p-6">
      {/* Bot√≥n Volver agregado */}
      <button 
        onClick={() => router.back()} 
        className="mb-4 text-blue-600 hover:text-blue-700 flex items-center gap-2 font-medium"
      >
        ‚Üê Volver
      </button>

      <h1 className="text-2xl font-semibold mb-6">
        Vinculaci√≥n de Mercado Pago
      </h1>

      {error && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
          <p className="text-red-700">‚ùå {error}</p>
        </div>
      )}

      <div className="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8">
        <h2 className="font-semibold text-lg mb-3">
          ‚ÑπÔ∏è ¬øPor qu√© vincular tu cuenta?
        </h2>
        <ul className="space-y-2 text-sm text-gray-700">
          <li>‚Ä¢ <strong>Recib√≠s pagos directamente</strong> en tu cuenta de Mercado Pago</li>
          <li>‚Ä¢ <strong>Sin intermediarios</strong> - El dinero va directo a vos</li>
          <li>‚Ä¢ <strong>Seguridad garantizada</strong> por Mercado Pago</li>
          <li>‚Ä¢ <strong>Retiros cuando quieras</strong> a tu banco</li>
        </ul>
      </div>

      {!mpConnected ? (
        <div className="bg-white rounded-xl shadow p-8">
          <h2 className="font-semibold text-xl mb-4">
            Vincular Cuenta de Mercado Pago
          </h2>

          <p className="text-gray-600 mb-6">
            Al hacer clic en "Vincular cuenta", ser√°s redirigido a Mercado Pago
            para autorizar que recibas pagos en tu cuenta.
          </p>

          <button
            onClick={handleConnect}
            disabled={loading}
            className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? 'Redirigiendo...' : 'Vincular cuenta de Mercado Pago'}
          </button>

          <p className="text-xs text-gray-500 mt-4 text-center">
            Es necesario tener una cuenta de Mercado Pago.
            Si no ten√©s una, pod√©s crearla gratis en mercadopago.com.ar
          </p>
        </div>
      ) : (
        <div className="bg-white rounded-xl shadow p-8">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h2 className="font-semibold text-xl mb-2">
                ‚úÖ Cuenta Vinculada
              </h2>
              {mpEmail && (
                <p className="text-gray-600">
                  {mpEmail}
                </p>
              )}
            </div>
            <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
              Activa
            </span>
          </div>

          <div className="bg-green-50 border border-green-200 rounded-xl p-4 mb-6">
            <p className="text-sm text-green-800">
              <strong>‚úì Todo listo!</strong> Ya pod√©s recibir pagos directamente en tu cuenta de Mercado Pago.
            </p>
          </div>

          <button
            onClick={handleDisconnect}
            disabled={loading}
            className="w-full border-2 border-red-500 text-red-600 py-3 rounded-xl font-semibold hover:bg-red-50 transition disabled:opacity-50"
          >
            {loading ? 'Procesando...' : 'Desvincular cuenta'}
          </button>
        </div>
      )}
    </div>
  );
}
</file>

<file path="app/dashboard/pedidos-fraccionados/layout.tsx">
import RevendedorSidebar from "../../../components/RevendedorSidebar";

export default function RevendedorLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="flex min-h-screen bg-gray-100">
      <RevendedorSidebar />
      <main className="flex-1 p-8">
        {children}
      </main>
    </div>
  );
}
</file>

<file path="app/dashboard/pedidos-fraccionados/pedidos/page.tsx">
// app/dashboard/pedidos-fraccionados/pedidos/page.tsx

import { db } from "../../../../lib/firebase-admin";
import { cookies } from "next/headers";

type Pedido = {
  id: string;
  productId: string;
  productName: string;
  qty: number;
  orderType: "direct" | "fractional";
  lotType?: "fractional_shipping" | "fractional_pickup";
  status: "accumulating" | "closed" | "completed";
  paymentId: string;
  paymentStatus: string;
  amount: number;
  shippingCost: number; // ‚úÖ Siempre ser√° un n√∫mero (0 si no hay costo)
  total: number;
  createdAt: string;
  createdAtTimestamp: number;
};

async function getRetailerOrders(retailerId: string): Promise<Pedido[]> {
  // ‚úÖ CORRECTO: Usar "retailerId" (como se guarda en el webhook)
  const paymentsSnap = await db
    .collection("payments")
    .where("retailerId", "==", retailerId)
    .get();

  if (paymentsSnap.empty) {
    return [];
  }

  const orders: Pedido[] = [];

  for (const paymentDoc of paymentsSnap.docs) {
    const payment = paymentDoc.data();

    // Obtener informaci√≥n del producto
    const productSnap = await db
      .collection("products")
      .doc(payment.productId)
      .get();

    const product = productSnap.data();

    // Determinar el estado del pedido
    let status: "accumulating" | "closed" | "completed" = "completed";
    
    // Para pedidos fraccionados, verificar el estado del lote
    if (payment.orderType === "fractional" && payment.lotType) {
      const lotSnap = await db
        .collection("lots")
        .where("productId", "==", payment.productId)
        .where("type", "==", payment.lotType)
        .orderBy("createdAt", "desc")
        .limit(1)
        .get();

      status = lotSnap.empty ? "accumulating" : lotSnap.docs[0].data().status;
    }

    // ‚úÖ Usar splitPayment si existe, sino calcular manual
    const splitPayment = payment.splitPayment || {};
    const amount = splitPayment.productTotal || payment.amount || 0;
    const shippingCost = splitPayment.shippingCost || payment.shippingCost || 0; // ‚úÖ Siempre 0 m√≠nimo
    const total = splitPayment.total || amount + shippingCost;

    orders.push({
      id: paymentDoc.id,
      productId: payment.productId,
      productName: product?.name || "Producto desconocido",
      qty: payment.qty,
      orderType: payment.orderType || "direct",
      lotType: payment.lotType,
      status,
      paymentId: payment.preferenceId || paymentDoc.id,
      paymentStatus: payment.status,
      amount,
      shippingCost, // ‚úÖ Garantizado n√∫mero
      total,
      createdAt: payment.createdAt?.toDate().toLocaleDateString("es-AR") || "-",
      createdAtTimestamp: payment.createdAt?.toMillis() || 0,
    });
  }

  // Ordenar por fecha (m√°s recientes primero)
  orders.sort((a, b) => b.createdAtTimestamp - a.createdAtTimestamp);

  return orders;
}

export default async function PedidosPage() {
  const userId = cookies().get("userId")?.value;
  const role = cookies().get("activeRole")?.value;

  if (!userId || role !== "retailer") {
    return (
      <div className="min-h-screen bg-gray-50 p-8">
        <div className="max-w-6xl mx-auto">
          <h1 className="text-3xl font-bold mb-4">No autorizado</h1>
          <p className="text-red-600">
            Debes tener rol de revendedor para acceder a esta p√°gina
          </p>
        </div>
      </div>
    );
  }

  const retailerSnap = await db
    .collection("retailers")
    .doc(userId)
    .get();

  if (!retailerSnap.exists) {
    return (
      <div className="min-h-screen bg-gray-50 p-8">
        <div className="max-w-6xl mx-auto">
          <h1 className="text-3xl font-bold mb-4">Error</h1>
          <p className="text-red-600">
            No se encontr√≥ el perfil de revendedor. Por favor, contacta a soporte.
          </p>
          <p className="text-sm text-gray-500 mt-2">
            User ID: {userId}
          </p>
        </div>
      </div>
    );
  }

  const retailerId = userId;
  const orders = await getRetailerOrders(retailerId);

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-6xl mx-auto p-8">
        
        {/* Header */}
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            Mis Pedidos
          </h1>
          <p className="text-gray-600">
            Historial completo de tus compras
          </p>
        </div>

        {/* Lista de pedidos */}
        {orders.length === 0 ? (
          <div className="bg-white rounded-lg shadow-sm p-8 text-center">
            <p className="text-gray-500 text-lg mb-4">
              No tienes pedidos todav√≠a
            </p>
            <p className="text-gray-400 mb-6">
              Empieza a comprar productos al por mayor
            </p>
            <a
              href="/explorar"
              className="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
            >
              Explorar productos
            </a>
          </div>
        ) : (
          <div className="space-y-4">
            {orders.map((order) => (
              <div
                key={order.id}
                className="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow"
              >
                <div className="flex justify-between items-start mb-4">
                  <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                      <h3 className="text-xl font-semibold text-gray-900">
                        {order.productName}
                      </h3>
                      <span
                        className={`px-2 py-1 rounded text-xs font-medium ${
                          order.orderType === "direct"
                            ? "bg-blue-100 text-blue-800"
                            : "bg-purple-100 text-purple-800"
                        }`}
                      >
                        {order.orderType === "direct" ? "Compra directa" : "Compra fraccionada"}
                      </span>
                    </div>
                    <p className="text-sm text-gray-500">{order.createdAt}</p>
                  </div>
                  
                  <span
                    className={`px-3 py-1 rounded-full text-sm font-medium ${
                      order.status === "completed" || order.status === "closed"
                        ? "bg-green-100 text-green-800"
                        : "bg-yellow-100 text-yellow-800"
                    }`}
                  >
                    {order.status === "completed" || order.status === "closed"
                      ? "Completado"
                      : "En proceso"}
                  </span>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
                  <div>
                    <p className="text-gray-500">Cantidad</p>
                    <p className="font-semibold text-gray-900">{order.qty} unidades</p>
                  </div>

                  <div>
                    <p className="text-gray-500">Modalidad</p>
                    <p className="font-semibold text-gray-900">
                      {order.orderType === "direct"
                        ? "Directa"
                        : order.lotType === "fractional_shipping"
                        ? "Fraccionado con env√≠o"
                        : "Fraccionado retiro"}
                    </p>
                  </div>

                  <div>
                    <p className="text-gray-500">Producto</p>
                    <p className="font-semibold text-gray-900">
                      ${order.amount.toFixed(2)}
                    </p>
                  </div>

                  {order.shippingCost > 0 && (
                    <div>
                      <p className="text-gray-500">Env√≠o</p>
                      <p className="font-semibold text-gray-900">
                        ${order.shippingCost.toFixed(2)}
                      </p>
                    </div>
                  )}
                </div>

                <div className="pt-4 border-t border-gray-200">
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="text-sm text-gray-500">Total pagado</p>
                      <p className="text-lg font-bold text-gray-900">
                        ${order.total.toFixed(2)}
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="text-sm text-gray-500">Estado del pago</p>
                      <p
                        className={`font-semibold ${
                          order.paymentStatus === "approved"
                            ? "text-green-600"
                            : order.paymentStatus === "pending"
                            ? "text-yellow-600"
                            : "text-red-600"
                        }`}
                      >
                        {order.paymentStatus === "approved"
                          ? "Pagado"
                          : order.paymentStatus === "pending"
                          ? "Pendiente"
                          : "Rechazado"}
                      </p>
                    </div>
                  </div>
                </div>

                {/* Mensajes informativos */}
                {order.orderType === "fractional" && order.status === "accumulating" && (
                  <div className="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p className="text-sm text-yellow-800">
                      ‚è≥ Este pedido fraccionado est√° acumul√°ndose con otros compradores hasta alcanzar el m√≠nimo de compra
                    </p>
                  </div>
                )}

                {order.orderType === "fractional" && order.status === "closed" && (
                  <div className="mt-4 bg-green-50 border border-green-200 rounded-lg p-3">
                    <p className="text-sm text-green-800">
                      ‚úÖ El lote se ha cerrado y tu pedido est√° siendo preparado para env√≠o
                    </p>
                  </div>
                )}

                {order.orderType === "direct" && (
                  <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p className="text-sm text-blue-800">
                      üì¶ Compra directa completada - El fabricante procesar√° tu pedido
                    </p>
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="app/dashboard/pedidos-fraccionados/perfil/page.tsx">
"use client";

import { useEffect, useState } from "react";
// 1Ô∏è‚É£ Importaci√≥n agregada
import { useRouter } from "next/navigation";

export default function PerfilRevendedorPage() {
  // 2Ô∏è‚É£ Router inicializado
  const router = useRouter();

  const [formattedAddress, setFormattedAddress] = useState("");
  const [lat, setLat] = useState("");
  const [lng, setLng] = useState("");

  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState<string | null>(null);

  /* ===============================
      üì• CARGAR DIRECCI√ìN
  =============================== */
  useEffect(() => {
    async function loadAddress() {
      try {
        const res = await fetch("/api/retailers/address");
        if (!res.ok) return;

        const data = await res.json();

        if (data?.address) {
          setFormattedAddress(
            data.address.formattedAddress || ""
          );
          setLat(
            data.address.lat !== undefined
              ? String(data.address.lat)
              : ""
          );
          setLng(
            data.address.lng !== undefined
              ? String(data.address.lng)
              : ""
          );
        }
      } catch (err) {
        console.error("Error cargando direcci√≥n", err);
      }
    }

    loadAddress();
  }, []);

  async function handleSave() {
    setLoading(true);
    setError(null);
    setSuccess(false);

    if (!formattedAddress || !lat || !lng) {
      setError("Complet√° todos los campos");
      setLoading(false);
      return;
    }

    const res = await fetch("/api/retailers/address", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        formattedAddress,
        lat: Number(lat),
        lng: Number(lng),
      }),
    });

    if (!res.ok) {
      const data = await res.json();
      setError(data?.error || "Error al guardar direcci√≥n");
      setLoading(false);
      return;
    }

    setSuccess(true);
    setLoading(false);
  }

  return (
    <div className="max-w-xl">
      {/* 3Ô∏è‚É£ Bot√≥n "Volver" agregado */}
      <button
        onClick={() => router.back()}
        className="mb-4 text-blue-600 hover:text-blue-700 flex items-center gap-2 font-medium"
      >
        ‚Üê Volver
      </button>

      <h1 className="text-2xl font-semibold mb-6">
        Configuraci√≥n del perfil
      </h1>

      <p className="text-gray-600 mb-8">
        Ingres√° tu direcci√≥n.
        Esta informaci√≥n se usa para calcular env√≠os.
      </p>

      {/* DIRECCI√ìN */}
      <div className="mb-4">
        <label className="block text-sm mb-1">
          Direcci√≥n
        </label>
        <input
          type="text"
          value={formattedAddress}
          onChange={(e) =>
            setFormattedAddress(e.target.value)
          }
          className="w-full border rounded px-3 py-2"
          placeholder="Ej: Calle Falsa 123, Buenos Aires"
        />
      </div>

      {/* LAT / LNG */}
      <div className="grid grid-cols-2 gap-4 mb-6">
        <div>
          <label className="block text-sm mb-1">
            Latitud
          </label>
          <input
            type="number"
            value={lat}
            onChange={(e) => setLat(e.target.value)}
            className="w-full border rounded px-3 py-2"
            placeholder="-34.6037"
          />
        </div>

        <div>
          <label className="block text-sm mb-1">
            Longitud
          </label>
          <input
            type="number"
            value={lng}
            onChange={(e) => setLng(e.target.value)}
            className="w-full border rounded px-3 py-2"
            placeholder="-58.3816"
          />
        </div>
      </div>

      {/* MENSAJES */}
      {error && (
        <p className="text-red-600 text-sm mb-4">
          {error}
        </p>
      )}

      {success && (
        <p className="text-green-600 text-sm mb-4">
          Direcci√≥n guardada correctamente
        </p>
      )}

      {/* BOT√ìN */}
      <button
        onClick={handleSave}
        disabled={loading}
        className="bg-black text-white px-6 py-2 rounded disabled:opacity-50"
      >
        {loading ? "Guardando..." : "Guardar direcci√≥n"}
      </button>
    </div>
  );
}
</file>

<file path="app/explorar/[productId]/page.tsx">
// app/explorar/[productId]/page.tsx - VERSI√ìN ACTUALIZADA

import { headers } from "next/headers";
import { cookies } from "next/headers";
import { db } from "../../../lib/firebase-admin";
import type { Product } from "../../../lib/types/product";
import ProductPurchaseClient from "../../../components/products/ProductPurchaseClient";
import ManufacturerInfoCard from "../../../components/ManufacturerInfoCard.tsx";
import Link from "next/link";

/* ===============================
    üìç OBTENER PRODUCTO
================================ */
async function getProduct(
  productId: string
): Promise<(Product & { id: string }) | null> {
  const snap = await db.collection("products").doc(productId).get();

  if (!snap.exists) return null;

  const data = snap.data() as Product;

  return {
    id: snap.id,
    ...data,
  };
}

/* ===============================
    üè¢ OBTENER INFO DEL FABRICANTE
    üîß CORREGIDO para leer verification.status
================================ */
async function getManufacturerInfo(factoryId: string) {
  console.log("üîç Buscando manufacturer con ID:", factoryId);
  
  const snap = await db.collection("manufacturers").doc(factoryId).get();
  
  if (!snap.exists) {
    console.log("‚ùå Manufacturer NO encontrado");
    return null;
  }
  
  const data = snap.data();
  
  // üîß LEER EL ESTADO DE VERIFICACI√ìN CORRECTAMENTE
  const isVerified = data?.verification?.status === "verified";
  
  console.log("‚úÖ Manufacturer encontrado:", {
    businessName: data?.businessName,
    verificationStatus: data?.verification?.status,
    isVerified: isVerified,
  });
  
  return {
    businessName: data?.businessName || "Fabricante",
    profileImageUrl: data?.profileImageUrl || "",
    address: data?.address || null,
    phone: data?.phone || "",
    email: data?.email || "",
    schedule: data?.schedule || null,
    verified: isVerified, // üîß CORREGIDO: usar verification.status === "verified"
  };
}

/* ===============================
    üì¶ PROGRESO FRACCIONADO
================================ */
async function getFraccionadoProgress(productId: string) {
  const headersList = headers();
  const host = headersList.get("host");

  if (!host) return null;

  const protocol =
    process.env.NODE_ENV === "development" ? "http" : "https";

  const res = await fetch(
    `${protocol}://${host}/api/lots/fraccionado/progress?productId=${productId}`,
    { cache: "no-store" }
  );

  if (!res.ok) return null;

  return res.json();
}

/* ===============================
    üßæ PAGE (SERVER COMPONENT)
================================ */
export default async function ProductDetailPage({
  params,
}: {
  params: { productId: string };
}) {
  const product = await getProduct(params.productId);
  const progressData = await getFraccionadoProgress(params.productId);

  const userId = cookies().get("userId")?.value;

  if (!product) {
    return <div className="p-8">Producto no encontrado</div>;
  }

  // ‚úÖ Obtener info del fabricante
  const manufacturerInfo = await getManufacturerInfo(product.factoryId);

  const minimumOrder = Number(product.minimumOrder) || 0;

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-6xl mx-auto p-8">
        
        <Link
          href="/explorar"
          className="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium mb-6"
        >
          ‚Üê Volver a explorar
        </Link>

        {/* LAYOUT DE 2 COLUMNAS */}
        <div className="grid lg:grid-cols-3 gap-8">
          
          {/* COLUMNA IZQUIERDA - INFO PRODUCTO */}
          <div className="lg:col-span-2 space-y-6">
            
            {/* HEADER */}
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h1 className="text-3xl font-bold mb-2">{product.name}</h1>
              <p className="text-xl text-blue-600 font-bold">
                ${product.price.toLocaleString("es-AR")}
              </p>
            </div>

            {/* PROGRESO FRACCIONADO */}
            {progressData && progressData.accumulatedQty > 0 && (
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h3 className="font-semibold text-lg mb-3">üì¶ Progreso Fraccionado</h3>
                <p className="text-sm text-gray-600 mb-4">
                  {progressData.accumulatedQty} / {minimumOrder} unidades acumuladas
                </p>
                <div className="w-full bg-gray-200 rounded-full h-4">
                  <div
                    className="bg-blue-600 h-4 rounded-full transition-all duration-300"
                    style={{
                      width: `${Math.min((progressData.accumulatedQty / minimumOrder) * 100, 100)}%`,
                    }}
                  />
                </div>
              </div>
            )}

            {/* COMPRA */}
            {userId && (
              <ProductPurchaseClient
                price={product.price}
                MF={minimumOrder}
                productId={product.id}
              />
            )}
          </div>

          {/* COLUMNA DERECHA - INFO FABRICANTE */}
          <div className="lg:col-span-1">
            {manufacturerInfo && (
              <div className="sticky top-8">
                {/* üÜï AHORA PASAMOS isIntermediary DEL PRODUCTO */}
                <ManufacturerInfoCard 
                  {...manufacturerInfo}
                  isIntermediary={product.isIntermediary || false}
                />
              </div>
            )}
          </div>

        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/explorar/page.tsx">
"use client";

import Link from "next/link";
import { useEffect, useState } from "react";
import { ProductCategory, CATEGORY_LABELS } from "../../lib/types/product";

type Product = {
  id: string;
  name: string;
  price: number;
  minimumOrder: number;
  category: ProductCategory;
  featured: boolean;
  shippingMethods: string[];
};

type SortOption = "price_asc" | "price_desc" | "min_asc" | "min_desc" | "name";

export default function ExplorarPage() {
  const [products, setProducts] = useState<Product[]>([]);
  const [filteredProducts, setFilteredProducts] = useState<Product[]>([]);
  const [loading, setLoading] = useState(true);

  // üîç Estados de filtros
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedCategory, setSelectedCategory] = useState<ProductCategory | "all">("all");
  const [minPrice, setMinPrice] = useState("");
  const [maxPrice, setMaxPrice] = useState("");
  const [minOrder, setMinOrder] = useState("");
  const [maxOrder, setMaxOrder] = useState("");
  const [onlyFeatured, setOnlyFeatured] = useState(false);
  const [sortBy, setSortBy] = useState<SortOption>("name");

  // üì• Cargar productos
  useEffect(() => {
    async function loadProducts() {
      try {
        const res = await fetch("/api/products/explore");
        if (!res.ok) throw new Error("Error cargando productos");
        
        const data = await res.json();
        setProducts(data.products || []);
        setFilteredProducts(data.products || []);
      } catch (error) {
        console.error("Error:", error);
      } finally {
        setLoading(false);
      }
    }

    loadProducts();
  }, []);

  // üîÑ Aplicar filtros
  useEffect(() => {
    let result = [...products];

    // üîç B√∫squeda por nombre
    if (searchTerm) {
      result = result.filter(p =>
        p.name.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }

    // üìÇ Filtro de categor√≠a
    if (selectedCategory !== "all") {
      result = result.filter(p => p.category === selectedCategory);
    }

    // üí∞ Filtro de precio
    if (minPrice) {
      result = result.filter(p => p.price >= Number(minPrice));
    }
    if (maxPrice) {
      result = result.filter(p => p.price <= Number(maxPrice));
    }

    // üì¶ Filtro de pedido m√≠nimo
    if (minOrder) {
      result = result.filter(p => p.minimumOrder >= Number(minOrder));
    }
    if (maxOrder) {
      result = result.filter(p => p.minimumOrder <= Number(maxOrder));
    }

    // ‚≠ê Solo destacados
    if (onlyFeatured) {
      result = result.filter(p => p.featured);
    }

    // üî¢ Ordenamiento
    switch (sortBy) {
      case "price_asc":
        result.sort((a, b) => a.price - b.price);
        break;
      case "price_desc":
        result.sort((a, b) => b.price - a.price);
        break;
      case "min_asc":
        result.sort((a, b) => a.minimumOrder - b.minimumOrder);
        break;
      case "min_desc":
        result.sort((a, b) => b.minimumOrder - a.minimumOrder);
        break;
      case "name":
        result.sort((a, b) => a.name.localeCompare(b.name));
        break;
    }

    setFilteredProducts(result);
  }, [
    products,
    searchTerm,
    selectedCategory,
    minPrice,
    maxPrice,
    minOrder,
    maxOrder,
    onlyFeatured,
    sortBy,
  ]);

  // üßπ Limpiar filtros
  function clearFilters() {
    setSearchTerm("");
    setSelectedCategory("all");
    setMinPrice("");
    setMaxPrice("");
    setMinOrder("");
    setMaxOrder("");
    setOnlyFeatured(false);
    setSortBy("name");
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Cargando productos...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-7xl mx-auto p-6">
        
        {/* Bot√≥n Volver agregado */}
        <button
          onClick={() => window.history.back()}
          className="mb-4 text-blue-600 hover:text-blue-700 flex items-center gap-2 font-medium"
        >
          ‚Üê Volver
        </button>

        {/* HEADER */}
        <div className="mb-8">
          <h1 className="text-3xl font-semibold text-gray-900 mb-2">
            Explorar productos
          </h1>
          <p className="text-gray-600">
            Compr√° directo o particip√° en pedidos fraccionados
          </p>
        </div>

        <div className="grid lg:grid-cols-4 gap-6">
          
          {/* SIDEBAR DE FILTROS */}
          <aside className="lg:col-span-1">
            <div className="bg-white rounded-xl shadow p-6 sticky top-6">
              
              <div className="flex justify-between items-center mb-4">
                <h2 className="font-semibold text-lg">Filtros</h2>
                <button
                  onClick={clearFilters}
                  className="text-sm text-blue-600 hover:underline"
                >
                  Limpiar
                </button>
              </div>

              {/* B√∫squeda */}
              <div className="mb-5">
                <label className="block text-sm font-medium mb-2">
                  Buscar
                </label>
                <input
                  type="text"
                  placeholder="Nombre del producto..."
                  className="w-full border rounded px-3 py-2 text-sm"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
              </div>

              {/* Categor√≠a */}
              <div className="mb-5">
                <label className="block text-sm font-medium mb-2">
                  Categor√≠a
                </label>
                <select
                  className="w-full border rounded px-3 py-2 text-sm"
                  value={selectedCategory}
                  onChange={(e) => setSelectedCategory(e.target.value as ProductCategory | "all")}
                >
                  <option value="all">Todas las categor√≠as</option>
                  {Object.entries(CATEGORY_LABELS).map(([value, label]) => (
                    <option key={value} value={value}>
                      {label}
                    </option>
                  ))}
                </select>
              </div>

              {/* Rango de precio */}
              <div className="mb-5">
                <label className="block text-sm font-medium mb-2">
                  Precio
                </label>
                <div className="grid grid-cols-2 gap-2">
                  <input
                    type="number"
                    placeholder="M√≠n"
                    className="border rounded px-3 py-2 text-sm"
                    value={minPrice}
                    onChange={(e) => setMinPrice(e.target.value)}
                  />
                  <input
                    type="number"
                    placeholder="M√°x"
                    className="border rounded px-3 py-2 text-sm"
                    value={maxPrice}
                    onChange={(e) => setMaxPrice(e.target.value)}
                  />
                </div>
              </div>

              {/* Pedido m√≠nimo */}
              <div className="mb-5">
                <label className="block text-sm font-medium mb-2">
                  Pedido m√≠nimo
                </label>
                <div className="grid grid-cols-2 gap-2">
                  <input
                    type="number"
                    placeholder="M√≠n"
                    className="border rounded px-3 py-2 text-sm"
                    value={minOrder}
                    onChange={(e) => setMinOrder(e.target.value)}
                  />
                  <input
                    type="number"
                    placeholder="M√°x"
                    className="border rounded px-3 py-2 text-sm"
                    value={maxOrder}
                    onChange={(e) => setMaxOrder(e.target.value)}
                  />
                </div>
              </div>

              {/* Solo destacados */}
              <div className="mb-5">
                <label className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    checked={onlyFeatured}
                    onChange={(e) => setOnlyFeatured(e.target.checked)}
                  />
                  <span className="text-sm">Solo destacados</span>
                </label>
              </div>

              {/* Ordenar */}
              <div>
                <label className="block text-sm font-medium mb-2">
                  Ordenar por
                </label>
                <select
                  className="w-full border rounded px-3 py-2 text-sm"
                  value={sortBy}
                  onChange={(e) => setSortBy(e.target.value as SortOption)}
                >
                  <option value="name">Nombre A-Z</option>
                  <option value="price_asc">Precio: menor a mayor</option>
                  <option value="price_desc">Precio: mayor a menor</option>
                  <option value="min_asc">Pedido m√≠n: menor a mayor</option>
                  <option value="min_desc">Pedido m√≠n: mayor a menor</option>
                </select>
              </div>

            </div>
          </aside>

          {/* LISTA DE PRODUCTOS */}
          <div className="lg:col-span-3">
            
            {/* Contador de resultados */}
            <div className="mb-4 text-sm text-gray-600">
              {filteredProducts.length} producto{filteredProducts.length !== 1 && 's'} encontrado{filteredProducts.length !== 1 && 's'}
            </div>

            {filteredProducts.length === 0 ? (
              <div className="bg-white rounded-xl shadow p-12 text-center">
                <p className="text-gray-500 text-lg">
                  No se encontraron productos con estos filtros
                </p>
                <button
                  onClick={clearFilters}
                  className="mt-4 text-blue-600 hover:underline"
                >
                  Limpiar filtros
                </button>
              </div>
            ) : (
              <div className="grid md:grid-cols-2 xl:grid-cols-3 gap-6">
                {filteredProducts.map((product) => (
                  <div
                    key={product.id}
                    className="bg-white rounded-xl shadow hover:shadow-lg transition p-6 flex flex-col"
                  >
                    {/* Badge destacado */}
                    {product.featured && (
                      <div className="mb-3">
                        <span className="inline-block bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-medium">
                          ‚≠ê Destacado
                        </span>
                      </div>
                    )}

                    {/* Nombre */}
                    <h2 className="text-lg font-semibold mb-2 line-clamp-2">
                      {product.name}
                    </h2>

                    {/* Categor√≠a */}
                    <p className="text-xs text-gray-500 mb-3">
                      {CATEGORY_LABELS[product.category]}
                    </p>

                    {/* Precio */}
                    <p className="text-gray-900 mb-1">
                      <span className="font-medium">Precio:</span>{" "}
                      <span className="font-bold text-blue-600">
                        ${product.price.toLocaleString("es-AR")}
                      </span>
                    </p>

                    {/* Pedido m√≠nimo */}
                    <p className="text-sm text-gray-600 mb-4">
                      Pedido m√≠nimo: {product.minimumOrder} unidades
                    </p>

                    {/* Bot√≥n */}
                    <Link
                      href={`/explorar/${product.id}`}
                      className="mt-auto w-full bg-blue-600 text-white text-center py-2 rounded-lg hover:bg-blue-700 transition font-medium"
                    >
                      Ver producto ‚Üí
                    </Link>
                  </div>
                ))}
              </div>
            )}
          </div>

        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/registro/page.tsx">
// app/registro/page.tsx - P√°gina de Registro que muestra el segundo home

import HomeRegistro from '../../components/HomeRegistro';

export default function RegistroPage() {
  return <HomeRegistro />;
}
</file>

<file path="components/ActiveRoleBadge.tsx">
"use client";

import { useEffect, useState } from "react";

export default function ActiveRoleBadge() {
  const [role, setRole] = useState<string | null>(null);

  useEffect(() => {
    async function fetchRole() {
      const res = await fetch("/api/auth/me");
      if (!res.ok) return;

      const data = await res.json();
      setRole(data.role);
    }

    fetchRole();
  }, []);

  if (!role) return null;

  const label =
    role === "manufacturer" ? "Fabricante" : "Revendedor";

  const color =
    role === "manufacturer"
      ? "bg-blue-100 text-blue-700"
      : "bg-green-100 text-green-700";

  return (
    <div
      className={`px-4 py-1 rounded-full text-sm font-medium ${color}`}
    >
      Rol activo: {label}
    </div>
  );
}
</file>

<file path="components/admin/AdminProductIntermediaryManager.tsx">
// components/admin/AdminProductIntermediaryManager.tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";

type AdminProduct = {
  id: string;
  name: string;
  price: number;
  minimumOrder: number;
  factoryId: string;
  isIntermediary: boolean;
  active: boolean;
  createdAt: Date;
};

type Props = {
  products: AdminProduct[];
};

export default function AdminProductIntermediaryManager({ products }: Props) {
  const router = useRouter();
  const [loading, setLoading] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  // Funci√≥n para cambiar el estado de intermediario
  async function toggleIntermediary(productId: string, currentValue: boolean) {
    const newValue = !currentValue;
    
    if (!confirm(
      newValue 
        ? "¬øMarcar este producto como intermediario?"
        : "¬øRemover la marca de intermediario de este producto?"
    )) {
      return;
    }

    setLoading(productId);
    setError(null);

    try {
      const res = await fetch("/api/admin/products/mark-intermediary", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          productId,
          isIntermediary: newValue,
        }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || "Error al actualizar producto");
      }

      // Recargar la p√°gina para ver los cambios
      router.refresh();
      
    } catch (err: any) {
      setError(err.message || "Error al actualizar producto");
    } finally {
      setLoading(null);
    }
  }

  return (
    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
      
      {/* MENSAJE DE ERROR GLOBAL */}
      {error && (
        <div className="bg-red-50 border-b border-red-200 text-red-700 p-4">
          ‚ùå {error}
        </div>
      )}

      {/* TABLA */}
      <div className="overflow-x-auto">
        <table className="w-full">
          <thead className="bg-gray-50 border-b border-gray-200">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Producto
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Precio
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                M√≠n. Orden
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Estado
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Intermediario
              </th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Acci√≥n
              </th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {products.map((product) => (
              <tr key={product.id} className="hover:bg-gray-50 transition">
                
                {/* NOMBRE */}
                <td className="px-6 py-4">
                  <div className="font-medium text-gray-900">
                    {product.name}
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    {product.createdAt.toLocaleDateString('es-AR', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                    })}
                  </div>
                </td>

                {/* PRECIO */}
                <td className="px-6 py-4">
                  <div className="text-sm font-semibold text-gray-900">
                    ${product.price.toLocaleString('es-AR')}
                  </div>
                </td>

                {/* PEDIDO M√çNIMO */}
                <td className="px-6 py-4">
                  <div className="text-sm text-gray-600">
                    {product.minimumOrder} uds
                  </div>
                </td>

                {/* ESTADO ACTIVO */}
                <td className="px-6 py-4">
                  {product.active ? (
                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      Activo
                    </span>
                  ) : (
                    <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                      Inactivo
                    </span>
                  )}
                </td>

                {/* ESTADO INTERMEDIARIO */}
                <td className="px-6 py-4">
                  {product.isIntermediary ? (
                    <span className="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-700">
                      <svg 
                        className="w-3 h-3"
                        viewBox="0 0 24 24" 
                        fill="currentColor"
                      >
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                      </svg>
                      S√ç
                    </span>
                  ) : (
                    <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600">
                      NO
                    </span>
                  )}
                </td>

                {/* ACCI√ìN */}
                <td className="px-6 py-4">
                  <button
                    onClick={() => toggleIntermediary(product.id, product.isIntermediary)}
                    disabled={loading === product.id}
                    className={`px-4 py-2 rounded-lg text-sm font-medium transition disabled:opacity-50 disabled:cursor-not-allowed ${
                      product.isIntermediary
                        ? "bg-gray-200 text-gray-700 hover:bg-gray-300"
                        : "bg-orange-600 text-white hover:bg-orange-700"
                    }`}
                  >
                    {loading === product.id ? (
                      "Procesando..."
                    ) : product.isIntermediary ? (
                      "Quitar marca"
                    ) : (
                      "Marcar como intermediario"
                    )}
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* FOOTER */}
      <div className="bg-gray-50 px-6 py-4 border-t border-gray-200">
        <p className="text-sm text-gray-600">
          Total de productos: <span className="font-semibold">{products.length}</span>
        </p>
      </div>
    </div>
  );
}
</file>

<file path="components/admin/VerificationActions.tsx">
// components/admin/VerificationActions.tsx
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";

type Props = {
  verificationId: string;
  manufacturerId: string;
  legalName: string;
};

export default function VerificationActions({
  verificationId,
  manufacturerId,
  legalName,
}: Props) {
  const router = useRouter();
  
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  
  const [showRejectForm, setShowRejectForm] = useState(false);
  const [rejectionReason, setRejectionReason] = useState("");

  /* ===============================
     ‚úÖ APROBAR VERIFICACI√ìN
  =============================== */
  async function handleApprove() {
    if (!confirm(`¬øAprobar la verificaci√≥n de "${legalName}"?`)) {
      return;
    }

    setLoading(true);
    setError("");

    try {
      const res = await fetch("/api/admin/verification/approve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          verificationId,
          manufacturerId,
        }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || "Error al aprobar");
      }

      alert("‚úÖ Verificaci√≥n aprobada correctamente");
      router.push("/admin/verificaciones");
      router.refresh();
      
    } catch (err: any) {
      setError(err.message || "Error al aprobar verificaci√≥n");
    } finally {
      setLoading(false);
    }
  }

  /* ===============================
     ‚ùå RECHAZAR VERIFICACI√ìN
  =============================== */
  async function handleReject() {
    if (!rejectionReason.trim()) {
      setError("Debes escribir un motivo de rechazo");
      return;
    }

    if (!confirm(`¬øRechazar la verificaci√≥n de "${legalName}"?`)) {
      return;
    }

    setLoading(true);
    setError("");

    try {
      const res = await fetch("/api/admin/verification/reject", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          verificationId,
          manufacturerId,
          rejectionReason: rejectionReason.trim(),
        }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || "Error al rechazar");
      }

      alert("‚úÖ Verificaci√≥n rechazada correctamente");
      router.push("/admin/verificaciones");
      router.refresh();
      
    } catch (err: any) {
      setError(err.message || "Error al rechazar verificaci√≥n");
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="bg-white rounded-xl shadow-lg p-6">
      <h2 className="text-xl font-bold mb-6">‚ö° Acciones de Verificaci√≥n</h2>

      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg mb-6">
          ‚ùå {error}
        </div>
      )}

      {/* BOTONES PRINCIPALES */}
      {!showRejectForm && (
        <div className="grid md:grid-cols-2 gap-4">
          
          {/* APROBAR */}
          <button
            onClick={handleApprove}
            disabled={loading}
            className="bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            {loading ? (
              "Procesando..."
            ) : (
              <>
                <span>‚úì</span>
                <span>Aprobar Verificaci√≥n</span>
              </>
            )}
          </button>

          {/* RECHAZAR */}
          <button
            onClick={() => setShowRejectForm(true)}
            disabled={loading}
            className="border-2 border-red-500 text-red-600 px-6 py-3 rounded-xl font-semibold hover:bg-red-50 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            <span>‚úï</span>
            <span>Rechazar Verificaci√≥n</span>
          </button>
        </div>
      )}

      {/* FORMULARIO DE RECHAZO */}
      {showRejectForm && (
        <div className="border-2 border-red-200 rounded-xl p-6 bg-red-50">
          <h3 className="font-bold text-red-900 mb-4">
            Motivo del Rechazo
          </h3>

          <textarea
            value={rejectionReason}
            onChange={(e) => setRejectionReason(e.target.value)}
            className="w-full border-2 border-red-300 rounded-lg px-4 py-3 focus:border-red-500 focus:outline-none mb-4"
            rows={4}
            placeholder="Ej: El documento de AFIP no coincide con el CUIT ingresado..."
          />

          <div className="flex gap-3">
            <button
              onClick={handleReject}
              disabled={loading || !rejectionReason.trim()}
              className="flex-1 bg-red-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {loading ? "Procesando..." : "Confirmar Rechazo"}
            </button>

            <button
              onClick={() => {
                setShowRejectForm(false);
                setRejectionReason("");
                setError("");
              }}
              disabled={loading}
              className="px-6 py-3 border-2 border-gray-300 rounded-xl font-semibold hover:bg-gray-50 transition"
            >
              Cancelar
            </button>
          </div>
        </div>
      )}

      {/* INFORMACI√ìN */}
      <div className="mt-6 p-4 bg-gray-50 rounded-lg">
        <p className="text-sm text-gray-700">
          <strong>‚ÑπÔ∏è Record√°:</strong>
        </p>
        <ul className="text-sm text-gray-600 mt-2 space-y-1">
          <li>‚Ä¢ Al aprobar, el fabricante recibir√° el badge de verificaci√≥n</li>
          <li>‚Ä¢ Al rechazar, el fabricante podr√° corregir y volver a enviar</li>
          <li>‚Ä¢ Verific√° que toda la documentaci√≥n sea correcta antes de aprobar</li>
        </ul>
      </div>
    </div>
  );
}
</file>

<file path="components/AuthCheck.tsx">
"use client";

import { useEffect } from "react";
import { useRouter, usePathname } from "next/navigation";

export default function AuthCheck() {
  const router = useRouter();
  const pathname = usePathname();
  
  useEffect(() => {
    // ‚úÖ FIX: Manejar pathname null de forma expl√≠cita
    const currentPath = pathname ?? "/";
    
    // ‚úÖ No verificar en p√°ginas p√∫blicas
    const publicPaths = ["/", "/login", "/success", "/failure", "/pending"];
    if (publicPaths.includes(currentPath)) {
      return;
    }

    async function checkAuth() {
      try {
        const res = await fetch("/api/auth/me", {
          cache: "no-store",
        });
        
        if (!res.ok) {
          // ‚úÖ Solo redirigir si estamos en ruta protegida
          if (currentPath.startsWith("/dashboard") || currentPath.startsWith("/explorar")) {
            console.log("‚ö†Ô∏è Sesi√≥n expirada, redirigiendo a login...");
            router.push("/login");
          }
        }
      } catch (error) {
        console.error("Error verificando autenticaci√≥n:", error);
        // No redirigir en caso de error de red para evitar loop
      }
    }
    
    // ‚úÖ Verificar al montar
    checkAuth();
    
    // ‚úÖ Verificar cada 5 minutos
    const interval = setInterval(checkAuth, 5 * 60 * 1000);
    
    return () => clearInterval(interval);
  }, [router, pathname]);
  
  return null;
}
</file>

<file path="components/BackButton.tsx">
// components/BackButton.tsx
"use client";

import { useRouter } from "next/navigation";

type BackButtonProps = {
  label?: string;
  className?: string;
};

export default function BackButton({ 
  label = "Volver", 
  className = "" 
}: BackButtonProps) {
  const router = useRouter();

  return (
    <button
      onClick={() => router.back()}
      className={`text-blue-600 hover:text-blue-700 flex items-center gap-2 font-medium transition ${className}`}
    >
      ‚Üê {label}
    </button>
  );
}
</file>

<file path="components/DashboardSkeleton.tsx">
export function DashboardSkeleton() {
  return (
    <div className="min-h-screen bg-gray-50">
      <div className="p-8 max-w-6xl mx-auto">
        
        {/* HEADER SKELETON */}
        <div className="flex justify-between items-center mb-10">
          <div>
            <div className="h-8 bg-gray-200 rounded w-64 mb-2 animate-pulse"></div>
            <div className="h-4 bg-gray-200 rounded w-96 animate-pulse"></div>
          </div>
          <div className="flex gap-4">
            <div className="h-10 bg-gray-200 rounded w-32 animate-pulse"></div>
            <div className="h-10 bg-gray-200 rounded w-40 animate-pulse"></div>
          </div>
        </div>

        {/* KPIs SKELETON */}
        <div className="grid md:grid-cols-3 gap-6 mb-12">
          {[...Array(3)].map((_, i) => (
            <div key={i} className="bg-white p-6 rounded-xl shadow animate-pulse">
              <div className="h-4 bg-gray-200 rounded w-24 mb-4"></div>
              <div className="h-8 bg-gray-200 rounded w-32"></div>
            </div>
          ))}
        </div>

        {/* CONTENT SKELETON */}
        <div className="bg-white rounded-xl shadow p-6">
          <div className="h-6 bg-gray-200 rounded w-48 mb-6 animate-pulse"></div>
          <div className="space-y-4">
            {[...Array(3)].map((_, i) => (
              <div key={i} className="h-20 bg-gray-200 rounded animate-pulse"></div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/FabricanteSidebar.tsx">
// components/FabricanteSidebar.tsx
"use client";

import Link from "next/link";
import { useState } from "react";

export default function FabricanteSidebar() {
  const [open, setOpen] = useState(true);

  return (
    <aside
      className={`bg-white border-r border-gray-200 transition-all duration-300 ${
        open ? "w-64" : "w-16"
      }`}
    >
      {/* TOGGLE */}
      <div className="p-4 flex justify-between items-center border-b">
        {open && (
          <span className="text-sm font-semibold text-gray-700">
            Panel Fabricante
          </span>
        )}
        <button
          onClick={() => setOpen(!open)}
          className="text-gray-500 hover:text-gray-900"
        >
          ‚ò∞
        </button>
      </div>

      {/* NAV */}
      <nav className="p-4 space-y-2">
        <Link
          href="/dashboard/fabricante"
          className="block text-sm text-gray-700 hover:bg-gray-100 rounded px-3 py-2"
        >
          üè† {open && "Resumen"}
        </Link>

        <Link
          href="/dashboard/fabricante/productos"
          className="block text-sm text-gray-700 hover:bg-gray-100 rounded px-3 py-2"
        >
          üì¶ {open && "Productos"}
        </Link>

        <Link
          href="/dashboard/fabricante/pedidos"
          className="block text-sm text-gray-700 hover:bg-gray-100 rounded px-3 py-2"
        >
          üìã {open && "Pedidos"}
        </Link>

        <Link
          href="/dashboard/fabricante/destacados"
          className="block text-sm text-gray-700 hover:bg-gray-100 rounded px-3 py-2"
        >
          ‚≠ê {open && "Destacados"}
        </Link>

        <Link
          href="/dashboard/fabricante/perfil"
          className="block text-sm text-gray-700 hover:bg-gray-100 rounded px-3 py-2"
        >
          ‚öôÔ∏è {open && "Perfil"}
        </Link>
      </nav>
    </aside>
  );
}
</file>

<file path="components/FeaturedExpirationAlert.tsx">
"use client";

import Link from "next/link";

type Props = {
  productName: string;
  daysLeft: number;
};

export default function FeaturedExpirationAlert({
  productName,
  daysLeft,
}: Props) {
  const urgent = daysLeft <= 1;

  return (
    <div
      className={`rounded-xl p-5 mb-6 border ${
        urgent
          ? "bg-red-50 border-red-400 text-red-700"
          : "bg-yellow-50 border-yellow-400 text-yellow-700"
      }`}
    >
      <h3 className="font-semibold text-lg mb-1">
        ‚ö†Ô∏è Tu producto destacado est√° por vencer
      </h3>

      <p className="mb-3">
        <strong>{productName}</strong> vence en{" "}
        <strong>{daysLeft} d√≠a{daysLeft > 1 && "s"}</strong>.
        <br />
        Si no renov√°s, perder√°s el lugar autom√°ticamente.
      </p>

      <Link
        href="/dashboard/featured/renew"
        className={`inline-block px-4 py-2 rounded-md text-sm font-medium ${
          urgent
            ? "bg-red-600 text-white hover:bg-red-700"
            : "bg-yellow-500 text-black hover:bg-yellow-600"
        }`}
      >
        Renovar ahora
      </Link>
    </div>
  );
}
</file>

<file path="components/HomeButtons.tsx">
"use client";

import { useRouter } from "next/navigation";

export default function HomeButtons() {
  const router = useRouter();

  function selectRole(role: "manufacturer" | "retailer") {
    // Guardar rol elegido en localStorage
    localStorage.setItem("selectedRole", role);
    
    // Redirigir a login
    router.push("/login");
  }

  return (
    <div className="flex flex-col md:flex-row justify-center gap-4 mt-8">
      <button
        onClick={() => selectRole("retailer")}
        className="px-8 py-4 bg-blue-600 text-white rounded-xl text-lg font-medium hover:bg-blue-700 transition-all shadow-lg hover:scale-105"
      >
        Soy revendedor
      </button>

      <button
        onClick={() => selectRole("manufacturer")}
        className="px-8 py-4 bg-white/90 text-blue-700 rounded-xl text-lg font-medium hover:bg-white transition-all shadow-lg hover:scale-105"
      >
        Soy fabricante
      </button>
    </div>
  );
}
</file>

<file path="components/HomePrincipal.tsx">
// components/HomePrincipal.tsx - Home Principal Funcional

'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';

// Tipos
type FeaturedProduct = {
  id: string;
  itemId: string;
  itemData: {
    id: string;
    name: string;
    price: number;
    minimumOrder: number;
    category: string;
  };
};

type FeaturedFactory = {
  id: string;
  itemId: string;
  itemData: {
    id: string;
    name: string;
    description: string;
    address: string;
  };
};

type Product = {
  id: string;
  name: string;
  price: number;
  minimumOrder: number;
  shippingMethods: string[];
  category?: string;
};

type LotData = {
  accumulatedQty: number;
  MF: number;
  progress?: number;
};

const CATEGORY_LABELS: Record<string, string> = {
  alimentos: "Alimentos",
  bebidas: "Bebidas",
  indumentaria: "Indumentaria",
  calzado: "Calzado",
  electronica: "Electr√≥nica",
  hogar: "Hogar",
  construccion: "Construcci√≥n",
  salud_belleza: "Salud y Belleza",
  jugueteria: "Jugueter√≠a",
  libreria: "Librer√≠a",
  deportes: "Deportes",
  automotor: "Automotor",
  mascotas: "Mascotas",
  otros: "Otros",
};

const CATEGORY_ICONS: Record<string, string> = {
  alimentos: 'üçï',
  bebidas: 'ü•§',
  indumentaria: 'üëï',
  calzado: 'üëü',
  electronica: 'üì±',
  hogar: 'üè†',
  construccion: 'üî®',
  salud_belleza: 'üíÑ',
  jugueteria: 'üß∏',
  libreria: 'üìö',
  deportes: '‚öΩ',
  automotor: 'üöó',
  mascotas: 'üêæ',
  otros: 'üì¶',
};

const CATEGORY_COLORS: Record<string, string> = {
  alimentos: 'bg-orange-500',
  bebidas: 'bg-blue-500',
  indumentaria: 'bg-pink-500',
  calzado: 'bg-purple-500',
  electronica: 'bg-indigo-500',
  hogar: 'bg-green-500',
  construccion: 'bg-yellow-600',
  salud_belleza: 'bg-rose-500',
  jugueteria: 'bg-red-500',
  libreria: 'bg-cyan-500',
  deportes: 'bg-lime-500',
  automotor: 'bg-slate-600',
  mascotas: 'bg-amber-500',
  otros: 'bg-gray-500',
};

export default function HomePrincipal() {
  const router = useRouter();
  const [currentBanner, setCurrentBanner] = useState(0);
  const [scrollY, setScrollY] = useState(0);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [isLoading, setIsLoading] = useState(true);

  // Datos din√°micos de las APIs
  const [featuredProducts, setFeaturedProducts] = useState<FeaturedProduct[]>([]);
  const [featuredFactories, setFeaturedFactories] = useState<FeaturedFactory[]>([]);
  const [allProducts, setAllProducts] = useState<Product[]>([]);
  const [productLots, setProductLots] = useState<Record<string, LotData>>({});
  
  const [loadingFeaturedProducts, setLoadingFeaturedProducts] = useState(true);
  const [loadingFeaturedFactories, setLoadingFeaturedFactories] = useState(true);
  const [loadingAllProducts, setLoadingAllProducts] = useState(true);

  // Verificar autenticaci√≥n
  useEffect(() => {
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me');
        if (response.ok) {
          const data = await response.json();
          setIsAuthenticated(!!data.userId);
        }
      } catch (error) {
        console.error('Error verificando autenticaci√≥n:', error);
        setIsAuthenticated(false);
      } finally {
        setIsLoading(false);
      }
    }
    checkAuth();
  }, []);

  // Cargar productos destacados
  useEffect(() => {
    async function loadFeaturedProducts() {
      try {
        const res = await fetch('/api/featured/active?type=product');
        if (res.ok) {
          const data = await res.json();
          setFeaturedProducts(data.items || []);
        }
      } catch (error) {
        console.error('Error cargando productos destacados:', error);
      } finally {
        setLoadingFeaturedProducts(false);
      }
    }
    loadFeaturedProducts();
  }, []);

  // Cargar f√°bricas destacadas
  useEffect(() => {
    async function loadFeaturedFactories() {
      try {
        const res = await fetch('/api/featured/active?type=factory');
        if (res.ok) {
          const data = await res.json();
          setFeaturedFactories(data.items || []);
        }
      } catch (error) {
        console.error('Error cargando f√°bricas destacadas:', error);
      } finally {
        setLoadingFeaturedFactories(false);
      }
    }
    loadFeaturedFactories();
  }, []);

  // Cargar todos los productos
  useEffect(() => {
    async function loadAllProducts() {
      try {
        const res = await fetch('/api/products/explore');
        if (res.ok) {
          const data = await res.json();
          setAllProducts(data.products || []);
        }
      } catch (error) {
        console.error('Error cargando productos:', error);
      } finally {
        setLoadingAllProducts(false);
      }
    }
    loadAllProducts();
  }, []);

  // Cargar progreso de lotes para productos destacados
  useEffect(() => {
    async function loadProductLots() {
      if (featuredProducts.length === 0) return;

      const lotsData: Record<string, LotData> = {};
      
      for (const product of featuredProducts) {
        try {
          const res = await fetch(`/api/lots/${product.itemData.id}`);
          if (res.ok) {
            const data = await res.json();
            const progress = data.MF > 0 ? Math.round((data.accumulatedQty / data.MF) * 100) : 0;
            lotsData[product.itemData.id] = {
              accumulatedQty: data.accumulatedQty || 0,
              MF: data.MF || 0,
              progress,
            };
          }
        } catch (error) {
          console.error(`Error cargando lote para producto ${product.itemData.id}:`, error);
        }
      }
      
      setProductLots(lotsData);
    }

    if (!loadingFeaturedProducts && featuredProducts.length > 0) {
      loadProductLots();
    }
  }, [featuredProducts, loadingFeaturedProducts]);

  const banners = [
    {
      title: '¬°Pedidos desde 10 unidades!',
      subtitle: 'Compr√° a precio de fabrica sin invertir grandes volumenes.',
      bgColor: 'from-blue-600 via-blue-700 to-blue-900',
      image: 'https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?w=1200',
      cta: 'Explorar'
    },
    {
       title: '¬°Fabricas celebres!',
      subtitle: 'Encontraras productos de las fabricas mas importantes',
      bgColor: 'from-zinc-600 via-zinc-700 to-zinc-900',
      image: 'https://images.unsplash.com/photo-1615797534094-7fde0a4861f3?w=1200',
      cta: 'Explorar'
    },
    {
      title: '¬°Fabricas Verificadas!',
      subtitle: 'Puedes buscar productos de forma segura y tranquila.',
       bgColor: 'from-emerald-600 via-emerald-700 to-emerald-900',
      image: 'https://images.unsplash.com/photo-1603899122406-e7eb957f9fd6?w=1200',
      cta: 'Explorar'
    },
    {
      title: '¬°Lotes a Punto De Cerrar!',
      subtitle: 'Unite antes de que se completen.',
      bgColor: 'from-orange-600 via-orange-700 to-orange-900',
      image: 'https://images.unsplash.com/photo-1472851294608-062f824d29cc?w=1200',
      cta: 'Ver Lotes'
    }
  ];

  // Obtener categor√≠as √∫nicas de los productos
  const categories = Object.keys(CATEGORY_LABELS).map(key => ({
    id: key,
    name: CATEGORY_LABELS[key],
    icon: CATEGORY_ICONS[key] || 'üì¶',
    color: CATEGORY_COLORS[key] || 'bg-gray-500',
    count: allProducts.filter(p => p.category === key).length
  })).filter(cat => cat.count > 0);

  // Auto-rotaci√≥n de banners
  useEffect(() => {
    const interval = setInterval(() => {
      setCurrentBanner((prev) => (prev + 1) % banners.length);
    }, 5000);
    return () => clearInterval(interval);
  }, [banners.length]);

  // Scroll detection para header sticky
  useEffect(() => {
    const handleScroll = () => setScrollY(window.scrollY);
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  // Funci√≥n para manejar clic en rol
  const handleRoleRedirect = (targetRole: 'retailer' | 'manufacturer') => {
    if (isAuthenticated) {
      // Usuario autenticado: ir al dashboard correcto
      if (targetRole === 'retailer') {
        router.push('/dashboard/pedidos-fraccionados');
      } else {
        router.push('/dashboard/fabricante');
      }
    } else {
      // Usuario NO autenticado: guardar rol y ir a /registro
      localStorage.setItem('selectedRole', targetRole);
      router.push('/registro');
    }
  };

  // Funci√≥n para manejar clic en login/perfil
  const handleLoginClick = () => {
    if (isAuthenticated) {
      router.push('/perfil');
    } else {
      router.push('/registro');
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      
      {/* HEADER PRINCIPAL */}
      <header className={`sticky top-0 z-50 transition-all duration-300 ${
        scrollY > 50 ? 'shadow-lg' : ''
      }`}>
        {/* Top Bar */}
        <div className="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-white">
          <div className="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between text-sm">
            <div className="flex items-center gap-6">
              <span className="flex items-center gap-2">
                üìç Env√≠os a todo el pa√≠s
              </span>
            </div>
            <div className="flex items-center gap-4">
              <Link href="/ayuda" className="hover:text-blue-300 transition">
                ¬øNecesit√°s ayuda?
              </Link>
              <Link href="/como-funciona" className="hover:text-blue-300 transition">
                ¬øC√≥mo funciona?
              </Link>
            </div>
          </div>
        </div>

        {/* Main Navigation */}
        <div className="bg-white border-b border-gray-200">
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex items-center justify-between gap-4">
              
              {/* Logo */}
              <Link href="/" className="flex items-center gap-3 group">
                <div className="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-800 rounded-xl flex items-center justify-center transform group-hover:scale-105 transition-transform shadow-lg">
                  <span className="text-2xl font-black text-white">M</span>
                </div>
                <div className="hidden sm:block">
                  <h1 className="text-2xl font-black bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent">
                    MayoristaMovil
                  </h1>
                  <p className="text-xs text-gray-500 font-medium">Compra fraccionada</p>
                </div>
              </Link>

              {/* Search Bar */}
              <div className="flex-1 max-w-2xl">
                <form onSubmit={(e) => { e.preventDefault(); router.push('/explorar'); }}>
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="Buscar productos, f√°bricas, categor√≠as..."
                      className="w-full px-4 py-3 pr-12 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all"
                    />
                    <button type="submit" className="absolute right-0 top-0 bottom-0 px-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-r-lg hover:from-blue-700 hover:to-blue-800 transition-all">
                      üîç
                    </button>
                  </div>
                </form>
              </div>

              {/* User Actions */}
              <div className="flex items-center gap-3">
                <button
                  onClick={handleLoginClick}
                  className="hidden lg:flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-lg transition"
                >
                  <span className="text-2xl">üë§</span>
                  <div className="text-left">
                    <p className="text-xs text-gray-500">{isAuthenticated ? 'Mi' : 'Hola,'}</p>
                    <p className="text-sm font-semibold">{isAuthenticated ? 'Perfil' : 'Ingres√°'}</p>
                  </div>
                </button>

                {isAuthenticated && (
                  <>
                    <Link 
                      href="/mis-compras" 
                      className="hidden md:flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-lg transition"
                    >
                      <span className="text-2xl">üì¶</span>
                      <div className="text-left">
                        <p className="text-xs text-gray-500">Mis</p>
                        <p className="text-sm font-semibold">Compras</p>
                      </div>
                    </Link>

                    <Link 
                      href="/carrito" 
                      className="relative px-4 py-2 hover:bg-gray-100 rounded-lg transition"
                    >
                      <span className="text-3xl">üõí</span>
                      <span className="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                        0
                      </span>
                    </Link>
                  </>
                )}
              </div>
            </div>

            {/* Categories Menu */}
            <div className="mt-4 flex items-center gap-4 overflow-x-auto pb-2 scrollbar-hide">
              <Link href="/explorar" className="text-sm font-semibold text-blue-600 hover:text-blue-800 whitespace-nowrap">
                Todas las categor√≠as
              </Link>
              <span className="text-gray-300">|</span>
              <Link href="/explorar" className="text-sm text-gray-700 hover:text-blue-600 whitespace-nowrap transition">
                Lotes por cerrar
              </Link>
              
              {/* Botones que manejan la redirecci√≥n seg√∫n autenticaci√≥n */}
              <button 
                onClick={() => handleRoleRedirect('retailer')}
                className="text-sm text-gray-700 hover:text-blue-600 whitespace-nowrap transition cursor-pointer"
              >
                Soy revendedor
              </button>
              <button 
                onClick={() => handleRoleRedirect('manufacturer')}
                className="text-sm text-gray-700 hover:text-blue-600 whitespace-nowrap transition cursor-pointer"
              >
                Soy fabricante
              </button>
            </div>
          </div>
        </div>
      </header>

      {/* CUADRO DE INTRODUCCI√ìN */}
      <section className="bg-gradient-to-r from-blue-600 via-blue-700 to-indigo-700 py-8">
        <div className="max-w-7xl mx-auto px-4">
          <div className="bg-white/10 backdrop-blur-md rounded-2xl border-2 border-white/30 p-6 md:p-8 shadow-2xl">
            <div className="flex flex-col md:flex-row items-center justify-between gap-6">
              <div className="flex-1 text-center md:text-left">
                <h2 className="text-3xl md:text-4xl font-black text-white mb-3 leading-tight">
                  COMPRA A PRECIOS DE FABRICA
                </h2>
                <p className="text-xl md:text-2xl text-white/90 font-semibold mb-2">
                  Incluso sin llegar al m√≠nimo, solo lo que necesites.
                </p>
                <p className="text-white/80 text-lg max-w-2xl">
                  Unite a otros compradores y revendedores para acceder a precios de fabrica comprando solo las unidades que necesit√°s.
                </p>
              </div>
              
              <div className="flex flex-col sm:flex-row gap-4">
                <Link 
                  href="/como-funciona" 
                  className="px-8 py-4 bg-white text-blue-700 font-black rounded-xl hover:bg-yellow-300 hover:text-blue-900 transition-all transform hover:scale-105 shadow-2xl text-center"
                >
                  ¬øC√≥mo funciona? ‚Üí
                </Link>
                <Link 
                  href="/explorar" 
                  className="px-8 py-4 bg-yellow-400 text-blue-900 font-black rounded-xl hover:bg-yellow-300 transition-all transform hover:scale-105 shadow-2xl text-center"
                >
                  Explorar productos
                </Link>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* BANNER CAROUSEL */}
      <section className="relative h-[400px] md:h-[500px] overflow-hidden bg-gradient-to-br from-slate-900 to-slate-700">
        
        {/* Indicador de banner actual */}
        <div className="absolute top-4 right-4 bg-black/70 text-white px-3 py-1 rounded-full text-sm font-bold z-30">
          {currentBanner + 1} / {banners.length}
        </div>

        {banners.map((banner, index) => (
          <div
            key={index}
            className={`absolute inset-0 transition-all duration-700 ${
              currentBanner === index ? 'opacity-100 scale-100' : 'opacity-0 scale-105'
            }`}
          >
            <div className={`absolute inset-0 bg-gradient-to-r ${banner.bgColor} opacity-90`} />
            <img
              src={banner.image}
              alt={banner.title}
              className="w-full h-full object-cover mix-blend-overlay"
            />
            <div className="absolute inset-0 flex items-center">
              <div className="max-w-7xl mx-auto px-4 w-full">
                <div className="max-w-2xl">
                  <h2 className="text-4xl md:text-6xl font-black text-white mb-4 leading-tight animate-fade-in-up">
                    {banner.title}
                  </h2>
                  <p className="text-xl md:text-2xl text-white/90 mb-8 animate-fade-in-up" style={{ animationDelay: '0.1s' }}>
                    {banner.subtitle}
                  </p>
                  <Link href="/explorar">
                    <button className="px-8 py-4 bg-white text-blue-600 font-bold rounded-xl hover:bg-blue-50 transform hover:scale-105 transition-all shadow-2xl animate-fade-in-up" style={{ animationDelay: '0.2s' }}>
                      {banner.cta} ‚Üí
                    </button>
                  </Link>
                </div>
              </div>
            </div>
          </div>
        ))}

        {/* Banner Navigation Dots */}
        <div className="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-3 z-20">
          {banners.map((banner, index) => (
            <button
              key={index}
              onClick={() => setCurrentBanner(index)}
              className={`transition-all ${
                currentBanner === index 
                  ? 'bg-white w-8 h-3 rounded-full' 
                  : 'bg-white/50 hover:bg-white/75 w-3 h-3 rounded-full'
              }`}
              aria-label={`Ir a banner ${index + 1}: ${banner.title}`}
              title={banner.title}
            />
          ))}
        </div>

        {/* Flechas de navegaci√≥n */}
        <button
          onClick={() => setCurrentBanner((prev) => (prev - 1 + banners.length) % banners.length)}
          className="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white rounded-full p-3 transition-all z-20"
          aria-label="Banner anterior"
        >
          ‚Üê
        </button>
        <button
          onClick={() => setCurrentBanner((prev) => (prev + 1) % banners.length)}
          className="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white rounded-full p-3 transition-all z-20"
          aria-label="Banner siguiente"
        >
          ‚Üí
        </button>
      </section>

      {/* CATEGOR√çAS */}
      <section className="max-w-7xl mx-auto px-4 -mt-16 relative z-10 mb-12">
        <div className="bg-white rounded-2xl shadow-2xl p-6">
          <h3 className="text-2xl font-bold text-gray-900 mb-6">Explorar por categor√≠a</h3>
          
          {loadingAllProducts ? (
            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
              {[...Array(8)].map((_, i) => (
                <div key={i} className="flex flex-col items-center gap-3 p-4">
                  <div className="w-16 h-16 bg-gray-200 rounded-2xl animate-pulse" />
                  <div className="w-20 h-4 bg-gray-200 rounded animate-pulse" />
                </div>
              ))}
            </div>
          ) : categories.length > 0 ? (
            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
              {categories.slice(0, 8).map((category) => (
                <Link
                  key={category.id}
                  href={`/explorar?category=${category.id}`}
                  className="group"
                >
                  <div className="flex flex-col items-center gap-3 p-4 rounded-xl hover:bg-gray-50 transition-all cursor-pointer">
                    <div className={`w-16 h-16 ${category.color} rounded-2xl flex items-center justify-center text-3xl transform group-hover:scale-110 group-hover:rotate-3 transition-all shadow-lg`}>
                      {category.icon}
                    </div>
                    <div className="text-center">
                      <p className="font-semibold text-sm text-gray-900">{category.name}</p>
                      <p className="text-xs text-gray-500">{category.count} productos</p>
                    </div>
                  </div>
                </Link>
              ))}
            </div>
          ) : (
            <p className="text-center text-gray-500 py-8">No hay categor√≠as disponibles</p>
          )}
        </div>
      </section>

      {/* PRODUCTOS DESTACADOS */}
      <section className="max-w-7xl mx-auto px-4 mb-12">
        <div className="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 rounded-2xl p-8 text-white shadow-2xl">
          <div className="flex items-center justify-between mb-6">
            <div>
              <h3 className="text-3xl font-black mb-2">‚≠ê Productos Destacados</h3>
              <p className="text-lg opacity-90">Los mejores productos seleccionados para vos</p>
            </div>
            <Link 
              href="/explorar" 
              className="hidden md:flex items-center gap-2 bg-white/20 backdrop-blur-sm px-6 py-3 rounded-xl hover:bg-white/30 transition-all font-semibold"
            >
              Ver todos ‚Üí
            </Link>
          </div>
          
          {loadingFeaturedProducts ? (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {[...Array(3)].map((_, i) => (
                <div key={i} className="bg-white rounded-xl overflow-hidden shadow-xl">
                  <div className="w-full h-48 bg-gray-200 animate-pulse" />
                  <div className="p-4 space-y-3">
                    <div className="h-6 bg-gray-200 rounded animate-pulse" />
                    <div className="h-4 bg-gray-200 rounded animate-pulse w-2/3" />
                    <div className="h-8 bg-gray-200 rounded animate-pulse" />
                  </div>
                </div>
              ))}
            </div>
          ) : featuredProducts.length > 0 ? (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {featuredProducts.slice(0, 3).map((product) => {
                const lotData = productLots[product.itemData.id];
                const progress = lotData?.progress || 0;
                const accumulated = lotData?.accumulatedQty || 0;
                const minimum = lotData?.MF || product.itemData.minimumOrder;

                return (
                  <Link key={product.id} href={`/explorar/${product.itemData.id}`}>
                    <div className="bg-white rounded-xl overflow-hidden shadow-xl hover:shadow-2xl transition-all transform hover:-translate-y-2 cursor-pointer">
                      <div className="relative">
                        <div className="w-full h-48 bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center">
                          <span className="text-6xl">üì¶</span>
                        </div>
                        <div className="absolute top-3 right-3 bg-yellow-500 text-white px-3 py-1 rounded-full font-bold text-sm flex items-center gap-1">
                          ‚≠ê Destacado
                        </div>
                      </div>
                      <div className="p-4">
                        <h4 className="font-bold text-gray-900 mb-1 line-clamp-2">{product.itemData.name}</h4>
                        <p className="text-sm text-gray-500 mb-3">{product.itemData.category}</p>
                        
                        {/* Barra de progreso del lote */}
                        <div className="mb-3">
                          <div className="flex justify-between text-sm mb-1">
                            <span className="text-gray-600">Progreso del lote</span>
                            <span className="font-bold text-blue-600">{progress}%</span>
                          </div>
                          <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div 
                              className="h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full transition-all"
                              style={{ width: `${Math.min(progress, 100)}%` }}
                            />
                          </div>
                          <p className="text-xs text-gray-500 mt-1">
                            {accumulated} de {minimum} unidades
                          </p>
                        </div>
                        
                        <div className="flex items-baseline gap-2 mb-3">
                          <span className="text-2xl font-black text-gray-900">
                            ${product.itemData.price.toLocaleString()}
                          </span>
                          <span className="text-xs text-gray-500">por unidad</span>
                        </div>
                        
                        <button className="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all transform hover:scale-105 shadow-lg">
                          Ver detalles
                        </button>
                      </div>
                    </div>
                  </Link>
                );
              })}
            </div>
          ) : (
            <div className="text-center py-12">
              <p className="text-white/80 text-lg">No hay productos destacados en este momento</p>
            </div>
          )}
        </div>
      </section>

      {/* C√ìMO FUNCIONA */}
      <section className="max-w-7xl mx-auto px-4 mb-12">
        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-8 border border-blue-100">
          <h3 className="text-3xl font-black text-gray-900 mb-2 text-center">
            ¬øC√≥mo funciona la compra fraccionada?
          </h3>
          <p className="text-center text-gray-600 mb-8 max-w-2xl mx-auto">
            Acced√© a precios de fabrica comprando pocas cantidades 
          </p>
          
          <div className="grid md:grid-cols-4 gap-8">
            <div className="text-center">
              <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-4xl mx-auto mb-4 transform hover:scale-110 transition-all shadow-xl">
                1
              </div>
              <h4 className="text-xl font-bold text-gray-900 mb-2">Eleg√≠ tu producto</h4>
              <p className="text-gray-600">
                Busca en el explorador, el producto que mas quieras o necesites.
              </p>
            </div>
            
            <div className="text-center">
              <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-4xl mx-auto mb-4 transform hover:scale-110 transition-all shadow-xl">
                2
              </div>
              <h4 className="text-xl font-bold text-gray-900 mb-2">Unite al lote</h4>
              <p className="text-gray-600">
                Cuando compras cantidades menores al minimo, te unes a la barra de progreso junto a otros compradores para llegar al minimo.
              </p>
            </div>
            
            <div className="text-center">
              <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-4xl mx-auto mb-4 transform hover:scale-110 transition-all shadow-xl">
                3
              </div>
              <h4 className="text-xl font-bold text-gray-900 mb-2">Reembolso</h4>
              <p className="text-gray-600">
                Mientras el lote este en progreso, puedes pedir el reembolso de tu dinero.
              </p>
            </div>
             
            <div className="text-center">
              <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-4xl mx-auto mb-4 transform hover:scale-110 transition-all shadow-xl">
                4
              </div>
              <h4 className="text-xl font-bold text-gray-900 mb-2">Recib√≠ tu pedido</h4>
              <p className="text-gray-600">
                Cuando el lote se completa, el dinero se libera y tu recibes el producto dentro de las 24-72h.
              </p>
            </div>
          </div>

          <div className="mt-8 text-center">
            <Link 
              href="/como-funciona" 
              className="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-all"
            >
              Conocer m√°s detalles ‚Üí
            </Link>
          </div>
        </div>
      </section>

      {/* F√ÅBRICAS DESTACADAS */}
      <section className="max-w-7xl mx-auto px-4 mb-12">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h3 className="text-3xl font-black text-gray-900">üè≠ F√°bricas Destacadas</h3>
            <p className="text-gray-600">Las mejores f√°bricas verificadas de la plataforma</p>
          </div>
          <Link href="/explorar" className="text-blue-600 font-semibold hover:text-blue-700 transition">
            Ver todas ‚Üí
          </Link>
        </div>

        {loadingFeaturedFactories ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {[...Array(3)].map((_, i) => (
              <div key={i} className="bg-white rounded-xl overflow-hidden shadow-md border border-gray-100">
                <div className="h-40 bg-gray-200 animate-pulse" />
                <div className="p-4 space-y-3">
                  <div className="h-6 bg-gray-200 rounded animate-pulse" />
                  <div className="h-4 bg-gray-200 rounded animate-pulse" />
                  <div className="h-4 bg-gray-200 rounded animate-pulse w-3/4" />
                </div>
              </div>
            ))}
          </div>
        ) : featuredFactories.length > 0 ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {featuredFactories.slice(0, 6).map((factory) => (
              <div
                key={factory.id}
                className="bg-white rounded-xl overflow-hidden shadow-md hover:shadow-2xl transition-all transform hover:-translate-y-1 border border-gray-100"
              >
                <div className="relative h-40 bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center">
                  <span className="text-6xl">üè≠</span>
                  <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                  
                  <div className="absolute top-3 right-3 bg-blue-600 text-white px-3 py-1 rounded-full font-bold text-xs flex items-center gap-1">
                    ‚úì Verificada
                  </div>
                  
                  <div className="absolute bottom-3 left-3 right-3">
                    <h4 className="font-bold text-white text-lg line-clamp-1">
                      {factory.itemData.name}
                    </h4>
                  </div>
                </div>
                
                <div className="p-4">
                  <p className="text-sm text-gray-600 mb-3 line-clamp-2 h-10">
                    {factory.itemData.description || 'Fabricante verificado'}
                  </p>
                  
                  {factory.itemData.address && (
                    <div className="bg-slate-50 rounded px-3 py-2 flex items-start gap-2">
                      <span className="text-slate-400 mt-0.5">üìç</span>
                      <p className="text-xs text-slate-600 line-clamp-2 font-medium">
                        {factory.itemData.address}
                      </p>
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div className="text-center py-12 bg-white rounded-xl">
            <p className="text-gray-500">No hay f√°bricas destacadas en este momento</p>
          </div>
        )}
      </section>

      {/* BENEFICIOS */}
      <section className="bg-gradient-to-br from-slate-900 to-slate-800 text-white py-16 mb-12">
        <div className="max-w-7xl mx-auto px-4">
          <h3 className="text-3xl font-black text-center mb-12">
            ¬øPor qu√© comprar en MayoristaMovil?
          </h3>
          
          <div className="grid md:grid-cols-4 gap-8">
            <div className="text-center">
              <div className="w-16 h-16 bg-blue-500 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4">
                üí∞
              </div>
              <h4 className="font-bold text-lg mb-2">Precios mayoristas</h4>
              <p className="text-gray-300 text-sm">
                Accedes a precios mayoristas directos de fabrica comprando pocas cantidades.
              </p>
            </div>
            
            <div className="text-center">
              <div className="w-16 h-16 bg-purple-500 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4">
                üöö
              </div>
              <h4 className="font-bold text-lg mb-2">Fabricas mas Importantes</h4>
              <p className="text-gray-300 text-sm">
                Tendras acceso a productos de las fabricas mas importantes y reconocidas del mercado.
              </p>
            </div>

            <div className="text-center">
              <div className="w-16 h-16 bg-green-500 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4">
                ‚úÖ
              </div>
              <h4 className="font-bold text-lg mb-2">F√°bricas Verificadas</h4>
              <p className="text-gray-300 text-sm">
                Puedes comprar de forma tranquila con nuestras fabricas verificadas.
              </p>
            </div>
            
            <div className="text-center">
              <div className="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4">
                üîí
              </div>
              <h4 className="font-bold text-lg mb-2">Mercado Pago</h4>
              <p className="text-gray-300 text-sm">
                Integracion directa de mercado pago para pagos y reembolsos completamente seguros.
              </p>
            </div>

            <div className="text-center">
              <div className="w-16 h-16 bg-purple-500 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4">
                üöö
              </div>
              <h4 className="font-bold text-lg mb-2">Env√≠o R√°pido</h4>
              <p className="text-gray-300 text-sm">
                Recib√≠ tu pedido en 24-72hs una vez que el lote se completa.
              </p>
            </div>
          </div>
        </div>
      </section>

      {/* FOOTER */}
      <footer className="bg-slate-900 text-white">
        <div className="max-w-7xl mx-auto px-4 py-12">
          <div className="grid md:grid-cols-4 gap-8 mb-8">
            <div>
              <h4 className="font-bold text-lg mb-4">Conocenos</h4>
              <ul className="space-y-2 text-gray-300">
                <li><Link href="/nosotros" className="hover:text-white transition">Sobre nosotros</Link></li>
                <li><Link href="/como-funciona" className="hover:text-white transition">C√≥mo funciona</Link></li>
                <li><Link href="/contacto" className="hover:text-white transition">Contacto</Link></li>
                <li><Link href="/blog" className="hover:text-white transition">Blog</Link></li>
              </ul>
            </div>
            
            <div>
              <h4 className="font-bold text-lg mb-4">Compradores</h4>
              <ul className="space-y-2 text-gray-300">
                <li><Link href="/como-comprar" className="hover:text-white transition">C√≥mo comprar</Link></li>
                <li><Link href="/mis-compras" className="hover:text-white transition">Mis compras</Link></li>
                <li><Link href="/preguntas-frecuentes" className="hover:text-white transition">Preguntas frecuentes</Link></li>
                <li><Link href="/politicas" className="hover:text-white transition">Pol√≠ticas de compra</Link></li>
              </ul>
            </div>
            
            <div>
              <h4 className="font-bold text-lg mb-4">Vendedores</h4>
              <ul className="space-y-2 text-gray-300">
                <li><Link href="/vender" className="hover:text-white transition">Vender en MayoristaMovil</Link></li>
                <li><Link href="/verificacion" className="hover:text-white transition">Verificaci√≥n de f√°brica</Link></li>
                <li><Link href="/dashboard/fabricante" className="hover:text-white transition">Panel de fabricante</Link></li>
                <li><Link href="/comisiones" className="hover:text-white transition">Comisiones y tarifas</Link></li>
              </ul>
            </div>
            
            <div>
              <h4 className="font-bold text-lg mb-4">Seguinos</h4>
              <div className="flex gap-4 mb-6">
                <a href="#" className="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center hover:bg-blue-700 transition">
                  f
                </a>
                <a href="#" className="w-10 h-10 bg-blue-400 rounded-lg flex items-center justify-center hover:bg-blue-500 transition">
                  t
                </a>
                <a href="#" className="w-10 h-10 bg-pink-600 rounded-lg flex items-center justify-center hover:bg-pink-700 transition">
                  i
                </a>
              </div>
              <h4 className="font-bold text-sm mb-2">Suscribite a nuestro newsletter</h4>
              <div className="flex gap-2">
                <input
                  type="email"
                  placeholder="Tu email"
                  className="flex-1 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 focus:border-blue-500 outline-none"
                />
                <button className="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 transition">
                  ‚Üí
                </button>
              </div>
            </div>
          </div>

          <div className="border-t border-slate-700 pt-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-800 rounded-lg flex items-center justify-center">
                <span className="text-xl font-black">M</span>
              </div>
              <div>
                <p className="font-bold">MayoristaMovil</p>
                <p className="text-xs text-gray-400">¬© 2025 Todos los derechos reservados</p>
              </div>
            </div>
            
            <div className="flex gap-6 text-sm text-gray-400">
              <Link href="/terminos" className="hover:text-white transition">T√©rminos y condiciones</Link>
              <Link href="/privacidad" className="hover:text-white transition">Privacidad</Link>
              <Link href="/cookies" className="hover:text-white transition">Cookies</Link>
            </div>
          </div>
        </div>
      </footer>

      {/* FLOATING ACTION BUTTON */}
      <button className="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-br from-blue-600 to-blue-700 text-white rounded-full shadow-2xl hover:shadow-blue-500/50 hover:scale-110 transition-all flex items-center justify-center text-2xl z-50">
        üí¨
      </button>

      <style jsx>{`
        @keyframes fade-in-up {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .animate-fade-in-up {
          animation: fade-in-up 0.6s ease-out forwards;
        }

        .scrollbar-hide::-webkit-scrollbar {
          display: none;
        }

        .scrollbar-hide {
          -ms-overflow-style: none;
          scrollbar-width: none;
        }

        .line-clamp-1 {
          display: -webkit-box;
          -webkit-line-clamp: 1;
          -webkit-box-orient: vertical;
          overflow: hidden;
        }

        .line-clamp-2 {
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
        }
      `}</style>
    </div>
  );
}
</file>

<file path="components/HomeRegistro.tsx">
// components/HomeRegistro.tsx - Landing Page con proceso unificado

"use client";

import Image from "next/image";
import Link from "next/link";
import { useEffect, useState } from "react";
import { useRouter } from 'next/navigation';

type FeaturedProduct = {
  id: string;
  itemId: string;
  metadata: {
    name: string;
  };
  itemData: {
    id: string;
    name: string;
    price: number;
    minimumOrder: number;
    category: string;
  };
};

type FeaturedFactory = {
  id: string;
  itemId: string;
  metadata: {
    name: string;
    description: string;
  };
  itemData: {
    id: string;
    name: string;
    description: string;
    address: string;
  };
};

export default function HomeRegistro() {
  const router = useRouter();
  const [featuredProducts, setFeaturedProducts] = useState<FeaturedProduct[]>([]);
  const [featuredFactories, setFeaturedFactories] = useState<FeaturedFactory[]>([]);
  const [loadingProducts, setLoadingProducts] = useState(true);
  const [loadingFactories, setLoadingFactories] = useState(true);

  // Cargar productos destacados
  useEffect(() => {
    async function loadFeaturedProducts() {
      try {
        const res = await fetch("/api/featured/active?type=product");
        if (res.ok) {
          const data = await res.json();
          setFeaturedProducts(data.items || []);
        }
      } catch (error) {
        console.error("Error cargando productos destacados:", error);
      } finally {
        setLoadingProducts(false);
      }
    }

    loadFeaturedProducts();
  }, []);

  // Cargar f√°bricas destacadas
  useEffect(() => {
    async function loadFeaturedFactories() {
      try {
        const res = await fetch("/api/featured/active?type=factory");
        if (res.ok) {
          const data = await res.json();
          setFeaturedFactories(data.items || []);
        }
      } catch (error) {
        console.error("Error cargando f√°bricas destacadas:", error);
      } finally {
        setLoadingFactories(false);
      }
    }

    loadFeaturedFactories();
  }, []);

  // Funci√≥n para redirigir al login con el rol guardado en localStorage
  const handleRoleSelection = (role: 'retailer' | 'manufacturer') => {
    localStorage.setItem('selectedRole', role);
    router.push('/login');
  };

  return (
    <main className="min-h-screen bg-slate-50 text-slate-900">
      
      {/* HERO - Profesional */}
      <section className="relative min-h-screen flex items-center justify-center">
        <Image
          src="/hero.jpeg"
          alt="Mayorista M√≥vil"
          fill
          priority
          className="object-cover brightness-[0.35]"
        />

        <div className="absolute inset-0 bg-gradient-to-b from-slate-900/60 via-slate-900/40 to-slate-900/80 z-[1]"></div>

        <div className="relative z-10 max-w-7xl mx-auto px-8 text-center mt-16">
          <h1 className="text-5xl md:text-7xl font-bold tracking-tight mb-10 leading-tight">
            <span className="block text-white drop-shadow-2xl mb-2">
              Compr√° y vend√© a precios de fabrica,
            </span>
            <span className="block text-blue-400 drop-shadow-2xl">
              incluso sin llegar al m√≠nimo
            </span>
          </h1>

          {/* Botones de registro por rol */}
          <div className="flex flex-col sm:flex-row gap-6 justify-center items-center max-w-2xl mx-auto mb-8">
            <button
              onClick={() => handleRoleSelection('retailer')}
              className="w-full sm:w-auto px-10 py-5 bg-blue-600 hover:bg-blue-700 text-white text-xl font-bold rounded-xl transition-all transform hover:scale-105 shadow-2xl flex items-center justify-center gap-3"
            >
              <span className="text-2xl">üõí</span>
              Soy Revendedor
            </button>
            
            <button
              onClick={() => handleRoleSelection('manufacturer')}
              className="w-full sm:w-auto px-10 py-5 bg-amber-600 hover:bg-amber-700 text-white text-xl font-bold rounded-xl transition-all transform hover:scale-105 shadow-2xl flex items-center justify-center gap-3"
            >
              <span className="text-2xl">üè≠</span>
              Soy Fabricante
            </button>
          </div>

          <p className="text-sm text-slate-300 mb-4">
            ¬øYa ten√©s cuenta? <Link href="/login" className="text-blue-400 hover:text-blue-300 underline font-semibold">Inici√° sesi√≥n</Link>
          </p>
        </div>
      </section>

      {/* PRODUCTOS DESTACADOS */}
      {!loadingProducts && featuredProducts.length > 0 && (
        <section className="py-28 bg-white">
          <div className="max-w-7xl mx-auto px-8">
            <div className="max-w-3xl mb-20">
              <div className="mb-6">
                <span className="inline-block bg-amber-100 text-amber-800 px-4 py-1.5 rounded-md text-sm font-semibold tracking-wide uppercase">
                  Selecci√≥n destacada
                </span>
              </div>
              <h2 className="text-4xl md:text-5xl font-bold text-slate-900 mb-6 leading-tight">
                Productos Destacados
              </h2>
              <p className="text-lg text-slate-600 leading-relaxed">
                Descubr√≠ los productos m√°s solicitados del momento, seleccionados por su calidad, precio competitivo y disponibilidad inmediata.
              </p>
            </div>

            <div className="grid md:grid-cols-2 lg:grid-cols-5 gap-6">
              {featuredProducts.slice(0, 10).map((item) => (
                <Link
                  key={item.id}
                  href={`/explorar/${item.itemData.id}`}
                  className="bg-white rounded-lg border border-slate-200 hover:border-blue-400 hover:shadow-xl transition-all duration-300 p-6 group"
                >
                  <div className="mb-4">
                    <span className="inline-block bg-amber-500 text-white text-xs px-3 py-1 rounded font-semibold uppercase tracking-wide shadow-sm">
                      Destacado
                    </span>
                  </div>

                  <h3 className="font-semibold text-lg mb-3 group-hover:text-blue-600 transition line-clamp-2 min-h-[3.5rem] text-slate-900">
                    {item.itemData.name}
                  </h3>

                  <p className="text-sm text-slate-500 mb-4 uppercase tracking-wide font-medium">
                    {item.itemData.category}
                  </p>

                  <div className="border-t border-slate-100 pt-4 mb-4">
                    <p className="text-blue-700 font-bold text-2xl">
                      ${item.itemData.price.toLocaleString("es-AR")}
                    </p>
                    <p className="text-xs text-slate-500 mt-1">
                      Precio por unidad
                    </p>
                  </div>

                  <div className="bg-slate-50 rounded px-3 py-2 mb-4">
                    <p className="text-xs text-slate-600">
                      <span className="font-semibold">Pedido m√≠nimo:</span> {item.itemData.minimumOrder} unidades
                    </p>
                  </div>

                  <div className="text-blue-600 font-semibold text-sm group-hover:underline flex items-center justify-between">
                    <span>Ver detalles</span>
                    <span className="group-hover:translate-x-1 transition-transform">‚Üí</span>
                  </div>
                </Link>
              ))}
            </div>
          </div>
        </section>
      )}

      {/* F√ÅBRICAS DESTACADAS */}
      {!loadingFactories && featuredFactories.length > 0 && (
        <section className="py-28 bg-slate-50">
          <div className="max-w-7xl mx-auto px-8">
            <div className="max-w-3xl mb-20">
              <div className="mb-6">
                <span className="inline-block bg-blue-100 text-blue-800 px-4 py-1.5 rounded-md text-sm font-semibold tracking-wide uppercase">
                  Red de fabricantes
                </span>
              </div>
              <h2 className="text-4xl md:text-5xl font-bold text-slate-900 mb-6 leading-tight">
                F√°bricas Destacadas
              </h2>
              <p className="text-lg text-slate-600 leading-relaxed">
                Trabajamos con los fabricantes m√°s confiables de la regi√≥n, garantizando calidad, transparencia y cumplimiento en cada transacci√≥n.
              </p>
            </div>

            <div className="grid md:grid-cols-2 lg:grid-cols-5 gap-6">
              {featuredFactories.slice(0, 10).map((item) => (
                <div
                  key={item.id}
                  className="bg-white rounded-lg border border-slate-200 hover:border-blue-400 hover:shadow-xl transition-all duration-300 p-6"
                >
                  <div className="mb-4">
                    <span className="inline-block bg-blue-600 text-white text-xs px-3 py-1 rounded font-semibold uppercase tracking-wide shadow-sm">
                      Verificada
                    </span>
                  </div>

                  <h3 className="font-semibold text-lg mb-3 min-h-[3.5rem] text-slate-900">
                    {item.itemData.name}
                  </h3>

                  {item.itemData.description && (
                    <p className="text-sm text-slate-600 mb-4 line-clamp-3 leading-relaxed min-h-[4rem]">
                      {item.itemData.description}
                    </p>
                  )}

                  {item.itemData.address && (
                    <div className="bg-slate-50 rounded px-3 py-2 flex items-start gap-2">
                      <span className="text-slate-400 mt-0.5">üìç</span>
                      <p className="text-xs text-slate-600 line-clamp-2 font-medium">
                        {item.itemData.address}
                      </p>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        </section>
      )}

      {/* BENEFICIOS MEJORADOS */}
      <section className="py-28 bg-white">
        <div className="max-w-7xl mx-auto px-8">
          <div className="max-w-3xl mx-auto text-center mb-20">
            <h2 className="text-4xl md:text-5xl font-bold mb-6 text-slate-900 leading-tight">
              Beneficios de usar Mayorista M√≥vil
            </h2>
            <p className="text-lg text-slate-600 leading-relaxed">
              Una plataforma dise√±ada para maximizar el valor tanto para revendedores como para fabricantes, sin costos ocultos ni comisiones.
            </p>
          </div>

          <div className="grid md:grid-cols-2 gap-10 max-w-6xl mx-auto">
            
            {/* Para revendedores */}
            <div className="bg-gradient-to-br from-slate-50 to-blue-50 rounded-2xl border-2 border-slate-200 p-10 hover:border-blue-400 transition-all">
              <div className="mb-8 pb-6 border-b border-slate-200">
                <div className="flex items-center gap-4 mb-4">
                  <div className="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                    <span className="text-2xl">üõí</span>
                  </div>
                  <h3 className="text-2xl font-bold text-slate-900">
                    Para revendedores
                  </h3>
                </div>
                <p className="text-slate-600">Compra inteligente al por mayor</p>
              </div>

              <ul className="space-y-5">
                <li className="flex items-start gap-4">
                  <div className="w-6 h-6 bg-blue-600 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-sm font-bold">‚úì</span>
                  </div>
                  <div>
                    <p className="font-semibold text-slate-900 mb-1">Precios de f√°brica con/sin intermediarios</p>
                    <p className="text-sm text-slate-600">‚Ä¢ Acced√© directamente a los mejores precios mayoristas, eliminando intermediarios y aumentando tu margen de ganancia</p>
                    <p className="text-sm text-slate-600">‚Ä¢ La plataforma puede funcionar como intermediario en algunos casos donde la fabrica todavia no a publicado sus productos</p>
                  </div>
                </li>
                <li className="flex items-start gap-4">
                  <div className="w-6 h-6 bg-blue-600 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-sm font-bold">‚úì</span>
                  </div>
                  <div>
                    <p className="font-semibold text-slate-900 mb-1">Compras desde 10 unidades</p>
                    <p className="text-sm text-slate-600">Unite a otros compradores para alcanzar el m√≠nimo de f√°brica. No necesit√°s comprar todo el lote vos solo</p>
                  </div>
                </li>
                <li className="flex items-start gap-4">
                  <div className="w-6 h-6 bg-blue-600 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-sm font-bold">‚úì</span>
                  </div>
                  <div>
                    <p className="font-semibold text-slate-900 mb-1">Sin gran inversi√≥n inicial</p>
                    <p className="text-sm text-slate-600">Empez√° o expand√≠ tu negocio sin necesidad de invertir miles de pesos en stock que tal vez no vendas</p>
                  </div>
                </li>
                <li className="flex items-start gap-4">
                  <div className="w-6 h-6 bg-blue-600 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-sm font-bold">‚úì</span>
                  </div>
                  <div>
                    <p className="font-semibold text-slate-900 mb-1">Reembolso disponible</p>
                    <p className="text-sm text-slate-600">Mientras el lote est√© en progreso, pod√©s solicitar reembolso total de tu dinero si cambi√°s de opini√≥n</p>
                  </div>
                </li>
                <li className="flex items-start gap-4 bg-blue-600 rounded-xl p-5 mt-6">
                  <div className="w-6 h-6 bg-white rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-blue-600 text-sm font-bold">‚úì</span>
                  </div>
                  <div>
                    <p className="font-bold text-white text-lg">
                      Todo por 0% de comisi√≥n
                    </p>
                  </div>
                </li>
              </ul>
            </div>

            {/* Para fabricantes */}
            <div className="bg-gradient-to-br from-slate-50 to-blue-50 rounded-2xl border-2 border-slate-200 p-10 hover:border-blue-400 transition-all">
              <div className="mb-8 pb-6 border-b border-slate-200">
                <div className="flex items-center gap-4 mb-4">
                  <div className="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                    <span className="text-2xl">üè≠</span>
                  </div>
                  <h3 className="text-2xl font-bold text-slate-900">
                    Para fabricantes
                  </h3>
                </div>
                <p className="text-slate-600">Venta directa y eficiente</p>
              </div>

              <ul className="space-y-5">
                <li className="flex items-start gap-4">
                  <div className="w-6 h-6 bg-blue-600 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-sm font-bold">‚úì</span>
                  </div>
                  <div>
                    <p className="font-semibold text-slate-900 mb-1">Nuevo mercado de pedidos fraccionados</p>
                    <p className="text-sm text-slate-600">Acced√© a compradores que antes no alcanzaban tu m√≠nimo. Convert√≠ consultas perdidas en ventas reales</p>
                  </div>
                </li>
                <li className="flex items-start gap-4">
                  <div className="w-6 h-6 bg-blue-600 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-sm font-bold">‚úì</span>
                  </div>
                  <div>
                    <p className="font-semibold text-slate-900 mb-1">Nosotros gestionamos la log√≠stica</p>
                    <p className="text-sm text-slate-600">En pedidos fraccionados, nosotros nos encargamos del env√≠o y separaci√≥n. Vos solo despach√°s como siempre</p>
                  </div>
                </li>
                <li className="flex items-start gap-4">
                  <div className="w-6 h-6 bg-blue-600 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-sm font-bold">‚úì</span>
                  </div>
                  <div>
                    <p className="font-semibold text-slate-900 mb-1">Pago seguro y garantizado</p>
                    <p className="text-sm text-slate-600">El dinero se retiene hasta que se completa el lote. Una vez cerrado, se libera autom√°ticamente</p>
                  </div>
                </li>
                <li className="flex items-start gap-4">
                  <div className="w-6 h-6 bg-blue-600 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-white text-sm font-bold">‚úì</span>
                  </div>
                  <div>
                    <p className="font-semibold text-slate-900 mb-1">Vend√©s sin cambiar tu operaci√≥n</p>
                    <p className="text-sm text-slate-600">Segu√≠s fabricando y despachando como siempre, sin modificar tus procesos actuales</p>
                  </div>
                </li>
                <li className="flex items-start gap-4 bg-blue-600 rounded-xl p-5 mt-6">
                  <div className="w-6 h-6 bg-white rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                    <span className="text-blue-600 text-sm font-bold">‚úì</span>
                  </div>
                  <div>
                    <p className="font-bold text-white text-lg">
                      Todo por 0% de comisi√≥n
                    </p>
                  </div>
                </li>
              </ul>
            </div>

          </div>
        </div>
      </section>

      {/* C√ìMO FUNCIONA - T√≠tulo profesional */}
      <section className="py-20 bg-slate-900 text-white">
        <div className="max-w-7xl mx-auto px-8">
          <div className="max-w-3xl mx-auto text-center">
            <h2 className="text-4xl md:text-5xl font-bold mb-6 leading-tight">
              ¬øC√≥mo funciona paso a paso?
            </h2>
            <p className="text-lg text-slate-300 leading-relaxed">
              Un proceso transparente y seguro dise√±ado para simplificar las operaciones mayoristas
            </p>
          </div>
        </div>
      </section>

      {/* PARA REVENDEDORES - PROCESO UNIFICADO EN UN SOLO RECUADRO */}
      <section className="py-28 bg-slate-50">
        <div className="max-w-7xl mx-auto px-8">
          <div className="max-w-3xl mb-12">
            <div className="mb-6">
              <span className="inline-block bg-slate-900 text-white px-4 py-1.5 rounded-md text-sm font-semibold tracking-wide uppercase">
                Proceso completo para revendedores
              </span>
            </div>
            <h3 className="text-3xl md:text-4xl font-bold mb-4 text-slate-900">
              Del registro a recibir tu producto
            </h3>
            <p className="text-lg text-slate-600">
              Te explicamos todo el proceso desde que te registr√°s hasta que recib√≠s tu mercader√≠a
            </p>
          </div>

          {/* CONTENEDOR UNIFICADO CON TODOS LOS PASOS */}
          <div className="bg-white rounded-3xl border-2 border-slate-200 p-8 md:p-12 shadow-xl hover:border-blue-400 transition-all">
            
            <div className="space-y-12">
              
              {/* PASO 1 */}
              <div className="flex items-start gap-6 relative">
                {/* L√≠nea vertical conectora */}
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-blue-400 to-purple-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    1
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üìù</span>
                    <h4 className="font-bold text-2xl text-slate-900">Registrate en la plataforma</h4>
                  </div>
                  <div className="space-y-3 text-slate-600">
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Hac√© clic en "Soy Revendedor"</span> arriba en los botones azules
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Inici√° sesi√≥n con Google</span> (recomendado - es instant√°neo) o cre√° una cuenta con tu email
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Complet√° tu perfil</span> con tu direcci√≥n de entrega (la necesitamos para enviarte los productos)
                    </p>
                    <div className="bg-blue-50 border-l-4 border-blue-600 p-4 mt-4 rounded">
                      <p className="text-sm font-semibold text-blue-900">üí° ¬°Listo! Ya pod√©s empezar a comprar. No se cobra nada por registrarte.</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* PASO 2 */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-purple-400 to-indigo-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    2
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üîç</span>
                    <h4 className="font-bold text-2xl text-slate-900">Encontr√° el producto que necesit√°s</h4>
                  </div>
                  <div className="space-y-3 text-slate-600">
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Explor√° por categor√≠as</span> (Indumentaria, Electr√≥nica, Hogar, etc.)
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Us√° el buscador</span> para encontrar productos espec√≠ficos
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Mir√° el precio por unidad</span> y el pedido m√≠nimo de cada producto
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Verific√° la barra de progreso</span> para ver cu√°ntas unidades faltan para completar el lote
                    </p>
                  </div>
                </div>
              </div>

              {/* PASO 3 */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-indigo-400 to-green-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    3
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üéØ</span>
                    <h4 className="font-bold text-2xl text-slate-900">Eleg√≠ c√≥mo comprar</h4>
                  </div>
                  <div className="space-y-4">
                    <div className="bg-blue-50 rounded-xl p-5 border-2 border-blue-200">
                      <p className="font-bold text-blue-900 mb-2 text-lg">üì¶ Compra Fraccionada (Recomendado)</p>
                      <p className="text-slate-700 mb-2">Compr√°s desde <span className="font-bold">10 unidades</span> (menos que el m√≠nimo de f√°brica)</p>
                      <p className="text-sm text-slate-600">‚úì Te un√≠s a un lote con otros compradores</p>
                      <p className="text-sm text-slate-600">‚úì Cuando se completa el m√≠nimo, se despacha para todos</p>
                      <p className="text-sm text-slate-600">‚úì Pod√©s pedir reembolso mientras el lote est√© en progreso</p>
                    </div>
                    <div className="bg-slate-50 rounded-xl p-5 border-2 border-slate-200">
                      <p className="font-bold text-slate-900 mb-2 text-lg">üè≠ Compra Directa</p>
                      <p className="text-slate-700 mb-2">Compr√°s el pedido m√≠nimo completo (ej: 100 unidades)</p>
                      <p className="text-sm text-slate-600">‚úì Despacho inmediato</p>
                      <p className="text-sm text-slate-600">‚úì La f√°brica gestiona el env√≠o directamente</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* PASO 4 */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-green-400 to-orange-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    4
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üí≥</span>
                    <h4 className="font-bold text-2xl text-slate-900">Pag√° de forma segura</h4>
                  </div>
                  <div className="space-y-3 text-slate-600">
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Pag√° con MercadoPago</span> (tarjeta de cr√©dito, d√©bito, efectivo en Rapipago/PagoF√°cil)
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Tu dinero est√° protegido</span> por MercadoPago hasta que se complete el lote
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ En compras fraccionadas:</span> el pago se retiene hasta que el lote alcanza el m√≠nimo
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ En compras directas:</span> el pago se libera apenas confirm√°s la compra
                    </p>
                    <div className="bg-green-50 border-l-4 border-green-600 p-4 mt-4 rounded">
                      <p className="text-sm font-semibold text-green-900">üîí Pago 100% seguro con MercadoPago - Plataforma l√≠der en Argentina</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* PASO 5 */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-orange-400 to-teal-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    5
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">‚è≥</span>
                    <h4 className="font-bold text-2xl text-slate-900">Esper√° a que se complete el lote</h4>
                    <span className="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-semibold">Solo en compras fraccionadas</span>
                  </div>
                  <div className="space-y-3 text-slate-600">
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Segu√≠ el progreso en tiempo real</span> desde tu panel de compras
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Recibir√°s notificaciones</span> cuando otros compradores se unan al lote
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Cuando el lote alcanza el m√≠nimo:</span> se cierra autom√°ticamente y comienza el despacho
                    </p>
                    <div className="bg-orange-50 border-l-4 border-orange-600 p-4 mt-4 rounded">
                      <p className="text-sm font-semibold text-orange-900 mb-2">üí° ¬øCambiaste de opini√≥n?</p>
                      <p className="text-sm text-orange-800">Pod√©s solicitar reembolso del 100% de tu dinero mientras el lote est√© en progreso. Una vez cerrado el lote, ya no se puede cancelar.</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* PASO 6 */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-teal-400 to-pink-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-teal-500 to-teal-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    6
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">‚úÖ</span>
                    <h4 className="font-bold text-2xl text-slate-900">El lote se completa y cierra</h4>
                  </div>
                  <div className="space-y-3 text-slate-600">
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Se alcanz√≥ el m√≠nimo de f√°brica:</span> el lote se cierra autom√°ticamente
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Los pagos se liberan:</span> el dinero pasa de estar retenido a la f√°brica
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Ya no se aceptan m√°s pedidos</span> para este lote
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Ya no pod√©s solicitar reembolso</span> (tu compra est√° confirmada)
                    </p>
                    <div className="bg-teal-50 border-l-4 border-teal-600 p-4 mt-4 rounded">
                      <p className="text-sm font-semibold text-teal-900">üéâ ¬°Tu compra est√° confirmada! Ahora comienza el proceso de despacho</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* PASO 7 */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-pink-400 to-cyan-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-pink-500 to-pink-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    7
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üì¶</span>
                    <h4 className="font-bold text-2xl text-slate-900">La f√°brica prepara tu pedido</h4>
                  </div>
                  <div className="space-y-3 text-slate-600">
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ La f√°brica recibe la orden completa</span> con todos los pedidos del lote
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Prepara la mercader√≠a</span> de todos los compradores
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ En compras directas:</span> la f√°brica te contacta para coordinar el env√≠o
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ En compras fraccionadas:</span> nosotros coordinamos con la f√°brica
                    </p>
                  </div>
                </div>
              </div>

              {/* PASO 8 */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-cyan-400 to-emerald-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    8
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üöö</span>
                    <h4 className="font-bold text-2xl text-slate-900">Env√≠o y seguimiento</h4>
                  </div>
                  <div className="space-y-4">
                    <div className="bg-blue-50 rounded-xl p-5 border-2 border-blue-200">
                      <p className="font-bold text-blue-900 mb-2">üì¶ Compras Fraccionadas con Env√≠o:</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ Nosotros gestionamos todo el env√≠o</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ Separamos las cantidades de cada comprador</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ Coordinamos la log√≠stica</p>
                      <p className="text-sm text-slate-700">‚Ä¢ Recib√≠s c√≥digo de seguimiento</p>
                    </div>
                    <div className="bg-green-50 rounded-xl p-5 border-2 border-green-200">
                      <p className="font-bold text-green-900 mb-2">üè™ Compras Fraccionadas con Retiro:</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ Retir√°s directamente de la f√°brica</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ Te contactamos para coordinar</p>
                      <p className="text-sm text-slate-700">‚Ä¢ Sin costo de env√≠o</p>
                    </div>
                    <div className="bg-slate-50 rounded-xl p-5 border-2 border-slate-200">
                      <p className="font-bold text-slate-900 mb-2">üè≠ Compras Directas:</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ La f√°brica gestiona el env√≠o directamente</p>
                      <p className="text-sm text-slate-700">‚Ä¢ Coordin√°s con ellos fechas y modalidad</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* PASO 9 - FINAL */}
              <div className="flex items-start gap-6">
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-emerald-500 to-green-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg animate-pulse">
                    9
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üéÅ</span>
                    <h4 className="font-bold text-2xl text-emerald-600">¬°Recib√≠s tu producto!</h4>
                  </div>
                  <div className="space-y-3 text-slate-600">
                    <p className="leading-relaxed text-lg">
                      <span className="font-semibold text-slate-900">‚Ä¢ Tiempo de entrega:</span> Entre 24-72 horas h√°biles desde el cierre del lote
                    </p>
                    <p className="leading-relaxed text-lg">
                      <span className="font-semibold text-slate-900">‚Ä¢ Verific√° tu pedido:</span> Revis√° que todo est√© correcto (cantidad, calidad)
                    </p>
                    <p className="leading-relaxed text-lg">
                      <span className="font-semibold text-slate-900">‚Ä¢ ¬øAlg√∫n problema?</span> Contactanos desde tu panel de compras
                    </p>
                    <div className="bg-gradient-to-r from-emerald-500 to-green-600 border-l-4 border-emerald-700 p-5 mt-4 rounded-xl shadow-lg">
                      <p className="text-lg font-bold text-white">üéâ ¬°Felicitaciones! Ya ten√©s tu mercader√≠a a precio de f√°brica lista para revender</p>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </section>

      {/* PARA FABRICANTES - PROCESO COMPLETO DETALLADO EN UN SOLO RECUADRO */}
      <section className="py-28 bg-white">
        <div className="max-w-7xl mx-auto px-8">
          <div className="max-w-3xl mb-12">
            <div className="mb-6">
              <span className="inline-block bg-slate-900 text-white px-4 py-1.5 rounded-md text-sm font-semibold tracking-wide uppercase">
                Proceso completo para fabricantes
              </span>
            </div>
            <h3 className="text-3xl md:text-4xl font-bold mb-4 text-slate-900">
              Del registro a vender tus productos
            </h3>
            <p className="text-lg text-slate-600">
              Te explicamos todo el proceso desde que te registr√°s hasta que despach√°s tu mercader√≠a
            </p>
          </div>

          {/* CONTENEDOR UNIFICADO CON TODOS LOS PASOS PARA FABRICANTES */}
          <div className="bg-white rounded-3xl border-2 border-slate-200 p-8 md:p-12 shadow-xl hover:border-amber-400 transition-all">
            
            <div className="space-y-12">
              
              {/* PASO 1 - REGISTRO Y VERIFICACI√ìN */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-amber-400 to-orange-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    1
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üìù</span>
                    <h4 className="font-bold text-2xl text-slate-900">Registrate y verific√° tu f√°brica</h4>
                  </div>
                  <div className="space-y-3 text-slate-600">
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Hac√© clic en "Soy Fabricante"</span> arriba en los botones naranjas
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Inici√° sesi√≥n con Google</span> (recomendado) o cre√° una cuenta con tu email
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Complet√° el proceso de verificaci√≥n:</span> carg√° tu CUIT, constancia de AFIP, datos fiscales y direcci√≥n de tu f√°brica
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Esper√° aprobaci√≥n:</span> nuestro equipo verifica tu documentaci√≥n en 24-48 horas h√°biles
                    </p>
                    <div className="bg-amber-50 border-l-4 border-amber-600 p-4 mt-4 rounded">
                      <p className="text-sm font-semibold text-amber-900 mb-2">üîí ¬øPor qu√© verificamos?</p>
                      <p className="text-sm text-amber-800">La verificaci√≥n garantiza confianza a los compradores y asegura que solo fabricantes legales operen en la plataforma.</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* PASO 2 - PUBLICAR PRODUCTOS */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-orange-400 to-red-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    2
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üì¶</span>
                    <h4 className="font-bold text-2xl text-slate-900">Public√° tus productos</h4>
                  </div>
                  <div className="space-y-3 text-slate-600">
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ And√° a tu panel de fabricante</span> y hac√© clic en "Nuevo Producto"
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Carg√° la informaci√≥n del producto:</span> nombre, descripci√≥n, categor√≠a, precio por unidad
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Defin√≠ tu pedido m√≠nimo:</span> la cantidad m√≠nima que necesit√°s para despachar (ej: 100 unidades)
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Habilit√° los m√©todos de compra:</span>
                    </p>
                    <div className="ml-6 space-y-2">
                      <div className="flex items-start gap-2">
                        <span className="text-blue-600 font-bold">‚úì</span>
                        <p className="text-sm"><span className="font-semibold text-slate-900">Compra Directa:</span> el comprador paga el m√≠nimo completo y vos gestion√°s el env√≠o</p>
                      </div>
                      <div className="flex items-start gap-2">
                        <span className="text-blue-600 font-bold">‚úì</span>
                        <p className="text-sm"><span className="font-semibold text-slate-900">Compra Fraccionada con Env√≠o:</span> nosotros gestionamos el env√≠o y separaci√≥n</p>
                      </div>
                      <div className="flex items-start gap-2">
                        <span className="text-blue-600 font-bold">‚úì</span>
                        <p className="text-sm"><span className="font-semibold text-slate-900">Compra Fraccionada con Retiro:</span> el comprador retira de tu f√°brica</p>
                      </div>
                    </div>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Carg√° informaci√≥n de env√≠o:</span> m√©todos disponibles, costos, tiempos de preparaci√≥n
                    </p>
                    <div className="bg-orange-50 border-l-4 border-orange-600 p-4 mt-4 rounded">
                      <p className="text-sm font-semibold text-orange-900">üí° Pod√©s habilitar las 3 opciones simult√°neamente para maximizar ventas</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* PASO 3 - RECIBIR PEDIDOS */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-red-400 to-purple-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-red-500 to-red-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    3
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üõí</span>
                    <h4 className="font-bold text-2xl text-slate-900">Los compradores compran tus productos</h4>
                  </div>
                  <div className="space-y-4">
                    <p className="leading-relaxed text-slate-600">
                      <span className="font-semibold text-slate-900">Los revendedores encuentran tu producto</span> en la plataforma y realizan pedidos
                    </p>
                    
                    <div className="bg-blue-50 rounded-xl p-5 border-2 border-blue-200">
                      <p className="font-bold text-blue-900 mb-3">üì¶ En Compras Directas:</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ El comprador paga el m√≠nimo completo</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ El pago se libera inmediatamente a tu cuenta de MercadoPago</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ Recib√≠s notificaci√≥n instant√°nea</p>
                      <p className="text-sm text-slate-700">‚Ä¢ Pod√©s empezar a preparar el pedido de inmediato</p>
                    </div>

                    <div className="bg-purple-50 rounded-xl p-5 border-2 border-purple-200">
                      <p className="font-bold text-purple-900 mb-3">üß© En Compras Fraccionadas:</p>
                      <p className="text-sm text-slate-700 mb-2">‚Ä¢ Los compradores compran cantidades menores a tu m√≠nimo (desde 10 unidades)</p>
                      <p className="text-sm text-slate-700 mb-2">‚Ä¢ Cada compra se suma a un "lote" hasta alcanzar tu m√≠nimo</p>
                      <p className="text-sm text-slate-700 mb-2">‚Ä¢ El dinero se retiene en MercadoPago hasta que el lote se complete</p>
                      <p className="text-sm text-slate-700 mb-2">‚Ä¢ Segu√≠s el progreso en tiempo real desde tu panel</p>
                      <p className="text-sm text-slate-700 font-semibold">‚Ä¢ Ejemplo: Tu m√≠nimo es 100 unidades</p>
                      <div className="ml-4 mt-2 space-y-1">
                        <p className="text-xs text-slate-600">- Comprador A: 15 unidades ‚Üí Lote: 15/100</p>
                        <p className="text-xs text-slate-600">- Comprador B: 25 unidades ‚Üí Lote: 40/100</p>
                        <p className="text-xs text-slate-600">- Comprador C: 30 unidades ‚Üí Lote: 70/100</p>
                        <p className="text-xs text-slate-600">- Comprador D: 30 unidades ‚Üí Lote: 100/100 ‚úÖ ¬°COMPLETO!</p>
                      </div>
                    </div>

                    <div className="bg-red-50 border-l-4 border-red-600 p-4 rounded">
                      <p className="text-sm font-semibold text-red-900 mb-2">‚ö†Ô∏è Importante sobre pagos retenidos:</p>
                      <p className="text-sm text-red-800">Los compradores pueden pedir reembolso mientras el lote est√© en progreso. Una vez que se completa el m√≠nimo, el dinero se libera autom√°ticamente y ya no hay reembolsos posibles.</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* PASO 4 - CIERRE DEL LOTE */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-purple-400 to-green-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    4
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">‚úÖ</span>
                    <h4 className="font-bold text-2xl text-slate-900">El lote se completa y se libera el pago</h4>
                    <span className="text-sm bg-purple-100 text-purple-800 px-3 py-1 rounded-full font-semibold">Solo en fraccionadas</span>
                  </div>
                  <div className="space-y-3 text-slate-600">
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Se alcanz√≥ tu m√≠nimo de f√°brica:</span> el lote se cierra autom√°ticamente
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Los pagos se liberan:</span> el dinero de todos los compradores se transfiere a tu cuenta de MercadoPago
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Recib√≠s notificaci√≥n por email y en la plataforma</span> con el detalle de todos los pedidos
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Ya no se aceptan m√°s pedidos</span> para este lote espec√≠fico
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Se crea una orden de despacho</span> con todas las cantidades de cada comprador
                    </p>
                    <div className="bg-purple-50 border-l-4 border-purple-600 p-4 mt-4 rounded">
                      <p className="text-sm font-semibold text-purple-900">üí∞ El dinero es 100% tuyo - No cobramos comisi√≥n</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* PASO 5 - PREPARAR PEDIDO */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-green-400 to-blue-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    5
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üì¶</span>
                    <h4 className="font-bold text-2xl text-slate-900">Prepar√°s el pedido</h4>
                  </div>
                  <div className="space-y-3 text-slate-600">
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Revis√°s la orden en tu panel:</span> vas a ver el detalle de cantidades por cada comprador
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Prepar√°s la mercader√≠a total del lote</span> (tu m√≠nimo o m√°s)
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ No necesit√°s separar pedidos:</span> despach√°s todo junto como siempre
                    </p>
                    <div className="bg-green-50 border-l-4 border-green-600 p-4 mt-4 rounded">
                      <p className="text-sm font-semibold text-green-900 mb-2">üí° ¬øTengo que empaquetar por separado cada pedido?</p>
                      <p className="text-sm text-green-800"><span className="font-bold">No.</span> En pedidos fraccionados con env√≠o, vos despach√°s todo el lote completo a nuestra direcci√≥n y nosotros nos encargamos de separar y enviar a cada comprador. Vos solo fabric√°s y despach√°s como siempre.</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* PASO 6 - DESPACHO */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-blue-400 to-teal-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    6
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üöö</span>
                    <h4 className="font-bold text-2xl text-slate-900">Despach√°s seg√∫n el tipo de compra</h4>
                  </div>
                  <div className="space-y-4">
                    <div className="bg-blue-50 rounded-xl p-5 border-2 border-blue-200">
                      <p className="font-bold text-blue-900 mb-3">üè≠ Compra Directa:</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ Vos gestion√°s el env√≠o directamente con el comprador</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ Coordin√°s m√©todo, fecha y direcci√≥n</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ Envi√°s la mercader√≠a al comprador</p>
                      <p className="text-sm text-slate-700">‚Ä¢ Actualiz√°s el estado en tu panel</p>
                    </div>

                    <div className="bg-indigo-50 rounded-xl p-5 border-2 border-indigo-200">
                      <p className="font-bold text-indigo-900 mb-3">üì¶ Compra Fraccionada con Env√≠o:</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ <span className="font-semibold">Nosotros coordinamos el retiro</span> de la mercader√≠a de tu f√°brica</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ Despach√°s todo el lote completo a nuestra direcci√≥n/dep√≥sito</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ <span className="font-semibold">Nosotros separamos</span> las cantidades de cada comprador</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ <span className="font-semibold">Nosotros enviamos</span> a cada comprador individual</p>
                      <p className="text-sm text-slate-700">‚Ä¢ Sin costo extra para vos - es parte del servicio</p>
                    </div>

                    <div className="bg-green-50 rounded-xl p-5 border-2 border-green-200">
                      <p className="font-bold text-green-900 mb-3">üè™ Compra Fraccionada con Retiro:</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ Los compradores retiran de tu f√°brica en horario coordinado</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ Vos prepar√°s los paquetes individuales</p>
                      <p className="text-sm text-slate-700 mb-1">‚Ä¢ Te contactamos con fechas estimadas de retiro</p>
                      <p className="text-sm text-slate-700">‚Ä¢ Cada comprador retira solo su cantidad</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* PASO 7 - NOTIFICACI√ìN AL COMPRADOR */}
              <div className="flex items-start gap-6 relative">
                <div className="absolute left-8 top-20 bottom-0 w-0.5 bg-gradient-to-b from-teal-400 to-cyan-400"></div>
                
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-teal-500 to-teal-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg">
                    7
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üìß</span>
                    <h4 className="font-bold text-2xl text-slate-900">Los compradores reciben su mercader√≠a</h4>
                  </div>
                  <div className="space-y-3 text-slate-600">
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Los compradores reciben notificaci√≥n</span> cuando su pedido est√° en camino
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ En compras fraccionadas con env√≠o:</span> reciben c√≥digo de seguimiento
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Tiempo de entrega:</span> 24-72 horas desde el despacho
                    </p>
                    <p className="leading-relaxed">
                      <span className="font-semibold text-slate-900">‚Ä¢ Los compradores confirman recepci√≥n</span> en la plataforma
                    </p>
                    <div className="bg-teal-50 border-l-4 border-teal-600 p-4 mt-4 rounded">
                      <p className="text-sm font-semibold text-teal-900">üí° Toda comunicaci√≥n est√° centralizada en la plataforma para tu tranquilidad</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* PASO 8 - CICLO COMPLETO */}
              <div className="flex items-start gap-6">
                <div className="flex-shrink-0 relative z-10">
                  <div className="w-16 h-16 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-lg animate-pulse">
                    8
                  </div>
                </div>
                <div className="flex-1 pt-2">
                  <div className="flex items-center gap-3 mb-4">
                    <span className="text-4xl">üîÑ</span>
                    <h4 className="font-bold text-2xl text-cyan-600">¬°Ciclo completo! Segu√≠ vendiendo</h4>
                  </div>
                  <div className="space-y-3 text-slate-600">
                    <p className="leading-relaxed text-lg">
                      <span className="font-semibold text-slate-900">‚Ä¢ La venta se completa exitosamente</span>
                    </p>
                    <p className="leading-relaxed text-lg">
                      <span className="font-semibold text-slate-900">‚Ä¢ Los compradores pueden dejar rese√±as</span> sobre tu producto y servicio
                    </p>
                    <p className="leading-relaxed text-lg">
                      <span className="font-semibold text-slate-900">‚Ä¢ Aparec√©s en el historial del comprador</span> para futuras recompras
                    </p>
                    <p className="leading-relaxed text-lg">
                      <span className="font-semibold text-slate-900">‚Ä¢ Pod√©s destacar tus productos</span> para mayor visibilidad
                    </p>
                    <div className="bg-gradient-to-r from-cyan-500 to-blue-600 border-l-4 border-cyan-700 p-5 mt-4 rounded-xl shadow-lg">
                      <p className="text-lg font-bold text-white mb-2">üéâ ¬°Felicitaciones! Completaste tu primera venta</p>
                      <p className="text-sm text-white">Tu producto sigue disponible y se pueden crear nuevos lotes fraccionados autom√°ticamente. Segu√≠ vendiendo sin l√≠mites.</p>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </section>

      {/* FOOTER */}
      <footer className="border-t-2 border-slate-200 py-16 bg-slate-50">
        <div className="max-w-7xl mx-auto px-8">
          <div className="flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
              <p className="font-bold text-slate-900 text-lg mb-2">Mayorista M√≥vil</p>
              <p className="text-slate-600">¬© {new Date().getFullYear()} Todos los derechos reservados</p>
            </div>
            <div className="flex gap-10">
              <a href="#" className="text-slate-600 hover:text-blue-600 transition font-medium">Contacto</a>
              <a href="#" className="text-slate-600 hover:text-blue-600 transition font-medium">T√©rminos de servicio</a>
              <a href="#" className="text-slate-600 hover:text-blue-600 transition font-medium">Pol√≠tica de privacidad</a>
            </div>
          </div>
        </div>
      </footer>

    </main>
  );
}
</file>

<file path="components/ManufacturerInfoCard.tsx.tsx">
// components/ManufacturerInfoCard.tsx - VERSI√ìN ACTUALIZADA
"use client";

import ProductBadges from "./ProductBadges";

type DaySchedule = {
  open: string;
  close: string;
  closed: boolean;
};

type WeekSchedule = {
  monday: DaySchedule;
  tuesday: DaySchedule;
  wednesday: DaySchedule;
  thursday: DaySchedule;
  friday: DaySchedule;
  saturday: DaySchedule;
  sunday: DaySchedule;
};

type Props = {
  businessName: string;
  profileImageUrl?: string;
  address?: {
    formattedAddress: string;
  };
  phone?: string;
  email?: string;
  schedule?: WeekSchedule;
  verified?: boolean; // Badge de verificado
  isIntermediary?: boolean; // üÜï NUEVO: Badge de intermediario
};

export default function ManufacturerInfoCard({
  businessName,
  profileImageUrl,
  address,
  phone,
  email,
  schedule,
  verified = false,
  isIntermediary = false, // üÜï NUEVO
}: Props) {
  
  // Formatear horarios de forma compacta
  function getCompactSchedule(): string {
    if (!schedule) return "No especificado";

    const days = [
      { key: 'monday', short: 'Lun' },
      { key: 'tuesday', short: 'Mar' },
      { key: 'wednesday', short: 'Mi√©' },
      { key: 'thursday', short: 'Jue' },
      { key: 'friday', short: 'Vie' },
      { key: 'saturday', short: 'S√°b' },
      { key: 'sunday', short: 'Dom' },
    ];

    // Agrupar d√≠as con mismo horario
    const groups: { days: string[]; hours: string }[] = [];
    
    for (const day of days) {
      const daySchedule = schedule[day.key as keyof WeekSchedule];
      
      if (daySchedule.closed) continue;
      
      const hours = `${daySchedule.open} - ${daySchedule.close}`;
      const existingGroup = groups.find(g => g.hours === hours);
      
      if (existingGroup) {
        existingGroup.days.push(day.short);
      } else {
        groups.push({ days: [day.short], hours });
      }
    }

    if (groups.length === 0) return "Cerrado";

    return groups.map(g => `${g.days.join(', ')}: ${g.hours}`).join(' | ');
  }

  return (
    <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
      <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
        üè¢ Informaci√≥n del Fabricante
      </h3>

      {/* FOTO Y NOMBRE */}
      <div className="flex items-center gap-4 mb-4 pb-4 border-b">
        <div className="relative">
          {profileImageUrl ? (
            <img
              src={profileImageUrl}
              alt={businessName}
              className="w-16 h-16 rounded-full object-cover border-2 border-blue-200"
            />
          ) : (
            <div className="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-2xl">
              üè≠
            </div>
          )}
          
          {/* ‚úÖ BADGE VERIFICADO SOBRE LA FOTO (solo si verified=true) */}
          {verified && (
            <div className="absolute -bottom-1 -right-1 bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center border-2 border-white text-xs font-bold shadow-md">
              ‚úì
            </div>
          )}
        </div>
        
        <div className="flex-1">
          <h4 className="font-bold text-lg text-gray-900 mb-2">
            {businessName}
          </h4>
          
          {/* üÜï BADGES USANDO EL NUEVO COMPONENTE */}
          <ProductBadges 
            isVerified={verified}
            isIntermediary={isIntermediary}
            size="small"
          />
          
          {address && (
            <p className="text-sm text-gray-600 flex items-center gap-1 mt-2">
              üìç {address.formattedAddress}
            </p>
          )}
        </div>
      </div>

      {/* HORARIOS */}
      {schedule && (
        <div className="mb-4">
          <div className="flex items-start gap-2">
            <span className="text-gray-700 font-medium text-sm">üìÖ</span>
            <div className="flex-1">
              <p className="text-sm font-medium text-gray-700 mb-1">
                Horarios de atenci√≥n:
              </p>
              <p className="text-sm text-gray-600 leading-relaxed">
                {getCompactSchedule()}
              </p>
            </div>
          </div>
        </div>
      )}

      {/* CONTACTO */}
      {(phone || email) && (
        <div className="pt-4 border-t space-y-2">
          {phone && (
            <div className="flex items-center gap-2 text-sm">
              <span className="text-gray-700">üìû</span>
              <a
                href={`tel:${phone}`}
                className="text-blue-600 hover:underline"
              >
                {phone}
              </a>
            </div>
          )}
          
          {email && (
            <div className="flex items-center gap-2 text-sm">
              <span className="text-gray-700">üìß</span>
              <a
                href={`mailto:${email}`}
                className="text-blue-600 hover:underline"
              >
                {email}
              </a>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
</file>

<file path="components/PickupDeadlineCounter.tsx">
//components/PickupDeadlineCounter.tsx
"use client";

import { useEffect, useState } from "react";
import { getTimeRemaining } from "../lib/business-hours";

type Props = {
  deadline: Date;
  compact?: boolean;
};

export default function PickupDeadlineCounter({ deadline, compact = false }: Props) {
  const [timeLeft, setTimeLeft] = useState(() => getTimeRemaining(deadline));

  useEffect(() => {
    const interval = setInterval(() => {
      setTimeLeft(getTimeRemaining(deadline));
    }, 60000); // Actualizar cada minuto

    return () => clearInterval(interval);
  }, [deadline]);

  if (timeLeft.expired) {
    return (
      <div className={compact ? "text-sm" : "text-base"}>
        <span className="bg-red-100 text-red-800 px-3 py-1 rounded-full font-semibold">
          ‚è∞ VENCIDO
        </span>
      </div>
    );
  }

  const isUrgent = timeLeft.hours <= 24;

  if (compact) {
    return (
      <div className="text-sm">
        <span className={`px-2 py-1 rounded font-medium ${
          isUrgent 
            ? "bg-red-100 text-red-800" 
            : "bg-yellow-100 text-yellow-800"
        }`}>
          ‚è∞ {timeLeft.formatted}
        </span>
      </div>
    );
  }

  return (
    <div className={`p-4 rounded-lg border-2 ${
      isUrgent
        ? "bg-red-50 border-red-400"
        : "bg-yellow-50 border-yellow-400"
    }`}>
      <div className="flex items-center justify-between">
        <div>
          <div className="font-semibold text-sm mb-1">
            {isUrgent ? "üö® URGENTE" : "‚è∞ Tiempo restante"}
          </div>
          <div className={`text-2xl font-bold ${
            isUrgent ? "text-red-700" : "text-yellow-700"
          }`}>
            {timeLeft.formatted}
          </div>
        </div>
        <div className="text-4xl">
          {isUrgent ? "üö®" : "‚è∞"}
        </div>
      </div>
      {isUrgent && (
        <p className="text-xs text-red-700 mt-2">
          ¬°Menos de 24 horas para retirar!
        </p>
      )}
    </div>
  );
}
</file>

<file path="components/ProductBadges.tsx">
// components/ProductBadges.tsx
"use client";

type ProductBadgesProps = {
  isVerified: boolean;
  isIntermediary: boolean;
  size?: "small" | "medium" | "large";
};

export default function ProductBadges({ 
  isVerified, 
  isIntermediary,
  size = "medium" 
}: ProductBadgesProps) {
  
  // Definir tama√±os seg√∫n el prop
  const sizeClasses = {
    small: {
      container: "gap-1.5",
      badge: "px-2 py-0.5 text-xs",
      icon: "text-xs",
    },
    medium: {
      container: "gap-2",
      badge: "px-3 py-1 text-sm",
      icon: "text-sm",
    },
    large: {
      container: "gap-2.5",
      badge: "px-4 py-1.5 text-base",
      icon: "text-base",
    },
  };

  const classes = sizeClasses[size];

  // Si no hay ning√∫n badge, no mostrar nada
  if (!isVerified && !isIntermediary) {
    return null;
  }

  return (
    <div className={`flex items-center flex-wrap ${classes.container}`}>
      
      {/* BADGE DE VERIFICADO */}
      {isVerified && (
        <span className={`inline-flex items-center gap-1 bg-blue-100 text-blue-700 font-semibold rounded-full ${classes.badge}`}>
          <svg 
            className={classes.icon}
            viewBox="0 0 24 24" 
            fill="currentColor"
            width="16"
            height="16"
          >
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
          </svg>
          Verificado
        </span>
      )}

      {/* BADGE DE INTERMEDIARIO */}
      {isIntermediary && (
        <span className={`inline-flex items-center gap-1 bg-orange-100 text-orange-700 font-semibold rounded-full ${classes.badge}`}>
          <svg 
            className={classes.icon}
            viewBox="0 0 24 24" 
            fill="currentColor"
            width="16"
            height="16"
          >
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
          </svg>
          Intermediario
        </span>
      )}
    </div>
  );
}
</file>

<file path="components/ProductsSkeleton.tsx">
export function ProductsSkeleton() {
  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-6xl mx-auto p-8">
        
        {/* HEADER SKELETON */}
        <div className="mb-10">
          <div className="h-8 bg-gray-200 rounded w-64 mb-2 animate-pulse"></div>
          <div className="h-4 bg-gray-200 rounded w-96 animate-pulse"></div>
        </div>

        {/* GRID SKELETON */}
        <div className="grid md:grid-cols-3 gap-6">
          {[...Array(6)].map((_, i) => (
            <div key={i} className="bg-white rounded-xl shadow p-6 animate-pulse">
              <div className="h-6 bg-gray-200 rounded w-3/4 mb-4"></div>
              <div className="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
              <div className="h-4 bg-gray-200 rounded w-2/3 mb-4"></div>
              <div className="h-10 bg-gray-200 rounded w-full"></div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="components/RevendedorSidebar.tsx">
"use client";

import Link from "next/link";
import { useState } from "react";

export default function RevendedorSidebar() {
  const [open, setOpen] = useState(true);

  return (
    <aside
      className={`bg-white border-r border-gray-200 transition-all duration-300 ${
        open ? "w-64" : "w-16"
      }`}
    >
      {/* HEADER */}
      <div className="p-4 flex justify-between items-center border-b">
        {open && (
          <span className="text-sm font-semibold text-gray-700">
            Panel
          </span>
        )}
        <button
          onClick={() => setOpen(!open)}
          className="text-gray-500 hover:text-gray-900"
        >
          ‚ò∞
        </button>
      </div>

      {/* NAV */}
      <nav className="p-4 space-y-2">

        <Link
          href="/dashboard/pedidos-fraccionados"
          className="block text-sm text-gray-700 hover:bg-gray-100 rounded px-3 py-2"
        >
          {open && "Resumen"}
        </Link>

        <Link
          href="/dashboard/pedidos-fraccionados/pedidos"
          className="block text-sm text-gray-700 hover:bg-gray-100 rounded px-3 py-2"
        >
          {open && "Mis pedidos"}
        </Link>

        <Link
          href="/dashboard/pedidos-fraccionados/perfil"
          className="block text-sm text-gray-700 hover:bg-gray-100 rounded px-3 py-2"
        >
          {open && "Perfil"}
        </Link>

      </nav>
    </aside>
  );
}
</file>

<file path="components/SwitchRoleButton.tsx">
"use client";

import { useRouter } from "next/navigation";
import { useState } from "react";
import toast from "react-hot-toast";

export default function SwitchRoleButton({
  targetRole,
}: {
  targetRole: "manufacturer" | "retailer";
}) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);

  async function switchRole() {
    setLoading(true);

    try {
      const res = await fetch("/api/auth/switch-role", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ role: targetRole }),
      });

      if (!res.ok) {
        throw new Error("Error al cambiar rol");
      }

      toast.success(
        `Rol cambiado a ${
          targetRole === "manufacturer"
            ? "Fabricante"
            : "Revendedor"
        }`
      );

      // üî• ESTA ES LA L√çNEA CLAVE
      router.refresh();

      router.push(
        targetRole === "manufacturer"
          ? "/dashboard/fabricante"
          : "/dashboard/pedidos-fraccionados"
      );
    } catch (error) {
  console.error("Error cambio rol:", error);
  toast.error("No se pudo cambiar el rol");
} finally {
      setLoading(false);
    }
  }

  return (
    <button
      onClick={switchRole}
      disabled={loading}
      className="px-4 py-2 border rounded-md text-sm hover:bg-gray-100 disabled:opacity-50"
    >
      {loading
        ? "Cambiando rol..."
        : `Cambiar a ${
            targetRole === "manufacturer"
              ? "Fabricante"
              : "Revendedor"
          }`}
    </button>
  );
}
</file>

<file path="components/VerificationBadge.tsx">
// components/VerificationBadge.tsx
"use client";

type Props = {
  verified: boolean;
  showLabel?: boolean;
  size?: 'sm' | 'md' | 'lg';
};

export default function VerificationBadge({ 
  verified,
  showLabel = true,
  size = 'md' 
}: Props) {
  
  // ‚úÖ SOLO MOSTRAR SI EST√Å VERIFICADO
  if (!verified) return null;

  const sizeClasses = {
    sm: 'text-xs px-2 py-0.5',
    md: 'text-sm px-3 py-1',
    lg: 'text-base px-4 py-1.5',
  };

  const iconSizes = {
    sm: 'text-xs',
    md: 'text-sm',
    lg: 'text-base',
  };

  if (!showLabel) {
    // Solo √≠cono circular
    return (
      <div 
        className={`
          inline-flex items-center justify-center
          bg-blue-600 text-white border-2 border-white
          ${size === 'sm' ? 'w-5 h-5 text-xs' : size === 'md' ? 'w-6 h-6 text-sm' : 'w-8 h-8 text-base'}
          rounded-full font-bold shadow-md
        `}
        title="Empresa Verificada"
      >
        ‚úì
      </div>
    );
  }

  return (
    <span 
      className={`
        inline-flex items-center gap-1.5
        bg-blue-100 text-blue-800 border-2 border-blue-300
        ${sizeClasses[size]}
        rounded-full font-semibold
      `}
    >
      <span className={`${iconSizes[size]} font-bold`}>
        ‚úì
      </span>
      <span>Verificada</span>
    </span>
  );
}
</file>

<file path="firebase.json">
{
  "functions": [
    {
      "source": "functions",
      "codebase": "default",
      "disallowLegacyRuntimeConfig": true,
      "ignore": [
        "node_modules",
        ".git",
        "firebase-debug.log",
        "firebase-debug.*.log",
        "*.local"
      ],
      "predeploy": [
        "npm --prefix \"$RESOURCE_DIR\" run build"
      ]
    }
  ]
}
</file>

<file path="firestore.indexes.json">
{
  "indexes": [
    {
      "collectionGroup": "lots",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "productId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "status",
          "order": "ASCENDING"
        }
      ]
    },
    {
      "collectionGroup": "lots",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "productId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "factoryId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "type",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "status",
          "order": "ASCENDING"
        }
      ]
    },
    {
      "collectionGroup": "payments",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "factoryId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "lotStatus",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    },
    {
      "collectionGroup": "payments",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "productId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "factoryId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "lotType",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "settled",
          "order": "ASCENDING"
        }
      ]
    },
    {
      "collectionGroup": "products",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "factoryId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    },
    {
      "collectionGroup": "notifications",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "recipientId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    },
    {
      "collectionGroup": "notifications",
      "queryScope": "COLLECTION",
      "fields": [
        {
          "fieldPath": "recipientId",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "read",
          "order": "ASCENDING"
        },
        {
          "fieldPath": "createdAt",
          "order": "DESCENDING"
        }
      ]
    }
  ],
  "fieldOverrides": []
}
</file>

<file path="functions/.gitignore">
# Compiled JavaScript files
lib/
*.js
*.js.map

# TypeScript cache
*.tsbuildinfo

# Node.js dependencies
node_modules/

# Firebase cache
.firebase/
</file>

<file path="functions/package.json">
{
  "name": "functions",
  "version": "1.0.0",
  "description": "Cloud Functions para Mayorista M√≥vil",
  "scripts": {
    "build": "tsc",
    "serve": "npm run build && firebase emulators:start --only functions",
    "deploy": "firebase deploy --only functions",
    "logs": "firebase functions:log"
  },
  "engines": {
    "node": "18"
  },
  "main": "lib/index.js",
  "dependencies": {
    "firebase-admin": "^12.0.0",
    "firebase-functions": "^4.5.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "typescript": "^5.0.0"
  },
  "private": true
}
</file>

<file path="functions/src/index.ts">
/**
 * FIREBASE CLOUD FUNCTIONS
 * 
 * Punto de entrada para todas las Cloud Functions
 */

// ‚úÖ Exportar funci√≥n de cron de destacados
export { checkFeaturedExpiration } from "./scheduled/checkFeaturedExpiration";

// ‚úÖ Aqu√≠ pod√©s agregar otras functions en el futuro
// export { myOtherFunction } from "./other/myOtherFunction";
</file>

<file path="functions/src/scheduled/checkFeaturedExpiration.ts">
import * as functions from "firebase-functions";
import * as admin from "firebase-admin";

if (!admin.apps.length) {
  admin.initializeApp();
}

const db = admin.firestore();

export const checkFeaturedExpiration = functions
  .pubsub.schedule("0 * * * *")
  .timeZone("America/Argentina/Buenos_Aires")
  .onRun(async () => {
    console.log("üïí Iniciando verificaci√≥n de destacados vencidos...");

    const now = new Date();
    let expired = 0;
    let productsUpdated = 0;

    try {
      const snapshot = await db
        .collection("featured")
        .where("active", "==", true)
        .where("expired", "==", false)
        .get();

      console.log(`üìä Destacados activos encontrados: ${snapshot.size}`);

      for (const doc of snapshot.docs) {
        const data = doc.data();
        const endDate = data.endDate?.toDate();

        if (!endDate || endDate > now) {
          continue;
        }

        await doc.ref.update({
          expired: true,
          active: false,
          updatedAt: admin.firestore.FieldValue.serverTimestamp(),
        });

        expired++;
        console.log(`‚úÖ Destacado expirado: ${doc.id} (${data.type})`);

        if (data.type === "product" && data.itemId) {
          try {
            const productRef = db.collection("products").doc(data.itemId);
            const productSnap = await productRef.get();

            if (productSnap.exists) {
              await productRef.update({
                featured: false,
                featuredUntil: null,
                updatedAt: admin.firestore.FieldValue.serverTimestamp(),
              });

              productsUpdated++;
              console.log(`‚úÖ Producto actualizado: ${data.itemId}`);
            }
          } catch (error) {
            console.error(`‚ùå Error actualizando producto ${data.itemId}:`, error);
          }
        }
      }

      const summary = {
        timestamp: now.toISOString(),
        totalChecked: snapshot.size,
        expired,
        productsUpdated,
      };

      console.log("üìä RESUMEN:", summary);

      return {
        success: true,
        ...summary,
        message: expired > 0 
          ? `Se expiraron ${expired} destacado(s)` 
          : "No hay destacados para expirar",
      };

    } catch (error) {
      console.error("‚ùå ERROR en cron:", error);
      throw error;
    }
  });
</file>

<file path="functions/tsconfig.json">
{
  "compilerOptions": {
    "module": "commonjs",
    "noImplicitReturns": true,
    "noUnusedLocals": true,
    "outDir": "lib",
    "sourceMap": true,
    "strict": true,
    "target": "es2017",
    "esModuleInterop": true,
    "skipLibCheck": true
  },
  "compileOnSave": true,
  "include": ["src"]
}
</file>

<file path="lib/auth/requireAdmin.ts">
// lib/auth/requireAdmin.ts

import { cookies } from "next/headers";
import { db } from "../firebase-admin";

/**
 * Verifica que el usuario sea administrador
 * @returns userId si es admin, lanza error si no
 */
export async function requireAdmin(): Promise<string> {
  const userId = cookies().get("userId")?.value;
  const activeRole = cookies().get("activeRole")?.value;

  if (!userId) {
    throw new Error("No autorizado - no hay sesi√≥n");
  }

  // Verificar en base de datos
  try {
    const userSnap = await db.collection("users").doc(userId).get();

    if (!userSnap.exists) {
      throw new Error("Usuario no encontrado");
    }

    const userData = userSnap.data();

    // Verificar rol de admin
    const isAdmin = userData?.isAdmin === true || userData?.role === 'admin';

    if (!isAdmin) {
      throw new Error("No autorizado - requiere privilegios de administrador");
    }

    return userId;
  } catch (error) {
    console.error("‚ùå Error en requireAdmin:", error);
    throw new Error("No autorizado");
  }
}
</file>

<file path="lib/auth/requireRole.ts">
import { cookies } from "next/headers";
import { db } from "../firebase-admin";

/**
 * ‚úÖ FIX ERROR 19: Validaci√≥n de rol en BD
 * 
 * Ahora verifica:
 * 1. Que exista userId y activeRole en cookies
 * 2. Que el usuario exista en Firestore
 * 3. Que el usuario tenga el rol requerido asignado en su documento
 * 
 * Esto previene que usuarios manipulen cookies para acceder
 * a funciones que no les corresponden.
 */
export async function requireRole(
  role: "manufacturer" | "retailer"
): Promise<string> {
  const userId = cookies().get("userId")?.value;
  const activeRole = cookies().get("activeRole")?.value;

  // ‚ùå Validaci√≥n b√°sica de cookies
  if (!userId || activeRole !== role) {
    throw new Error("No autorizado");
  }

  // ‚úÖ FIX ERROR 19: VALIDAR EN BASE DE DATOS
  try {
    const userSnap = await db.collection("users").doc(userId).get();

    if (!userSnap.exists) {
      throw new Error("Usuario no encontrado en la base de datos");
    }

    const userData = userSnap.data();

    // Verificar que el usuario tenga el rol requerido
    // El campo puede ser 'usertype' o 'roles' dependiendo de la estructura
    const userType = userData?.usertype;
    const roles = userData?.roles || [];

    // Validar que tenga el rol (ya sea en usertype o en array roles)
    const hasRole =
      userType === role ||
      userType === "both" ||
      roles.includes(role);

    if (!hasRole) {
      throw new Error(`Usuario no tiene el rol '${role}' asignado`);
    }

    // ‚úÖ Usuario v√°lido y autorizado
    return userId;
  } catch (error) {
    console.error("‚ùå Error en requireRole:", error);
    throw new Error("No autorizado - validaci√≥n de rol fall√≥");
  }
}
</file>

<file path="lib/business-hours.ts">
// lib/business-hours.ts

import { addBusinessDays, isWeekend, differenceInHours, differenceInMinutes } from 'date-fns';
import { toZonedTime, fromZonedTime } from 'date-fns-tz';

const TIMEZONE = 'America/Argentina/Buenos_Aires';

/**
 * Horario de un d√≠a
 */
export type DaySchedule = {
  open: string;   // "09:00"
  close: string;  // "18:00"
  closed: boolean;
};

/**
 * Horarios semanales del fabricante
 */
export type WeekSchedule = {
  monday: DaySchedule;
  tuesday: DaySchedule;
  wednesday: DaySchedule;
  thursday: DaySchedule;
  friday: DaySchedule;
  saturday: DaySchedule;
  sunday: DaySchedule;
};

/**
 * Horario por defecto (Lun-Vie 9-18)
 */
export const DEFAULT_SCHEDULE: WeekSchedule = {
  monday: { open: '09:00', close: '18:00', closed: false },
  tuesday: { open: '09:00', close: '18:00', closed: false },
  wednesday: { open: '09:00', close: '18:00', closed: false },
  thursday: { open: '09:00', close: '18:00', closed: false },
  friday: { open: '09:00', close: '18:00', closed: false },
  saturday: { open: '00:00', close: '00:00', closed: true },
  sunday: { open: '00:00', close: '00:00', closed: true },
};

/**
 * Calcula la fecha l√≠mite de retiro (48hs h√°biles)
 */
export function calculatePickupDeadline(
  startDate: Date,
  schedule: WeekSchedule = DEFAULT_SCHEDULE
): Date {
  const argDate = toZonedTime(startDate, TIMEZONE);
  
  // Agregar 48 horas h√°biles (2 d√≠as h√°biles completos)
  let deadline = addBusinessDays(argDate, 2);
  
  // Ajustar a horario de cierre del d√≠a
  const dayKey = getDayKey(deadline);
  const daySchedule = schedule[dayKey];
  
  if (!daySchedule.closed) {
    const [closeHour, closeMin] = daySchedule.close.split(':').map(Number);
    deadline.setHours(closeHour, closeMin, 0, 0);
  }
  
  return fromZonedTime(deadline, TIMEZONE);
}

/**
 * Obtiene el tiempo restante hasta el deadline
 */
export function getTimeRemaining(deadline: Date): {
  hours: number;
  minutes: number;
  expired: boolean;
  formatted: string;
} {
  const now = toZonedTime(new Date(), TIMEZONE);
  const end = toZonedTime(deadline, TIMEZONE);
  
  const expired = now > end;
  
  if (expired) {
    return {
      hours: 0,
      minutes: 0,
      expired: true,
      formatted: 'VENCIDO',
    };
  }
  
  const totalMinutes = differenceInMinutes(end, now);
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  
  const formatted = hours > 24
    ? `${Math.floor(hours / 24)} d√≠as ${hours % 24}hs`
    : `${hours}hs ${minutes}min`;
  
  return {
    hours,
    minutes,
    expired: false,
    formatted,
  };
}

/**
 * Formatea horarios para mostrar
 */
export function formatSchedule(schedule: WeekSchedule): string {
  const days = [
    { key: 'monday', label: 'Lunes' },
    { key: 'tuesday', label: 'Martes' },
    { key: 'wednesday', label: 'Mi√©rcoles' },
    { key: 'thursday', label: 'Jueves' },
    { key: 'friday', label: 'Viernes' },
    { key: 'saturday', label: 'S√°bado' },
    { key: 'sunday', label: 'Domingo' },
  ];

  const lines: string[] = [];

  for (const day of days) {
    const daySchedule = schedule[day.key as keyof WeekSchedule];
    
    if (daySchedule.closed) {
      lines.push(`${day.label}: Cerrado`);
    } else {
      lines.push(`${day.label}: ${daySchedule.open} - ${daySchedule.close}`);
    }
  }

  return lines.join('\n');
}

/**
 * Verifica si una fecha est√° en horario h√°bil
 */
export function isBusinessHour(
  date: Date,
  schedule: WeekSchedule
): boolean {
  const argDate = toZonedTime(date, TIMEZONE);
  
  if (isWeekend(argDate)) return false;
  
  const dayKey = getDayKey(argDate);
  const daySchedule = schedule[dayKey];
  
  if (daySchedule.closed) return false;
  
  const hours = argDate.getHours();
  const minutes = argDate.getMinutes();
  const currentTime = hours * 60 + minutes;
  
  const [openHour, openMin] = daySchedule.open.split(':').map(Number);
  const [closeHour, closeMin] = daySchedule.close.split(':').map(Number);
  
  const openTime = openHour * 60 + openMin;
  const closeTime = closeHour * 60 + closeMin;
  
  return currentTime >= openTime && currentTime <= closeTime;
}

/**
 * Obtiene la clave del d√≠a de la semana
 */
function getDayKey(date: Date): keyof WeekSchedule {
  const dayNames: (keyof WeekSchedule)[] = [
    'sunday', 'monday', 'tuesday', 'wednesday',
    'thursday', 'friday', 'saturday'
  ];
  
  return dayNames[date.getDay()];
}

/**
 * Formatea fecha para Argentina
 */
export function formatArgentinaDate(date: Date): string {
  const argDate = toZonedTime(date, TIMEZONE);
  
  return new Intl.DateTimeFormat('es-AR', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    timeZone: TIMEZONE,
  }).format(argDate);
}
</file>

<file path="lib/date-utils.ts">
import { differenceInDays } from 'date-fns';
import { toZonedTime } from 'date-fns-tz'; // 

const TIMEZONE = 'America/Argentina/Buenos_Aires';

/**
 * Obtiene la fecha actual en zona horaria de Argentina
 */
export function getArgentinaDate(date: Date = new Date()): Date {
  return toZonedTime(date, TIMEZONE); // ‚úÖ Usar toZonedTime
}

/**
 * Calcula d√≠as hasta una fecha futura (en zona horaria Argentina)
 */
export function getDaysUntil(futureDate: Date): number {
  const now = getArgentinaDate();
  const future = getArgentinaDate(futureDate);
  return differenceInDays(future, now);
}
</file>

<file path="lib/email/client.ts">
// lib/email/client.ts

import { Resend } from 'resend';

if (!process.env.RESEND_API_KEY) {
  console.warn('‚ö†Ô∏è RESEND_API_KEY no configurada');
}

export const resend = new Resend(process.env.RESEND_API_KEY);

/**
 * Par√°metros base para enviar email
 */
export type SendEmailParams = {
  to: string;
  subject: string;
  html: string;
  text?: string;
};

/**
 * Env√≠a un email usando Resend
 */
export async function sendEmail(params: SendEmailParams) {
  try {
    const result = await resend.emails.send({
      from: process.env.EMAIL_FROM || 'Mayorista M√≥vil <onboarding@resend.dev>',
      to: params.to,
      subject: params.subject,
      html: params.html,
      text: params.text,
    });

    console.log('‚úÖ Email enviado:', result);
    return { success: true, id: result.data?.id };
    
  } catch (error) {
    console.error('‚ùå Error enviando email:', error);
    return { success: false, error };
  }
}
</file>

<file path="lib/email/templates.ts">
// lib/email/templates.ts

import { formatSchedule, formatArgentinaDate, getTimeRemaining } from '../business-hours';
import type { WeekSchedule } from '../business-hours';

/**
 * Base HTML para emails
 */
function emailWrapper(content: string): string {
  return `
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .email-container {
      background-color: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      border-bottom: 3px solid #2563eb;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    .header h1 {
      color: #2563eb;
      margin: 0;
      font-size: 24px;
    }
    .section {
      margin: 25px 0;
      padding: 20px;
      background-color: #f9fafb;
      border-radius: 6px;
      border-left: 4px solid #2563eb;
    }
    .section-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 15px;
      color: #1f2937;
    }
    .info-row {
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
    }
    .info-label {
      font-weight: 500;
      color: #6b7280;
    }
    .info-value {
      font-weight: 600;
      color: #111827;
    }
    .warning-box {
      background-color: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 6px;
      padding: 15px;
      margin: 20px 0;
    }
    .warning-box strong {
      color: #92400e;
    }
    .deadline {
      background-color: #fee2e2;
      border: 2px solid #dc2626;
      border-radius: 6px;
      padding: 15px;
      margin: 20px 0;
      text-align: center;
    }
    .deadline-time {
      font-size: 24px;
      font-weight: bold;
      color: #dc2626;
      margin: 10px 0;
    }
    .button {
      display: inline-block;
      background-color: #2563eb;
      color: white;
      padding: 12px 24px;
      text-decoration: none;
      border-radius: 6px;
      margin: 20px 0;
      font-weight: 600;
    }
    .footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
      color: #6b7280;
      font-size: 14px;
    }
    .retailer-item {
      background-color: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 15px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="email-container">
    ${content}
  </div>
</body>
</html>
  `;
}

/**
 * FABRICANTE - Pedido Directo
 */
export function manufacturerDirectOrderEmail(data: {
  productName: string;
  qty: number;
  retailerName: string;
  retailerAddress: string;
  retailerPhone?: string;
  shippingMode: string;
  orderId: string;
  dashboardLink: string;
}): string {
  const content = `
    <div class="header">
      <h1>üéâ Nuevo Pedido Directo</h1>
    </div>

    <p>¬°Felicitaciones! Recibiste un nuevo pedido directo confirmado.</p>

    <div class="section">
      <div class="section-title">üì¶ Detalles del Pedido</div>
      <div class="info-row">
        <span class="info-label">Producto:</span>
        <span class="info-value">${data.productName}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Cantidad:</span>
        <span class="info-value">${data.qty} unidades</span>
      </div>
      <div class="info-row">
        <span class="info-label">Tipo:</span>
        <span class="info-value">Compra directa</span>
      </div>
    </div>

    <div class="section">
      <div class="section-title">üë§ Cliente</div>
      <div class="info-row">
        <span class="info-label">Nombre:</span>
        <span class="info-value">${data.retailerName}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Direcci√≥n:</span>
        <span class="info-value">${data.retailerAddress}</span>
      </div>
      ${data.retailerPhone ? `
      <div class="info-row">
        <span class="info-label">Tel√©fono:</span>
        <span class="info-value">${data.retailerPhone}</span>
      </div>
      ` : ''}
    </div>

    <div class="section">
      <div class="section-title">üöö Env√≠o</div>
      <p><strong>Modalidad:</strong> ${data.shippingMode === 'pickup' ? 'Retiro en f√°brica' : 'Env√≠o por f√°brica'}</p>
      ${data.shippingMode === 'pickup' ? `
        <div class="warning-box">
          <strong>‚è∞ IMPORTANTE:</strong> El cliente tiene 48hs h√°biles para retirar desde que realiz√≥ la compra.
        </div>
      ` : ''}
    </div>

    <div class="section">
      <div class="section-title">‚è∞ Pr√≥ximos Pasos</div>
      <ol>
        <li>Preparar ${data.qty} unidades</li>
        <li>${data.shippingMode === 'pickup' ? 'Tener la mercader√≠a lista para retiro' : 'Coordinar env√≠o con el cliente'}</li>
        <li>El pago ya est√° acreditado</li>
      </ol>
    </div>

    <div style="text-align: center;">
      <a href="${data.dashboardLink}/dashboard/fabricante/pedidos/${data.orderId}" class="button">
        Ver Pedido Completo
      </a>
    </div>

    <div class="footer">
      <p><strong>Mayorista M√≥vil</strong></p>
      <p>Tu plataforma mayorista de confianza</p>
    </div>
  `;

  return emailWrapper(content);
}

/**
 * FABRICANTE - Lote Fraccionado Cerrado (SIN GANANCIA)
 */
export function manufacturerLotClosedEmail(data: {
  productName: string;
  totalQty: number;
  retailers: Array<{
    name: string;
    qty: number;
    address: string;
    phone?: string;
  }>;
  lotType: string;
  factoryAddress: string;
  orderId: string;
  dashboardLink: string;
}): string {
  const isPickup = data.lotType.includes('pickup');

  const content = `
    <div class="header">
      <h1>‚úÖ Lote Fraccionado Completado</h1>
    </div>

    <p>¬°El lote fraccionado alcanz√≥ el m√≠nimo y est√° listo para despacho!</p>

    <div class="section">
      <div class="section-title">üì¶ Resumen del Lote</div>
      <div class="info-row">
        <span class="info-label">Producto:</span>
        <span class="info-value">${data.productName}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Pedido Total:</span>
        <span class="info-value">${data.totalQty} unidades</span>
      </div>
      <div class="info-row">
        <span class="info-label">Origen:</span>
        <span class="info-value">Compra fraccionada</span>
      </div>
    </div>

    <div class="section">
      <div class="section-title">üìã Distribuci√≥n por Revendedor</div>
      ${data.retailers.map(r => `
        <div class="retailer-item">
          <div style="font-weight: bold; margin-bottom: 8px;">${r.name}</div>
          <div>‚Ä¢ Cantidad: ${r.qty} unidades</div>
          <div>‚Ä¢ Direcci√≥n: ${r.address}</div>
          ${r.phone ? `<div>‚Ä¢ Tel√©fono: ${r.phone}</div>` : ''}
        </div>
      `).join('')}
    </div>

    <div class="section">
      <div class="section-title">üöö Log√≠stica</div>
      ${isPickup ? `
        <p><strong>Modalidad:</strong> RETIRO EN F√ÅBRICA</p>
        <div class="warning-box">
          <strong>‚è∞ IMPORTANTE:</strong> Los revendedores tienen 48hs h√°biles para retirar desde que realizaron la compra.
          <br><br>
          Asegurate de tener la mercader√≠a preparada en tus horarios de atenci√≥n.
        </div>
      ` : `
        <p><strong>Modalidad:</strong> ENV√çO POR PLATAFORMA</p>
        <ol>
          <li><strong>Preparar:</strong> ${data.totalQty} unidades separadas por revendedor</li>
          <li><strong>Punto de entrega:</strong> ${data.factoryAddress}</li>
          <li><strong>Coordinaci√≥n:</strong> Te contactaremos para coordinar retiro</li>
        </ol>
      `}
    </div>

    <div class="section">
      <div class="section-title">‚è∞ Pr√≥ximos Pasos</div>
      <ol>
        <li>Preparar ${data.totalQty} unidades</li>
        <li>Separar por revendedor (ver distribuci√≥n arriba)</li>
        <li>${isPickup ? 'Tener lista para retiro en horarios de atenci√≥n' : 'Esperar coordinaci√≥n de log√≠stica'}</li>
      </ol>
    </div>

    <div style="text-align: center;">
      <a href="${data.dashboardLink}/dashboard/fabricante/pedidos/${data.orderId}" class="button">
        Ver Orden Completa
      </a>
    </div>

    <div class="footer">
      <p><strong>Mayorista M√≥vil</strong></p>
      <p>Tu plataforma mayorista de confianza</p>
    </div>
  `;

  return emailWrapper(content);
}

/**
 * REVENDEDOR - Compra con Retiro en F√°brica
 */
export function retailerPickupEmail(data: {
  productName: string;
  qty: number;
  subtotal: number;
  total: number;
  factoryBusinessName: string;
  factoryAddress: string;
  factorySchedule: WeekSchedule;
  factoryPhone?: string;
  factoryEmail?: string;
  pickupDeadline: Date;
  orderId: string;
  dashboardLink: string;
  isDirect: boolean;
}): string {
  const timeRemaining = getTimeRemaining(data.pickupDeadline);
  const formattedDeadline = formatArgentinaDate(data.pickupDeadline);
  const formattedSchedule = formatSchedule(data.factorySchedule);

  const content = `
    <div class="header">
      <h1>‚úÖ Compra Confirmada - Retiro en F√°brica</h1>
    </div>

    <p>¬°Tu pago fue aprobado exitosamente!</p>

    <div class="section">
      <div class="section-title">üì¶ Detalles de tu Pedido</div>
      <div class="info-row">
        <span class="info-label">Producto:</span>
        <span class="info-value">${data.productName}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Cantidad:</span>
        <span class="info-value">${data.qty} unidades</span>
      </div>
      <div class="info-row">
        <span class="info-label">Tipo:</span>
        <span class="info-value">${data.isDirect ? 'Compra directa' : 'Compra fraccionada'}</span>
      </div>
    </div>

    <div class="section">
      <div class="section-title">üí∞ Resumen de Pago</div>
      <div class="info-row">
        <span class="info-label">Subtotal producto:</span>
        <span class="info-value">$${data.subtotal.toLocaleString('es-AR')}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Env√≠o:</span>
        <span class="info-value">$0 (retiro en f√°brica)</span>
      </div>
      <div class="info-row" style="border-top: 2px solid #e5e7eb; padding-top: 10px; margin-top: 10px;">
        <span class="info-label"><strong>Total pagado:</strong></span>
        <span class="info-value"><strong>$${data.total.toLocaleString('es-AR')}</strong></span>
      </div>
    </div>

    <div class="deadline">
      <div style="font-size: 18px; font-weight: bold; color: #dc2626;">
        ‚è∞ PLAZO DE RETIRO - ¬°MUY IMPORTANTE!
      </div>
      <div style="margin: 15px 0;">
        <strong>Ten√©s 48 HORAS H√ÅBILES para retirar</strong>
      </div>
      <div class="deadline-time">
        ${timeRemaining.formatted}
      </div>
      <div style="font-size: 14px; margin-top: 10px;">
        Vencimiento: ${formattedDeadline}
      </div>
      <div class="warning-box" style="margin-top: 15px;">
        <strong>‚ùå Pasado este plazo, se aplicar√°n sanciones en tus pr√≥ximas compras.</strong>
      </div>
    </div>

    <div class="section">
      <div class="section-title">üìç D√≥nde Retirar</div>
      <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
        ${data.factoryBusinessName}
      </div>
      <div style="margin-bottom: 15px;">
        üìç ${data.factoryAddress}
      </div>
    </div>

    <div class="section">
      <div class="section-title">üìÖ D√≠as y Horarios de Atenci√≥n</div>
      <pre style="background-color: white; padding: 15px; border-radius: 4px; border: 1px solid #e5e7eb;">${formattedSchedule}</pre>
    </div>

    ${(data.factoryPhone || data.factoryEmail) ? `
    <div class="section">
      <div class="section-title">üìû Contacto</div>
      ${data.factoryPhone ? `<div>Tel√©fono: <strong>${data.factoryPhone}</strong></div>` : ''}
      ${data.factoryEmail ? `<div>Email: <strong>${data.factoryEmail}</strong></div>` : ''}
    </div>
    ` : ''}

    <div class="section">
      <div class="section-title">‚è∞ Pr√≥ximos Pasos</div>
      <ol>
        <li>Coordin√° tu visita dentro del plazo</li>
        <li>Llev√° identificaci√≥n</li>
        <li>Mencion√° tu pedido <strong>#${data.orderId}</strong></li>
      </ol>
    </div>

    <div style="text-align: center;">
      <a href="${data.dashboardLink}/dashboard/pedidos-fraccionados" class="button">
        Ver Mi Pedido
      </a>
    </div>

    <div class="footer">
      <p><strong>Mayorista M√≥vil</strong></p>
      <p>Tu plataforma mayorista de confianza</p>
    </div>
  `;

  return emailWrapper(content);
}

/**
 * FABRICANTE - Nuevo Pedido Fraccionado (Notificaci√≥n de Progreso)
 */
export function manufacturerFractionalProgressEmail(data: {
  productName: string;
  retailerName: string;
  qty: number;
  accumulatedQty: number;
  minimumOrder: number;
  percentage: number;
  remaining: number;
}): string {
  const content = `
    <div class="header">
      <h1>üìä Nuevo Pedido Fraccionado</h1>
    </div>

    <p>Se sum√≥ un nuevo pedido fraccionado a tu producto.</p>

    <div class="section">
      <div class="section-title">üì¶ Producto</div>
      <div class="info-row">
        <span class="info-label">Producto:</span>
        <span class="info-value">${data.productName}</span>
      </div>
    </div>

    <div class="section">
      <div class="section-title">‚ûï Nuevo Pedido Sumado</div>
      <div class="info-row">
        <span class="info-label">Revendedor:</span>
        <span class="info-value">${data.retailerName}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Cantidad:</span>
        <span class="info-value">${data.qty} unidades</span>
      </div>
    </div>

    <div class="section">
      <div class="section-title">üìà Progreso del Lote</div>
      <div class="info-row">
        <span class="info-label">Acumulado:</span>
        <span class="info-value">${data.accumulatedQty} / ${data.minimumOrder}</span>
      </div>
      <div style="margin: 15px 0;">
        <div style="background-color: #e5e7eb; border-radius: 4px; height: 20px; overflow: hidden;">
          <div style="background-color: #2563eb; height: 100%; width: ${data.percentage}%; transition: width 0.3s;"></div>
        </div>
        <div style="text-align: center; margin-top: 5px; font-weight: bold;">
          ${data.percentage.toFixed(0)}%
        </div>
      </div>
      <div class="info-row">
        <span class="info-label">Faltan:</span>
        <span class="info-value">${data.remaining} unidades</span>
      </div>
      ${data.percentage >= 80 ? `
        <div class="warning-box" style="margin-top: 15px;">
          <strong>üéØ ¬°Casi completo!</strong> Solo faltan ${data.remaining} unidades.
        </div>
      ` : ''}
    </div>

    <p style="text-align: center; color: #6b7280;">
      ‚ÑπÔ∏è Te notificaremos cuando se complete el lote.
    </p>

    <div class="footer">
      <p><strong>Mayorista M√≥vil</strong></p>
      <p>Tu plataforma mayorista de confianza</p>
    </div>
  `;

  return emailWrapper(content);
}
</file>

<file path="lib/env.ts">
/**
 * Validador centralizado de variables de entorno
 * Falla r√°pido en build/startup si falta alguna variable cr√≠tica
 */

type EnvVar = {
  key: string;
  required: boolean;
  description: string;
};

const ENV_VARS: EnvVar[] = [
  // Firebase Client
  {
    key: "NEXT_PUBLIC_FIREBASE_API_KEY",
    required: true,
    description: "Firebase API Key (cliente)",
  },
  {
    key: "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN",
    required: true,
    description: "Firebase Auth Domain",
  },
  {
    key: "NEXT_PUBLIC_FIREBASE_PROJECT_ID",
    required: true,
    description: "Firebase Project ID",
  },
  {
    key: "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET",
    required: true,
    description: "Firebase Storage Bucket",
  },
  {
    key: "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID",
    required: true,
    description: "Firebase Messaging Sender ID",
  },
  {
    key: "NEXT_PUBLIC_FIREBASE_APP_ID",
    required: true,
    description: "Firebase App ID",
  },

  // Firebase Admin (solo en producci√≥n)
  {
    key: "FIREBASE_SERVICE_ACCOUNT",
    required: false, // ‚úÖ CAMBIO AQU√ç - ahora es false
    description: "Firebase Service Account JSON (solo producci√≥n)",
  },

  // Mercado Pago
  {
    key: "MERCADOPAGO_ACCESS_TOKEN",
    required: true,
    description: "Mercado Pago Access Token",
  },
  {
    key: "MERCADOPAGO_WEBHOOK_URL",
    required: false, // ‚úÖ CAMBIO AQU√ç - ahora es false
    description: "URL del webhook de Mercado Pago",
  },

  // Google Maps
  {
    key: "GOOGLE_MAPS_API_KEY",
    required: false,
    description: "Google Maps API Key",
  },

  // App
  {
    key: "NEXT_PUBLIC_APP_URL",
    required: true,
    description: "URL base de la aplicaci√≥n",
  },
];

/**
 * Valida que todas las variables de entorno requeridas est√©n presentes
 */
export function validateEnv() {
  const missing: string[] = [];
  const warnings: string[] = [];

  ENV_VARS.forEach(({ key, required, description }) => {
    const value = process.env[key];

    if (!value || value.trim() === "") {
      if (required) {
        missing.push(`‚ùå ${key}: ${description}`);
      } else {
        warnings.push(`‚ö†Ô∏è  ${key}: ${description} (opcional)`);
      }
    }
  });

  // Mostrar warnings
  if (warnings.length > 0) {
    console.warn("\n‚ö†Ô∏è  Variables de entorno opcionales faltantes:");
    warnings.forEach((w) => console.warn(`   ${w}`));
    console.warn("");
  }

  // Si hay variables faltantes, lanzar error
  if (missing.length > 0) {
    console.error("\n‚ùå ERROR: Variables de entorno requeridas faltantes:\n");
    missing.forEach((m) => console.error(`   ${m}`));
    console.error("\nüí° Copia .env.example a .env y completa los valores\n");
    
    throw new Error("Faltan variables de entorno cr√≠ticas");
  }

  console.log("‚úÖ Todas las variables de entorno requeridas est√°n presentes");
}

/**
 * Helpers seguros para obtener variables de entorno
 */
export function getEnv(key: string): string {
  const value = process.env[key];
  
  if (!value) {
    throw new Error(`Variable de entorno ${key} no est√° configurada`);
  }
  
  return value;
}

export function getEnvOptional(key: string, defaultValue = ""): string {
  return process.env[key] || defaultValue;
}

/**
 * Variables de entorno tipadas y validadas
 */
export const env = {
  // Firebase Client
  firebase: {
    apiKey: () => getEnv("NEXT_PUBLIC_FIREBASE_API_KEY"),
    authDomain: () => getEnv("NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN"),
    projectId: () => getEnv("NEXT_PUBLIC_FIREBASE_PROJECT_ID"),
    storageBucket: () => getEnv("NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET"),
    messagingSenderId: () => getEnv("NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID"),
    appId: () => getEnv("NEXT_PUBLIC_FIREBASE_APP_ID"),
  },

  // Mercado Pago
  mercadopago: {
    accessToken: () => getEnv("MERCADOPAGO_ACCESS_TOKEN"),
    webhookUrl: () => getEnvOptional("MERCADOPAGO_WEBHOOK_URL"),
  },

  // Google Maps
  googleMaps: {
    apiKey: () => getEnvOptional("GOOGLE_MAPS_API_KEY"),
  },

  // App
  app: {
    url: () => getEnv("NEXT_PUBLIC_APP_URL"),
    nodeEnv: () => getEnvOptional("NODE_ENV", "development"),
    isDevelopment: () => process.env.NODE_ENV === "development",
    isProduction: () => process.env.NODE_ENV === "production",
  },
};
</file>

<file path="lib/featured/checkExpiration.ts">
import { db } from "../../lib/firebase-admin";
import { FieldValue, Timestamp } from "firebase-admin/firestore";

export async function checkFeaturedExpiration() {
  const now = Timestamp.now();

  const snap = await db
    .collection("products")
    .where("isFeatured", "==", true)
    .get();

  for (const doc of snap.docs) {
    const product = doc.data();
    const ref = doc.ref;

    if (!product.featuredUntil) continue;

    const diffMs =
      product.featuredUntil.toMillis() - now.toMillis();
    const daysLeft = Math.ceil(
      diffMs / (1000 * 60 * 60 * 24)
    );

    const alerts = product.featuredAlerts || {};

    // ‚ö†Ô∏è 3 d√≠as antes
    if (daysLeft === 3 && !alerts.warned3d) {
      console.log(`‚ö†Ô∏è Aviso 3 d√≠as: ${product.name}`);
      await ref.update({
        "featuredAlerts.warned3d": true,
      });
    }

    // ‚õî 1 d√≠a antes
    if (daysLeft === 1 && !alerts.warned1d) {
      console.log(`‚õî Aviso 1 d√≠a: ${product.name}`);
      await ref.update({
        "featuredAlerts.warned1d": true,
      });
    }

    // ‚ùå Vencido
    if (daysLeft <= 0) {
      console.log(`‚ùå Destacado vencido: ${product.name}`);
      await ref.update({
        isFeatured: false,
        featuredUntil: null,
        featuredAlerts: FieldValue.delete(),
      });
    }
  }
}
</file>

<file path="lib/mercadopago-split.ts">
import MercadoPagoConfig, { Preference } from "mercadopago";

const client = new MercadoPagoConfig({
  accessToken: process.env.MERCADOPAGO_ACCESS_TOKEN!,
});

type SplitPaymentParams = {
  title: string;
  unit_price: number;
  quantity: number;
  metadata: {
    productId: string;
    qty: number;
    tipo: "directa" | "fraccionada";
    withShipping: boolean;
    orderType?: string;
    lotType?: string;
    retailerId?: string;
    original_qty?: number;
    MF?: number;
    shippingCost?: number;
    shippingMode?: string;
    commission?: number;
  };
  back_urls: {
    success: string;
    pending: string;
    failure: string;
  };
  factoryMPUserId?: string;
  shippingCost: number;
  productTotal: number;
  commission: number;
};

export async function createSplitPreference(params: SplitPaymentParams) {
  const {
    title,
    unit_price,
    quantity,
    metadata,
    back_urls,
    commission,
  } = params;

  const preference = new Preference(client);

  if (metadata.tipo === "directa") {
    const response = await preference.create({
      body: {
        items: [
          {
            id: metadata.productId,
            title,
            unit_price,
            quantity,
          },
        ],
        back_urls,
        auto_return: "approved",
        metadata: metadata as any,
      },
    });

    return response;
  }

  if (metadata.tipo === "fraccionada") {
    const response = await preference.create({
      body: {
        items: [
          {
            id: metadata.productId,
            title,
            unit_price,
            quantity,
          },
        ],
        back_urls,
        auto_return: "approved",
        metadata: metadata as any,
        marketplace_fee: commission,
      },
    });

    return response;
  }

  const response = await preference.create({
    body: {
      items: [
        {
          id: metadata.productId,
          title,
          unit_price,
          quantity,
        },
      ],
      back_urls,
      auto_return: "approved",
      metadata: metadata as any,
    },
  });

  return response;
}
</file>

<file path="lib/notifications/send.ts">
// lib/notifications/send.ts

import { db } from '../firebase-admin';
import { FieldValue } from 'firebase-admin/firestore';
import { sendEmail } from '../email/client';
import {
  manufacturerDirectOrderEmail,
  manufacturerLotClosedEmail,
  manufacturerFractionalProgressEmail,
  retailerPickupEmail,
} from '../email/templates';
import type { WeekSchedule } from '../business-hours';

/**
 * Tipos de notificaci√≥n
 */
export type NotificationType =
  | 'manufacturer_direct_order'
  | 'manufacturer_lot_closed'
  | 'manufacturer_fractional_progress'
  | 'retailer_direct_pickup'
  | 'retailer_fractional_pickup'
  | 'retailer_refund';

/**
 * Data base para notificaciones
 */
export interface NotificationData {
  type: NotificationType;
  recipientId: string;
  recipientEmail: string;
  recipientRole: 'manufacturer' | 'retailer';
  data: Record<string, any>;
}

/**
 * Guarda notificaci√≥n en Firestore
 */
async function saveNotification(params: NotificationData) {
  await db.collection('notifications').add({
    ...params,
    status: 'pending',
    read: false,
    createdAt: FieldValue.serverTimestamp(),
  });
}

/**
 * Env√≠a notificaci√≥n completa (Firestore + Email)
 */
export async function sendNotification(params: NotificationData) {
  try {
    // 1Ô∏è‚É£ Guardar en Firestore (para historial/dashboard)
    await saveNotification(params);

    // 2Ô∏è‚É£ Determinar subject y template
    let subject = '';
    let html = '';

    switch (params.type) {
      case 'manufacturer_direct_order':
        subject = `üéâ Nuevo Pedido Directo - ${params.data.productName || 'Producto'}`;
        html = manufacturerDirectOrderEmail(params.data as any);
        break;

      case 'manufacturer_lot_closed':
        subject = `‚úÖ Lote Fraccionado Completado - ${params.data.productName || 'Producto'}`;
        html = manufacturerLotClosedEmail(params.data as any);
        break;

      case 'manufacturer_fractional_progress':
        subject = `üìä Nuevo Pedido Fraccionado - ${params.data.productName || 'Producto'}`;
        html = manufacturerFractionalProgressEmail(params.data as any);
        break;

      case 'retailer_direct_pickup':
      case 'retailer_fractional_pickup':
        subject = `‚úÖ Pedido Confirmado - Retiro en F√°brica`;
        html = retailerPickupEmail(params.data as any);
        break;

      default:
        console.warn(`‚ö†Ô∏è Tipo de notificaci√≥n no implementado: ${params.type}`);
        return;
    }

    // 3Ô∏è‚É£ Enviar email
    const result = await sendEmail({
      to: params.recipientEmail,
      subject,
      html,
    });

    if (result.success) {
      console.log(`‚úÖ Notificaci√≥n enviada: ${params.type} ‚Üí ${params.recipientEmail}`);
    } else {
      console.error(`‚ùå Error enviando email: ${params.type}`);
    }

    return result;

  } catch (error) {
    console.error('‚ùå Error en sendNotification:', error);
    throw error;
  }
}

/**
 * Notificar pedido directo a fabricante
 */
export async function notifyManufacturerDirectOrder(params: {
  factoryId: string;
  factoryEmail: string;
  productName: string;
  qty: number;
  retailerName: string;
  retailerAddress: string;
  retailerPhone?: string;
  shippingMode: string;
  orderId: string;
}) {
  await sendNotification({
    type: 'manufacturer_direct_order',
    recipientId: params.factoryId,
    recipientEmail: params.factoryEmail,
    recipientRole: 'manufacturer',
    data: {
      productName: params.productName,
      qty: params.qty,
      retailerName: params.retailerName,
      retailerAddress: params.retailerAddress,
      retailerPhone: params.retailerPhone,
      shippingMode: params.shippingMode,
      orderId: params.orderId,
      dashboardLink: process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000',
    },
  });
}

/**
 * Notificar lote cerrado a fabricante
 */
export async function notifyManufacturerLotClosed(params: {
  factoryId: string;
  factoryEmail: string;
  productName: string;
  totalQty: number;
  retailers: Array<{
    name: string;
    qty: number;
    address: string;
    phone?: string;
  }>;
  lotType: string;
  factoryAddress: string;
  orderId: string;
}) {
  await sendNotification({
    type: 'manufacturer_lot_closed',
    recipientId: params.factoryId,
    recipientEmail: params.factoryEmail,
    recipientRole: 'manufacturer',
    data: {
      productName: params.productName,
      totalQty: params.totalQty,
      retailers: params.retailers,
      lotType: params.lotType,
      factoryAddress: params.factoryAddress,
      orderId: params.orderId,
      dashboardLink: process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000',
    },
  });
}

/**
 * Notificar progreso de lote a fabricante
 */
export async function notifyManufacturerFractionalProgress(params: {
  factoryId: string;
  factoryEmail: string;
  productName: string;
  retailerName: string;
  qty: number;
  accumulatedQty: number;
  minimumOrder: number;
}) {
  const percentage = (params.accumulatedQty / params.minimumOrder) * 100;
  const remaining = params.minimumOrder - params.accumulatedQty;

  await sendNotification({
    type: 'manufacturer_fractional_progress',
    recipientId: params.factoryId,
    recipientEmail: params.factoryEmail,
    recipientRole: 'manufacturer',
    data: {
      productName: params.productName,
      retailerName: params.retailerName,
      qty: params.qty,
      accumulatedQty: params.accumulatedQty,
      minimumOrder: params.minimumOrder,
      percentage: Math.round(percentage),
      remaining: Math.max(0, remaining),
    },
  });
}

/**
 * Notificar retiro en f√°brica a revendedor
 */
export async function notifyRetailerPickup(params: {
  retailerId: string;
  retailerEmail: string;
  productName: string;
  qty: number;
  subtotal: number;
  total: number;
  factoryBusinessName: string;
  factoryAddress: string;
  factorySchedule: WeekSchedule;
  factoryPhone?: string;
  factoryEmail?: string;
  pickupDeadline: Date;
  orderId: string;
  isDirect: boolean;
}) {
  await sendNotification({
    type: params.isDirect ? 'retailer_direct_pickup' : 'retailer_fractional_pickup',
    recipientId: params.retailerId,
    recipientEmail: params.retailerEmail,
    recipientRole: 'retailer',
    data: {
      productName: params.productName,
      qty: params.qty,
      subtotal: params.subtotal,
      total: params.total,
      factoryBusinessName: params.factoryBusinessName,
      factoryAddress: params.factoryAddress,
      factorySchedule: params.factorySchedule,
      factoryPhone: params.factoryPhone,
      factoryEmail: params.factoryEmail,
      pickupDeadline: params.pickupDeadline,
      orderId: params.orderId,
      isDirect: params.isDirect,
      dashboardLink: process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000',
    },
  });
}
</file>

<file path="lib/rate-limit.ts">
import { LRUCache } from 'lru-cache';

type Options = {
  uniqueTokenPerInterval?: number;
  interval?: number;
};

export default function rateLimit(options?: Options) {
  const tokenCache = new LRUCache({
    max: options?.uniqueTokenPerInterval || 500,
    ttl: options?.interval || 60000,
  });

  return {
    check: (limit: number, token: string) =>
      new Promise<void>((resolve, reject) => {
        const tokenCount = (tokenCache.get(token) as number[]) || [0];
        if (tokenCount[0] === 0) {
          tokenCache.set(token, tokenCount);
        }
        tokenCount[0] += 1;

        const currentUsage = tokenCount[0];
        const isRateLimited = currentUsage >= limit;

        return isRateLimited ? reject() : resolve();
      }),
  };
}
</file>

<file path="lib/shipping/calculateShippingInternal.ts">
import { ProductShipping } from "../../lib/types/product";
import { calculateOwnShipping } from "./ownShipping";
import { calculateThirdPartyShipping } from "./thirdPartyShipping";

type Address = {
  lat: number;
  lng: number;
};

type Params = {
  shippingConfig: ProductShipping;
  factoryAddress: Address;
  retailerAddress: Address;
};

export function calculateShippingInternal({
  shippingConfig,
  factoryAddress,
  retailerAddress,
}: Params) {
  const results: Array<{
    method: "factory_pickup" | "own_shipping" | "third_party";
    cost: number;
  }> = [];

  const methods = shippingConfig.methods;

  // üè≠ Retiro en f√°brica
  if (methods.includes("factory_pickup")) {
    results.push({ method: "factory_pickup", cost: 0 });
  }

  // üöö Env√≠o propio
  if (
    methods.includes("own_logistics") &&
    shippingConfig.ownLogistics
  ) {
    const cost = calculateOwnShipping(
      factoryAddress,
      retailerAddress,
      shippingConfig.ownLogistics
    );

    results.push({ method: "own_shipping", cost });
  }

  // üöõ Env√≠o por terceros
  if (
    methods.includes("third_party") &&
    shippingConfig.thirdParty
  ) {
    const cost = calculateThirdPartyShipping(
      shippingConfig.thirdParty.fixedPrice
    );

    results.push({ method: "third_party", cost });
  }

  if (results.length === 0) {
    return {
      available: false,
      reason: "El producto no tiene m√©todos de env√≠o disponibles",
    };
  }

  return {
    available: true,
    options: results,
  };
}
</file>

<file path="lib/shipping/distance.ts">
export function distanceKm(
  a: { lat: number; lng: number },
  b: { lat: number; lng: number }
): number {
  if (
    typeof a.lat !== "number" ||
    typeof a.lng !== "number" ||
    typeof b.lat !== "number" ||
    typeof b.lng !== "number"
  ) {
    throw new Error("Coordenadas inv√°lidas para calcular distancia");
  }

  const R = 6371; // Radio de la Tierra en km
  const dLat = ((b.lat - a.lat) * Math.PI) / 180;
  const dLng = ((b.lng - a.lng) * Math.PI) / 180;

  const lat1 = (a.lat * Math.PI) / 180;
  const lat2 = (b.lat * Math.PI) / 180;

  const h =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1) *
      Math.cos(lat2) *
      Math.sin(dLng / 2) ** 2;

  const distance = R * 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));

  return Math.round(distance * 100) / 100; // 2 decimales
}
</file>

<file path="lib/shipping/fraccionadoShipping.ts">
import { distanceKm } from "./distance";

const BASE_ADDRESS = {
  lat: -34.591058,
  lng: -58.632046,
};

export function calculateFraccionadoShipping({
  factoryAddress,
  retailerAddress,
}: {
  factoryAddress: { lat: number; lng: number };
  retailerAddress: { lat: number; lng: number };
}) {
  const kmBaseFactory = distanceKm(BASE_ADDRESS, factoryAddress);
  const kmFactoryRetailer = distanceKm(factoryAddress, retailerAddress);

  const totalKm = (kmBaseFactory + kmFactoryRetailer) * 2;
  const cost = totalKm * 85 + 3500;

  return {
    shippingMode: "platform",
    shippingCost: Math.round(cost),
  };
}
</file>

<file path="lib/shipping/index.ts">
import { calculateShippingInternal } from "./calculateShippingInternal";

export function calculateShipping(params: any) {
  return calculateShippingInternal(params);
}
</file>

<file path="lib/shipping/ownShipping.ts">
import { distanceKm } from "./distance";
import { ProductShipping } from "../../lib/types/product";

type Address = {
  lat: number;
  lng: number;
};

export function calculateOwnShipping(
  factoryAddress: Address,
  retailerAddress: Address,
  config: ProductShipping["ownLogistics"]
): number {
  if (!config) {
    throw new Error("Config ownLogistics faltante");
  }

  const km = distanceKm(factoryAddress, retailerAddress);

  // 1Ô∏è‚É£ Precio por KM
  if (config.type === "per_km") {
    return Math.round(km * config.pricePerKm);
  }

  // 2Ô∏è‚É£ Zonas por distancia
  if (config.type === "zones") {
    if (km <= 10) return config.zones.zone1;
    if (km <= 30) return config.zones.zone2;
    return config.zones.zone3;
  }

  // 3Ô∏è‚É£ Zonas geogr√°ficas
  if (config.type === "geographic") {
    // simplificado: asumimos AMBA
    return config.areas.amba;
  }

  throw new Error("Modelo de env√≠o propio inv√°lido");
}
</file>

<file path="lib/shipping/thirdPartyShipping.ts">
export function calculateThirdPartyShipping(
  fixedPrice: number
): number {
  if (
    typeof fixedPrice !== "number" ||
    isNaN(fixedPrice) ||
    fixedPrice <= 0
  ) {
    throw new Error("Precio fijo de env√≠o por terceros inv√°lido");
  }

  return Math.round(fixedPrice);
}
</file>

<file path="lib/shipping/types.ts">

</file>

<file path="lib/shipping/validateConfig.ts">

</file>

<file path="lib/shipping/validateShippingConfig.ts">
import { ProductShipping } from "../../lib/types/product";

export class ShippingConfigError extends Error {
  code: string;

  constructor(message: string, code: string) {
    super(message);
    this.code = code;
  }
}

export function validateShippingConfig(shipping: ProductShipping) {
  if (!shipping) {
    throw new ShippingConfigError(
      "El producto no tiene configuraci√≥n de env√≠o",
      "SHIPPING_MISSING"
    );
  }

  const hasAnyMethod =
    shipping.methods.length > 0;

  if (!hasAnyMethod) {
    throw new ShippingConfigError(
      "Debe existir al menos un m√©todo de entrega",
      "NO_SHIPPING_METHOD"
    );
  }

  // üöö Env√≠o propio
  if (shipping.methods.includes("own_logistics")) {
    const own = shipping.ownLogistics;

    if (!own) {
      throw new ShippingConfigError(
        "Falta configuraci√≥n de env√≠o propio",
        "OWN_LOGISTICS_MISSING"
      );
    }

    if (own.type === "per_km" && own.pricePerKm <= 0) {
      throw new ShippingConfigError(
        "Precio por km inv√°lido",
        "OWN_LOGISTICS_KM_INVALID"
      );
    }

    if (own.type === "zones") {
      const { zone1, zone2, zone3 } = own.zones;
      if (zone1 <= 0 || zone2 <= 0 || zone3 <= 0) {
        throw new ShippingConfigError(
          "Zonas de distancia inv√°lidas",
          "OWN_LOGISTICS_ZONES_INVALID"
        );
      }
    }

    if (own.type === "geographic") {
      if (own.areas.amba <= 0) {
        throw new ShippingConfigError(
          "Precio AMBA inv√°lido",
          "OWN_LOGISTICS_GEO_INVALID"
        );
      }
    }
  }

  // üöõ Terceros
  if (shipping.methods.includes("third_party")) {
    if (
      !shipping.thirdParty ||
      shipping.thirdParty.fixedPrice <= 0 ||
      !shipping.thirdParty.disclaimerAccepted
    ) {
      throw new ShippingConfigError(
        "Configuraci√≥n inv√°lida de env√≠o por terceros",
        "THIRD_PARTY_INVALID"
      );
    }
  }

  // üè≠ Retiro en f√°brica: siempre v√°lido
}
</file>

<file path="lib/types/featured.ts">
// lib/types/featured.ts

export type FeaturedType = "product" | "factory";

export type FeaturedDuration = 7 | 15 | 30; // d√≠as

export const FEATURED_PRICES: Record<FeaturedDuration, number> = {
  7: 14000,   // 1 semana = $14,000
  15: 28000,  // 15 d√≠as = $28,000
  30: 50000, // 1 mes = $50,000
};

export const FEATURED_SLOTS = {
  product: 10,  // 10 slots para productos
  factory: 10,  // 10 slots para f√°bricas
};

export interface FeaturedItem {
  id?: string;
  type: FeaturedType;
  itemId: string; // productId o factoryId
  factoryId: string; // siempre el fabricante que paga
  
  // Duraci√≥n y fechas
  duration: FeaturedDuration;
  startDate: Date;
  endDate: Date;
  
  // Pago
  paymentId: string;
  amount: number;
  
  // Estado
  active: boolean;
  expired: boolean;
  
  // Metadata (para mostrar en home)
  metadata: {
    name: string;
    description?: string;
    imageUrl?: string;
  };
  
  createdAt: Date;
  updatedAt: Date;
}

export interface FeaturedSlotStatus {
  total: number;
  occupied: number;
  available: number;
  items: FeaturedItem[];
}
</file>

<file path="lib/types/product.ts">
// lib/types/product.ts

export type ProfitType = "percentage" | "fixed";

export type ShippingMethod =
  | "own_logistics"
  | "third_party"
  | "factory_pickup";

export type OwnLogisticsPricing =
  | {
      type: "per_km";
      pricePerKm: number;
    }
  | {
      type: "zones";
      zones: {
        zone1: number;
        zone2: number;
        zone3: number;
      };
    }
  | {
      type: "geographic";
      areas: {
        caba: number;
        amba: number;
        interior: number;
      };
    };

export interface ProductShipping {
  methods: ShippingMethod[];
  ownLogistics?: OwnLogisticsPricing;
  thirdParty?: {
    fixedPrice: number;
    disclaimerAccepted: boolean;
  };
  factoryPickup?: boolean;
}

export interface ProductProfit {
  type: ProfitType;
  value: number;
}

// ‚úÖ Categor√≠as/Rubros disponibles
export type ProductCategory =
  | "alimentos"
  | "bebidas"
  | "indumentaria"
  | "calzado"
  | "electronica"
  | "hogar"
  | "construccion"
  | "salud_belleza"
  | "jugueteria"
  | "libreria"
  | "deportes"
  | "automotor"
  | "mascotas"
  | "otros";

// ‚úÖ Labels amigables para categor√≠as
export const CATEGORY_LABELS: Record<ProductCategory, string> = {
  alimentos: "Alimentos y Bebidas",
  bebidas: "Bebidas",
  indumentaria: "Indumentaria",
  calzado: "Calzado",
  electronica: "Electr√≥nica",
  hogar: "Hogar y Decoraci√≥n",
  construccion: "Construcci√≥n y Ferreter√≠a",
  salud_belleza: "Salud y Belleza",
  jugueteria: "Jugueter√≠a",
  libreria: "Librer√≠a y Oficina",
  deportes: "Deportes y Fitness",
  automotor: "Automotor",
  mascotas: "Mascotas",
  otros: "Otros",
};

export interface Product {
  id?: string;

  /* üè≠ PROPIETARIO */
  factoryId: string;

  /* üì¶ B√ÅSICO */
  name: string;
  description?: string;
  price: number;
  minimumOrder: number;

  /* ‚úÖ Categor√≠a del producto */
  category: ProductCategory;

  /* üí∞ Ganancia neta informativa por unidad (solo fabricante) */
  netProfitPerUnit: number;

  /* üöö ENV√çOS */
  shipping: ProductShipping;

  /* ‚≠ê DESTACADO */
  featured: boolean;
  featuredUntil?: Date;

  /* üÜï INTERMEDIARIO - Indica si la plataforma act√∫a como intermediario */
  isIntermediary?: boolean;  // üëà AGREGAR ESTA L√çNEA

  /* üìä ESTADO */
  active: boolean;

  /* üïí FECHAS */
  createdAt: Date;
  updatedAt: Date;
}
</file>

<file path="lib/types/verification.ts">
// lib/types/verification.ts

/**
 * Estado de verificaci√≥n
 */
export type VerificationStatus = 
  | 'unverified'      // Sin verificar (reci√©n registrado)
  | 'pending'         // En revisi√≥n (documentos enviados)
  | 'verified'        // Verificado ‚úÖ
  | 'rejected';       // Rechazado (documentos inv√°lidos)

/**
 * Tipo de documento
 */
export type DocumentType =
  | 'cuit'              // Constancia AFIP
  | 'address_proof'     // Comprobante domicilio fiscal
  | 'facade_photo'      // Foto fachada
  | 'dni_front'         // DNI frente
  | 'dni_back'          // DNI dorso
  | 'license'           // Habilitaci√≥n (opcional)
  | 'certificate';      // Certificados (opcional)

/**
 * Documento subido
 */
export interface VerificationDocument {
  type: DocumentType;
  url: string;           // URL en Firebase Storage
  fileName: string;
  uploadedAt: Date;
  status: 'pending' | 'approved' | 'rejected';
  rejectionReason?: string;
}

/**
 * Solicitud de verificaci√≥n
 */
export interface VerificationRequest {
  id?: string;
  manufacturerId: string;
  
  // Informaci√≥n b√°sica
  cuit: string;
  legalName: string;      // Raz√≥n social
  businessAddress: string;
  
  // Documentos
  documents: VerificationDocument[];
  
  // Estado
  status: VerificationStatus;
  submittedAt?: Date;
  reviewedAt?: Date;
  reviewedBy?: string;    // Admin que revis√≥
  
  // Notas
  notes?: string;         // Notas del admin
  rejectionReason?: string;
  
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Info de verificaci√≥n en el perfil del fabricante
 */
export interface ManufacturerVerification {
  status: VerificationStatus;
  verifiedAt?: Date;
  cuit?: string;
  legalName?: string;
  
  // Para mostrar en UI
  badge: {
    show: boolean;
    label: string;
    color: 'gray' | 'yellow' | 'blue' | 'red';
    icon: string;
  };
}

/**
 * Helper para obtener info del badge seg√∫n status
 */
export function getVerificationBadge(status: VerificationStatus): ManufacturerVerification['badge'] {
  switch (status) {
    case 'verified':
      return {
        show: true,
        label: 'Empresa Verificada',
        color: 'blue',
        icon: '‚úì',
      };
    
    case 'pending':
      return {
        show: true,
        label: 'En Verificaci√≥n',
        color: 'yellow',
        icon: '‚è≥',
      };
    
    case 'rejected':
      return {
        show: true,
        label: 'Verificaci√≥n Rechazada',
        color: 'red',
        icon: '‚úï',
      };
    
    case 'unverified':
    default:
      return {
        show: false,
        label: 'Sin Verificar',
        color: 'gray',
        icon: '',
      };
  }
}
</file>

<file path="lib/validate-image.ts">
/**
 * Validaci√≥n de im√°genes para productos
 * Uso futuro cuando se implemente upload de im√°genes
 */

export interface ImageValidationResult {
  valid: boolean;
  error?: string;
}

export function validateImage(file: File): ImageValidationResult {
  // Tama√±o m√°ximo: 5MB
  const maxSize = 5 * 1024 * 1024;
  
  // Formatos permitidos
  const allowedTypes = [
    'image/jpeg',
    'image/png',
    'image/webp'
  ];
  
  // Validar tipo
  if (!allowedTypes.includes(file.type)) {
    return {
      valid: false,
      error: "Formato no permitido. Solo se aceptan JPEG, PNG y WEBP."
    };
  }
  
  // Validar tama√±o
  if (file.size > maxSize) {
    return {
      valid: false,
      error: "Imagen demasiado grande. El m√°ximo es 5MB."
    };
  }
  
  // Todo OK
  return { valid: true };
}

/**
 * Ejemplo de uso (cuando implementes el upload):
 * 
 * const validation = validateImage(file);
 * if (!validation.valid) {
 *   alert(validation.error);
 *   return;
 * }
 * // Continuar con el upload...
 */
</file>

<file path="pages/api/cron/featured.ts">
import type { NextApiRequest, NextApiResponse } from "next";
import { checkFeaturedExpiration } from "../../../lib/featured/checkExpiration";

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  if (req.method !== "GET") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  try {
    await checkFeaturedExpiration();
    return res.status(200).json({ success: true });
  } catch (err) {
    console.error("‚ùå CRON FEATURED ERROR:", err);
    return res.status(500).json({ error: "Internal error" });
  }
}
</file>

<file path="public/google.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 533.5 544.3">
  <path fill="#4285f4" d="M533.5 278.4c0-17.4-1.6-34.1-4.6-50.3H272v95.1h146.9c-6.3 34-25 62.7-53.3 81.9v67h86.2c50.4-46.4 81.7-114.8 81.7-193.7z"/>
  <path fill="#34a853" d="M272 544.3c72.6 0 133.6-24.1 178.1-65.3l-86.2-67c-24 16.1-54.7 25.6-91.9 25.6-70.7 0-130.6-47.7-152-111.6h-89v70.3C74.7 475.3 167.4 544.3 272 544.3z"/>
  <path fill="#fbbc04" d="M120 326c-10.3-30.9-10.3-64.1 0-95l-89-70.3C4.5 214.4 0 243.7 0 272s4.5 57.6 31 111.3l89-70.3z"/>
  <path fill="#ea4335" d="M272 107.7c39.5-.6 77.5 13.9 106.5 40.9l79.3-79.3C411.1 24.6 344.6-1.4 272 0 167.4 0 74.7 69 31 160.7l89 70.3c21.4-63.9 81.3-111.6 152-111.6z"/>
</svg>
</file>

<file path="scripts/migrate-products-category.ts">
import admin from "firebase-admin";
import path from "path";
import fs from "fs";

function initFirebase() {
  if (admin.apps.length > 0) {
    return admin.app();
  }

  const serviceAccountPath = path.join(
    process.cwd(),
    "credentials",
    "firebase-service-account.json"
  );

  if (!fs.existsSync(serviceAccountPath)) {
    throw new Error(
      `‚ùå Archivo de credenciales no encontrado: ${serviceAccountPath}\n` +
      "Asegurate de tener el archivo en credentials/firebase-service-account.json"
    );
  }

  const serviceAccount = JSON.parse(
    fs.readFileSync(serviceAccountPath, "utf8")
  );

  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
  });

  return admin.app();
}

async function migrateProducts() {
  console.log("üöÄ Iniciando migraci√≥n de productos...\n");

  try {
    initFirebase();
    const db = admin.firestore();

    const productsSnapshot = await db.collection("products").get();

    console.log(`üì¶ Productos encontrados: ${productsSnapshot.size}\n`);

    if (productsSnapshot.empty) {
      console.log("‚ö†Ô∏è  No hay productos para migrar");
      return;
    }

    let updated = 0;
    let alreadyHaveCategory = 0;

    for (const doc of productsSnapshot.docs) {
      try {
        const data = doc.data();

        if (data.category) {
          alreadyHaveCategory++;
          console.log(`‚úì ${doc.id} - Ya tiene categor√≠a: ${data.category}`);
          continue;
        }

        await doc.ref.update({
          category: "otros",
          updatedAt: admin.firestore.FieldValue.serverTimestamp(),
        });

        updated++;
        console.log(`‚úÖ ${doc.id} - Categor√≠a agregada: "otros"`);
      } catch (error) {
        console.error(`‚ùå Error en producto ${doc.id}:`, error);
      }
    }

    console.log("\n" + "=".repeat(50));
    console.log("üìä RESUMEN DE MIGRACI√ìN");
    console.log("=".repeat(50));
    console.log(`Total de productos:           ${productsSnapshot.size}`);
    console.log(`‚úÖ Actualizados:               ${updated}`);
    console.log(`‚úì  Ya ten√≠an categor√≠a:        ${alreadyHaveCategory}`);
    console.log("=".repeat(50) + "\n");
    console.log("üéâ Migraci√≥n completada exitosamente!\n");

  } catch (error) {
    console.error("\n‚ùå ERROR CR√çTICO:", error);
    process.exit(1);
  }
}

migrateProducts()
  .then(() => {
    console.log("‚úÖ Proceso finalizado");
    process.exit(0);
  })
  .catch((error) => {
    console.error("‚ùå Error fatal:", error);
    process.exit(1);
  });
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
# firebase admin credentials
credentials/

# Credenciales sensibles
credentials/
.env
.env.local
.env.production
.env.development

# Mantener solo el ejemplo
.env.example
</file>

<file path="app/api/auth/login/route.ts">
export const runtime = "nodejs";

import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { auth, db } from "../../../../lib/firebase-admin";

export async function POST(req: Request) {
  try {
    const { idToken } = await req.json();

    if (!idToken) {
      return NextResponse.json(
        { error: "Token requerido" },
        { status: 400 }
      );
    }

    // üîê Verificar token Firebase (Admin SDK)
    const decoded = await auth.verifyIdToken(idToken);
    const userId = decoded.uid;

    // üîé Buscar usuario en Firestore
    const userSnap = await db
      .collection("users")
      .where("userId", "==", userId)
      .limit(1)
      .get();

    if (userSnap.empty) {
      return NextResponse.json(
        { error: "Usuario no registrado" },
        { status: 403 }
      );
    }

    const user = userSnap.docs[0].data();
    const activeRole = user.activeRole || user.usertype;

    // üç™ Cookies
    cookies().set("userId", userId, {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production",
      sameSite: "lax",
      path: "/",
    });

    cookies().set("activeRole", activeRole, {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production",
      sameSite: "lax",
      path: "/",
    });

    return NextResponse.json({
      success: true,
      role: activeRole,
    });
  } catch (err) {
    console.error("‚ùå LOGIN ERROR:", err);
    return NextResponse.json(
      { error: "No autorizado" },
      { status: 401 }
    );
  }
}
</file>

<file path="app/api/payments/create-preference/route.ts">
import { NextResponse } from "next/server";
import { createPreference } from "../../../../lib/mercadopago";
import { createPurchaseOrder } from "../../../../lib/orders";

export async function POST(req: Request) {
  try {
    const body = await req.json();

    const {
      productId,
      qty,
      tipo,
      withShipping,
      title,
      unitPrice,
    } = body;

    // üîí Validaciones m√≠nimas
    if (!productId || !qty || !tipo || !title || !unitPrice) {
      return NextResponse.json(
        { error: "Datos incompletos" },
        { status: 400 }
      );
    }

    // 1Ô∏è‚É£ Crear preferencia en Mercado Pago
    const preference = await createPreference({
      title,
      unit_price: unitPrice,
      quantity: qty,
      metadata: {
        productId,
        qty,
        tipo,
        withShipping: Boolean(withShipping),
      },
      back_urls: {
        success:
          process.env.NEXT_PUBLIC_BASE_URL + "/success",
        pending:
          process.env.NEXT_PUBLIC_BASE_URL + "/pending",
        failure:
          process.env.NEXT_PUBLIC_BASE_URL + "/failure",
      },
    });

    // 2Ô∏è‚É£ VALIDAR preference.id (CLAVE)
    if (!preference.id) {
      throw new Error(
        "No se pudo obtener preferenceId de Mercado Pago"
      );
    }

    // 3Ô∏è‚É£ Crear ORDEN DE COMPRA (usuario)
    await createPurchaseOrder({
      productId,
      qty,
      tipo,
      withShipping: Boolean(withShipping),
      preferenceId: preference.id,
    });

    // 4Ô∏è‚É£ Devolver init_point al frontend
    return NextResponse.json({
      init_point: preference.init_point,
    });
  } catch (error) {
    console.error("Error create-preference:", error);

    return NextResponse.json(
      { error: "Error al crear preferencia" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/payments/refund/route.ts">
import { NextResponse } from "next/server";
import { MercadoPagoConfig, Payment } from "mercadopago";
import { db } from "../../../../lib/firebase-admin";
import { FieldValue } from "firebase-admin/firestore";

export async function POST(req: Request) {
  try {
    const { paymentId } = await req.json();

    if (!paymentId) {
      return NextResponse.json(
        { error: "paymentId requerido" },
        { status: 400 }
      );
    }

    /* ===============================
       1Ô∏è‚É£ OBTENER PAGO
    =============================== */
    const paymentRef = db.collection("payments").doc(paymentId);
    const paymentSnap = await paymentRef.get();

    if (!paymentSnap.exists) {
      return NextResponse.json(
        { error: "Pago no encontrado" },
        { status: 404 }
      );
    }

    const paymentData = paymentSnap.data()!;

    /* ===============================
       2Ô∏è‚É£ VALIDACIONES DE NEGOCIO
    =============================== */

    // üîí Solo fraccionados
    if (!paymentData.isFraccionado) {
      return NextResponse.json(
        { error: "Solo pedidos fraccionados pueden reembolsarse" },
        { status: 400 }
      );
    }

    // üîí Ya reembolsado
    if (paymentData.refunded === true) {
      return NextResponse.json(
        { error: "Pago ya fue reembolsado" },
        { status: 400 }
      );
    }

    // üîí Ya liquidado
    if (paymentData.settled === true) {
      return NextResponse.json(
        { error: "Lote cerrado, no se puede reembolsar" },
        { status: 400 }
      );
    }

    /* ===============================
       3Ô∏è‚É£ VALIDAR ESTADO DEL LOTE
       üëâ SOLO accumulating
    =============================== */
    const lotQuery = await db
      .collection("lots")
      .where("productId", "==", paymentData.productId)
      .where("factoryId", "==", paymentData.factoryId)
      .where("type", "==", paymentData.lotType)
      .limit(1)
      .get();

    if (lotQuery.empty) {
      return NextResponse.json(
        { error: "Lote no encontrado" },
        { status: 400 }
      );
    }

    const lotSnap = lotQuery.docs[0];
    const lot = lotSnap.data();

    if (lot.status !== "accumulating") {
      return NextResponse.json(
        { error: "El lote ya se cerr√≥, no se puede reembolsar" },
        { status: 400 }
      );
    }

    /* ===============================
       4Ô∏è‚É£ REEMBOLSO EN MERCADOPAGO
    =============================== */
    const client = new MercadoPagoConfig({
      accessToken: process.env.MERCADOPAGO_ACCESS_TOKEN!,
    });

    const paymentApi = new Payment(client);

    // ‚ö†Ô∏è cancel() es correcto para pagos a√∫n no liquidados
    await paymentApi.cancel({ id: paymentId });

    /* ===============================
       5Ô∏è‚É£ TRANSACCI√ìN FIRESTORE
       - Descontar del lote
       - Eliminar orden
       - Marcar pago reembolsado
    =============================== */
    await db.runTransaction(async (tx) => {
      const freshLotSnap = await tx.get(lotSnap.ref);
      if (!freshLotSnap.exists) return;

      const freshLot = freshLotSnap.data()!;
      const currentQty = Number(freshLot.accumulatedQty || 0);
      const refundQty = Number(paymentData.qty || 0);

      const newQty = Math.max(0, currentQty - refundQty);

      tx.update(freshLotSnap.ref, {
        accumulatedQty: newQty,
        orders: (freshLot.orders || []).filter(
          (o: any) => o.paymentId !== paymentId
        ),
        updatedAt: FieldValue.serverTimestamp(),
      });

      tx.update(paymentRef, {
        refunded: true,
        refundable: false,
        appliedToLot: false,
        refundedAt: FieldValue.serverTimestamp(),
      });
    });

    return NextResponse.json({ success: true });
  } catch (err) {
    console.error("‚ùå REFUND ERROR:", err);
    return NextResponse.json(
      { error: "Error al reembolsar" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/payments/route.ts">
import { NextResponse } from "next/server";
import { MercadoPagoConfig, Preference } from "mercadopago";

export async function POST(req: Request) {
  try {
    const body = await req.json();

    // üîí Validaciones b√°sicas
    if (
      typeof body.unitPrice !== "number" ||
      typeof body.qty !== "number" ||
      body.qty <= 0
    ) {
      return NextResponse.json(
        { error: "Datos de pago inv√°lidos" },
        { status: 400 }
      );
    }

    const client = new MercadoPagoConfig({
      accessToken: process.env.MERCADOPAGO_ACCESS_TOKEN!,
    });

    const preference = new Preference(client);

    const result = await preference.create({
      body: {
        items: [
          {
            id: String(body.productId ?? "prod_test_123"),
            title: "Producto de prueba",
            quantity: body.qty,
            unit_price: body.unitPrice,
          },
        ],

        // üîî WEBHOOK (YA FUNCIONA)
        notification_url:
          "https://thatcher-nonideological-windingly.ngrok-free.dev/api/webhooks/mercadopago",

        // üß† METADATA (ESTO ERA LO QUE FALTABA)
        metadata: {
          orderType: "fraccionado",
          productId: body.productId ?? "prod_test_123",
          qty: body.qty,
          MF: body.MF ?? 50,
          retailerId: "retailer_test",
          factoryId: "factory_test",
        },

        // ‚õî auto_return NO usar
        back_urls: {
          success: "http://localhost:3000/success",
          failure: "http://localhost:3000/failure",
          pending: "http://localhost:3000/pending",
        },
      },
    });

    return NextResponse.json({
      init_point: result.init_point,
    });
  } catch (error) {
    console.error("ERROR MP:", error);
    return NextResponse.json(
      { error: "Error creando preferencia" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/shipping/calculate/route.ts">
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { db } from "../../../../lib/firebase-admin";

/* ===============================
   üîç DISTANCIA (HAVERSINE)
=============================== */
function distanceKm(
  lat1: number,
  lng1: number,
  lat2: number,
  lng2: number
) {
  const R = 6371;
  const dLat = ((lat2 - lat1) * Math.PI) / 180;
  const dLng = ((lng2 - lng1) * Math.PI) / 180;

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos((lat1 * Math.PI) / 180) *
      Math.cos((lat2 * Math.PI) / 180) *
      Math.sin(dLng / 2) ** 2;

  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

/* ===============================
   üßæ TIPOS
=============================== */
type Address = {
  lat: number;
  lng: number;
  area?: "caba" | "amba" | "interior";
};

/* ===============================
   üìä FUNCI√ìN DE LOGGING MEJORADA
=============================== */
function logShippingError(error: unknown, context: Record<string, any>) {
  const errorDetails = {
    timestamp: new Date().toISOString(),
    context,
    error: {
      message: error instanceof Error ? error.message : "Unknown error",
      stack: error instanceof Error ? error.stack : undefined,
      type: error?.constructor?.name || typeof error,
    },
  };

  // ‚úÖ Log detallado a consola
  console.error("‚ùå SHIPPING CALCULATE ERROR:", JSON.stringify(errorDetails, null, 2));

  // ‚úÖ TODO: Integrar con Sentry cuando est√© disponible
  if (process.env.SENTRY_DSN) {
    try {
      // Sentry.captureException(error, {
      //   extra: context,
      //   tags: { service: 'shipping-calculate' }
      // });
    } catch (sentryError) {
      console.error("‚ùå Error al enviar a Sentry:", sentryError);
    }
  }

  return errorDetails;
}

export async function POST(req: Request) {
  const requestContext = {
    url: req.url,
    method: req.method,
  };

  try {
    /* ===============================
       üîê RETAILER DESDE COOKIE
    =============================== */
    const retailerId = cookies().get("userId")?.value;

    if (!retailerId) {
      logShippingError(
        new Error("No hay retailerId en cookie"),
        { ...requestContext, step: "auth" }
      );
      
      return NextResponse.json(
        {
          shippingMode: "pickup",
          shippingCost: 0,
          error: "Usuario no autenticado. Se asign√≥ retiro en f√°brica por defecto.",
        },
        { status: 200 }
      );
    }

    /* ===============================
       üì¶ BODY
    =============================== */
    const body = await req.json();
    const { productId, qty } = body;

    if (!productId || typeof qty !== "number" || qty <= 0) {
      logShippingError(
        new Error("Datos de entrada inv√°lidos"),
        { ...requestContext, body, step: "validation" }
      );

      return NextResponse.json(
        {
          shippingMode: "pickup",
          shippingCost: 0,
          error: "Datos inv√°lidos. Se asign√≥ retiro en f√°brica por defecto.",
        },
        { status: 200 }
      );
    }

    /* ===============================
       üì¶ PRODUCTO
    =============================== */
    const productSnap = await db
      .collection("products")
      .doc(productId)
      .get();

    if (!productSnap.exists) {
      logShippingError(
        new Error("Producto no encontrado"),
        { ...requestContext, productId, step: "product_fetch" }
      );

      return NextResponse.json(
        {
          shippingMode: "pickup",
          shippingCost: 0,
          error: "Producto no encontrado. Se asign√≥ retiro en f√°brica por defecto.",
        },
        { status: 200 }
      );
    }

    const product = productSnap.data();
    if (!product || !product.factoryId) {
      logShippingError(
        new Error("Producto sin factoryId"),
        { ...requestContext, productId, productData: product, step: "product_validation" }
      );

      return NextResponse.json(
        {
          shippingMode: "pickup",
          shippingCost: 0,
          error: "Producto sin fabricante asociado. Se asign√≥ retiro en f√°brica.",
        },
        { status: 200 }
      );
    }

    const shippingConfig = product.shipping;

    /* ===============================
       üè≠ F√ÅBRICA
    =============================== */
    const factorySnap = await db
      .collection("manufacturers")
      .doc(product.factoryId)
      .get();

    if (!factorySnap.exists) {
      logShippingError(
        new Error("F√°brica no encontrada"),
        { ...requestContext, factoryId: product.factoryId, step: "factory_fetch" }
      );

      return NextResponse.json(
        {
          shippingMode: "pickup",
          shippingCost: 0,
          error: "F√°brica no encontrada. Se asign√≥ retiro en f√°brica por defecto.",
        },
        { status: 200 }
      );
    }

    const factoryData = factorySnap.data();
    if (!factoryData || !factoryData.address) {
      logShippingError(
        new Error("F√°brica sin direcci√≥n"),
        { ...requestContext, factoryId: product.factoryId, step: "factory_address" }
      );

      return NextResponse.json(
        {
          shippingMode: "pickup",
          shippingCost: 0,
          error: "F√°brica sin direcci√≥n configurada. Se asign√≥ retiro en f√°brica.",
        },
        { status: 200 }
      );
    }

    const fAddr = factoryData.address as Address;

    /* ===============================
       üõí RETAILER
    =============================== */
    const retailerSnap = await db
      .collection("retailers")
      .doc(retailerId)
      .get();

    if (!retailerSnap.exists) {
      logShippingError(
        new Error("Revendedor no encontrado"),
        { ...requestContext, retailerId, step: "retailer_fetch" }
      );

      return NextResponse.json(
        {
          shippingMode: "pickup",
          shippingCost: 0,
          error: "Revendedor no encontrado. Se asign√≥ retiro en f√°brica por defecto.",
        },
        { status: 200 }
      );
    }

    const retailerData = retailerSnap.data();
    if (!retailerData || !retailerData.address) {
      logShippingError(
        new Error("Revendedor sin direcci√≥n"),
        { ...requestContext, retailerId, step: "retailer_address" }
      );

      return NextResponse.json(
        {
          shippingMode: "pickup",
          shippingCost: 0,
          error: "Revendedor sin direcci√≥n configurada. Se asign√≥ retiro en f√°brica.",
        },
        { status: 200 }
      );
    }

    const rAddr = retailerData.address as Address;

    if (
      typeof fAddr.lat !== "number" ||
      typeof fAddr.lng !== "number" ||
      typeof rAddr.lat !== "number" ||
      typeof rAddr.lng !== "number"
    ) {
      logShippingError(
        new Error("Direcciones incompletas o inv√°lidas"),
        {
          ...requestContext,
          factoryAddress: fAddr,
          retailerAddress: rAddr,
          step: "address_validation",
        }
      );

      return NextResponse.json(
        {
          shippingMode: "pickup",
          shippingCost: 0,
          error: "Direcciones incompletas. Se asign√≥ retiro en f√°brica por defecto.",
        },
        { status: 200 }
      );
    }

    /* ===============================
       üîç DISTANCIA
    =============================== */
    const km = distanceKm(
      fAddr.lat,
      fAddr.lng,
      rAddr.lat,
      rAddr.lng
    );

    /* ===============================
       üöö APLICAR REGLAS DEL PRODUCTO
    =============================== */

    // ENV√çO PROPIO
    if (
      shippingConfig?.methods?.includes("own_logistics") &&
      shippingConfig.ownLogistics
    ) {
      const own = shippingConfig.ownLogistics;

      if (own.type === "per_km") {
        return NextResponse.json({
          shippingMode: "factory",
          shippingCost: Math.round(km * own.pricePerKm),
        });
      }

      if (own.type === "zones") {
        let zone: "z1" | "z2" | "z3" = "z3";
        if (km <= 10) zone = "z1";
        else if (km <= 30) zone = "z2";

        return NextResponse.json({
          shippingMode: "factory",
          shippingCost: own.zones[zone],
        });
      }

      if (own.type === "geographic") {
        const area = rAddr.area ?? "interior";

        return NextResponse.json({
          shippingMode: "factory",
          shippingCost: own.areas[area],
        });
      }
    }

    // ENV√çO POR TERCEROS
    if (
      shippingConfig?.methods?.includes("third_party") &&
      shippingConfig.thirdParty
    ) {
      return NextResponse.json({
        shippingMode: "third_party",
        shippingCost: shippingConfig.thirdParty.fixedPrice,
      });
    }

    // RETIRO (DEFAULT)
    return NextResponse.json({
      shippingMode: "pickup",
      shippingCost: 0,
    });
    
  } catch (error) {
    // ‚úÖ LOGGING COMPLETO DEL ERROR
    logShippingError(error, {
      ...requestContext,
      step: "unexpected_error",
    });

    // ‚úÖ RESPUESTA SEGURA PARA EL CLIENTE
    return NextResponse.json(
      {
        shippingMode: "pickup",
        shippingCost: 0,
        error: "Ocurri√≥ un error al calcular el env√≠o. Se asign√≥ retiro en f√°brica por defecto.",
      },
      { status: 200 }
    );
  }
}
</file>

<file path="app/api/shipping/factory/route.ts">
import { NextResponse } from "next/server";
import { calculateShippingInternal } from "../../../../lib/shipping/calculateShippingInternal";

export async function POST(req: Request) {
  try {
    const body = await req.json();

    const result = calculateShippingInternal({
      shippingConfig: body.shipping, // üëà nombre correcto
      factoryAddress: body.factoryAddress,
      retailerAddress: body.retailerAddress,
    });

    return NextResponse.json(result);
  } catch (error: any) {
    return NextResponse.json(
      { error: error.message ?? "Error calculando retiro en f√°brica" },
      { status: 400 }
    );
  }
}
</file>

<file path="app/dashboard/pedidos-fraccionados/page.tsx">
import { db } from "../../../lib/firebase-admin";
import { cookies } from "next/headers";
import ActiveRoleBadge from "../../../components/ActiveRoleBadge";
import SwitchRoleButton from "../../../components/SwitchRoleButton";
import Link from "next/link";
import { formatCurrency } from "../../../lib/utils";
import { Suspense } from "react"; // ‚úÖ NUEVO
import { DashboardSkeleton } from "../../../components/DashboardSkeleton"; // ‚úÖ NUEVO

// ‚úÖ NUEVO: Separar contenido en funci√≥n async
async function DashboardRevendedorContent() {
  const userId = cookies().get("userId")?.value;
  const role = cookies().get("activeRole")?.value;

  if (!userId || role !== "retailer") {
    return <div className="p-6">No autorizado</div>;
  }

  /* ===============================
     üßæ PEDIDOS DEL REVENDEDOR
  =============================== */
  const ordersSnap = await db
    .collection("payments")
    .where("buyerId", "==", userId)
    .get();

  const orders = ordersSnap.docs.map(doc => doc.data());

  /* ===============================
     üìä M√âTRICAS
  =============================== */

  // ‚úÖ PEDIDOS CERRADOS (directos + fraccionados cerrados)
  const pedidosTotales = orders.filter(o =>
    o.type === "direct" ||
    (o.type === "fractional" && o.lotStatus === "closed")
  );

  // ‚è≥ PEDIDOS FRACCIONADOS EN PROCESO
  const pedidosEnProceso = orders.filter(o =>
    o.type === "fractional" && o.lotStatus !== "closed"
  );

  // üí∞ TOTAL INVERTIDO (solo pedidos cerrados)
  const totalInvertido = pedidosTotales.reduce(
    (acc, o) => acc + (o.total || 0),
    0
  );

  /* ===============================
     ‚úÖ FIX ERROR 22: LOTES ACTIVOS REALES
     Traer datos reales de Firestore
  =============================== */
  const activeLotsSnap = await db
    .collection("lots")
    .where("status", "==", "accumulating")
    .get();

  // Filtrar solo los lotes donde este usuario tiene pedidos
  const activeLots = activeLotsSnap.docs
    .map(doc => {
      const data = doc.data();
      const orders = data.orders || [];
      
      // Verificar si este usuario tiene pedidos en este lote
      const userOrders = orders.filter(
        (o: any) => o.retailerId === userId
      );
      
      if (userOrders.length === 0) return null;
      
      // Calcular cantidad del usuario en este lote
      const userQty = userOrders.reduce(
        (sum: number, o: any) => sum + (o.qty || 0),
        0
      );
      
      return {
        id: doc.id,
        productId: data.productId,
        productName: data.productName || "Producto",
        type: data.type,
        accumulatedQty: data.accumulatedQty || 0,
        minimumOrder: data.minimumOrder || data.MF || 0,
        userQty,
        progress: data.minimumOrder > 0 
          ? Math.min((data.accumulatedQty / data.minimumOrder) * 100, 100)
          : 0,
      };
    })
    .filter(Boolean); // Remover nulls

  // Obtener nombres de productos para los lotes
  const productIds = [...new Set(activeLots.map(l => l?.productId).filter(Boolean))];
  const productsSnap = await db
    .collection("products")
    .where("__name__", "in", productIds.length > 0 ? productIds : ["dummy"])
    .get();
  
  const productsMap = new Map();
  productsSnap.docs.forEach(doc => {
    productsMap.set(doc.id, doc.data().name);
  });

  // Actualizar nombres de productos
  activeLots.forEach(lot => {
    if (lot && lot.productId && productsMap.has(lot.productId)) {
      lot.productName = productsMap.get(lot.productId);
    }
  });

  /* ===============================
     üßæ UI
  =============================== */
  return (
    <div className="min-h-screen bg-gray-50">
      <div className="p-8 max-w-6xl mx-auto">

        {/* HEADER */}
        <div className="flex justify-between items-center mb-10">
          <div>
            <h1 className="text-3xl font-semibold">
              Dashboard del revendedor
            </h1>
            <p className="text-gray-600 mt-1">
              Gestion√° tus compras y pedidos
            </p>
          </div>

          <div className="flex items-center gap-4">
            <ActiveRoleBadge />
            <SwitchRoleButton targetRole="manufacturer" />
          </div>
        </div>

        {/* KPIs */}
        <div className="grid md:grid-cols-3 gap-6 mb-12">

          {/* ‚úÖ PEDIDOS TOTALES */}
          <div className="bg-white p-6 rounded-xl shadow">
            <p className="text-sm text-gray-500">Pedidos totales</p>
            <p className="text-3xl font-semibold mt-2">
              {pedidosTotales.length}
            </p>
          </div>

          {/* ‚è≥ PEDIDOS EN PROCESO */}
          <div className="bg-white p-6 rounded-xl shadow">
            <p className="text-sm text-gray-500">Pedidos en proceso</p>
            <p className="text-3xl font-semibold mt-2">
              {pedidosEnProceso.length}
            </p>
          </div>

          {/* üí∞ TOTAL INVERTIDO */}
          <div className="bg-white p-6 rounded-xl shadow">
            <p className="text-sm text-gray-500">Total invertido</p>
            <p className="text-3xl font-semibold mt-2">
              {formatCurrency(totalInvertido)}
            </p>
          </div>

        </div>

        {/* ‚úÖ FIX ERROR 22: SECCI√ìN PEDIDOS FRACCIONADOS EN CURSO (DATOS REALES) */}
        <div className="bg-white rounded-xl shadow p-6 mb-12">
          <h2 className="text-lg font-semibold mb-4">
            Pedidos fraccionados en curso
          </h2>

          {activeLots.length === 0 ? (
            <p className="text-gray-500 text-sm">
              No ten√©s pedidos fraccionados en proceso actualmente.
            </p>
          ) : (
            <div className="space-y-4">
              {activeLots.map((lot) => {
                if (!lot) return null;
                
                const progressPercent = Math.round(lot.progress);
                const isNearComplete = progressPercent >= 80;
                
                return (
                  <div key={lot.id}>
                    <div className="flex justify-between text-sm mb-1">
                      <div>
                        <span className="font-medium">{lot.productName}</span>
                        <span className="text-xs text-gray-500 ml-2">
                          (Tu pedido: {lot.userQty} unidades)
                        </span>
                      </div>
                      <span className="text-gray-500">
                        {lot.accumulatedQty} / {lot.minimumOrder}
                      </span>
                    </div>

                    <div className="w-full bg-gray-200 rounded-full h-3">
                      <div
                        className={`h-3 rounded-full transition-all ${
                          isNearComplete ? 'bg-green-600' : 'bg-blue-600'
                        }`}
                        style={{ width: `${progressPercent}%` }}
                      />
                    </div>
                    
                    {isNearComplete && (
                      <p className="text-xs text-green-600 mt-1">
                        ¬°Cerca de completarse!
                      </p>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>

        {/* EXPLORAR PRODUCTOS (SE MANTIENE) */}
        <div className="grid md:grid-cols-1 gap-6 mb-12">
          <Link
            href="/explorar"
            className="bg-white p-8 rounded-xl shadow hover:shadow-lg transition"
          >
            <h2 className="text-xl font-semibold mb-2">
              Explorar productos
            </h2>
            <p className="text-gray-600 mb-4">
              Compr√° directo o fraccionado
            </p>
            <span className="text-blue-600 font-medium">
              Ver productos ‚Üí
            </span>
          </Link>
        </div>

      </div>
    </div>
  );
}

// ‚úÖ NUEVO: P√°gina principal con Suspense
export default function DashboardRevendedor() {
  return (
    <Suspense fallback={<DashboardSkeleton />}>
      <DashboardRevendedorContent />
    </Suspense>
  );
}
</file>

<file path="app/globals.css">
@import "tailwindcss";

/* ===============================
   VARIABLES DE COLOR CENTRALIZADAS
   Ahora puedes cambiar los colores de toda la web desde aqu√≠
=============================== */

:root {
  /* Colores base */
  --background: #ffffff;
  --foreground: #171717;
  
  /* Colores principales */
  --primary: #2563eb;        /* Azul principal */
  --primary-foreground: #ffffff;
  --primary-hover: #1d4ed8;
  
  /* Colores secundarios */
  --secondary: #10b981;      /* Verde */
  --secondary-foreground: #ffffff;
  
  /* Estados */
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  
  /* Grises */
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  
  /* Bordes y sombras */
  --border: #e5e7eb;
  --ring: #3b82f6;
}

/* ===============================
   MODO OSCURO (opcional para futuro)
=============================== */

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
    --primary: #3b82f6;
    --border: #374151;
  }
}

/* ===============================
   ESTILOS BASE
=============================== */

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}

/* ===============================
   ANIMACIONES GLOBALES
=============================== */

@keyframes fadeUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ===============================
   CLASES UTILITARIAS CON VARIABLES
   Usa estas en vez de bg-blue-600, etc.
=============================== */

.bg-primary {
  background-color: var(--primary);
}

.text-primary {
  color: var(--primary);
}

.bg-primary-hover:hover {
  background-color: var(--primary-hover);
}

.bg-secondary {
  background-color: var(--secondary);
}

.text-secondary {
  color: var(--secondary);
}

.bg-success {
  background-color: var(--success);
}

.text-success {
  color: var(--success);
}

.bg-danger {
  background-color: var(--danger);
}

.text-danger {
  color: var(--danger);
}

.border-primary {
  border-color: var(--border);
}
</file>

<file path="app/layout.tsx">
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import { Toaster } from "react-hot-toast";
import AuthCheck from "../components/AuthCheck"; // ‚úÖ NUEVO

const inter = Inter({
  subsets: ["latin"],
  variable: "--font-inter",
});

export const metadata: Metadata = {
  title: "Plataforma",
  description: "Marketplace mayorista",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="es">
      <body className={inter.variable + " antialiased"}>
        {/* ‚úÖ NUEVO: Verificaci√≥n de sesi√≥n */}
        <AuthCheck />
        
        {children}

        {/* üîî TOAST GLOBAL (UX PRO) */}
        <Toaster position="top-right" />
      </body>
    </html>
  );
}
</file>

<file path="app/login/page.tsx">
"use client";

import Image from "next/image";
import { useState, useEffect } from "react";
import {
  signInWithEmailAndPassword,
  GoogleAuthProvider,
  signInWithPopup,
} from "firebase/auth";
import { auth } from "../../lib/firebase-client";
import { useRouter } from "next/navigation";

export default function LoginPage() {
  const router = useRouter();

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [selectedRole, setSelectedRole] = useState<"manufacturer" | "retailer" | null>(null);

  // Obtener rol elegido desde localStorage
  useEffect(() => {
    const role = localStorage.getItem("selectedRole") as "manufacturer" | "retailer" | null;
    
    if (!role) {
      // Si no hay rol seleccionado, volver al home
      router.push("/");
      return;
    }
    
    setSelectedRole(role);
  }, [router]);

  if (!selectedRole) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Cargando...</p>
        </div>
      </div>
    );
  }

  const roleLabel = selectedRole === "manufacturer" ? "Fabricante" : "Revendedor";

  /* ===============================
     üîê LOGIN EMAIL / PASSWORD
  =============================== */
  async function handleLogin(e: React.FormEvent) {
    e.preventDefault();
    setLoading(true);
    setError("");

    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      const idToken = await cred.user.getIdToken();

      // Intentar login
      const res = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ idToken }),
      });

      if (res.ok) {
        const data = await res.json();
        redirectToDashboard(data.role);
      } else if (res.status === 403) {
        // Usuario no registrado -> Registrar autom√°ticamente
        await registerUser(idToken);
      } else {
        throw new Error("Login backend fall√≥");
      }
    } catch (err) {
      console.error(err);
      setError("Email o contrase√±a incorrectos");
      setLoading(false);
    }
  }

  /* ===============================
     üîµ LOGIN GOOGLE
  =============================== */
  async function handleGoogleLogin() {
    setLoading(true);
    setError("");

    try {
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const idToken = await user.getIdToken();

      // Intentar login
      const res = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ idToken }),
      });

      if (res.ok) {
        const data = await res.json();
        redirectToDashboard(data.role);
      } else if (res.status === 403) {
        // Usuario no registrado -> Registrar autom√°ticamente
        await registerUser(idToken);
      } else {
        throw new Error("Login backend fall√≥");
      }
    } catch (err) {
      console.error(err);
      setError("Error al iniciar sesi√≥n con Google");
      setLoading(false);
    }
  }

  /* ===============================
     üìù REGISTRAR USUARIO AUTOM√ÅTICAMENTE
  =============================== */
  async function registerUser(idToken: string) {
    try {
      const res = await fetch("/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          idToken,
          usertype: selectedRole, // Usar el rol elegido en HOME
        }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.error || "Error al registrar");
      }

      // Despu√©s de registrar, hacer login
      const loginRes = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ idToken }),
      });

      if (!loginRes.ok) {
        throw new Error("Login fall√≥ despu√©s del registro");
      }

      const data = await loginRes.json();
      
      // Limpiar localStorage
      localStorage.removeItem("selectedRole");
      
      redirectToDashboard(data.role);

    } catch (err: any) {
      console.error(err);
      setError(err.message || "Error al completar registro");
      setLoading(false);
    }
  }

  /* ===============================
     üîÄ REDIRIGIR AL DASHBOARD
  =============================== */
  function redirectToDashboard(role: string) {
    // Limpiar localStorage
    localStorage.removeItem("selectedRole");
    
    if (role === "manufacturer") {
      router.push("/dashboard/fabricante");
    } else {
      router.push("/dashboard/pedidos-fraccionados");
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
        
        {/* Header con rol elegido */}
        <div className="text-center mb-6">
          <div className="inline-block bg-blue-100 text-blue-700 px-4 py-2 rounded-full text-sm font-medium mb-4">
            {roleLabel}
          </div>
          <h1 className="text-2xl font-semibold mb-2">
            Iniciar sesi√≥n
          </h1>
          <p className="text-gray-600 text-sm">
            Ingres√° a tu cuenta de {roleLabel.toLowerCase()}
          </p>
        </div>

        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 p-3 rounded mb-4 text-sm">
            {error}
          </div>
        )}

        {/* Login con Google (principal) */}
        <button
          onClick={handleGoogleLogin}
          disabled={loading}
          className="w-full border-2 border-gray-300 py-3 rounded-lg flex items-center justify-center gap-3 hover:bg-gray-50 disabled:opacity-50 transition mb-4"
        >
          <Image src="/google.svg" alt="Google" width={20} height={20} />
          <span className="font-medium">Continuar con Google</span>
        </button>

        {/* Divisor */}
        <div className="relative my-6">
          <div className="absolute inset-0 flex items-center">
            <div className="w-full border-t border-gray-300"></div>
          </div>
          <div className="relative flex justify-center text-sm">
            <span className="px-4 bg-white text-gray-500">O con email</span>
          </div>
        </div>

        {/* Login con email */}
        <form onSubmit={handleLogin} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Email
            </label>
            <input
              type="email"
              placeholder="tu@email.com"
              className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Contrase√±a
            </label>
            <input
              type="password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
            />
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 transition"
          >
            {loading ? "Ingresando..." : "Ingresar"}
          </button>
        </form>

        {/* Cambiar rol */}
        <div className="mt-6 text-center">
          <button
            onClick={() => router.push("/")}
            className="text-sm text-gray-600 hover:text-gray-900"
          >
            ‚Üê Volver y elegir otro rol
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="app/products/[id]/page.tsx">
import { db } from "../../../lib/firebase-admin";
import ProductPurchaseClient from "../../../components/products/ProductPurchaseClient";

/* ===============================
   TIPOS
================================ */

type Product = {
  id: string;
  name: string;
  price: number;
  MF: number;
};

type FraccionadoLot = {
  accumulatedQty: number;
  MF: number;
  status: "accumulating" | "closed";
};

type Props = {
  params: { id: string };
};

/* ===============================
   DATA
================================ */

async function getProductById(
  id: string
): Promise<Product | null> {
  const snap = await db.collection("products").doc(id).get();
  if (!snap.exists) return null;

  const data = snap.data();

  return {
    id: snap.id,
    name: data?.name ?? "",
    price: data?.price ?? 0,
    MF: data?.minimumQuantity ?? 0,
  };
}

async function getFraccionadoLot(
  productId: string,
  lotType: "fraccionado_retiro" | "fraccionado_envio"
): Promise<FraccionadoLot | null> {
  const snap = await db
    .collection("lots")
    .doc(`${productId}_${lotType}`)
    .get();

  if (!snap.exists) return null;

  const data = snap.data();

  return {
    accumulatedQty: data?.accumulatedQty ?? 0,
    MF: data?.MF ?? 0,
    status: data?.status ?? "accumulating",
  };
}

/* ===============================
   PAGE
================================ */

export default async function ProductPage({ params }: Props) {
  const product = await getProductById(params.id);

  if (!product) {
    return (
      <main className="p-6">
        <h1 className="text-xl font-bold">
          Producto no encontrado
        </h1>
      </main>
    );
  }

  const retiroLot = await getFraccionadoLot(
    product.id,
    "fraccionado_retiro"
  );

  const envioLot = await getFraccionadoLot(
    product.id,
    "fraccionado_envio"
  );

  return (
    <main className="max-w-3xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-4">
        {product.name}
      </h1>

      <p className="text-lg mb-4">
        Precio base: $ {product.price}
      </p>

      {retiroLot && (
        <p className="text-sm text-gray-600 mb-1">
          Fraccionado ‚Äì Retiro:{" "}
          {retiroLot.accumulatedQty}/{retiroLot.MF}
        </p>
      )}

      {envioLot && (
        <p className="text-sm text-gray-600 mb-4">
          Fraccionado ‚Äì Env√≠o:{" "}
          {envioLot.accumulatedQty}/{envioLot.MF}
        </p>
      )}

      {/* üëá SOLO PASA LO NECESARIO */}
      <ProductPurchaseClient
  price={product.price}
  MF={product.MF}
  productId={product.id}
/>
    </main>
  );
}
</file>

<file path="app/products/page.tsx">
import Link from "next/link";
import { db } from "../../lib/firebase-admin";

type Product = {
  id: string;
  name: string;
  price: number;
  MF: number;
  accumulatedQty: number;
};

async function getProducts(): Promise<Product[]> {
  const snapshot = await db.collection("products").get();

  return snapshot.docs.map((doc) => {
    const data = doc.data();

    return {
      id: doc.id,
      name: data.name,
      price: data.price,
      MF: data.MF,
      accumulatedQty: data.accumulatedQty ?? 0,
    };
  });
}

export default async function ProductsPage() {
  const products = await getProducts();

  return (
    <main className="max-w-7xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-6">
        Cat√°logo mayorista
      </h1>

      {products.length === 0 && (
        <p className="text-gray-500">
          No hay productos cargados.
        </p>
      )}

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {products.map((product) => {
          const progress =
            product.MF > 0
              ? Math.min(
                  (product.accumulatedQty / product.MF) * 100,
                  100
                )
              : 0;

          return (
            <Link
              key={product.id}
              href={"/products/" + product.id}
              className="border rounded-lg p-4 hover:shadow transition block"
            >
              <h2 className="font-semibold text-lg mb-2">
                {product.name}
              </h2>

              <p className="text-sm mb-1">
                Precio base: $ {product.price}
              </p>

              <p className="text-sm mb-2">
                Lote: {product.accumulatedQty} / {product.MF}
              </p>

              <div className="w-full bg-gray-200 rounded h-2">
                <div
                  className="bg-blue-600 h-2 rounded"
                  style={{ width: progress + "%" }}
                />
              </div>
            </Link>
          );
        })}
      </div>
    </main>
  );
}
</file>

<file path="app/products/test/page.tsx">
"use client";

import { useEffect, useState } from "react";

type Lot = {
  accumulatedQty: number;
  MF: number;
};

export default function TestProductPage() {
  const PRODUCT_PRICE = 2000;
  const PRODUCT_ID = "prod_test_123";
  const MF = 50;

  const FACTORY_SHIPPING = 15000;
  const COMMISSION_RATE = 0.12;

  const [qty, setQty] = useState(18);
  const [shippingFraccionado, setShippingFraccionado] = useState<number | null>(null);
  const [lot, setLot] = useState<Lot | null>(null);
  const [loadingPay, setLoadingPay] = useState(false);

  // üîπ Calcular env√≠o fraccionado
  useEffect(() => {
    async function calcularEnvio() {
      const res = await fetch("/api/shipping/fraccionado", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          factoryAddress: "Av. Corrientes 1234, CABA",
          retailerAddress: "Av. San Mart√≠n 2500, Hurlingham",
        }),
      });

      const data = await res.json();
      setShippingFraccionado(Number(data.totalCost));
    }

    calcularEnvio();
  }, []);

  // üîπ Cargar lote fraccionado
  useEffect(() => {
    async function cargarLote() {
      const res = await fetch("/api/lots/" + PRODUCT_ID);
      const data = await res.json();
      setLot(data);
    }

    cargarLote();
  }, []);

  // üîπ C√°lculos
  const subtotal = PRODUCT_PRICE * qty;

  const directUnitPrice = (subtotal + FACTORY_SHIPPING) / qty;

  const fraccionadoUnitPrice =
    shippingFraccionado !== null
      ? (subtotal + subtotal * COMMISSION_RATE + shippingFraccionado) / qty
      : null;

  const mejorOpcion =
    qty >= MF
      ? "directa"
      : fraccionadoUnitPrice !== null && fraccionadoUnitPrice < directUnitPrice
      ? "fraccionada"
      : "directa";

  // üî• PAGO FINAL (UNA SOLA FUNCI√ìN)
  async function pagarAhora() {
    if (mejorOpcion === "fraccionada" && fraccionadoUnitPrice === null) {
      alert("Calculando env√≠o fraccionado...");
      return;
    }

    setLoadingPay(true);

    const unitPrice =
      mejorOpcion === "directa"
        ? Number(directUnitPrice.toFixed(2))
        : Number(fraccionadoUnitPrice!.toFixed(2));

    const res = await fetch("/api/payments", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        productId: PRODUCT_ID,
        qty,
        orderType: mejorOpcion,
        unitPrice,
      }),
    });

    const data = await res.json();

    if (data.init_point) {
      window.location.href = data.init_point;
    } else {
      alert("Error iniciando el pago");
      setLoadingPay(false);
    }
  }

  return (
    <div style={{ padding: 20, maxWidth: 520 }}>
      <h1>Producto de prueba</h1>

      <p>
        <strong>Precio f√°brica:</strong> ARS {PRODUCT_PRICE}
      </p>

      <label>Cantidad</label>
      <input
        type="number"
        value={qty}
        onChange={(e) => setQty(Number(e.target.value))}
        min={1}
        style={{ width: "100%", marginBottom: 10 }}
      />

      <hr />

      <h3>Compra directa</h3>
      <p>ARS {directUnitPrice.toFixed(2)} / unidad</p>

      {fraccionadoUnitPrice !== null && (
        <>
          <hr />
          <h3>Compra fraccionada</h3>
          <p>ARS {fraccionadoUnitPrice.toFixed(2)} / unidad</p>

          {lot && lot.accumulatedQty < lot.MF && (
            <div style={{ marginTop: 15 }}>
              <strong>Lote fraccionado</strong>
              <p>
                {lot.accumulatedQty} / {lot.MF}
              </p>

              <div
                style={{
                  height: 10,
                  background: "#eee",
                  borderRadius: 6,
                  overflow: "hidden",
                }}
              >
                <div
                  style={{
                    width: `${(lot.accumulatedQty / lot.MF) * 100}%`,
                    background: "#4caf50",
                    height: "100%",
                  }}
                />
              </div>
            </div>
          )}
        </>
      )}

      <hr />

      <div style={{ background: "#e6f7e6", padding: 10, marginBottom: 15 }}>
        üí° <strong>Te conviene {mejorOpcion}</strong>
      </div>

      <button
        onClick={pagarAhora}
        disabled={loadingPay}
        style={{
          width: "100%",
          padding: 12,
          fontSize: 16,
          background: "#0070f3",
          color: "#fff",
          border: "none",
          borderRadius: 6,
          cursor: "pointer",
        }}
      >
        {loadingPay ? "Redirigiendo..." : "Pagar ahora"}
      </button>
    </div>
  );
}
</file>

<file path="app/test-payment/page.tsx">
"use client";

export default function Home() {
  const pagar = async () => {
    const res = await fetch("/api/payments", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        items: [
          {
            title: "Pedido mayorista",
            quantity: 1,
            unit_price: 1500,
          },
        ],
      }),
    });

    const data = await res.json();

    if (data.init_point) {
      window.location.href = data.init_point;
    } else {
      alert("Error al crear el pago");
      console.error(data);
    }
  };

  return (
    <main style={{ padding: 40 }}>
      <h1>Pago de prueba Mercado Pago</h1>

      <button
        onClick={pagar}
        style={{
          padding: "12px 20px",
          fontSize: 18,
          cursor: "pointer",
          marginTop: 20,
        }}
      >
        Pagar $1500
      </button>
    </main>
  );
}
</file>

<file path="components/PedidoFraccionadoCard.tsx">
"use client";

import { useState } from "react";

type PedidoFraccionadoCardProps = {
  paymentId: string;
  productName: string;
  qty: number;
  MF: number;
  accumulatedQty: number;
  status: "accumulating" | "closed";
  createdAt: string;
  refundable: boolean;
};

export default function PedidoFraccionadoCard({
  paymentId,
  productName,
  qty,
  MF,
  accumulatedQty,
  status,
  createdAt,
  refundable,
}: PedidoFraccionadoCardProps) {
  const [loading, setLoading] = useState(false);
  const [refunded, setRefunded] = useState(false);

  async function handleRefund() {
    if (!confirm("¬øSeguro que quer√©s cancelar y reembolsar este pedido?")) {
      return;
    }

    setLoading(true);

    try {
      const res = await fetch("/api/payments/refund", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paymentId }),
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.error || "Error al reembolsar");
        return;
      }

      setRefunded(true);
    } catch (err) {
  console.error("Error reembolso:", err);
  alert("Error inesperado");
} finally {
      setLoading(false);
    }
  }

  const progress = Math.min(
    Math.round((accumulatedQty / MF) * 100),
    100
  );

  return (
    <div className="border rounded-lg p-4 mb-4 bg-white shadow-sm">
      <div className="flex justify-between items-start">
        <div>
          <h3 className="font-semibold text-lg">{productName}</h3>
          <p className="text-sm text-gray-500">
            Pedido realizado: {createdAt}
          </p>
        </div>

        <span
          className={`text-xs px-2 py-1 rounded ${
            status === "closed"
              ? "bg-green-100 text-green-700"
              : "bg-yellow-100 text-yellow-700"
          }`}
        >
          {status === "closed" ? "Lote cerrado" : "En acumulaci√≥n"}
        </span>
      </div>

      {/* PROGRESO */}
<div className="mt-4">
  <div className="flex justify-between text-sm mb-1">
    <span>
      Progreso del lote: {accumulatedQty}/{MF}
    </span>
    <span>{progress}%</span>
  </div>

  <div className="w-full bg-gray-200 rounded h-2 overflow-hidden">
    <div
      className="bg-black h-2 transition-all"
      style={{ width: progress + "%" }}
    />
  </div>
</div>

      {/* INFO PEDIDO */}
      <div className="mt-3 text-sm">
        <p>
          <strong>Tu cantidad:</strong> {qty}
        </p>
      </div>

      {/* REEMBOLSO */}
      {refundable && status === "accumulating" && !refunded && (
        <button
          onClick={handleRefund}
          disabled={loading}
          className="mt-4 w-full border border-red-500 text-red-600 py-2 rounded hover:bg-red-50 disabled:opacity-50"
        >
          {loading ? "Procesando..." : "Cancelar y pedir reembolso"}
        </button>
      )}

      {refunded && (
        <p className="mt-4 text-sm text-red-600">
          Pedido reembolsado correctamente
        </p>
      )}

      {status === "closed" && (
        <p className="mt-4 text-sm text-green-700">
          El lote ya se cerr√≥. No se puede reembolsar.
        </p>
      )}
    </div>
  );
}
</file>

<file path="components/products/ProductPurchaseClient.tsx">
"use client";

import { useEffect, useMemo, useState, useCallback } from "react";

type Props = {
  price: number;
  MF: number;
  productId: string;
};

type ShippingMode = "pickup" | "factory" | "platform";

export default function ProductPurchaseClient({ price, MF, productId }: Props) {
  const [qty, setQty] = useState(1);
  const isFraccionado = qty < MF;
  
  const [selectedShipping, setSelectedShipping] = useState<ShippingMode>("pickup");
  const [shippingCost, setShippingCost] = useState(0);
  const [loadingShipping, setLoadingShipping] = useState(false);
  
  const [mpConnected, setMpConnected] = useState<boolean | null>(null);
  const [loadingMPStatus, setLoadingMPStatus] = useState(true);
  const [factoryId, setFactoryId] = useState<string | null>(null);

  useEffect(() => {
    async function checkFactoryMPStatus() {
      setLoadingMPStatus(true);
      try {
        const productRes = await fetch(`/api/products/explore`);
        if (!productRes.ok) throw new Error("Error cargando producto");
        
        const { products } = await productRes.json();
        const product = products.find((p: any) => p.id === productId);
        
        if (!product || !product.factoryId) {
          setMpConnected(false);
          return;
        }
        
        setFactoryId(product.factoryId);

        const mpRes = await fetch(`/api/manufacturers/mp-status-public?factoryId=${product.factoryId}`);
        if (!mpRes.ok) {
          setMpConnected(false);
          return;
        }
        
        const mpData = await mpRes.json();
        setMpConnected(mpData.connected === true);
      } catch (err) {
        console.error("Error verificando MP:", err);
        setMpConnected(false);
      } finally {
        setLoadingMPStatus(false);
      }
    }

    checkFactoryMPStatus();
  }, [productId]);

  const calculatePlatformShipping = useCallback(async () => {
    setLoadingShipping(true);
    try {
      const res = await fetch("/api/shipping/fraccionado", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productId }),
      });

      const data = await res.json();
      setSelectedShipping("platform");
      setShippingCost(typeof data.shippingCost === "number" ? data.shippingCost : 0);
    } catch (err) {
      console.error("Error env√≠o plataforma:", err);
      setSelectedShipping("platform");
      setShippingCost(0);
    } finally {
      setLoadingShipping(false);
    }
  }, [productId]);

  useEffect(() => {
    if (isFraccionado) {
      calculatePlatformShipping();
      return;
    }

    async function calculateDirectShipping() {
      setLoadingShipping(true);
      try {
        const res = await fetch("/api/shipping/calculate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productId, qty }),
        });

        const data = await res.json();

        if (data && typeof data.shippingCost === "number" && data.shippingMode) {
          setSelectedShipping(data.shippingMode);
          setShippingCost(data.shippingCost);
        } else {
          setSelectedShipping("pickup");
          setShippingCost(0);
        }
      } catch (err) {
        console.error("Error env√≠o directo:", err);
        setSelectedShipping("pickup");
        setShippingCost(0);
      } finally {
        setLoadingShipping(false);
      }
    }

    calculateDirectShipping();
  }, [qty, MF, productId, isFraccionado, calculatePlatformShipping]);

  const productSubtotal = price * qty;
  const commission = isFraccionado ? Math.round(productSubtotal * 0.12) : 0;
  const totalToCharge = useMemo(
    () => productSubtotal + commission + shippingCost,
    [productSubtotal, commission, shippingCost]
  );

  async function handleCheckout() {
    if (mpConnected === false) {
      alert("‚ö†Ô∏è Este producto no est√° disponible para compra.\n\nEl fabricante a√∫n no ha vinculado su cuenta de Mercado Pago.");
      return;
    }

    if (loadingMPStatus) {
      alert("‚è≥ Verificando disponibilidad...");
      return;
    }

    const orderType = isFraccionado ? "fraccionado" : "directa";
    const lotType = isFraccionado
      ? selectedShipping === "pickup" ? "fraccionado_retiro" : "fraccionado_envio"
      : selectedShipping === "pickup" ? "directa_retiro" : "directa_envio";

    const res = await fetch("/api/payments/mercadopago", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title: "Compra Mayorista",
        unitPrice: totalToCharge,
        qty: 1,
        originalQty: qty,
        productId,
        orderType,
        lotType,
        shippingMode: selectedShipping,
        shippingCost,
        commission,
        MF,
      }),
    });

    if (!res.ok) {
      alert("Error iniciando pago");
      return;
    }

    const data = await res.json();
    if (data?.init_point) {
      window.location.href = data.init_point;
    }
  }

  return (
    <div className="border rounded-xl p-6 mt-8 bg-white shadow">
      
      {!loadingMPStatus && mpConnected === false && (
        <div className="mb-6 bg-red-50 border-2 border-red-300 rounded-lg p-4">
          <div className="flex items-start gap-3">
            <div className="text-2xl">‚ö†Ô∏è</div>
            <div>
              <p className="font-semibold text-red-800 mb-1">
                Producto no disponible temporalmente
              </p>
              <p className="text-sm text-red-700">
                El fabricante a√∫n no ha vinculado su cuenta de Mercado Pago para recibir pagos.
              </p>
            </div>
          </div>
        </div>
      )}

      <div className="mb-5">
        <label className="block text-sm mb-1">Cantidad</label>
        <input
          type="number"
          min={1}
          value={qty}
          onChange={(e) => setQty(Number(e.target.value))}
          className="border rounded px-3 py-2 w-32"
          disabled={mpConnected === false}
        />
        {isFraccionado && (
          <p className="text-xs text-gray-500 mt-1">
            Pedido fraccionado (m√≠nimo {MF})
          </p>
        )}
      </div>

      <div className="mb-5">
        <p className="font-semibold mb-2">Forma de env√≠o</p>

        <label className="block">
          <input
            type="radio"
            name="shipping"
            checked={selectedShipping === "pickup"}
            onChange={() => {
              setSelectedShipping("pickup");
              setShippingCost(0);
            }}
            disabled={mpConnected === false}
          />
          <span className="ml-2">Retiro en f√°brica (Gratis)</span>
        </label>

        {isFraccionado && (
          <label className="block mt-1">
            <input
              type="radio"
              name="shipping"
              checked={selectedShipping === "platform"}
              onChange={calculatePlatformShipping}
              disabled={mpConnected === false}
            />
            <span className="ml-2">
              {loadingShipping
                ? "Calculando env√≠o..."
                : `Env√≠o por plataforma: $ ${shippingCost}`}
            </span>
          </label>
        )}

        {!isFraccionado && (
          <label className="block mt-1">
            <input
              type="radio"
              name="shipping"
              checked={selectedShipping === "factory"}
              onChange={() => setSelectedShipping("factory")}
              disabled={mpConnected === false}
            />
            <span className="ml-2">
              {loadingShipping
                ? "Calculando env√≠o..."
                : `Env√≠o por f√°brica: $ ${shippingCost}`}
            </span>
          </label>
        )}
      </div>

      <div className="border rounded p-4 text-sm mb-6 bg-gray-50">
        <p>Subtotal producto: $ {productSubtotal}</p>
        {commission > 0 && <p>Comisi√≥n (12%): $ {commission}</p>}
        <p>Env√≠o: $ {shippingCost}</p>
        <p className="font-semibold mt-2 text-base">
          Total: $ {totalToCharge}
        </p>
      </div>

      <button
        onClick={handleCheckout}
        disabled={loadingMPStatus || mpConnected === false}
        className="w-full bg-black text-white py-3 rounded-lg font-medium hover:bg-gray-800 transition disabled:opacity-50 disabled:cursor-not-allowed"
      >
        {loadingMPStatus 
          ? "Verificando disponibilidad..." 
          : mpConnected === false
          ? "Producto no disponible"
          : "Continuar al pago"}
      </button>
    </div>
  );
}
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  {
    rules: {
      "@typescript-eslint/no-explicit-any": "off",
      "@typescript-eslint/no-unused-vars": "warn",
      "@typescript-eslint/no-require-imports": "off",
      "@typescript-eslint/no-unused-expressions": "off",
      "react-hooks/exhaustive-deps": "warn",
      "react-hooks/purity": "off",
      "@next/next/no-html-link-for-pages": "warn",
      "@next/next/no-img-element": "warn",
    }
  },
  globalIgnores([
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="lib/firebase-client.ts">
import { initializeApp, getApps, getApp } from "firebase/app";
import { getAuth } from "firebase/auth";

const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY!,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN!,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID!,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET!,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID!,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID!,
};

const app = !getApps().length ? initializeApp(firebaseConfig) : getApp();

export const auth = getAuth(app);
export default app;
</file>

<file path="lib/lot.types.ts">
/**
 * TIPOS DE LOTES - ESTANDARIZADOS
 * 
 * ‚úÖ CAMBIOS:
 * - MF ‚Üí minimumOrder
 * - Tipos normalizados de lote
 */

export interface FraccionatedOrder {
  retailerId: string;
  qty: number;
  paymentId: string;
}

export type LotType =
  | "fractional_pickup"    // Fraccionado + retiro
  | "fractional_shipping"  // Fraccionado + env√≠o
  | "direct_pickup"        // Directo + retiro
  | "direct_shipping";     // Directo + env√≠o

export interface Lot {
  id?: string;
  productId: string;
  factoryId: string;
  type: LotType;
  minimumOrder: number; // ‚úÖ Antes era MF
  accumulatedQty: number;
  orders: FraccionatedOrder[];
  status: "accumulating" | "closed";
  orderCreated?: boolean;
  createdAt: any;
  updatedAt?: any;
  closedAt?: any;
}

/**
 * Helper para migrar datos legacy
 */
export function normalizeLot(data: any): Lot {
  // Normalizar type
  let type = data.type;
  if (type === "fraccionado_retiro") type = "fractional_pickup";
  if (type === "fraccionado_envio") type = "fractional_shipping";
  if (type === "directa_retiro") type = "direct_pickup";
  if (type === "directa_envio") type = "direct_shipping";

  return {
    ...data,
    type,
    minimumOrder: data.minimumOrder ?? data.MF ?? 0,
  };
}
</file>

<file path="lib/mercadopago.ts">
import MercadoPagoConfig, { Preference } from "mercadopago";
import { env } from "./env";

/**
 * Configuraci√≥n del cliente de Mercado Pago
 * Usa el SDK nuevo oficial
 */
const client = new MercadoPagoConfig({
  accessToken: env.mercadopago.accessToken(),
});

/**
 * Helper para crear una preferencia de pago
 * NO es una API Route
 * Se usa solo desde server (app/api)
 */
export async function createPreference({
  title,
  unit_price,
  quantity,
  metadata,
  back_urls,
}: {
  title: string;
  unit_price: number;
  quantity: number;
  metadata: {
    productId: string;
    qty: number;
    tipo: "directa" | "fraccionada" | "destacado"; // ‚úÖ AGREGADO "destacado"
    withShipping: boolean;
    // ‚úÖ NUEVO: Campos opcionales para destacados
    featuredType?: "product" | "factory";
    featuredItemId?: string;
    featuredDuration?: number;
  };
  back_urls: {
    success: string;
    pending: string;
    failure: string;
  };
}) {
  const preference = new Preference(client);

  const response = await preference.create({
    body: {
      items: [
        {
          id: metadata.productId,
          title,
          unit_price,
          quantity,
        },
      ],
      metadata,
      back_urls,
      auto_return: "approved",
    },
  });

  return response;
}
</file>

<file path="lib/shipping.ts">
import { env } from "./env";

/**
 * Direcci√≥n base fija (centro log√≠stico)
 */
const BASE_ADDRESS =
  "Poeta Romildo Risso 3244, William Morris, Hurlingham, Buenos Aires, Argentina";

const PRECIO_POR_KM = 85;
const FIJO_CONDUCTOR = 3500;

export type ShippingResult = {
  kmBaseToFactory: number;
  kmFactoryToRetailer: number;
  kmTotal: number;
  kmCharged: number;
  totalCost: number;
};

/**
 * Calcula env√≠o fraccionado
 * ‚ö†Ô∏è REQUIERE direcciones v√°lidas (string)
 */
export async function calculateFraccionadoShipping(params: {
  factoryAddress: string;
  retailerAddress: string;
}): Promise<ShippingResult> {
  const { factoryAddress, retailerAddress } = params;

  // ‚úÖ Usa el validador seguro
  const apiKey = env.googleMaps.apiKey();
  
  if (!apiKey) {
    throw new Error("GOOGLE_MAPS_API_KEY no configurada");
  }

  const kmBaseToFactory = await getKm(
    BASE_ADDRESS,
    factoryAddress,
    apiKey
  );

  const kmFactoryToRetailer = await getKm(
    factoryAddress,
    retailerAddress,
    apiKey
  );

  const kmTotal = kmBaseToFactory + kmFactoryToRetailer;
  const kmCharged = kmTotal * 2;

  const totalCost = Math.round(
    kmCharged * PRECIO_POR_KM + FIJO_CONDUCTOR
  );

  return {
    kmBaseToFactory,
    kmFactoryToRetailer,
    kmTotal,
    kmCharged,
    totalCost,
  };
}

async function getKm(
  origin: string,
  destination: string,
  apiKey: string
): Promise<number> {
  const url = new URL(
    "https://maps.googleapis.com/maps/api/distancematrix/json"
  );

  url.searchParams.set("origins", origin);
  url.searchParams.set("destinations", destination);
  url.searchParams.set("key", apiKey);

  const res = await fetch(url.toString());
  const data = await res.json();

  if (
    data.status !== "OK" ||
    data.rows[0].elements[0].status !== "OK"
  ) {
    throw new Error("Error calculando distancia");
  }

  return data.rows[0].elements[0].distance.value / 1000;
}
</file>

<file path="lib/shipping/zones.ts">
export type KmZones = {
  z1: number; // 0‚Äì10 km
  z2: number; // 10‚Äì30 km
  z3: number; // 30‚Äì60 km
};

export function calculateZoneShipping(
  distanceKm: number,
  kmZones: KmZones
): { cost: number; zone: "z1" | "z2" | "z3" } {
  if (distanceKm <= 10) {
    return { cost: kmZones.z1, zone: "z1" };
  }

  if (distanceKm <= 30) {
    return { cost: kmZones.z2, zone: "z2" };
  }

  // > 30 km
  return { cost: kmZones.z3, zone: "z3" };
}
</file>

<file path="lib/types/shipping.ts">
export type ShippingConfig = {
  // ‚úÖ Retiro en f√°brica (opcional y combinable)
  allowPickup: boolean;

  // üöö Tipo principal de env√≠o
  shippingType: "own" | "third_party";

  // ============================
  // üè≠ LOG√çSTICA PROPIA
  // ============================
  ownShipping?: {
    pricingModel: "km" | "zones" | "region";

    // üîπ Precio por KM
    perKmRate?: number;

    // üîπ Zonas por distancia
    kmZones?: {
      z1: number; // ej: hasta 10km
      z2: number; // ej: hasta 30km
      z3: number; // ej: +30km
    };

    // üîπ Regiones geogr√°ficas
    regionPrices?: {
      caba: number;
      amba: number;
      interior: number;
    };
  };

  // ============================
  // üöö ENV√çO POR TERCEROS
  // ============================
  thirdPartyShipping?: {
    fixedPrice: number; // precio √∫nico fijo
  };
};
</file>

<file path="lib/utils.ts">
import { clsx } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: any[]) {
  return twMerge(clsx(inputs));
}

/* ===============================
   ‚úÖ FIX ERROR 21: Helper de formateo de moneda
   Uso consistente en toda la aplicaci√≥n
=============================== */

/**
 * Formatea un monto en pesos argentinos sin decimales
 * @param amount - Monto a formatear
 * @returns String formateado (ej: "$ 1.500")
 */
export function formatCurrency(amount: number): string {
  return new Intl.NumberFormat('es-AR', {
    style: 'currency',
    currency: 'ARS',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount);
}

/**
 * Formatea un monto en pesos argentinos con 2 decimales
 * @param amount - Monto a formatear
 * @returns String formateado (ej: "$ 1.500,50")
 */
export function formatCurrencyWithDecimals(amount: number): string {
  return new Intl.NumberFormat('es-AR', {
    style: 'currency',
    currency: 'ARS',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(amount);
}
</file>

<file path="middleware.ts">
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

export function middleware(req: NextRequest) {
  const userId = req.cookies.get("userId")?.value;
  const role = req.cookies.get("activeRole")?.value;
  const path = req.nextUrl.pathname;

  // ‚úÖ FIX ERROR 18: Redirigir a login si no est√° autenticado
  if (!userId && !path.startsWith("/login")) {
    return NextResponse.redirect(new URL("/login", req.url));
  }

  // üè≠ Fabricante queriendo entrar a revendedor
  if (
    path.startsWith("/dashboard/pedidos-fraccionados") &&
    role !== "retailer"
  ) {
    return NextResponse.redirect(
      new URL("/dashboard/fabricante", req.url)
    );
  }

  // üõí Revendedor queriendo entrar a fabricante
  if (
    path.startsWith("/dashboard/fabricante") &&
    role !== "manufacturer"
  ) {
    return NextResponse.redirect(
      new URL("/dashboard/pedidos-fraccionados", req.url)
    );
  }

  return NextResponse.next();
}

/* ===============================
   RUTAS PROTEGIDAS
   ‚úÖ FIX ERROR 18: Agregado /explorar
=============================== */
export const config = {
  matcher: [
    "/dashboard/:path*",
    "/explorar/:path*", // ‚úÖ Ahora explorar requiere autenticaci√≥n
  ],
};
</file>

<file path="next.config.js">
/** @type {import('next').NextConfig} */

const nextConfig = {
  reactStrictMode: true,
  
  async headers() {
    return [
      {
        source: "/api/:path*",
        headers: [
          {
            key: "Access-Control-Allow-Credentials",
            value: "true",
          },
          {
            key: "Access-Control-Allow-Origin",
            value: process.env.ALLOWED_ORIGIN || process.env.NEXT_PUBLIC_APP_URL || "*",
          },
          {
            key: "Access-Control-Allow-Methods",
            value: "GET,POST,PUT,DELETE,OPTIONS",
          },
          {
            key: "Access-Control-Allow-Headers",
            value: "Content-Type, Authorization",
          },
        ],
      },
    ];
  },
};

module.exports = nextConfig;
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="app/api/lots/[productId]/route.ts">
import { NextResponse } from "next/server";
import { getAdminServices } from "../../../../lib/firebase-admin";

export async function GET(
  req: Request,
  { params }: { params: { productId: string } }
) {
  try {
    const { adminDb } = await getAdminServices();
    const productId = params.productId;

    if (!productId) {
      return NextResponse.json({ accumulatedQty: 0, MF: 0 });
    }

    const snap = await adminDb
      .collection("lots")
      .doc(productId)
      .get();

    if (!snap.exists) {
      return NextResponse.json({ accumulatedQty: 0, MF: 0 });
    }

    const data = snap.data();

    return NextResponse.json({
      accumulatedQty: data?.accumulatedQty ?? 0,
      MF: data?.MF ?? 0,
    });
  } catch (error) {
    console.error("ERROR LOTS:", error);
    return NextResponse.json(
      { error: "Error cargando lote" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/lots/active/route.ts">
import { NextResponse } from "next/server";
import { db } from "../../../../lib/firebase-admin";

export async function GET(req: Request) {
  try {
    const { searchParams } = new URL(req.url);
    const productId = searchParams.get("productId");

    if (!productId) {
      return NextResponse.json(
        { error: "productId requerido" },
        { status: 400 }
      );
    }

    const lotRef = db.collection("lots").doc(productId);
    const snap = await lotRef.get();

    // üü° Si no existe, el lote est√° vac√≠o
    if (!snap.exists) {
      return NextResponse.json({
        productId,
        accumulatedQty: 0,
        MF: 0,
        status: "open",
        progress: 0,
        isComplete: false,
      });
    }

    const data = snap.data()!;
    const accumulatedQty = data.accumulatedQty ?? 0;
    const MF = data.MF ?? 0;

    const isComplete = MF > 0 && accumulatedQty >= MF;

    return NextResponse.json({
      productId,
      accumulatedQty,
      MF,
      status: isComplete ? "closed" : "open",
      progress: MF > 0 ? Math.min(accumulatedQty / MF, 1) : 0,
      isComplete,
      updatedAt: data.updatedAt ?? null,
    });
  } catch (error) {
    console.error("‚ùå ERROR ACTIVE LOT:", error);
    return NextResponse.json(
      { error: "Error obteniendo lote activo" },
      { status: 500 }
    );
  }
}
</file>

<file path="app/api/payments/mercadopago/route.ts">
import { NextResponse } from "next/server";
import { createSplitPreference } from "../../../../lib/mercadopago-split";
import { cookies } from "next/headers";
import { db } from "../../../../lib/firebase-admin";
import rateLimit from "../../../../lib/rate-limit";

const limiter = rateLimit({
  interval: 60 * 1000,
  uniqueTokenPerInterval: 500,
});

export async function POST(req: Request) {
  const ip = req.headers.get('x-forwarded-for') || 
             req.headers.get('x-real-ip') || 
             'unknown';
  
  try {
    await limiter.check(10, ip);
  } catch {
    return NextResponse.json(
      { error: "Demasiados intentos. Por favor, espera un minuto." },
      { status: 429 }
    );
  }

  try {
    // ‚úÖ OBTENER USER ID DESDE COOKIE
    const userId = cookies().get("userId")?.value;
    
    if (!userId) {
      return NextResponse.json(
        { error: "No autorizado" },
        { status: 401 }
      );
    }

    const body = await req.json();
    const { 
      title, 
      unitPrice, 
      originalQty, 
      orderType, 
      lotType, 
      productId, 
      shippingMode, 
      shippingCost = 0, 
      MF,
      commission = 0,
    } = body;

    if (!originalQty || !Number.isFinite(Number(originalQty)) || !unitPrice || unitPrice <= 0) {
      return NextResponse.json({ error: "Datos inv√°lidos" }, { status: 400 });
    }

    const baseUrl = process.env.NEXT_PUBLIC_APP_URL;
    if (!baseUrl) {
      return NextResponse.json({ error: "Configuraci√≥n faltante" }, { status: 500 });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // OBTENER DATOS DEL PRODUCTO Y FABRICANTE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const productSnap = await db.collection("products").doc(productId).get();
    if (!productSnap.exists) {
      return NextResponse.json({ error: "Producto no encontrado" }, { status: 404 });
    }

    const productData = productSnap.data()!;
    const factoryId = productData.factoryId;

    const factorySnap = await db.collection("manufacturers").doc(factoryId).get();
    const factoryData = factorySnap.data();
    const factoryMPUserId = factoryData?.mercadopago?.user_id || null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DETERMINAR TIPO DE PEDIDO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const tipo = orderType === "fraccionada" ? "fraccionada" : "directa";
    const withShipping = shippingMode !== "pickup";

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CALCULAR MONTOS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const productTotal = unitPrice - (commission + shippingCost);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CREAR PREFERENCIA CON SPLIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const preference = await createSplitPreference({
      title,
      unit_price: Math.round(unitPrice),
      quantity: 1,
      
      metadata: {
        productId,
        qty: originalQty,
        tipo,
        withShipping,
        orderType,
        lotType,
        retailerId: userId, // ‚úÖ USANDO userId de cookie
        original_qty: originalQty,
        MF,
        shippingCost,
        shippingMode,
        commission,
      },
      
      back_urls: {
        success: `${baseUrl}/success`,
        failure: `${baseUrl}/failure`,
        pending: `${baseUrl}/pending`,
      },
      
      // ‚úÖ SPLIT DE PAGOS
      factoryMPUserId,
      shippingCost,
      productTotal,
      commission,
    });

    return NextResponse.json({ init_point: preference.init_point });
  } catch (error: any) {
    console.error("Error MP:", error);
    return NextResponse.json({ error: "Error iniciando pago" }, { status: 500 });
  }
}
</file>

<file path="app/api/shipping/fraccionado/route.ts">
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { db } from "../../../../lib/firebase-admin";

/* ===============================
   üîç DISTANCIA (HAVERSINE)
=============================== */
function distanceKmFrac(
  lat1: number,
  lng1: number,
  lat2: number,
  lng2: number
) {
  const R = 6371;
  const dLat = ((lat2 - lat1) * Math.PI) / 180;
  const dLng = ((lng2 - lng1) * Math.PI) / 180;

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos((lat1 * Math.PI) / 180) *
      Math.cos((lat2 * Math.PI) / 180) *
      Math.sin(dLng / 2) ** 2;

  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

/* ===============================
   üîç BASE PLATAFORMA (FIJA)
=============================== */
const PLATFORM_BASE = {
  lat: -34.6059, // Poeta Romildo Rizzo 3244
  lng: -58.6427, // William Morris, Hurlingham
};

/* ===============================
   üí≤ REGLAS DE COSTO
=============================== */
const PRICE_PER_KM = 85;
const FIXED_COST = 3500;

type AddressFrac = {
  lat: number;
  lng: number;
};

/* ===============================
   üìä FUNCI√ìN DE LOGGING MEJORADA
=============================== */
function logFraccionadoError(error: unknown, context: Record<string, any>) {
  const errorDetails = {
    timestamp: new Date().toISOString(),
    context,
    error: {
      message: error instanceof Error ? error.message : "Unknown error",
      stack: error instanceof Error ? error.stack : undefined,
      type: error?.constructor?.name || typeof error,
    },
  };

  // ‚úÖ Log detallado a consola
  console.error("‚ùå SHIPPING FRACCIONADO ERROR:", JSON.stringify(errorDetails, null, 2));

  // ‚úÖ TODO: Integrar con Sentry cuando est√© disponible
  if (process.env.SENTRY_DSN) {
    try {
      // Sentry.captureException(error, {
      //   extra: context,
      //   tags: { service: 'shipping-fraccionado' }
      // });
    } catch (sentryError) {
      console.error("‚ùå Error al enviar a Sentry:", sentryError);
    }
  }

  return errorDetails;
}

export async function POST(req: Request) {
  const requestContext = {
    url: req.url,
    method: req.method,
  };

  try {
    /* ===============================
       üîê RETAILER DESDE COOKIE
    =============================== */
    const retailerId = cookies().get("userId")?.value;

    if (!retailerId) {
      logFraccionadoError(
        new Error("No hay retailerId en cookie"),
        { ...requestContext, step: "auth" }
      );

      return NextResponse.json(
        {
          shippingCost: FIXED_COST,
          error: "Usuario no autenticado. Se asign√≥ costo fijo por defecto.",
        },
        { status: 200 }
      );
    }

    /* ===============================
       üì¶ BODY
    =============================== */
    const body = await req.json();
    const { productId } = body;

    if (!productId) {
      logFraccionadoError(
        new Error("productId faltante"),
        { ...requestContext, body, step: "validation" }
      );

      return NextResponse.json(
        {
          shippingCost: FIXED_COST,
          error: "Datos inv√°lidos. Se asign√≥ costo fijo por defecto.",
        },
        { status: 200 }
      );
    }

    /* ===============================
       üì¶ PRODUCTO ‚Üí FACTORY
    =============================== */
    const productSnap = await db
      .collection("products")
      .doc(productId)
      .get();

    if (!productSnap.exists) {
      logFraccionadoError(
        new Error("Producto no encontrado"),
        { ...requestContext, productId, step: "product_fetch" }
      );

      return NextResponse.json(
        {
          shippingCost: FIXED_COST,
          error: "Producto no encontrado. Se asign√≥ costo fijo por defecto.",
        },
        { status: 200 }
      );
    }

    const product = productSnap.data();
    if (!product?.factoryId) {
      logFraccionadoError(
        new Error("Producto sin factoryId"),
        { ...requestContext, productId, productData: product, step: "product_validation" }
      );

      return NextResponse.json(
        {
          shippingCost: FIXED_COST,
          error: "Producto sin fabricante asociado. Se asign√≥ costo fijo.",
        },
        { status: 200 }
      );
    }

    /* ===============================
       üè≠ F√ÅBRICA
    =============================== */
    const factorySnap = await db
      .collection("manufacturers")
      .doc(product.factoryId)
      .get();

    if (!factorySnap.exists) {
      logFraccionadoError(
        new Error("F√°brica no encontrada"),
        { ...requestContext, factoryId: product.factoryId, step: "factory_fetch" }
      );

      return NextResponse.json(
        {
          shippingCost: FIXED_COST,
          error: "F√°brica no encontrada. Se asign√≥ costo fijo por defecto.",
        },
        { status: 200 }
      );
    }

    const factoryData = factorySnap.data();
    const factoryAddress = factoryData?.address as AddressFrac;

    if (
      !factoryAddress ||
      typeof factoryAddress.lat !== "number" ||
      typeof factoryAddress.lng !== "number"
    ) {
      logFraccionadoError(
        new Error("Direcci√≥n de f√°brica inv√°lida"),
        {
          ...requestContext,
          factoryId: product.factoryId,
          factoryAddress,
          step: "factory_address",
        }
      );

      return NextResponse.json(
        {
          shippingCost: FIXED_COST,
          error: "F√°brica sin direcci√≥n v√°lida. Se asign√≥ costo fijo.",
        },
        { status: 200 }
      );
    }

    /* ===============================
       üõí RETAILER
    =============================== */
    const retailerSnap = await db
      .collection("retailers")
      .doc(retailerId)
      .get();

    if (!retailerSnap.exists) {
      logFraccionadoError(
        new Error("Revendedor no encontrado"),
        { ...requestContext, retailerId, step: "retailer_fetch" }
      );

      return NextResponse.json(
        {
          shippingCost: FIXED_COST,
          error: "Revendedor no encontrado. Se asign√≥ costo fijo por defecto.",
        },
        { status: 200 }
      );
    }

    const retailerData = retailerSnap.data();
    const retailerAddress = retailerData?.address as AddressFrac;

    if (
      !retailerAddress ||
      typeof retailerAddress.lat !== "number" ||
      typeof retailerAddress.lng !== "number"
    ) {
      logFraccionadoError(
        new Error("Direcci√≥n de revendedor inv√°lida"),
        {
          ...requestContext,
          retailerId,
          retailerAddress,
          step: "retailer_address",
        }
      );

      return NextResponse.json(
        {
          shippingCost: FIXED_COST,
          error: "Revendedor sin direcci√≥n v√°lida. Se asign√≥ costo fijo.",
        },
        { status: 200 }
      );
    }

    /* ===============================
       üîç DISTANCIAS
    =============================== */
    const baseToFactory = distanceKmFrac(
      PLATFORM_BASE.lat,
      PLATFORM_BASE.lng,
      factoryAddress.lat,
      factoryAddress.lng
    );

    const factoryToRetailer = distanceKmFrac(
      factoryAddress.lat,
      factoryAddress.lng,
      retailerAddress.lat,
      retailerAddress.lng
    );

    // ida + vuelta
    const totalKm = (baseToFactory + factoryToRetailer) * 2;

    /* ===============================
       üí∞ COSTO FINAL
    =============================== */
    const shippingCost =
      Math.round(totalKm * PRICE_PER_KM) + FIXED_COST;

    return NextResponse.json({
      shippingMode: "platform",
      shippingCost,
      km: Math.round(totalKm * 10) / 10,
    });
    
  } catch (error) {
    // ‚úÖ LOGGING COMPLETO DEL ERROR
    logFraccionadoError(error, {
      ...requestContext,
      step: "unexpected_error",
    });

    // ‚úÖ RESPUESTA SEGURA PARA EL CLIENTE
    return NextResponse.json(
      {
        shippingCost: FIXED_COST,
        error: "Ocurri√≥ un error al calcular el env√≠o fraccionado. Se asign√≥ costo fijo por defecto.",
      },
      { status: 200 }
    );
  }
}
</file>

<file path="app/api/test-firebase/route.ts">
import { NextResponse } from "next/server";
import { db } from "../../../lib/firebase-admin";

export async function GET() {
  const snap = await db.collection("lots").limit(1).get();
  return NextResponse.json({ ok: true, size: snap.size });
}
</file>

<file path="app/api/webhooks/mercadopago/route.ts">
// app/api/webhooks/mercadopago/route.ts
import { NextResponse } from "next/server";
import { MercadoPagoConfig, Payment } from "mercadopago";
import { db } from "../../../../lib/firebase-admin";
import { FieldValue } from "firebase-admin/firestore";
import { addFraccionadoToLot, FraccionatedLot } from "../../../../lib/lots";
import { createOrderFromClosedLot } from "../../../../lib/orders";
import rateLimit from "../../../../lib/rate-limit";
import { calculatePickupDeadline } from "../../../../lib/business-hours";
import {
  notifyManufacturerDirectOrder,
  notifyManufacturerLotClosed,
  notifyManufacturerFractionalProgress,
  notifyRetailerPickup,
} from "../../../../lib/notifications/send";

const limiter = rateLimit({
  interval: 60 * 1000,
  uniqueTokenPerInterval: 1000,
});

const DEFAULT_SCHEDULE = {
  monday: { open: "09:00", close: "18:00" },
  tuesday: { open: "09:00", close: "18:00" },
  wednesday: { open: "09:00", close: "18:00" },
  thursday: { open: "09:00", close: "18:00" },
  friday: { open: "09:00", close: "18:00" },
  saturday: { open: "09:00", close: "13:00" },
  sunday: null,
};

type MPMetadata = {
  orderType?: string;
  order_type?: string;
  productId?: string;
  product_id?: string;
  retailerId?: string;
  retailer_id?: string;
  original_qty?: number;
  minimumOrder?: number;
  MF?: number;
  mf?: number;
  lotType?: string;
  lot_type?: string;
  shippingCost?: number;
  shippingMode?: string;
  tipo?: string;
  commission?: number;
  featuredType?: "product" | "factory";
  featuredItemId?: string;
  featuredDuration?: number;
};

export async function GET() {
  return NextResponse.json({ 
    status: "ok",
    message: "Webhook activo"
  });
}

export async function POST(req: Request) {
  const ip = req.headers.get('x-forwarded-for') || 
             req.headers.get('x-real-ip') || 
             'mercadopago';
  
  try {
    await limiter.check(100, ip);
  } catch {
    console.warn("‚ö†Ô∏è Rate limit alcanzado en webhook, pero procesando igual");
  }

  try {
    const url = new URL(req.url);
    const paymentId = url.searchParams.get("data.id") || url.searchParams.get("id");
    const topic = url.searchParams.get("type") || url.searchParams.get("topic");

    if (!paymentId || topic !== "payment") {
      return NextResponse.json({ received: true });
    }

    const paymentRef = db.collection("payments").doc(paymentId.toString());
    const quickCheck = await paymentRef.get();
    
    if (quickCheck.exists && quickCheck.data()?.appliedToLot === true) {
      return NextResponse.json({ received: true });
    }

    const client = new MercadoPagoConfig({
      accessToken: process.env.MERCADOPAGO_ACCESS_TOKEN!,
    });

    const paymentApi = new Payment(client);
    
    const alreadyProcessed = await db.runTransaction(async (tx) => {
      const snap = await tx.get(paymentRef);
      if (snap.exists && snap.data()?.appliedToLot === true) {
        return true;
      }
      
      const payment = await paymentApi.get({ id: paymentId });
      
      if (payment.status !== "approved") {
        return true;
      }
      
      tx.set(paymentRef, {
        processing: true,
        appliedToLot: true,
        status: payment.status,
        createdAt: FieldValue.serverTimestamp(),
      }, { merge: true });
      return false;
    });

    if (alreadyProcessed) {
      return NextResponse.json({ received: true });
    }

    const payment = await paymentApi.get({ id: paymentId });
    const m = (payment.metadata as MPMetadata) || {};

    // ‚úÖ DESTACADOS
    if (m.tipo === "destacado" && m.featuredType && m.featuredItemId && m.featuredDuration) {
      await processFeaturedPayment({
        paymentId: paymentId.toString(),
        type: m.featuredType,
        itemId: m.featuredItemId,
        duration: m.featuredDuration as 7 | 15 | 30,
        payment,
      });

      return NextResponse.json({ received: true });
    }

    // ‚úÖ NORMALIZAR DATOS
    let orderType = m.orderType || m.order_type;
    if (orderType === "fraccionada") orderType = "fractional";
    if (orderType === "directa") orderType = "direct";

    const productId = m.productId || m.product_id;
    const retailerId = m.retailerId || m.retailer_id || "";
    const qty = Number(m.original_qty);
    const minimumOrder = Number(m.minimumOrder || 0);
    
    let lotType = m.lotType || m.lot_type;
    if (lotType === "fraccionado_retiro") lotType = "fractional_pickup";
    if (lotType === "fraccionado_envio") lotType = "fractional_shipping";

    if (!lotType && orderType === "fractional") {
      console.error("‚ùå lotType faltante para pedido fraccionado");
      return NextResponse.json({ received: true });
    }

    if (!orderType || !productId || !Number.isInteger(qty) || qty <= 0) {
      return NextResponse.json({ received: true });
    }

    const productSnap = await db.collection("products").doc(productId).get();
    if (!productSnap.exists) {
      return NextResponse.json({ received: true });
    }

    const productData = productSnap.data()!;
    const factoryId = productData.factoryId;
    const netProfitPerUnit = productData.netProfitPerUnit || 0;
    const productProfit = netProfitPerUnit * qty;

    // ‚úÖ‚úÖ‚úÖ CALCULAR SPLIT DE PAGOS ‚úÖ‚úÖ‚úÖ
    const totalAmount = payment.transaction_amount || 0;
    const shippingCost = m.shippingCost || 0;
    const commission = m.commission || 0;
    
    // Para fraccionados: total = producto + comisi√≥n + env√≠o
    // Para directos: total = producto + env√≠o
    const productTotal = orderType === "fractional"
      ? totalAmount - commission - shippingCost
      : totalAmount - shippingCost;

    const factoryReceives = orderType === "direct"
      ? totalAmount  // Fabricante recibe TODO en directos
      : productTotal; // Fabricante recibe solo producto en fraccionados

    const platformReceives = orderType === "fractional"
      ? commission + shippingCost  // Plataforma recibe comisi√≥n + env√≠o
      : 0; // Plataforma no recibe nada en directos

    // ‚úÖ‚úÖ‚úÖ GUARDAR PAGO CON SPLIT INFO ‚úÖ‚úÖ‚úÖ
    await paymentRef.set({
      status: payment.status,
      orderType,
      isFraccionado: orderType === "fractional",
      productId,
      retailerId,
      factoryId,
      qty,
      minimumOrder,
      lotType,
      netProfitPerUnit,
      productProfit,
      settled: orderType !== "fractional",
      refundable: orderType === "fractional",
      
      // ‚úÖ SPLIT PAYMENT INFO (NUEVO)
      splitPayment: {
        total: totalAmount,
        productTotal: Math.round(productTotal),
        commission: Math.round(commission),
        shippingCost: Math.round(shippingCost),
        factoryReceives: Math.round(factoryReceives),
        platformReceives: Math.round(platformReceives),
        splitType: orderType === "direct" ? "all_to_factory" : "split_commission",
      },
      
      updatedAt: FieldValue.serverTimestamp(),
      raw: payment,
    }, { merge: true });

    // ‚úÖ OBTENER DATOS PARA NOTIFICACIONES
    const factorySnap = await db.collection("manufacturers").doc(factoryId).get();
    const retailerSnap = await db.collection("retailers").doc(retailerId).get();

    const factoryData = factorySnap.exists ? factorySnap.data() : null;
    const retailerData = retailerSnap.exists ? retailerSnap.data() : null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 1Ô∏è‚É£ PEDIDO DIRECTO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (orderType === "direct") {
      const shippingMode = m.shippingMode || "pickup";
      
      // üìß Notificar fabricante
      if (factoryData) {
        await notifyManufacturerDirectOrder({
          factoryId,
          factoryEmail: factoryData.email || `factory-${factoryId}@placeholder.com`,
          productName: productData.name,
          qty,
          retailerName: retailerData?.businessName || retailerData?.name || "Revendedor",
          retailerAddress: retailerData?.address?.formattedAddress || "No especificada",
          retailerPhone: retailerData?.phone,
          shippingMode,
          orderId: paymentId.toString(),
        });
      }

      // üìß Si es RETIRO ‚Üí Notificar revendedor
      if (shippingMode === "pickup" && retailerData && factoryData) {
        const pickupDeadline = calculatePickupDeadline(
          new Date(),
          factoryData.schedule
        );

        await paymentRef.update({
          pickupDeadline,
          pickupDeadlineWarning: new Date(pickupDeadline.getTime() - 24 * 60 * 60 * 1000),
        });

        await notifyRetailerPickup({
          retailerId,
          retailerEmail: retailerData.email || `retailer-${retailerId}@placeholder.com`,
          productName: productData.name,
          qty,
          subtotal: productTotal,
          total: totalAmount,
          factoryBusinessName: factoryData.businessName || "F√°brica",
          factoryAddress: factoryData.address?.formattedAddress || "No especificada",
          factorySchedule: factoryData.schedule || DEFAULT_SCHEDULE,
          factoryPhone: factoryData.phone,
          factoryEmail: factoryData.email,
          pickupDeadline,
          orderId: paymentId.toString(),
          isDirect: true,
        });
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 2Ô∏è‚É£ PEDIDO FRACCIONADO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (orderType === "fractional" && lotType) {
      if (lotType !== "fractional_pickup" && lotType !== "fractional_shipping") {
        console.error("‚ùå lotType inv√°lido:", lotType);
        return NextResponse.json({ received: true });
      }

      // Agregar al lote
      await addFraccionadoToLot({
        productId,
        factoryId,
        minimumOrder,
        lotType,
        retailerOrder: { retailerId, qty, paymentId: paymentId.toString() },
      });

      // ‚úÖ Obtener estado del lote DESPU√âS de agregar
      const lotSnap = await db.collection("lots")
        .where("productId", "==", productId)
        .where("factoryId", "==", factoryId)
        .where("type", "==", lotType)
        .orderBy("createdAt", "desc")
        .limit(1)
        .get();

      if (!lotSnap.empty) {
        const lot = lotSnap.docs[0].data();
        const accumulatedQty = lot.accumulatedQty || 0;

        // üìß Notificar fabricante del progreso
        if (factoryData) {
          await notifyManufacturerFractionalProgress({
            factoryId,
            factoryEmail: factoryData.email || `factory-${factoryId}@placeholder.com`,
            productName: productData.name,
            retailerName: retailerData?.businessName || "Revendedor",
            qty,
            accumulatedQty,
            minimumOrder,
          });
        }

        // üìß Si es RETIRO ‚Üí Notificar revendedor con plazo
        const isPickup = lotType.includes("pickup");
        
        if (isPickup && retailerData && factoryData) {
          const pickupDeadline = calculatePickupDeadline(
            new Date(),
            factoryData.schedule
          );

          await paymentRef.update({
            pickupDeadline,
            pickupDeadlineWarning: new Date(pickupDeadline.getTime() - 24 * 60 * 60 * 1000),
          });

          // Solo notificar si el lote YA est√° cerrado
          if (lot.status === "closed") {
            await notifyRetailerPickup({
              retailerId,
              retailerEmail: retailerData.email || `retailer-${retailerId}@placeholder.com`,
              productName: productData.name,
              qty,
              subtotal: productTotal,
              total: totalAmount,
              factoryBusinessName: factoryData.businessName || "F√°brica",
              factoryAddress: factoryData.address?.formattedAddress || "No especificada",
              factorySchedule: factoryData.schedule || DEFAULT_SCHEDULE,
              factoryPhone: factoryData.phone,
              factoryEmail: factoryData.email,
              pickupDeadline,
              orderId: paymentId.toString(),
              isDirect: false,
            });
          }
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // 3Ô∏è‚É£ SI EL LOTE SE CIERRA ‚Üí NOTIFICAR FABRICANTE
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      const closedLotSnap = await db.collection("lots")
        .where("productId", "==", productId)
        .where("factoryId", "==", factoryId)
        .where("type", "==", lotType)
        .where("status", "==", "closed")
        .where("orderCreated", "==", false)
        .limit(1)
        .get();

      if (!closedLotSnap.empty) {
        const closedLot = closedLotSnap.docs[0].data();
        
        // Crear orden log√≠stica
        await createOrderFromClosedLot({
          ...(closedLot as FraccionatedLot),
          id: closedLotSnap.docs[0].id,
        });

        // üìß Notificar fabricante que el lote se complet√≥
        if (factoryData) {
          const retailerPromises = closedLot.orders.map(async (order: any) => {
            const rSnap = await db.collection("retailers").doc(order.retailerId).get();
            const rData = rSnap.data();
            
            return {
              name: rData?.businessName || rData?.name || "Revendedor",
              qty: order.qty,
              address: rData?.address?.formattedAddress || "No especificada",
              phone: rData?.phone,
            };
          });

          const retailers = await Promise.all(retailerPromises);

          await notifyManufacturerLotClosed({
            factoryId,
            factoryEmail: factoryData.email || `factory-${factoryId}@placeholder.com`,
            productName: productData.name,
            totalQty: closedLot.accumulatedQty,
            retailers,
            lotType,
            factoryAddress: factoryData.address?.formattedAddress || "No especificada",
            orderId: closedLotSnap.docs[0].id,
          });
        }

        // üìß Notificar a TODOS los revendedores del lote cerrado (si es retiro)
        const isPickup = lotType.includes("pickup");
        
        if (isPickup && factoryData) {
          for (const order of closedLot.orders) {
            const rSnap = await db.collection("retailers").doc(order.retailerId).get();
            const rData = rSnap.data();

            if (rData) {
              const pSnap = await db.collection("payments").doc(order.paymentId).get();
              const pData = pSnap.data();
              
              const pickupDeadline = pData?.pickupDeadline?.toDate() || calculatePickupDeadline(
                new Date(),
                factoryData.schedule
              );

              // ‚úÖ Usar splitPayment para subtotal y total
              const subtotal = pData?.splitPayment?.productTotal || 0;
              const total = pData?.splitPayment?.total || 0;

              await notifyRetailerPickup({
                retailerId: order.retailerId,
                retailerEmail: rData.email || `retailer-${order.retailerId}@placeholder.com`,
                productName: productData.name,
                qty: order.qty,
                subtotal,
                total,
                factoryBusinessName: factoryData.businessName || "F√°brica",
                factoryAddress: factoryData.address?.formattedAddress || "No especificada",
                factorySchedule: factoryData.schedule || DEFAULT_SCHEDULE,
                factoryPhone: factoryData.phone,
                factoryEmail: factoryData.email,
                pickupDeadline,
                orderId: order.paymentId,
                isDirect: false,
              });
            }
          }
        }
      }
    }

    return NextResponse.json({ received: true });
  } catch (err) {
    console.error("‚ùå Error webhook:", err);
    
    console.error("Error details:", {
      message: err instanceof Error ? err.message : "Unknown error",
      stack: err instanceof Error ? err.stack : undefined,
      timestamp: new Date().toISOString(),
    });
    
    return NextResponse.json({ received: true });
  }
}

// ‚úÖ PROCESAR PAGO DE DESTACADO
async function processFeaturedPayment({
  paymentId,
  type,
  itemId,
  duration,
  payment,
}: {
  paymentId: string;
  type: "product" | "factory";
  itemId: string;
  duration: 7 | 15 | 30;
  payment: any;
}) {
  try {
    let factoryId = "";
    let metadata: any = {};

    if (type === "product") {
      const productSnap = await db.collection("products").doc(itemId).get();
      if (!productSnap.exists) throw new Error("Producto no encontrado");
      
      const product = productSnap.data()!;
      factoryId = product.factoryId;
      metadata = {
        name: product.name,
        description: product.description || "",
        imageUrl: product.imageUrl || "",
      };

      await productSnap.ref.update({
        featured: true,
        featuredUntil: new Date(Date.now() + duration * 24 * 60 * 60 * 1000),
        updatedAt: FieldValue.serverTimestamp(),
      });

    } else {
      factoryId = itemId;
      const factorySnap = await db.collection("manufacturers").doc(itemId).get();
      if (!factorySnap.exists) throw new Error("F√°brica no encontrada");
      
      const factory = factorySnap.data()!;
      metadata = {
        name: factory.businessName || factory.name || "Mi f√°brica",
        description: factory.description || "",
        imageUrl: factory.imageUrl || "",
      };
    }

    const startDate = new Date();
    const endDate = new Date(startDate.getTime() + duration * 24 * 60 * 60 * 1000);

    await db.collection("featured").add({
      type,
      itemId,
      factoryId,
      duration,
      startDate: FieldValue.serverTimestamp(),
      endDate,
      paymentId,
      amount: payment.transaction_amount || 0,
      active: true,
      expired: false,
      metadata,
      createdAt: FieldValue.serverTimestamp(),
      updatedAt: FieldValue.serverTimestamp(),
    });

    console.log(`‚úÖ Destacado activado: ${type} ${itemId} por ${duration} d√≠as`);

  } catch (error) {
    console.error("‚ùå Error procesando pago destacado:", error);
    throw error;
  }
}
</file>

<file path="app/failure/page.tsx">
import Link from "next/link";
export default function FailurePage() {
  return (
    <main className="max-w-xl mx-auto p-6 text-center">
      <h1 className="text-2xl font-bold mb-4">
        ‚ùå El pago no se pudo completar
      </h1>

      <p className="mb-4">
        Hubo un problema al procesar el pago.
      </p>

      <p className="text-sm text-gray-600 mb-6">
        No se realiz√≥ ning√∫n cargo. Pod√©s intentarlo nuevamente.
      </p>

      <Link
  href="/products"
  className="inline-block bg-black text-white px-4 py-2 rounded"
>
  Volver al cat√°logo
</Link>
    </main>
  );
}
</file>

<file path="app/page.tsx">
// app/page.tsx - Home Principal (SIEMPRE se muestra este)

import HomePrincipal from '../components/HomePrincipal';

export default async function Page() {
  // SIEMPRE mostrar el home principal
  // La l√≥gica de redirecci√≥n est√° dentro del componente
  return <HomePrincipal />;
}
</file>

<file path="app/pending/page.tsx">
import Link from "next/link";
export default function PendingPage() {
  return (
    <main className="max-w-xl mx-auto p-6 text-center">
      <h1 className="text-2xl font-bold mb-4">
        ‚è≥ Pago pendiente
      </h1>

      <p className="mb-4">
        Tu pago est√° siendo procesado.
      </p>

      <p className="text-sm text-gray-600 mb-6">
        Esto puede demorar unos minutos. Cuando se confirme,
        tu pedido se procesar√° autom√°ticamente.
      </p>

      <Link
  href="/products"
  className="inline-block bg-black text-white px-4 py-2 rounded"
>
  Volver al cat√°logo
</Link>
    </main>
  );
}
</file>

<file path="app/success/page.tsx">
import Link from "next/link";
export default function SuccessPage() {
  return (
    <main className="max-w-xl mx-auto p-6 text-center">
      <h1 className="text-2xl font-bold mb-4">
        ‚úÖ Pago realizado con √©xito
      </h1>

      <p className="mb-4">
        Tu pago fue confirmado correctamente.
      </p>

      <p className="text-sm text-gray-600 mb-6">
        Si elegiste compra fraccionada, tu pedido ya fue sumado al lote.
        Te avisaremos cuando el lote se complete.
      </p>

      <Link
  href="/products"
  className="inline-block bg-black text-white px-4 py-2 rounded"
>
  Volver al cat√°logo
</Link>
    </main>
  );
}
</file>

<file path="components/ui/radio-group.tsx">
"use client";

import * as React from "react";
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group";
import { cn } from "../../lib/utils";

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => (
  <RadioGroupPrimitive.Root
    ref={ref}
    className={cn("grid gap-2", className)}
    {...props}
  />
));
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName;

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => (
  <RadioGroupPrimitive.Item
    ref={ref}
    className={cn(
      "aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
      className
    )}
    {...props}
  >
    <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
      <div className="h-2.5 w-2.5 rounded-full bg-current" />
    </RadioGroupPrimitive.Indicator>
  </RadioGroupPrimitive.Item>
));
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName;

export { RadioGroup, RadioGroupItem };
</file>

<file path="lib/firebase-admin.ts">
import admin from "firebase-admin";
import path from "path";
import fs from "fs";

if (!admin.apps.length) {
  try {
    // üõ†Ô∏è DESARROLLO: Intentar usar archivo local primero
    if (process.env.NODE_ENV !== "production") {
      console.log("üî• Inicializando Firebase Admin desde archivo local...");
      
      const serviceAccountPath = path.join(
        process.cwd(),
        "credentials",
        "firebase-service-account.json"
      );

      if (fs.existsSync(serviceAccountPath)) {
        const serviceAccount = JSON.parse(
          fs.readFileSync(serviceAccountPath, "utf8")
        );

        admin.initializeApp({
          credential: admin.credential.cert(serviceAccount),
        });

        console.log("‚úÖ Firebase Admin inicializado correctamente");
      } else {
        throw new Error(
          `‚ùå Archivo de credenciales no encontrado: ${serviceAccountPath}\n` +
          "Aseg√∫rate de tener el archivo en credentials/firebase-service-account.json"
        );
      }
    } 
    // üåê PRODUCCI√ìN: Usar variable de entorno
    else if (process.env.FIREBASE_SERVICE_ACCOUNT) {
      console.log("üî• Inicializando Firebase Admin desde ENV...");
      
      const serviceAccount = JSON.parse(
        process.env.FIREBASE_SERVICE_ACCOUNT
      );

      admin.initializeApp({
        credential: admin.credential.cert(serviceAccount),
      });

      console.log("‚úÖ Firebase Admin inicializado correctamente");
    } 
    // ‚ùå ERROR: Falta configuraci√≥n en producci√≥n
    else {
      throw new Error(
        "‚ùå Configuraci√≥n de Firebase Admin faltante en producci√≥n.\n" +
        "Configura la variable FIREBASE_SERVICE_ACCOUNT"
      );
    }

  } catch (error) {
    console.error("‚ùå ERROR CR√çTICO al inicializar Firebase Admin:", error);
    throw error;
  }
}

// Exports est√°ndar
export const db = admin.firestore();
export const auth = admin.auth();

export async function getAdminServices() {
  return {
    adminDb: admin.firestore(),
    adminAuth: admin.auth(),
  };
}
</file>

<file path="lib/lots.ts">
import { db } from "../lib/firebase-admin";
import { FieldValue, Transaction } from "firebase-admin/firestore";

/**
 * Pedido individual fraccionado
 */
export type FraccionatedOrder = {
  retailerId: string;
  qty: number;
  paymentId: string;
};

/**
 * Tipos de lote (estandarizados)
 */
export type LotType =
  | "fractional_pickup"
  | "fractional_shipping"
  | "direct_pickup"
  | "direct_shipping";

/**
 * Lote fraccionado (retiro o env√≠o)
 */
export type FraccionatedLot = {
  id?: string;
  productId: string;
  factoryId: string;
  type: LotType;
  minimumOrder: number; // ‚úÖ Estandarizado (antes era MF)
  accumulatedQty: number;
  status: "accumulating" | "closed";
  orders: FraccionatedOrder[];
  orderCreated?: boolean;
  createdAt: any;
  updatedAt: any;
  closedAt?: any;
};

/**
 * Par√°metros para agregar pedido fraccionado
 */
export type AddFraccionadoParams = {
  productId: string;
  factoryId: string;
  minimumOrder: number; // ‚úÖ Agregado aqu√≠
  lotType: "fractional_pickup" | "fractional_shipping"; // ‚úÖ Solo fraccionados
  retailerOrder: FraccionatedOrder;
};

/**
 * Agrega pedido fraccionado al lote ACTIVO
 * - Si no hay lote activo ‚Üí crea uno nuevo
 * - Si el lote alcanza minimumOrder ‚Üí se cierra
 * - Los lotes cerrados NO se reutilizan
 */
export async function addFraccionadoToLot(
  params: AddFraccionadoParams
) {
  const {
    productId,
    factoryId,
    minimumOrder,
    lotType,
    retailerOrder,
  } = params;

  // üîí FIX CR√çTICO ‚Äì factoryId SIEMPRE obligatorio
  if (!factoryId) {
    throw new Error(
      "factoryId es obligatorio para pedidos fraccionados"
    );
  }

  const lotsRef = db.collection("lots");

  await db.runTransaction(async (tx: Transaction) => {
    /**
     * üîç Buscar lote ACTIVO (MISMO producto + f√°brica + tipo)
     */
    const activeLotQuery = await tx.get(
      lotsRef
        .where("productId", "==", productId)
        .where("factoryId", "==", factoryId)
        .where("type", "==", lotType)
        .where("status", "==", "accumulating")
        .limit(1)
    );

    /**
     * üÜï NO existe lote activo ‚Üí crear uno nuevo
     */
    if (activeLotQuery.empty) {
      const newLotRef = lotsRef.doc();

      const accumulatedQty = retailerOrder.qty;
      const status =
        accumulatedQty >= minimumOrder ? "closed" : "accumulating";

      tx.set(newLotRef, {
        productId,
        factoryId,
        type: lotType,
        minimumOrder, // ‚úÖ Usar nombre estandarizado
        accumulatedQty,
        status,
        orders: [retailerOrder],
        orderCreated: false,
        createdAt: FieldValue.serverTimestamp(),
        updatedAt: FieldValue.serverTimestamp(),
        closedAt:
          status === "closed"
            ? FieldValue.serverTimestamp()
            : null,
      });

      return;
    }

    /**
     * ‚ûï Usar lote activo existente
     */
    const lotSnap = activeLotQuery.docs[0];
    const lotRef = lotSnap.ref;
    const lot = lotSnap.data() as FraccionatedLot;

    const newQty = lot.accumulatedQty + retailerOrder.qty;
    const newStatus =
      newQty >= minimumOrder ? "closed" : "accumulating";

    tx.update(lotRef, {
      accumulatedQty: newQty,
      orders: FieldValue.arrayUnion(retailerOrder),
      status: newStatus,
      updatedAt: FieldValue.serverTimestamp(),
      closedAt:
        newStatus === "closed"
          ? FieldValue.serverTimestamp()
          : null,
    });
  });
}
</file>

<file path="lib/lots/addFraccionadoToLot.ts">
import { db } from "../../lib/firebase-admin";
import { FieldValue } from "firebase-admin/firestore";

/* =====================================================
   üîí SANITIZADOR DE CANTIDAD (FIX CR√çTICO)
===================================================== */
function parseQty(qty: any): number {
  const n = Number(qty);
  
  if (!Number.isFinite(n)) {
    throw new Error(`‚ùå Cantidad inv√°lida: ${qty} no es un n√∫mero`);
  }
  
  if (n <= 0) {
    throw new Error(`‚ùå Cantidad inv√°lida: ${qty} debe ser mayor a 0`);
  }
  
  if (!Number.isInteger(n)) {
    throw new Error(`‚ùå Cantidad inv√°lida: ${qty} debe ser un n√∫mero entero`);
  }
  
  if (n > 1000000) {
    throw new Error(`‚ùå Cantidad inv√°lida: ${qty} es demasiado grande`);
  }
  
  return n;
}

/* =====================================================
   ‚ûï AGREGAR PEDIDO FRACCIONADO A LOTE
===================================================== */
export async function addFraccionadoToLot({
  productId,
  factoryId,
  minimumOrder, // ‚úÖ Nombre estandarizado
  lotType,
  retailerOrder,
}: {
  productId: string;
  factoryId: string;
  minimumOrder: number; // ‚úÖ En vez de MF
  lotType: "fractional_pickup" | "fractional_shipping"; // ‚úÖ Solo fraccionados
  retailerOrder: {
    retailerId: string;
    qty: number;
    paymentId: string;
  };
}) {
  const lotsRef = db.collection("lots");

  // üîí LOCK √öNICO POR PRODUCTO + F√ÅBRICA + TIPO
  const lockId = `${productId}_${factoryId}_${lotType}`;
  const lockRef = db.collection("lotLocks").doc(lockId);

  // üîí REFERENCIA AL PAGO (CLAVE DEL FIX)
  const paymentRef = db
    .collection("payments")
    .doc(retailerOrder.paymentId);

  await db.runTransaction(async (tx) => {
    /* ===============================
       0Ô∏è‚É£ IDEMPOTENCIA REAL POR PAGO
       üîí SI YA FUE APLICADO ‚Üí SALIR
    =============================== */
    const paymentSnap = await tx.get(paymentRef);
    if (
      paymentSnap.exists &&
      paymentSnap.data()?.appliedToLot === true
    ) {
      console.log("‚úã Pago ya aplicado al lote");
      return;
    }

    /* ===============================
       1Ô∏è‚É£ LOCK ANTI DUPLICADOS
    =============================== */
    const lockSnap = await tx.get(lockRef);
    if (!lockSnap.exists) {
      tx.set(lockRef, {
        createdAt: FieldValue.serverTimestamp(),
      });
    }

    /* ===============================
       2Ô∏è‚É£ BUSCAR LOTE ACTIVO
    =============================== */
    const activeLotQuery = await tx.get(
      lotsRef
        .where("productId", "==", productId)
        .where("factoryId", "==", factoryId)
        .where("type", "==", lotType)
        .where("status", "==", "accumulating")
        .limit(1)
    );

    // üîí CANTIDAD REAL Y SEGURA
    const orderQty = parseQty(retailerOrder.qty);

    /* ===============================
       3Ô∏è‚É£ NO HAY LOTE ‚Üí CREAR NUEVO
    =============================== */
    if (activeLotQuery.empty) {
      const willClose = orderQty >= minimumOrder;
      const newLotRef = lotsRef.doc();

      tx.set(newLotRef, {
        productId,
        factoryId,
        type: lotType,
        minimumOrder, // ‚úÖ Nombre estandarizado
        accumulatedQty: orderQty,
        status: willClose ? "closed" : "accumulating",
        orders: [
          {
            retailerId: retailerOrder.retailerId,
            paymentId: retailerOrder.paymentId,
            qty: orderQty,
          },
        ],
        orderCreated: false,
        createdAt: FieldValue.serverTimestamp(),
        updatedAt: FieldValue.serverTimestamp(),
        closedAt: willClose ? FieldValue.serverTimestamp() : null,
      });

      console.log(`üì¶ Nuevo lote creado: ${newLotRef.id}`);
      console.log(`   Status: ${willClose ? "closed" : "accumulating"}`);
      console.log(`   Qty: ${orderQty}/${minimumOrder}`);

      // üîí MARCAR PAGO COMO APLICADO
      tx.set(
        paymentRef,
        { appliedToLot: true },
        { merge: true }
      );

      return;
    }

    /* ===============================
       4Ô∏è‚É£ HAY LOTE ‚Üí ACTUALIZAR
    =============================== */
    const lotSnap = activeLotQuery.docs[0];
    const lotRef = lotSnap.ref;
    const lot = lotSnap.data()!;

    // üõë EVITAR DUPLICADO (SEGUNDA BARRERA)
    const alreadyExists = (lot.orders || []).some(
      (o: any) => o.paymentId === retailerOrder.paymentId
    );
    if (alreadyExists) {
      console.log("‚úã Pedido ya existe en el lote");
      tx.set(
        paymentRef,
        { appliedToLot: true },
        { merge: true }
      );
      return;
    }

    const currentQty = Number(lot.accumulatedQty || 0);
    const newQty = currentQty + orderQty;
    const willClose = newQty >= minimumOrder;

    tx.update(lotRef, {
      accumulatedQty: newQty,
      orders: FieldValue.arrayUnion({
        retailerId: retailerOrder.retailerId,
        paymentId: retailerOrder.paymentId,
        qty: orderQty,
      }),
      status: willClose ? "closed" : "accumulating",
      updatedAt: FieldValue.serverTimestamp(),
      closedAt: willClose ? FieldValue.serverTimestamp() : null,
    });

    console.log(`üì¶ Lote actualizado: ${lotSnap.id}`);
    console.log(`   Status: ${willClose ? "closed" : "accumulating"}`);
    console.log(`   Qty: ${newQty}/${minimumOrder}`);

    // üîí MARCAR PAGO COMO APLICADO (CLAVE ABSOLUTA)
    tx.set(
      paymentRef,
      { appliedToLot: true },
      { merge: true }
    );
  });
}
</file>

<file path="lib/lots/getOrCreateOpenLot.ts">
import { db } from "../../lib/firebase-admin";
import { FieldValue } from "firebase-admin/firestore";

export async function getOrCreateOpenLot({
  productId,
  factoryId,
  minimumOrder,
  lotType,
}: {
  productId: string;
  factoryId: string;
  minimumOrder: number;
  lotType: "fractional_shipping" | "fractional_pickup";
}) {
  /**
   * üîç BUSCAR LOTE ABIERTO EXISTENTE
   */
  const snap = await db
    .collection("lots")
    .where("productId", "==", productId)
    .where("type", "==", lotType)
    .where("status", "==", "accumulating")
    .limit(1)
    .get();

  if (!snap.empty) {
    const doc = snap.docs[0];
    return {
      id: doc.id,
      ...doc.data(),
    };
  }

  /**
   * üÜï CREAR NUEVO LOTE
   */
  const newLotRef = db.collection("lots").doc();
  const newLot = {
    productId,
    factoryId,
    type: lotType,
    minimumOrder,
    accumulatedQty: 0,
    status: "accumulating",
    orders: [],
    orderCreated: false,
    createdAt: FieldValue.serverTimestamp(),
    updatedAt: FieldValue.serverTimestamp(),
    closedAt: null,
  };

  await newLotRef.set(newLot);

  return {
    id: newLotRef.id,
    ...newLot,
  };
}
</file>

<file path="lib/orders.ts">
import { db } from "../lib/firebase-admin";
import { FieldValue } from "firebase-admin/firestore";
import { FraccionatedLot } from "../lib/lots";

/* =====================================================
   1Ô∏è‚É£ ORDEN LOG√çSTICA FINAL (NO TOCAR)
   Se crea UNA sola vez cuando un lote fraccionado se cierra
===================================================== */

export async function createOrderFromClosedLot(
  lot: FraccionatedLot & { id: string }
) {
  // üõë Seguridad absoluta
  if (lot.status !== "closed") return;
  if (lot.orderCreated === true) return;

  // üîí Evitar duplicados (misma f√°brica + producto)
  const existing = await db
    .collection("orders")
    .where("origin", "==", "fraccionado")
    .where("productId", "==", lot.productId)
    .where("factoryId", "==", lot.factoryId)
    .limit(1)
    .get();

  if (!existing.empty) return;

  // üè≠ Obtener f√°brica
  const factorySnap = await db
    .collection("manufacturers")
    .doc(lot.factoryId)
    .get();

  const factory = factorySnap.data();
  if (!factory || !factory.address) {
    throw new Error("La f√°brica no tiene direcci√≥n cargada");
  }

  // üè™ Obtener revendedores
  const items = await Promise.all(
    lot.orders.map(async (o) => {
      const retailerSnap = await db
        .collection("retailers")
        .doc(o.retailerId)
        .get();

      const retailer = retailerSnap.data();
      if (!retailer || !retailer.address) {
        throw new Error(
          `El revendedor ${o.retailerId} no tiene direcci√≥n cargada`
        );
      }

      return {
        retailerId: o.retailerId,
        qty: o.qty,
        name:
          retailer.businessName ||
          retailer.contactFullName ||
          "Revendedor",
        address: retailer.address,
      };
    })
  );

  // üì¶ Crear ORDEN FINAL (log√≠stica)
  await db.collection("orders").add({
    origin: "fraccionado",
    productId: lot.productId,
    factoryId: lot.factoryId,
    factoryAddress: factory.address,
    totalQty: lot.accumulatedQty,
    items,
    status: "ready_to_ship",
    createdAt: FieldValue.serverTimestamp(),
  });

  // üîí Marcar lote como procesado (USAR ID REAL)
  await db
    .collection("lots")
    .doc(lot.id)
    .update({
      orderCreated: true,
      updatedAt: FieldValue.serverTimestamp(),
    });

  /* =====================================================
     üîì LIBERAR PAGOS AL CERRAR LOTE (FIX FINAL)
     - Libera dinero a f√°brica
     - Bloquea reembolsos
     - Pagos fraccionados retenidos hasta cierre
  ===================================================== */

  await db.runTransaction(async (tx) => {
    const paymentsSnap = await tx.get(
      db
        .collection("payments")
        .where("productId", "==", lot.productId)
        .where("factoryId", "==", lot.factoryId)
        .where("lotType", "==", lot.type)
        .where("settled", "==", false)
        .where("refunded", "!=", true)
    );

    paymentsSnap.docs.forEach((doc) => {
      tx.update(doc.ref, {
        settled: true,                 // üí∞ dinero liberado
        refundable: false,             // üö´ no m√°s reembolsos
        settledAt: FieldValue.serverTimestamp(),
      });
    });
  });
}

/* =====================================================
   2Ô∏è‚É£ ORDEN DE COMPRA DEL USUARIO
   (flujo futuro / dashboard)
===================================================== */

type CreatePurchaseOrderInput = {
  productId: string;
  qty: number;
  tipo: "directa" | "fraccionada";
  withShipping: boolean;
  preferenceId: string;
};

export async function createPurchaseOrder({
  productId,
  qty,
  tipo,
  withShipping,
  preferenceId,
}: CreatePurchaseOrderInput) {
  const orderRef = await db.collection("purchase_orders").add({
    productId,
    qty,
    tipo,
    withShipping,
    status: "created",
    payment: {
      provider: "mercadopago",
      preferenceId,
    },
    createdAt: FieldValue.serverTimestamp(),
  });

  return orderRef.id;
}
</file>

<file path="package.json">
{
  "name": "plataforma-next",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@radix-ui/react-radio-group": "^1.3.8",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "date-fns-tz": "^3.2.0",
    "firebase": "^12.7.0",
    "firebase-admin": "^13.6.0",
    "firebase-functions": "^7.0.3",
    "lru-cache": "^11.2.4",
    "mercadopago": "^2.11.0",
    "next": "^14.2.5",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-hot-toast": "^2.6.0",
    "resend": "^4.8.0",
    "tailwind-merge": "^3.4.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.1.0",
    "tailwindcss": "^4",
    "ts-node": "^10.9.2",
    "typescript": "^5"
  }
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "baseUrl": ".",
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": false,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/": [
        "./"
      ]
    },
    "strictNullChecks": true
  },
  "include": [
    "next-env.d.ts",
    "*/.ts",
    "*/.tsx",
    ".next/types/*/.ts",
    ".next/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

</files>
